/*!
 * Adapted from koa-send at https://github.com/koajs/send and which is licensed
 * with the MIT license.
 */
import { calculate, ifNoneMatch } from "./etag.ts";
import { createHttpError } from "./httpError.ts";
import { assert, basename, extname, LimitedReader, parse, readAll, Status, } from "./deps.ts";
import { ifRange, MultiPartStream, parseRange } from "./range.ts";
import { decodeComponent, getBoundary, resolvePath } from "./util.ts";
const MAXBUFFER_DEFAULT = 1_048_576;
const BOUNDARY = getBoundary();
function isHidden(path) {
    const pathArr = path.split("/");
    for (const segment of pathArr) {
        if (segment[0] === "." && segment !== "." && segment !== "..") {
            return true;
        }
        return false;
    }
}
async function exists(path) {
    try {
        return (await Deno.stat(path)).isFile;
    }
    catch {
        return false;
    }
}
async function getEntity(path, mtime, stats, maxbuffer, response) {
    let body;
    let entity;
    const file = await Deno.open(path, { read: true });
    if (stats.size < maxbuffer) {
        const buffer = await readAll(file);
        file.close();
        body = entity = buffer;
    }
    else {
        response.addResource(file.rid);
        body = file;
        entity = {
            mtime: new Date(mtime),
            size: stats.size,
        };
    }
    return [body, entity];
}
async function sendRange(response, body, range, size) {
    const ranges = parseRange(range, size);
    if (ranges.length === 0) {
        throw createHttpError(Status.RequestedRangeNotSatisfiable);
    }
    response.status = Status.PartialContent;
    if (ranges.length === 1) {
        const [byteRange] = ranges;
        response.headers.set("Content-Length", String(byteRange.end - byteRange.start + 1));
        response.headers.set("Content-Range", `bytes ${byteRange.start}-${byteRange.end}/${size}`);
        if (body instanceof Uint8Array) {
            response.body = body.slice(byteRange.start, byteRange.end + 1);
        }
        else {
            await body.seek(byteRange.start, Deno.SeekMode.Start);
            response.body = new LimitedReader(body, byteRange.end - byteRange.start);
        }
    }
    else {
        assert(response.type);
        response.headers.set("content-type", `multipart/byteranges; boundary=${BOUNDARY}`);
        const multipartBody = new MultiPartStream(body, response.type, ranges, size, BOUNDARY);
        response.headers.set("content-length", String(multipartBody.contentLength()));
        response.body = multipartBody;
    }
}
export async function send({ request, response }, path, options = { root: "" }) {
    const { brotli = true, contentTypes = {}, extensions, format = true, gzip = true, hidden = false, immutable = false, index, maxbuffer = MAXBUFFER_DEFAULT, maxage = 0, root, } = options;
    const trailingSlash = path[path.length - 1] === "/";
    path = decodeComponent(path.substr(parse(path).root.length));
    if (index && trailingSlash) {
        path += index;
    }
    if (!hidden && isHidden(path)) {
        throw createHttpError(403);
    }
    path = resolvePath(root, path);
    let encodingExt = "";
    if (brotli &&
        request.acceptsEncodings("br", "identity") === "br" &&
        (await exists(`${path}.br`))) {
        path = `${path}.br`;
        response.headers.set("Content-Encoding", "br");
        response.headers.delete("Content-Length");
        encodingExt = ".br";
    }
    else if (gzip &&
        request.acceptsEncodings("gzip", "identity") === "gzip" &&
        (await exists(`${path}.gz`))) {
        path = `${path}.gz`;
        response.headers.set("Content-Encoding", "gzip");
        response.headers.delete("Content-Length");
        encodingExt = ".gz";
    }
    if (extensions && !/\.[^/]*$/.exec(path)) {
        for (let ext of extensions) {
            if (!/^\./.exec(ext)) {
                ext = `.${ext}`;
            }
            if (await exists(`${path}${ext}`)) {
                path += ext;
                break;
            }
        }
    }
    let stats;
    try {
        stats = await Deno.stat(path);
        if (stats.isDirectory) {
            if (format && index) {
                path += `/${index}`;
                stats = await Deno.stat(path);
            }
            else {
                return;
            }
        }
    }
    catch (err) {
        if (err instanceof Deno.errors.NotFound) {
            throw createHttpError(404, err.message);
        }
        throw createHttpError(500, err.message);
    }
    let mtime = null;
    if (response.headers.has("Last-Modified")) {
        mtime = new Date(response.headers.get("Last-Modified")).getTime();
    }
    else if (stats.mtime) {
        mtime = stats.mtime.getTime();
        mtime -= mtime % 1000;
        response.headers.set("Last-Modified", new Date(mtime).toUTCString());
    }
    if (!response.headers.has("Cache-Control")) {
        const directives = [`max-age=${(maxage / 1000) | 0}`];
        if (immutable) {
            directives.push("immutable");
        }
        response.headers.set("Cache-Control", directives.join(","));
    }
    if (!response.type) {
        response.type = encodingExt !== ""
            ? extname(basename(path, encodingExt))
            : contentTypes[extname(path)] ?? extname(path);
    }
    let entity = null;
    let body = null;
    if (request.headers.has("If-None-Match") && mtime) {
        [body, entity] = await getEntity(path, mtime, stats, maxbuffer, response);
        if (!ifNoneMatch(request.headers.get("If-None-Match"), entity)) {
            response.headers.set("ETag", calculate(entity));
            response.status = 304;
            return path;
        }
    }
    if (request.headers.has("If-Modified-Since") && mtime) {
        const ifModifiedSince = new Date(request.headers.get("If-Modified-Since"));
        if (ifModifiedSince.getTime() >= mtime) {
            response.status = 304;
            return path;
        }
    }
    if (!body || !entity) {
        [body, entity] = await getEntity(path, mtime ?? 0, stats, maxbuffer, response);
    }
    if (request.headers.has("If-Range") && mtime &&
        ifRange(request.headers.get("If-Range"), mtime, entity) &&
        request.headers.has("Range")) {
        await sendRange(response, body, request.headers.get("Range"), stats.size);
        return path;
    }
    if (request.headers.has("Range")) {
        await sendRange(response, body, request.headers.get("Range"), stats.size);
        return path;
    }
    response.headers.set("Content-Length", String(stats.size));
    response.body = body;
    if (!response.headers.has("ETag")) {
        response.headers.set("ETag", calculate(entity));
    }
    if (!response.headers.has("Accept-Ranges")) {
        response.headers.set("Accept-Ranges", "bytes");
    }
    return path;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VuZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNlbmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OztHQUdHO0FBR0gsT0FBTyxFQUFFLFNBQVMsRUFBWSxXQUFXLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDN0QsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2pELE9BQU8sRUFDTCxNQUFNLEVBQ04sUUFBUSxFQUNSLE9BQU8sRUFDUCxhQUFhLEVBQ2IsS0FBSyxFQUNMLE9BQU8sRUFDUCxNQUFNLEdBQ1AsTUFBTSxXQUFXLENBQUM7QUFDbkIsT0FBTyxFQUFFLE9BQU8sRUFBRSxlQUFlLEVBQUUsVUFBVSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBRWxFLE9BQU8sRUFBRSxlQUFlLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUV0RSxNQUFNLGlCQUFpQixHQUFHLFNBQVMsQ0FBQztBQUNwQyxNQUFNLFFBQVEsR0FBRyxXQUFXLEVBQUUsQ0FBQztBQTRFL0IsU0FBUyxRQUFRLENBQUMsSUFBWTtJQUM1QixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2hDLEtBQUssTUFBTSxPQUFPLElBQUksT0FBTyxFQUFFO1FBQzdCLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxPQUFPLEtBQUssR0FBRyxJQUFJLE9BQU8sS0FBSyxJQUFJLEVBQUU7WUFDN0QsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELE9BQU8sS0FBSyxDQUFDO0tBQ2Q7QUFDSCxDQUFDO0FBRUQsS0FBSyxVQUFVLE1BQU0sQ0FBQyxJQUFZO0lBQ2hDLElBQUk7UUFDRixPQUFPLENBQUMsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO0tBQ3ZDO0lBQUMsTUFBTTtRQUNOLE9BQU8sS0FBSyxDQUFD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QUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUUsRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDM0UsT0FBTyxJQUFJLENBQUM7S0FDYjtJQUVELFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUMzRCxRQUFRLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztJQUVyQixJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUU7UUFDakMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0tBQ2pEO0lBRUQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQyxFQUFFO1FBQzFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsRUFBRSxPQUFPLENBQUMsQ0FBQztLQUNoRDtJQUVELE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQWRhcHRlZCBmcm9tIGtvYS1zZW5kIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9rb2Fqcy9zZW5kIGFuZCB3aGljaCBpcyBsaWNlbnNlZFxuICogd2l0aCB0aGUgTUlUIGxpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHR5cGUgeyBDb250ZXh0IH0gZnJvbSBcIi4vY29udGV4dC50c1wiO1xuaW1wb3J0IHsgY2FsY3VsYXRlLCBGaWxlSW5mbywgaWZOb25lTWF0Y2ggfSBmcm9tIFwiLi9ldGFnLnRzXCI7XG5pbXBvcnQgeyBjcmVhdGVIdHRwRXJyb3IgfSBmcm9tIFwiLi9odHRwRXJyb3IudHNcIjtcbmltcG9ydCB7XG4gIGFzc2VydCxcbiAgYmFzZW5hbWUsXG4gIGV4dG5hbWUsXG4gIExpbWl0ZWRSZWFkZXIsXG4gIHBhcnNlLFxuICByZWFkQWxsLFxuICBTdGF0dXMsXG59IGZyb20gXCIuL2RlcHMudHNcIjtcbmltcG9ydCB7IGlmUmFuZ2UsIE11bHRpUGFydFN0cmVhbSwgcGFyc2VSYW5nZSB9IGZyb20gXCIuL3JhbmdlLnRzXCI7XG5pbXBvcnQgdHlwZSB7IFJlc3BvbnNlIH0gZnJvbSBcIi4vcmVzcG9uc2UudHNcIjtcbmltcG9ydCB7IGRlY29kZUNvbXBvbmVudCwgZ2V0Qm91bmRhcnksIHJlc29sdmVQYXRoIH0gZnJvbSBcIi4vdXRpbC50c1wiO1xuXG5jb25zdCBNQVhCVUZGRVJfREVGQVVMVCA9IDFfMDQ4XzU3NjsgLy8gMU1pQjtcbmNvbnN0IEJPVU5EQVJZID0gZ2V0Qm91bmRhcnkoKTtcblxuZXhwb3J0IGludGVyZmFjZSBTZW5kT3B0aW9ucyB7XG4gIC8qKiBUcnkgdG8gc2VydmUgdGhlIGJyb3RsaSB2ZXJzaW9uIG9mIGEgZmlsZSBhdXRvbWF0aWNhbGx5IHdoZW4gYnJvdGxpIGlzXG4gICAqIHN1cHBvcnRlZCBieSBhIGNsaWVudCBhbmQgaWYgdGhlIHJlcXVlc3RlZCBmaWxlIHdpdGggYC5icmAgZXh0ZW5zaW9uXG4gICAqIGV4aXN0cy4gKGRlZmF1bHRzIHRvIGB0cnVlYCkgKi9cbiAgYnJvdGxpPzogYm9vbGVhbjtcblxuICAvKiogQSByZWNvcmQgb2YgZXh0ZW5zaW9ucyBhbmQgY29udGVudCB0eXBlcyB0aGF0IHNob3VsZCBiZSB1c2VkIHdoZW5cbiAgICogZGV0ZXJtaW5pbmcgdGhlIGNvbnRlbnQgb2YgYSBmaWxlIGJlaW5nIHNlcnZlZC4gQnkgZGVmYXVsdCwgdGhlXG4gICAqIFtgbWVkaWFfdHlwZWBdKGh0dHBzOi8vZ2l0aHViLmNvbS9vYWtzZXJ2ZXIvbWVkaWFfdHlwZXMvKSBkYXRhYmFzZSBpcyB1c2VkXG4gICAqIHRvIG1hcCBhbiBleHRlbnNpb24gdG8gdGhlIHNlcnZlZCBjb250ZW50LXR5cGUuIFRoZSBrZXlzIG9mIHRoZSBtYXAgYXJlXG4gICAqIGV4dGVuc2lvbnMsIGFuZCB2YWx1ZXMgYXJlIHRoZSBjb250ZW50IHR5cGVzIHRvIHVzZS4gVGhlIGNvbnRlbnQgdHlwZSBjYW5cbiAgICogYmUgYSBwYXJ0aWFsIGNvbnRlbnQgdHlwZSwgd2hpY2ggd2lsbCBiZSByZXNvbHZlZCB0byBhIGZ1bGwgY29udGVudCB0eXBlXG4gICAqIGhlYWRlci5cbiAgICpcbiAgICogQW55IGV4dGVuc2lvbnMgbWF0Y2hlZCB3aWxsIG92ZXJyaWRlIHRoZSBkZWZhdWx0IGJlaGF2aW9yLiBLZXkgc2hvdWxkXG4gICAqIGluY2x1ZGUgdGhlIGxlYWRpbmcgZG90IChlLmcuIGAuZXh0YCBpbnN0ZWFkIG9mIGp1c3QgYGV4dGApLlxuICAgKlxuICAgKiAjIyMgRXhhbXBsZVxuICAgKlxuICAgKiBgYGB0c1xuICAgKiBhcHAudXNlKChjdHgpID0+IHtcbiAgICogICByZXR1cm4gc2VuZChjdHgsIGN0eC5yZXF1ZXN0LnVybC5wYXRobmFtZSwge1xuICAgKiAgICAgY29udGVudFR5cGVzOiB7XG4gICAqICAgICAgIFwiLmltcG9ydG1hcFwiOiBcImFwcGxpY2F0aW9uL2ltcG9ydG1hcCtqc29uXCJcbiAgICogICAgIH0sXG4gICAqICAgICByb290OiBcIi5cIixcbiAgICogICB9KVxuICAgKiB9KTtcbiAgICogYGBgXG4gICAqXG4gICAqL1xuICBjb250ZW50VHlwZXM/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xuXG4gIC8qKiBUcnkgdG8gbWF0Y2ggZXh0ZW5zaW9ucyBmcm9tIHBhc3NlZCBhcnJheSB0byBzZWFyY2ggZm9yIGZpbGUgd2hlbiBub1xuICAgKiBleHRlbnNpb24gaXMgc3VmZmljZWQgaW4gVVJMLiBGaXJzdCBmb3VuZCBpcyBzZXJ2ZWQuIChkZWZhdWx0cyB0b1xuICAgKiBgdW5kZWZpbmVkYCkgKi9cbiAgZXh0ZW5zaW9ucz86IHN0cmluZ1tdO1xuXG4gIC8qKiBJZiBgdHJ1ZWAsIGZvcm1hdCB0aGUgcGF0aCB0byBzZXJ2ZSBzdGF0aWMgZmlsZSBzZXJ2ZXJzIGFuZCBub3QgcmVxdWlyZSBhXG4gICAqIHRyYWlsaW5nIHNsYXNoIGZvciBkaXJlY3Rvcmllcywgc28gdGhhdCB5b3UgY2FuIGRvIGJvdGggYC9kaXJlY3RvcnlgIGFuZFxuICAgKiBgL2RpcmVjdG9yeS9gLiAoZGVmYXVsdHMgdG8gYHRydWVgKSAqL1xuICBmb3JtYXQ/OiBib29sZWFuO1xuXG4gIC8qKiBUcnkgdG8gc2VydmUgdGhlIGd6aXBwZWQgdmVyc2lvbiBvZiBhIGZpbGUgYXV0b21hdGljYWxseSB3aGVuIGd6aXAgaXNcbiAgICogc3VwcG9ydGVkIGJ5IGEgY2xpZW50IGFuZCBpZiB0aGUgcmVxdWVzdGVkIGZpbGUgd2l0aCBgLmd6YCBleHRlbnNpb25cbiAgICogZXhpc3RzLiAoZGVmYXVsdHMgdG8gYHRydWVgKS4gKi9cbiAgZ3ppcD86IGJvb2xlYW47XG5cbiAgLyoqIEFsbG93IHRyYW5zZmVyIG9mIGhpZGRlbiBmaWxlcy4gKGRlZmF1bHRzIHRvIGBmYWxzZWApICovXG4gIGhpZGRlbj86IGJvb2xlYW47XG5cbiAgLyoqIFRlbGwgdGhlIGJyb3dzZXIgdGhlIHJlc291cmNlIGlzIGltbXV0YWJsZSBhbmQgY2FuIGJlIGNhY2hlZFxuICAgKiBpbmRlZmluaXRlbHkuIChkZWZhdWx0cyB0byBgZmFsc2VgKSAqL1xuICBpbW11dGFibGU/OiBib29sZWFuO1xuXG4gIC8qKiBOYW1lIG9mIHRoZSBpbmRleCBmaWxlIHRvIHNlcnZlIGF1dG9tYXRpY2FsbHkgd2hlbiB2aXNpdGluZyB0aGUgcm9vdFxuICAgKiBsb2NhdGlvbi4gKGRlZmF1bHRzIHRvIG5vbmUpICovXG4gIGluZGV4Pzogc3RyaW5nO1xuXG4gIC8qKiBCcm93c2VyIGNhY2hlIG1heC1hZ2UgaW4gbWlsbGlzZWNvbmRzLiAoZGVmYXVsdHMgdG8gYDBgKSAqL1xuICBtYXhhZ2U/OiBudW1iZXI7XG5cbiAgLyoqIEEgc2l6ZSBpbiBieXRlcyB3aGVyZSBpZiB0aGUgZmlsZSBpcyBsZXNzIHRoYW4gdGhpcyBzaXplLCB0aGUgZmlsZSB3aWxsXG4gICAqIGJlIHJlYWQgaW50byBtZW1vcnkgYnkgc2VuZCBpbnN0ZWFkIG9mIHJldHVybmluZyBhIGZpbGUgaGFuZGxlLiAgRmlsZXMgbGVzc1xuICAgKiB0aGFuIHRoZSBieXRlIHNpemUgd2lsbCBzZW5kIGFuIFwic3Ryb25nXCIgYEVUYWdgIGhlYWRlciB3aGlsZSB0aG9zZSBsYXJnZXJcbiAgICogdGhhbiB0aGUgYnl0ZXMgc2l6ZSB3aWxsIG9ubHkgYmUgYWJsZSB0byBzZW5kIGEgXCJ3ZWFrXCIgYEVUYWdgIGhlYWRlciAoYXNcbiAgICogdGhleSBjYW5ub3QgaGFzaCB0aGUgY29udGVudHMgb2YgdGhlIGZpbGUpLiAoZGVmYXVsdHMgdG8gMU1pQilcbiAgICovXG4gIG1heGJ1ZmZlcj86IG51bWJlcjtcblxuICAvKiogUm9vdCBkaXJlY3RvcnkgdG8gcmVzdHJpY3QgZmlsZSBhY2Nlc3MuICovXG4gIHJvb3Q6IHN0cmluZztcbn1cblxuZnVuY3Rpb24gaXNIaWRkZW4ocGF0aDogc3RyaW5nKSB7XG4gIGNvbnN0IHBhdGhBcnIgPSBwYXRoLnNwbGl0KFwiL1wiKTtcbiAgZm9yIChjb25zdCBzZWdtZW50IG9mIHBhdGhBcnIpIHtcbiAgICBpZiAoc2VnbWVudFswXSA9PT0gXCIuXCIgJiYgc2VnbWVudCAhPT0gXCIuXCIgJiYgc2VnbWVudCAhPT0gXCIuLlwiKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGV4aXN0cyhwYXRoOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gKGF3YWl0IERlbm8uc3RhdChwYXRoKSkuaXNGaWxlO1xuICB9IGNhdGNoIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0RW50aXR5KFxuICBwYXRoOiBzdHJpbmcsXG4gIG10aW1lOiBudW1iZXIsXG4gIHN0YXRzOiBEZW5vLkZpbGVJbmZvLFxuICBtYXhidWZmZXI6IG51bWJlcixcbiAgcmVzcG9uc2U6IFJlc3BvbnNlLFxuKTogUHJvbWlzZTxbVWludDhBcnJheSB8IERlbm8uRmlsZSwgVWludDhBcnJheSB8IEZpbGVJbmZvXT4ge1xuICBsZXQgYm9keTogVWludDhBcnJheSB8IERlbm8uRmlsZTtcbiAgbGV0IGVudGl0eTogVWludDhBcnJheSB8IEZpbGVJbmZvO1xuICBjb25zdCBmaWxlID0gYXdhaXQgRGVuby5vcGVuKHBhdGgsIHsgcmVhZDogdHJ1ZSB9KTtcbiAgaWYgKHN0YXRzLnNpemUgPCBtYXhidWZmZXIpIHtcbiAgICBjb25zdCBidWZmZXIgPSBhd2FpdCByZWFkQWxsKGZpbGUpO1xuICAgIGZpbGUuY2xvc2UoKTtcbiAgICBib2R5ID0gZW50aXR5ID0gYnVmZmVyO1xuICB9IGVsc2Uge1xuICAgIHJlc3BvbnNlLmFkZFJlc291cmNlKGZpbGUucmlkKTtcbiAgICBib2R5ID0gZmlsZTtcbiAgICBlbnRpdHkgPSB7XG4gICAgICBtdGltZTogbmV3IERhdGUobXRpbWUhKSxcbiAgICAgIHNpemU6IHN0YXRzLnNpemUsXG4gICAgfTtcbiAgfVxuICByZXR1cm4gW2JvZHksIGVudGl0eV07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNlbmRSYW5nZShcbiAgcmVzcG9uc2U6IFJlc3BvbnNlLFxuICBib2R5OiBVaW50OEFycmF5IHwgRGVuby5GaWxlLFxuICByYW5nZTogc3RyaW5nLFxuICBzaXplOiBudW1iZXIsXG4pIHtcbiAgY29uc3QgcmFuZ2VzID0gcGFyc2VSYW5nZShyYW5nZSwgc2l6ZSk7XG4gIGlmIChyYW5nZXMubGVuZ3RoID09PSAwKSB7XG4gICAgdGhyb3cgY3JlYXRlSHR0cEVycm9yKFN0YXR1cy5SZXF1ZXN0ZWRSYW5nZU5vdFNhdGlzZmlhYmxlKTtcbiAgfVxuICByZXNwb25zZS5zdGF0dXMgPSBTdGF0dXMuUGFydGlhbENvbnRlbnQ7XG4gIGlmIChyYW5nZXMubGVuZ3RoID09PSAxKSB7XG4gICAgY29uc3QgW2J5dGVSYW5nZV0gPSByYW5nZXM7XG4gICAgcmVzcG9uc2UuaGVhZGVycy5zZXQoXG4gICAgICBcIkNvbnRlbnQtTGVuZ3RoXCIsXG4gICAgICBTdHJpbmcoYnl0ZVJhbmdlLmVuZCAtIGJ5dGVSYW5nZS5zdGFydCArIDEpLFxuICAgICk7XG4gICAgcmVzcG9uc2UuaGVhZGVycy5zZXQoXG4gICAgICBcIkNvbnRlbnQtUmFuZ2VcIixcbiAgICAgIGBieXRlcyAke2J5dGVSYW5nZS5zdGFydH0tJHtieXRlUmFuZ2UuZW5kfS8ke3NpemV9YCxcbiAgICApO1xuICAgIGlmIChib2R5IGluc3RhbmNlb2YgVWludDhBcnJheSkge1xuICAgICAgcmVzcG9uc2UuYm9keSA9IGJvZHkuc2xpY2UoYnl0ZVJhbmdlLnN0YXJ0LCBieXRlUmFuZ2UuZW5kICsgMSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IGJvZHkuc2VlayhieXRlUmFuZ2Uuc3RhcnQsIERlbm8uU2Vla01vZGUuU3RhcnQpO1xuICAgICAgcmVzcG9uc2UuYm9keSA9IG5ldyBMaW1pdGVkUmVhZGVyKGJvZHksIGJ5dGVSYW5nZS5lbmQgLSBieXRlUmFuZ2Uuc3RhcnQpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBhc3NlcnQocmVzcG9uc2UudHlwZSk7XG4gICAgcmVzcG9uc2UuaGVhZGVycy5zZXQoXG4gICAgICBcImNvbnRlbnQtdHlwZVwiLFxuICAgICAgYG11bHRpcGFydC9ieXRlcmFuZ2VzOyBib3VuZGFyeT0ke0JPVU5EQVJZfWAsXG4gICAgKTtcbiAgICBjb25zdCBtdWx0aXBhcnRCb2R5ID0gbmV3IE11bHRpUGFydFN0cmVhbShcbiAgICAgIGJvZHksXG4gICAgICByZXNwb25zZS50eXBlLFxuICAgICAgcmFuZ2VzLFxuICAgICAgc2l6ZSxcbiAgICAgIEJPVU5EQVJZLFxuICAgICk7XG4gICAgcmVzcG9uc2UuaGVhZGVycy5zZXQoXG4gICAgICBcImNvbnRlbnQtbGVuZ3RoXCIsXG4gICAgICBTdHJpbmcobXVsdGlwYXJ0Qm9keS5jb250ZW50TGVuZ3RoKCkpLFxuICAgICk7XG4gICAgcmVzcG9uc2UuYm9keSA9IG11bHRpcGFydEJvZHk7XG4gIH1cbn1cblxuLyoqIEFzeW5jaHJvbm91c2x5IGZ1bGZpbGwgYSByZXNwb25zZSB3aXRoIGEgZmlsZSBmcm9tIHRoZSBsb2NhbCBmaWxlXG4gKiBzeXN0ZW0uXG4gKlxuICogUmVxdWlyZXMgRGVubyByZWFkIHBlcm1pc3Npb24gZm9yIHRoZSBgcm9vdGAgZGlyZWN0b3J5LiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNlbmQoXG4gIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gIHsgcmVxdWVzdCwgcmVzcG9uc2UgfTogQ29udGV4dDxhbnk+LFxuICBwYXRoOiBzdHJpbmcsXG4gIG9wdGlvbnM6IFNlbmRPcHRpb25zID0geyByb290OiBcIlwiIH0sXG4pOiBQcm9taXNlPHN0cmluZyB8IHVuZGVmaW5lZD4ge1xuICBjb25zdCB7XG4gICAgYnJvdGxpID0gdHJ1ZSxcbiAgICBjb250ZW50VHlwZXMgPSB7fSxcbiAgICBleHRlbnNpb25zLFxuICAgIGZvcm1hdCA9IHRydWUsXG4gICAgZ3ppcCA9IHRydWUsXG4gICAgaGlkZGVuID0gZmFsc2UsXG4gICAgaW1tdXRhYmxlID0gZmFsc2UsXG4gICAgaW5kZXgsXG4gICAgbWF4YnVmZmVyID0gTUFYQlVGRkVSX0RFRkFVTFQsXG4gICAgbWF4YWdlID0gMCxcbiAgICByb290LFxuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgdHJhaWxpbmdTbGFzaCA9IHBhdGhbcGF0aC5sZW5ndGggLSAxXSA9PT0gXCIvXCI7XG4gIHBhdGggPSBkZWNvZGVDb21wb25lbnQocGF0aC5zdWJzdHIocGFyc2UocGF0aCkucm9vdC5sZW5ndGgpKTtcbiAgaWYgKGluZGV4ICYmIHRyYWlsaW5nU2xhc2gpIHtcbiAgICBwYXRoICs9IGluZGV4O1xuICB9XG5cbiAgaWYgKCFoaWRkZW4gJiYgaXNIaWRkZW4ocGF0aCkpIHtcbiAgICB0aHJvdyBjcmVhdGVIdHRwRXJyb3IoNDAzKTtcbiAgfVxuXG4gIHBhdGggPSByZXNvbHZlUGF0aChyb290LCBwYXRoKTtcblxuICBsZXQgZW5jb2RpbmdFeHQgPSBcIlwiO1xuICBpZiAoXG4gICAgYnJvdGxpICYmXG4gICAgcmVxdWVzdC5hY2NlcHRzRW5jb2RpbmdzKFwiYnJcIiwgXCJpZGVudGl0eVwiKSA9PT0gXCJiclwiICYmXG4gICAgKGF3YWl0IGV4aXN0cyhgJHtwYXRofS5icmApKVxuICApIHtcbiAgICBwYXRoID0gYCR7cGF0aH0uYnJgO1xuICAgIHJlc3BvbnNlLmhlYWRlcnMuc2V0KFwiQ29udGVudC1FbmNvZGluZ1wiLCBcImJyXCIpO1xuICAgIHJlc3BvbnNlLmhlYWRlcnMuZGVsZXRlKFwiQ29udGVudC1MZW5ndGhcIik7XG4gICAgZW5jb2RpbmdFeHQgPSBcIi5iclwiO1xuICB9IGVsc2UgaWYgKFxuICAgIGd6aXAgJiZcbiAgICByZXF1ZXN0LmFjY2VwdHNFbmNvZGluZ3MoXCJnemlwXCIsIFwiaWRlbnRpdHlcIikgPT09IFwiZ3ppcFwiICYmXG4gICAgKGF3YWl0IGV4aXN0cyhgJHtwYXRofS5nemApKVxuICApIHtcbiAgICBwYXRoID0gYCR7cGF0aH0uZ3pgO1xuICAgIHJlc3BvbnNlLmhlYWRlcnMuc2V0KFwiQ29udGVudC1FbmNvZGluZ1wiLCBcImd6aXBcIik7XG4gICAgcmVzcG9uc2UuaGVhZGVycy5kZWxldGUoXCJDb250ZW50LUxlbmd0aFwiKTtcbiAgICBlbmNvZGluZ0V4dCA9IFwiLmd6XCI7XG4gIH1cblxuICBpZiAoZXh0ZW5zaW9ucyAmJiAhL1xcLlteL10qJC8uZXhlYyhwYXRoKSkge1xuICAgIGZvciAobGV0IGV4dCBvZiBleHRlbnNpb25zKSB7XG4gICAgICBpZiAoIS9eXFwuLy5leGVjKGV4dCkpIHtcbiAgICAgICAgZXh0ID0gYC4ke2V4dH1gO1xuICAgICAgfVxuICAgICAgaWYgKGF3YWl0IGV4aXN0cyhgJHtwYXRofSR7ZXh0fWApKSB7XG4gICAgICAgIHBhdGggKz0gZXh0O1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBsZXQgc3RhdHM6IERlbm8uRmlsZUluZm87XG4gIHRyeSB7XG4gICAgc3RhdHMgPSBhd2FpdCBEZW5vLnN0YXQocGF0aCk7XG5cbiAgICBpZiAoc3RhdHMuaXNEaXJlY3RvcnkpIHtcbiAgICAgIGlmIChmb3JtYXQgJiYgaW5kZXgpIHtcbiAgICAgICAgcGF0aCArPSBgLyR7aW5kZXh9YDtcbiAgICAgICAgc3RhdHMgPSBhd2FpdCBEZW5vLnN0YXQocGF0aCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoZXJyIGluc3RhbmNlb2YgRGVuby5lcnJvcnMuTm90Rm91bmQpIHtcbiAgICAgIHRocm93IGNyZWF0ZUh0dHBFcnJvcig0MDQsIGVyci5tZXNzYWdlKTtcbiAgICB9XG4gICAgdGhyb3cgY3JlYXRlSHR0cEVycm9yKDUwMCwgZXJyLm1lc3NhZ2UpO1xuICB9XG5cbiAgbGV0IG10aW1lOiBudW1iZXIgfCBudWxsID0gbnVsbDtcbiAgaWYgKHJlc3BvbnNlLmhlYWRlcnMuaGFzKFwiTGFzdC1Nb2RpZmllZFwiKSkge1xuICAgIG10aW1lID0gbmV3IERhdGUocmVzcG9uc2UuaGVhZGVycy5nZXQoXCJMYXN0LU1vZGlmaWVkXCIpISkuZ2V0VGltZSgpO1xuICB9IGVsc2UgaWYgKHN0YXRzLm10aW1lKSB7XG4gICAgLy8gUm91bmQgZG93biB0byBzZWNvbmQgYmVjYXVzZSBpdCdzIHRoZSBwcmVjaXNpb24gb2YgdGhlIFVUQyBzdHJpbmcuXG4gICAgbXRpbWUgPSBzdGF0cy5tdGltZS5nZXRUaW1lKCk7XG4gICAgbXRpbWUgLT0gbXRpbWUgJSAxMDAwO1xuICAgIHJlc3BvbnNlLmhlYWRlcnMuc2V0KFwiTGFzdC1Nb2RpZmllZFwiLCBuZXcgRGF0ZShtdGltZSkudG9VVENTdHJpbmcoKSk7XG4gIH1cblxuICBpZiAoIXJlc3BvbnNlLmhlYWRlcnMuaGFzKFwiQ2FjaGUtQ29udHJvbFwiKSkge1xuICAgIGNvbnN0IGRpcmVjdGl2ZXMgPSBbYG1heC1hZ2U9JHsobWF4YWdlIC8gMTAwMCkgfCAwfWBdO1xuICAgIGlmIChpbW11dGFibGUpIHtcbiAgICAgIGRpcmVjdGl2ZXMucHVzaChcImltbXV0YWJsZVwiKTtcbiAgICB9XG4gICAgcmVzcG9uc2UuaGVhZGVycy5zZXQoXCJDYWNoZS1Db250cm9sXCIsIGRpcmVjdGl2ZXMuam9pbihcIixcIikpO1xuICB9XG4gIGlmICghcmVzcG9uc2UudHlwZSkge1xuICAgIHJlc3BvbnNlLnR5cGUgPSBlbmNvZGluZ0V4dCAhPT0gXCJcIlxuICAgICAgPyBleHRuYW1lKGJhc2VuYW1lKHBhdGgsIGVuY29kaW5nRXh0KSlcbiAgICAgIDogY29udGVudFR5cGVzW2V4dG5hbWUocGF0aCldID8/IGV4dG5hbWUocGF0aCk7XG4gIH1cblxuICBsZXQgZW50aXR5OiBVaW50OEFycmF5IHwgRmlsZUluZm8gfCBudWxsID0gbnVsbDtcbiAgbGV0IGJvZHk6IFVpbnQ4QXJyYXkgfCBEZW5vLkZpbGUgfCBudWxsID0gbnVsbDtcblxuICBpZiAocmVxdWVzdC5oZWFkZXJzLmhhcyhcIklmLU5vbmUtTWF0Y2hcIikgJiYgbXRpbWUpIHtcbiAgICBbYm9keSwgZW50aXR5XSA9IGF3YWl0IGdldEVudGl0eShwYXRoLCBtdGltZSwgc3RhdHMsIG1heGJ1ZmZlciwgcmVzcG9uc2UpO1xuICAgIGlmICghaWZOb25lTWF0Y2gocmVxdWVzdC5oZWFkZXJzLmdldChcIklmLU5vbmUtTWF0Y2hcIikhLCBlbnRpdHkpKSB7XG4gICAgICByZXNwb25zZS5oZWFkZXJzLnNldChcIkVUYWdcIiwgY2FsY3VsYXRlKGVudGl0eSkpO1xuICAgICAgcmVzcG9uc2Uuc3RhdHVzID0gMzA0O1xuICAgICAgcmV0dXJuIHBhdGg7XG4gICAgfVxuICB9XG5cbiAgaWYgKHJlcXVlc3QuaGVhZGVycy5oYXMoXCJJZi1Nb2RpZmllZC1TaW5jZVwiKSAmJiBtdGltZSkge1xuICAgIGNvbnN0IGlmTW9kaWZpZWRTaW5jZSA9IG5ldyBEYXRlKHJlcXVlc3QuaGVhZGVycy5nZXQoXCJJZi1Nb2RpZmllZC1TaW5jZVwiKSEpO1xuICAgIGlmIChpZk1vZGlmaWVkU2luY2UuZ2V0VGltZSgpID49IG10aW1lKSB7XG4gICAgICByZXNwb25zZS5zdGF0dXMgPSAzMDQ7XG4gICAgICByZXR1cm4gcGF0aDtcbiAgICB9XG4gIH1cblxuICBpZiAoIWJvZHkgfHwgIWVudGl0eSkge1xuICAgIFtib2R5LCBlbnRpdHldID0gYXdhaXQgZ2V0RW50aXR5KFxuICAgICAgcGF0aCxcbiAgICAgIG10aW1lID8/IDAsXG4gICAgICBzdGF0cyxcbiAgICAgIG1heGJ1ZmZlcixcbiAgICAgIHJlc3BvbnNlLFxuICAgICk7XG4gIH1cblxuICBpZiAoXG4gICAgcmVxdWVzdC5oZWFkZXJzLmhhcyhcIklmLVJhbmdlXCIpICYmIG10aW1lICYmXG4gICAgaWZSYW5nZShyZXF1ZXN0LmhlYWRlcnMuZ2V0KFwiSWYtUmFuZ2VcIikhLCBtdGltZSwgZW50aXR5KSAmJlxuICAgIHJlcXVlc3QuaGVhZGVycy5oYXMoXCJSYW5nZVwiKVxuICApIHtcbiAgICBhd2FpdCBzZW5kUmFuZ2UocmVzcG9uc2UsIGJvZHksIHJlcXVlc3QuaGVhZGVycy5nZXQoXCJSYW5nZVwiKSEsIHN0YXRzLnNpemUpO1xuICAgIHJldHVybiBwYXRoO1xuICB9XG5cbiAgaWYgKHJlcXVlc3QuaGVhZGVycy5oYXMoXCJSYW5nZVwiKSkge1xuICAgIGF3YWl0IHNlbmRSYW5nZShyZXNwb25zZSwgYm9keSwgcmVxdWVzdC5oZWFkZXJzLmdldChcIlJhbmdlXCIpISwgc3RhdHMuc2l6ZSk7XG4gICAgcmV0dXJuIHBhdGg7XG4gIH1cblxuICByZXNwb25zZS5oZWFkZXJzLnNldChcIkNvbnRlbnQtTGVuZ3RoXCIsIFN0cmluZyhzdGF0cy5zaXplKSk7XG4gIHJlc3BvbnNlLmJvZHkgPSBib2R5O1xuXG4gIGlmICghcmVzcG9uc2UuaGVhZGVycy5oYXMoXCJFVGFnXCIpKSB7XG4gICAgcmVzcG9uc2UuaGVhZGVycy5zZXQoXCJFVGFnXCIsIGNhbGN1bGF0ZShlbnRpdHkpKTtcbiAgfVxuXG4gIGlmICghcmVzcG9uc2UuaGVhZGVycy5oYXMoXCJBY2NlcHQtUmFuZ2VzXCIpKSB7XG4gICAgcmVzcG9uc2UuaGVhZGVycy5zZXQoXCJBY2NlcHQtUmFuZ2VzXCIsIFwiYnl0ZXNcIik7XG4gIH1cblxuICByZXR1cm4gcGF0aDtcbn1cbiJdfQ==