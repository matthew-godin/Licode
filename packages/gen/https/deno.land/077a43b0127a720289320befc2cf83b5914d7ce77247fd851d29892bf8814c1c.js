import { encodeArgument } from "./encode.ts";
import { decode } from "./decode.ts";
const commandTagRegexp = /^([A-Za-z]+)(?: (\d+))?(?: (\d+))?/;
export var ResultType;
(function (ResultType) {
    ResultType[ResultType["ARRAY"] = 0] = "ARRAY";
    ResultType[ResultType["OBJECT"] = 1] = "OBJECT";
})(ResultType || (ResultType = {}));
export class RowDescription {
    columnCount;
    columns;
    constructor(columnCount, columns) {
        this.columnCount = columnCount;
        this.columns = columns;
    }
}
export function templateStringToQuery(template, args, result_type) {
    const text = template.reduce((curr, next, index) => {
        return `${curr}$${index}${next}`;
    });
    return new Query(text, result_type, args);
}
function objectQueryToQueryArgs(query, args) {
    args = normalizeObjectQueryArgs(args);
    let counter = 0;
    const clean_args = [];
    const clean_query = query.replaceAll(/(?<=\$)\w+/g, (match) => {
        match = match.toLowerCase();
        if (match in args) {
            clean_args.push(args[match]);
        }
        else {
            throw new Error(`No value was provided for the query argument "${match}"`);
        }
        return String(++counter);
    });
    return [clean_query, clean_args];
}
function normalizeObjectQueryArgs(args) {
    const normalized_args = Object.fromEntries(Object.entries(args).map(([key, value]) => [key.toLowerCase(), value]));
    if (Object.keys(normalized_args).length !== Object.keys(args).length) {
        throw new Error("The arguments provided for the query must be unique (insensitive)");
    }
    return normalized_args;
}
export class QueryResult {
    query;
    command;
    rowCount;
    #row_description;
    warnings = [];
    get rowDescription() {
        return this.#row_description;
    }
    set rowDescription(row_description) {
        if (row_description && !this.#row_description) {
            this.#row_description = row_description;
        }
    }
    constructor(query) {
        this.query = query;
    }
    loadColumnDescriptions(description) {
        this.rowDescription = description;
    }
    handleCommandComplete(commandTag) {
        const match = commandTagRegexp.exec(commandTag);
        if (match) {
            this.command = match[1];
            if (match[3]) {
                this.rowCount = parseInt(match[3], 10);
            }
            else {
                this.rowCount = parseInt(match[2], 10);
            }
        }
    }
    insertRow(_row) {
        throw new Error("No implementation for insertRow is defined");
    }
}
export class QueryArrayResult extends QueryResult {
    rows = [];
    insertRow(row_data) {
        if (!this.rowDescription) {
            throw new Error("The row descriptions required to parse the result data weren't initialized");
        }
        const row = row_data.map((raw_value, index) => {
            const column = this.rowDescription.columns[index];
            if (raw_value === null) {
                return null;
            }
            return decode(raw_value, column);
        });
        this.rows.push(row);
    }
}
function findDuplicatesInArray(array) {
    return array.reduce((duplicates, item, index) => {
        const is_duplicate = array.indexOf(item) !== index;
        if (is_duplicate && !duplicates.includes(item)) {
            duplicates.push(item);
        }
        return duplicates;
    }, []);
}
function snakecaseToCamelcase(input) {
    return input
        .split("_")
        .reduce((res, word, i) => {
        if (i !== 0) {
            word = word[0].toUpperCase() + word.slice(1);
        }
        res += word;
        return res;
    }, "");
}
export class QueryObjectResult extends QueryResult {
    columns;
    rows = [];
    insertRow(row_data) {
        if (!this.rowDescription) {
            throw new Error("The row description required to parse the result data wasn't initialized");
        }
        if (!this.columns) {
            if (this.query.fields) {
                if (this.rowDescription.columns.length !== this.query.fields.length) {
                    throw new RangeError("The fields provided for the query don't match the ones returned as a result " +
                        `(${this.rowDescription.columns.length} expected, ${this.query.fields.length} received)`);
                }
                this.columns = this.query.fields;
            }
            else {
                let column_names;
                if (this.query.camelcase) {
                    column_names = this.rowDescription.columns.map((column) => snakecaseToCamelcase(column.name));
                }
                else {
                    column_names = this.rowDescription.columns.map((column) => column.name);
                }
                const duplicates = findDuplicatesInArray(column_names);
                if (duplicates.length) {
                    throw new Error(`Field names ${duplicates.map((str) => `"${str}"`).join(", ")} are duplicated in the result of the query`);
                }
                this.columns = column_names;
            }
        }
        const columns = this.columns;
        if (columns.length !== row_data.length) {
            throw new RangeError("The result fields returned by the database don't match the defined structure of the result");
        }
        const row = row_data.reduce((row, raw_value, index) => {
            const current_column = this.rowDescription.columns[index];
            if (raw_value === null) {
                row[columns[index]] = null;
            }
            else {
                row[columns[index]] = decode(raw_value, current_column);
            }
            return row;
        }, {});
        this.rows.push(row);
    }
}
export class Query {
    args;
    camelcase;
    fields;
    result_type;
    text;
    constructor(config_or_text, result_type, args = []) {
        this.result_type = result_type;
        if (typeof config_or_text === "string") {
            if (!Array.isArray(args)) {
                [config_or_text, args] = objectQueryToQueryArgs(config_or_text, args);
            }
            this.text = config_or_text;
            this.args = args.map(encodeArgument);
        }
        else {
            let { args = [], camelcase, encoder = encodeArgument, fields, name, text, } = config_or_text;
            if (fields) {
                const fields_are_clean = fields.every((field) => /^[a-zA-Z_][a-zA-Z0-9_]*$/.test(field));
                if (!fields_are_clean) {
                    throw new TypeError("The fields provided for the query must contain only letters and underscores");
                }
                if (new Set(fields).size !== fields.length) {
                    throw new TypeError("The fields provided for the query must be unique");
                }
                this.fields = fields;
            }
            this.camelcase = camelcase;
            if (!Array.isArray(args)) {
                [text, args] = objectQueryToQueryArgs(text, args);
            }
            this.args = args.map(encoder);
            this.text = text;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJxdWVyeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsY0FBYyxFQUFjLE1BQU0sYUFBYSxDQUFDO0FBQ3pELE9BQU8sRUFBVSxNQUFNLEVBQUUsTUFBTSxhQUFhLENBQUM7QUEyQjdDLE1BQU0sZ0JBQWdCLEdBQUcsb0NBQW9DLENBQUM7QUFZOUQsTUFBTSxDQUFOLElBQVksVUFHWDtBQUhELFdBQVksVUFBVTtJQUNwQiw2Q0FBSyxDQUFBO0lBQ0wsK0NBQU0sQ0FBQTtBQUNSLENBQUMsRUFIVyxVQUFVLEtBQVYsVUFBVSxRQUdyQjtBQUVELE1BQU0sT0FBTyxjQUFjO0lBQ047SUFBNEI7SUFBL0MsWUFBbUIsV0FBbUIsRUFBUyxPQUFpQjtRQUE3QyxnQkFBVyxHQUFYLFdBQVcsQ0FBUTtRQUFTLFlBQU8sR0FBUCxPQUFPLENBQVU7SUFBRyxDQUFDO0NBQ3JFO0FBVUQsTUFBTSxVQUFVLHFCQUFxQixDQUNuQyxRQUE4QixFQUM5QixJQUFlLEVBQ2YsV0FBYztJQUVkLE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFO1FBQ2pELE9BQU8sR0FBRyxJQUFJLElBQUksS0FBSyxHQUFHLElBQUksRUFBRSxDQUFDO0lBQ25DLENBQUMsQ0FBQyxDQUFDO0lBRUgsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLEVBQUUsV0FBVyxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQzVDLENBQUM7QUFFRCxTQUFTLHNCQUFzQixDQUM3QixLQUFhLEVBQ2IsSUFBNkI7SUFFN0IsSUFBSSxHQUFHLHdCQUF3QixDQUFDLElBQUksQ0FBQyxDQUFDO0lBRXRDLElBQUksT0FBTyxHQUFHLENBQUMsQ0FBQztJQUNoQixNQUFNLFVBQVUsR0FBYyxFQUFFLENBQUM7SUFDakMsTUFBTSxXQUFXLEdBQUcsS0FBSyxDQUFD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Q0FDbkQsQ0FBQztpQkFDSDtnQkFFRCxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQzthQUN0QjtZQUVELElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1lBRTNCLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUN4QixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxzQkFBc0IsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7YUFDbkQ7WUFFRCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDOUIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7U0FDbEI7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlbmNvZGVBcmd1bWVudCwgRW5jb2RlZEFyZyB9IGZyb20gXCIuL2VuY29kZS50c1wiO1xuaW1wb3J0IHsgQ29sdW1uLCBkZWNvZGUgfSBmcm9tIFwiLi9kZWNvZGUudHNcIjtcbmltcG9ydCB7IE5vdGljZSB9IGZyb20gXCIuLi9jb25uZWN0aW9uL21lc3NhZ2UudHNcIjtcblxuLy8gVE9ET1xuLy8gTGltaXQgdGhlIHR5cGUgb2YgcGFyYW1ldGVycyB0aGF0IGNhbiBiZSBwYXNzZWRcbi8vIHRvIGEgcXVlcnlcbi8qKlxuICogaHR0cHM6Ly93d3cucG9zdGdyZXNxbC5vcmcvZG9jcy8xNC9zcWwtcHJlcGFyZS5odG1sXG4gKlxuICogVGhpcyBhcmd1bWVudHMgd2lsbCBiZSBhcHBlbmRlZCB0byB0aGUgcHJlcGFyZWQgc3RhdGVtZW50IHBhc3NlZFxuICogYXMgcXVlcnlcbiAqXG4gKiBUaGV5IHdpbGwgdGFrZSB0aGUgcG9zaXRpb24gYWNjb3JkaW5nIHRvIHRoZSBvcmRlciBpbiB3aGljaCB0aGV5IHdlcmUgcHJvdmlkZWRcbiAqXG4gKiBgYGB0c1xuICogaW1wb3J0IHsgQ2xpZW50IH0gZnJvbSBcIi4uL2NsaWVudC50c1wiO1xuICpcbiAqIGNvbnN0IG15X2NsaWVudCA9IG5ldyBDbGllbnQoKTtcbiAqXG4gKiBhd2FpdCBteV9jbGllbnQucXVlcnlBcnJheShcIlNFTEVDVCBJRCwgTkFNRSBGUk9NIFBFT1BMRSBXSEVSRSBBR0UgPiAkMSBBTkQgQUdFIDwgJDJcIiwgW1xuICogICAxMCwgLy8gJDFcbiAqICAgMjAsIC8vICQyXG4gKiBdKTtcbiAqIGBgYFxuICovXG5leHBvcnQgdHlwZSBRdWVyeUFyZ3VtZW50cyA9IHVua25vd25bXSB8IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuXG5jb25zdCBjb21tYW5kVGFnUmVnZXhwID0gL14oW0EtWmEtel0rKSg/OiAoXFxkKykpPyg/OiAoXFxkKykpPy87XG5cbnR5cGUgQ29tbWFuZFR5cGUgPSAoXG4gIHwgXCJJTlNFUlRcIlxuICB8IFwiREVMRVRFXCJcbiAgfCBcIlVQREFURVwiXG4gIHwgXCJTRUxFQ1RcIlxuICB8IFwiTU9WRVwiXG4gIHwgXCJGRVRDSFwiXG4gIHwgXCJDT1BZXCJcbik7XG5cbmV4cG9ydCBlbnVtIFJlc3VsdFR5cGUge1xuICBBUlJBWSxcbiAgT0JKRUNULFxufVxuXG5leHBvcnQgY2xhc3MgUm93RGVzY3JpcHRpb24ge1xuICBjb25zdHJ1Y3RvcihwdWJsaWMgY29sdW1uQ291bnQ6IG51bWJlciwgcHVibGljIGNvbHVtbnM6IENvbHVtbltdKSB7fVxufVxuXG4vKipcbiAqIFRoaXMgZnVuY3Rpb24gdHJhbnNmb3JtcyB0ZW1wbGF0ZSBzdHJpbmcgYXJndW1lbnRzIGludG8gYSBxdWVyeVxuICpcbiAqIGBgYHRzXG4gKiBbXCJTRUxFQ1QgTkFNRSBGUk9NIFRBQkxFIFdIRVJFIElEID0gXCIsIFwiIEFORCBEQVRFIDwgXCJdXG4gKiAvLyBcIlNFTEVDVCBOQU1FIEZST00gVEFCTEUgV0hFUkUgSUQgPSAkMSBBTkQgREFURSA8ICQyXCJcbiAqIGBgYFxuICovXG5leHBvcnQgZnVuY3Rpb24gdGVtcGxhdGVTdHJpbmdUb1F1ZXJ5PFQgZXh0ZW5kcyBSZXN1bHRUeXBlPihcbiAgdGVtcGxhdGU6IFRlbXBsYXRlU3RyaW5nc0FycmF5LFxuICBhcmdzOiB1bmtub3duW10sXG4gIHJlc3VsdF90eXBlOiBULFxuKTogUXVlcnk8VD4ge1xuICBjb25zdCB0ZXh0ID0gdGVtcGxhdGUucmVkdWNlKChjdXJyLCBuZXh0LCBpbmRleCkgPT4ge1xuICAgIHJldHVybiBgJHtjdXJyfSQke2luZGV4fSR7bmV4dH1gO1xuICB9KTtcblxuICByZXR1cm4gbmV3IFF1ZXJ5KHRleHQsIHJlc3VsdF90eXBlLCBhcmdzKTtcbn1cblxuZnVuY3Rpb24gb2JqZWN0UXVlcnlUb1F1ZXJ5QXJncyhcbiAgcXVlcnk6IHN0cmluZyxcbiAgYXJnczogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4pOiBbc3RyaW5nLCB1bmtub3duW11dIHtcbiAgYXJncyA9IG5vcm1hbGl6ZU9iamVjdFF1ZXJ5QXJncyhhcmdzKTtcblxuICBsZXQgY291bnRlciA9IDA7XG4gIGNvbnN0IGNsZWFuX2FyZ3M6IHVua25vd25bXSA9IFtdO1xuICBjb25zdCBjbGVhbl9xdWVyeSA9IHF1ZXJ5LnJlcGxhY2VBbGwoLyg/PD1cXCQpXFx3Ky9nLCAobWF0Y2gpID0+IHtcbiAgICBtYXRjaCA9IG1hdGNoLnRvTG93ZXJDYXNlKCk7XG4gICAgaWYgKG1hdGNoIGluIGFyZ3MpIHtcbiAgICAgIGNsZWFuX2FyZ3MucHVzaChhcmdzW21hdGNoXSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYE5vIHZhbHVlIHdhcyBwcm92aWRlZCBmb3IgdGhlIHF1ZXJ5IGFyZ3VtZW50IFwiJHttYXRjaH1cImAsXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBTdHJpbmcoKytjb3VudGVyKTtcbiAgfSk7XG5cbiAgcmV0dXJuIFtjbGVhbl9xdWVyeSwgY2xlYW5fYXJnc107XG59XG5cbi8qKiBUaGlzIGZ1bmN0aW9uIGxvd2VyY2FzZXMgYWxsIHRoZSBrZXlzIG9mIHRoZSBvYmplY3QgcGFzc2VkIHRvIGl0IGFuZCBjaGVja3MgZm9yIGNvbGxpc3Npb24gbmFtZXMgKi9cbmZ1bmN0aW9uIG5vcm1hbGl6ZU9iamVjdFF1ZXJ5QXJncyhcbiAgYXJnczogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4pOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiB7XG4gIGNvbnN0IG5vcm1hbGl6ZWRfYXJncyA9IE9iamVjdC5mcm9tRW50cmllcyhcbiAgICBPYmplY3QuZW50cmllcyhhcmdzKS5tYXAoKFxuICAgICAgW2tleSwgdmFsdWVdLFxuICAgICkgPT4gW2tleS50b0xvd2VyQ2FzZSgpLCB2YWx1ZV0pLFxuICApO1xuXG4gIGlmIChPYmplY3Qua2V5cyhub3JtYWxpemVkX2FyZ3MpLmxlbmd0aCAhPT0gT2JqZWN0LmtleXMoYXJncykubGVuZ3RoKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgXCJUaGUgYXJndW1lbnRzIHByb3ZpZGVkIGZvciB0aGUgcXVlcnkgbXVzdCBiZSB1bmlxdWUgKGluc2Vuc2l0aXZlKVwiLFxuICAgICk7XG4gIH1cblxuICByZXR1cm4gbm9ybWFsaXplZF9hcmdzO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFF1ZXJ5T3B0aW9ucyB7XG4gIGFyZ3M/OiBRdWVyeUFyZ3VtZW50cztcbiAgZW5jb2Rlcj86IChhcmc6IHVua25vd24pID0+IEVuY29kZWRBcmc7XG4gIG5hbWU/OiBzdHJpbmc7XG4gIC8vIFRPRE9cbiAgLy8gUmVuYW1lIHRvIHF1ZXJ5XG4gIHRleHQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBRdWVyeU9iamVjdE9wdGlvbnMgZXh0ZW5kcyBRdWVyeU9wdGlvbnMge1xuICAvLyBUT0RPXG4gIC8vIFN1cHBvcnQgbXVsdGlwbGUgY2FzZSBvcHRpb25zXG4gIC8qKlxuICAgKiBFbmFibGluZyBjYW1lbGNhc2Ugd2lsbCB0cmFuc2Zvcm0gYW55IHNuYWtlIGNhc2UgZmllbGQgbmFtZXMgY29taW5nIGZyb20gdGhlIGRhdGFiYXNlIGludG8gY2FtZWwgY2FzZSBvbmVzXG4gICAqXG4gICAqIEV4OiBgU0VMRUNUIDEgQVMgbXlfZmllbGRgIHdpbGwgcmV0dXJuIGB7IG15RmllbGQ6IDEgfWBcbiAgICpcbiAgICogVGhpcyB3b24ndCBoYXZlIGFueSBlZmZlY3QgaWYgeW91IGV4cGxpY2l0bHkgc2V0IHRoZSBmaWVsZCBuYW1lcyB3aXRoIHRoZSBgZmllbGRzYCBwYXJhbWV0ZXJcbiAgICovXG4gIGNhbWVsY2FzZT86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBUaGlzIHBhcmFtZXRlciBzdXBlcnNlZGVzIHF1ZXJ5IGNvbHVtbiBuYW1lcyBjb21pbmcgZnJvbSB0aGUgZGF0YWJhc2VzIGluIHRoZSBvcmRlciB0aGV5IHdlcmUgcHJvdmlkZWQuXG4gICAqIEZpZWxkcyBtdXN0IGJlIHVuaXF1ZSBhbmQgYmUgaW4gdGhlIHJhbmdlIG9mIChhLXpBLVowLTlfKSwgb3RoZXJ3aXNlIHRoZSBxdWVyeSB3aWxsIHRocm93IGJlZm9yZSBleGVjdXRpb24uXG4gICAqIEEgZmllbGQgY2FuIG5vdCBzdGFydCB3aXRoIGEgbnVtYmVyLCBqdXN0IGxpa2UgSmF2YVNjcmlwdCB2YXJpYWJsZXNcbiAgICpcbiAgICogVGhpcyBzZXR0aW5nIG92ZXJyaWRlcyB0aGUgY2FtZWxjYXNlIG9wdGlvblxuICAgKlxuICAgKiBFeDogYFNFTEVDVCAnQScsICdCJyBBUyBteV9maWVsZGAgd2l0aCBmaWVsZHMgYFtcImZpZWxkXzFcIiwgXCJmaWVsZF8yXCJdYCB3aWxsIHJldHVybiBgeyBmaWVsZF8xOiBcIkFcIiwgZmllbGRfMjogXCJCXCIgfWBcbiAgICovXG4gIGZpZWxkcz86IHN0cmluZ1tdO1xufVxuXG5leHBvcnQgY2xhc3MgUXVlcnlSZXN1bHQge1xuICBwdWJsaWMgY29tbWFuZCE6IENvbW1hbmRUeXBlO1xuICBwdWJsaWMgcm93Q291bnQ/OiBudW1iZXI7XG4gIC8qKlxuICAgKiBUaGlzIHZhcmlhYmxlIHdpbGwgYmUgc2V0IGFmdGVyIHRoZSBjbGFzcyBpbml0aWFsaXphdGlvbiwgaG93ZXZlciBpdCdzIHJlcXVpcmVkIHRvIGJlIHNldFxuICAgKiBpbiBvcmRlciB0byBoYW5kbGUgcmVzdWx0IHJvd3MgY29taW5nIGluXG4gICAqL1xuICAjcm93X2Rlc2NyaXB0aW9uPzogUm93RGVzY3JpcHRpb247XG4gIHB1YmxpYyB3YXJuaW5nczogTm90aWNlW10gPSBbXTtcblxuICBnZXQgcm93RGVzY3JpcHRpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuI3Jvd19kZXNjcmlwdGlvbjtcbiAgfVxuXG4gIHNldCByb3dEZXNjcmlwdGlvbihyb3dfZGVzY3JpcHRpb246IFJvd0Rlc2NyaXB0aW9uIHwgdW5kZWZpbmVkKSB7XG4gICAgLy8gUHJldmVudCAjcm93X2Rlc2NyaXB0aW9uIGZyb20gYmVpbmcgY2hhbmdlZCBvbmNlIHNldFxuICAgIGlmIChyb3dfZGVzY3JpcHRpb24gJiYgIXRoaXMuI3Jvd19kZXNjcmlwdGlvbikge1xuICAgICAgdGhpcy4jcm93X2Rlc2NyaXB0aW9uID0gcm93X2Rlc2NyaXB0aW9uO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBxdWVyeTogUXVlcnk8UmVzdWx0VHlwZT4pIHt9XG5cbiAgLyoqXG4gICAqIFRoaXMgZnVuY3Rpb24gaXMgcmVxdWlyZWQgdG8gcGFyc2UgZWFjaCBjb2x1bW5cbiAgICogb2YgdGhlIHJlc3VsdHNcbiAgICovXG4gIGxvYWRDb2x1bW5EZXNjcmlwdGlvbnMoZGVzY3JpcHRpb246IFJvd0Rlc2NyaXB0aW9uKSB7XG4gICAgdGhpcy5yb3dEZXNjcmlwdGlvbiA9IGRlc2NyaXB0aW9uO1xuICB9XG5cbiAgaGFuZGxlQ29tbWFuZENvbXBsZXRlKGNvbW1hbmRUYWc6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IG1hdGNoID0gY29tbWFuZFRhZ1JlZ2V4cC5leGVjKGNvbW1hbmRUYWcpO1xuICAgIGlmIChtYXRjaCkge1xuICAgICAgdGhpcy5jb21tYW5kID0gbWF0Y2hbMV0gYXMgQ29tbWFuZFR5cGU7XG4gICAgICBpZiAobWF0Y2hbM10pIHtcbiAgICAgICAgLy8gQ09NTUFORCBPSUQgUk9XU1xuICAgICAgICB0aGlzLnJvd0NvdW50ID0gcGFyc2VJbnQobWF0Y2hbM10sIDEwKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIENPTU1BTkQgUk9XU1xuICAgICAgICB0aGlzLnJvd0NvdW50ID0gcGFyc2VJbnQobWF0Y2hbMl0sIDEwKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQWRkIGEgcm93IHRvIHRoZSByZXN1bHQgYmFzZWQgb24gbWV0YWRhdGEgcHJvdmlkZWQgYnkgYHJvd0Rlc2NyaXB0aW9uYFxuICAgKiBUaGlzIGltcGxlbWVudGF0aW9uIGRlcGVuZHMgb24gcm93IGRlc2NyaXB0aW9uIG5vdCBiZWluZyBtb2RpZmllZCBhZnRlciBpbml0aWFsaXphdGlvblxuICAgKlxuICAgKiBUaGlzIGZ1bmN0aW9uIGNhbiB0aHJvdyBvbiB2YWxpZGF0aW9uLCBzbyBhbnkgZXJyb3JzIG11c3QgYmUgaGFuZGxlZCBpbiB0aGUgbWVzc2FnZSBsb29wIGFjY29yZGluZ2x5XG4gICAqL1xuICBpbnNlcnRSb3coX3JvdzogVWludDhBcnJheVtdKTogdm9pZCB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiTm8gaW1wbGVtZW50YXRpb24gZm9yIGluc2VydFJvdyBpcyBkZWZpbmVkXCIpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBRdWVyeUFycmF5UmVzdWx0PFQgZXh0ZW5kcyBBcnJheTx1bmtub3duPiA9IEFycmF5PHVua25vd24+PlxuICBleHRlbmRzIFF1ZXJ5UmVzdWx0IHtcbiAgcHVibGljIHJvd3M6IFRbXSA9IFtdO1xuXG4gIGluc2VydFJvdyhyb3dfZGF0YTogVWludDhBcnJheVtdKSB7XG4gICAgaWYgKCF0aGlzLnJvd0Rlc2NyaXB0aW9uKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIFwiVGhlIHJvdyBkZXNjcmlwdGlvbnMgcmVxdWlyZWQgdG8gcGFyc2UgdGhlIHJlc3VsdCBkYXRhIHdlcmVuJ3QgaW5pdGlhbGl6ZWRcIixcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gUm93IGRlc2NyaXB0aW9uIHdvbid0IGJlIG1vZGlmaWVkIGFmdGVyIGluaXRpYWxpemF0aW9uXG4gICAgY29uc3Qgcm93ID0gcm93X2RhdGEubWFwKChyYXdfdmFsdWUsIGluZGV4KSA9PiB7XG4gICAgICBjb25zdCBjb2x1bW4gPSB0aGlzLnJvd0Rlc2NyaXB0aW9uIS5jb2x1bW5zW2luZGV4XTtcblxuICAgICAgaWYgKHJhd192YWx1ZSA9PT0gbnVsbCkge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICAgIHJldHVybiBkZWNvZGUocmF3X3ZhbHVlLCBjb2x1bW4pO1xuICAgIH0pIGFzIFQ7XG5cbiAgICB0aGlzLnJvd3MucHVzaChyb3cpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGZpbmREdXBsaWNhdGVzSW5BcnJheShhcnJheTogc3RyaW5nW10pOiBzdHJpbmdbXSB7XG4gIHJldHVybiBhcnJheS5yZWR1Y2UoKGR1cGxpY2F0ZXMsIGl0ZW0sIGluZGV4KSA9PiB7XG4gICAgY29uc3QgaXNfZHVwbGljYXRlID0gYXJyYXkuaW5kZXhPZihpdGVtKSAhPT0gaW5kZXg7XG4gICAgaWYgKGlzX2R1cGxpY2F0ZSAmJiAhZHVwbGljYXRlcy5pbmNsdWRlcyhpdGVtKSkge1xuICAgICAgZHVwbGljYXRlcy5wdXNoKGl0ZW0pO1xuICAgIH1cblxuICAgIHJldHVybiBkdXBsaWNhdGVzO1xuICB9LCBbXSBhcyBzdHJpbmdbXSk7XG59XG5cbmZ1bmN0aW9uIHNuYWtlY2FzZVRvQ2FtZWxjYXNlKGlucHV0OiBzdHJpbmcpIHtcbiAgcmV0dXJuIGlucHV0XG4gICAgLnNwbGl0KFwiX1wiKVxuICAgIC5yZWR1Y2UoXG4gICAgICAocmVzLCB3b3JkLCBpKSA9PiB7XG4gICAgICAgIGlmIChpICE9PSAwKSB7XG4gICAgICAgICAgd29yZCA9IHdvcmRbMF0udG9VcHBlckNhc2UoKSArIHdvcmQuc2xpY2UoMSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXMgKz0gd29yZDtcbiAgICAgICAgcmV0dXJuIHJlcztcbiAgICAgIH0sXG4gICAgICBcIlwiLFxuICAgICk7XG59XG5cbmV4cG9ydCBjbGFzcyBRdWVyeU9iamVjdFJlc3VsdDxcbiAgVCA9IFJlY29yZDxzdHJpbmcsIHVua25vd24+LFxuPiBleHRlbmRzIFF1ZXJ5UmVzdWx0IHtcbiAgLyoqXG4gICAqIFRoZSBjb2x1bW4gbmFtZXMgd2lsbCBiZSB1bmRlZmluZWQgb24gdGhlIGZpcnN0IHJ1biBvZiBpbnNlcnRSb3csIHNpbmNlXG4gICAqL1xuICBwdWJsaWMgY29sdW1ucz86IHN0cmluZ1tdO1xuICBwdWJsaWMgcm93czogVFtdID0gW107XG5cbiAgaW5zZXJ0Um93KHJvd19kYXRhOiBVaW50OEFycmF5W10pIHtcbiAgICBpZiAoIXRoaXMucm93RGVzY3JpcHRpb24pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgXCJUaGUgcm93IGRlc2NyaXB0aW9uIHJlcXVpcmVkIHRvIHBhcnNlIHRoZSByZXN1bHQgZGF0YSB3YXNuJ3QgaW5pdGlhbGl6ZWRcIixcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gVGhpcyB3aWxsIG9ubHkgcnVuIG9uIHRoZSBmaXJzdCBpdGVyYXRpb24gYWZ0ZXIgcm93IGRlc2NyaXB0aW9ucyBoYXZlIGJlZW4gc2V0XG4gICAgaWYgKCF0aGlzLmNvbHVtbnMpIHtcbiAgICAgIGlmICh0aGlzLnF1ZXJ5LmZpZWxkcykge1xuICAgICAgICBpZiAodGhpcy5yb3dEZXNjcmlwdGlvbi5jb2x1bW5zLmxlbmd0aCAhPT0gdGhpcy5xdWVyeS5maWVsZHMubGVuZ3RoKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoXG4gICAgICAgICAgICBcIlRoZSBmaWVsZHMgcHJvdmlkZWQgZm9yIHRoZSBxdWVyeSBkb24ndCBtYXRjaCB0aGUgb25lcyByZXR1cm5lZCBhcyBhIHJlc3VsdCBcIiArXG4gICAgICAgICAgICAgIGAoJHt0aGlzLnJvd0Rlc2NyaXB0aW9uLmNvbHVtbnMubGVuZ3RofSBleHBlY3RlZCwgJHt0aGlzLnF1ZXJ5LmZpZWxkcy5sZW5ndGh9IHJlY2VpdmVkKWAsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY29sdW1ucyA9IHRoaXMucXVlcnkuZmllbGRzO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGV0IGNvbHVtbl9uYW1lczogc3RyaW5nW107XG4gICAgICAgIGlmICh0aGlzLnF1ZXJ5LmNhbWVsY2FzZSkge1xuICAgICAgICAgIGNvbHVtbl9uYW1lcyA9IHRoaXMucm93RGVzY3JpcHRpb24uY29sdW1ucy5tYXAoKGNvbHVtbikgPT5cbiAgICAgICAgICAgIHNuYWtlY2FzZVRvQ2FtZWxjYXNlKGNvbHVtbi5uYW1lKVxuICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29sdW1uX25hbWVzID0gdGhpcy5yb3dEZXNjcmlwdGlvbi5jb2x1bW5zLm1hcCgoY29sdW1uKSA9PlxuICAgICAgICAgICAgY29sdW1uLm5hbWVcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQ2hlY2sgZmllbGQgbmFtZXMgcmV0dXJuZWQgYnkgdGhlIGRhdGFiYXNlIGFyZSBub3QgZHVwbGljYXRlZFxuICAgICAgICBjb25zdCBkdXBsaWNhdGVzID0gZmluZER1cGxpY2F0ZXNJbkFycmF5KGNvbHVtbl9uYW1lcyk7XG4gICAgICAgIGlmIChkdXBsaWNhdGVzLmxlbmd0aCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBGaWVsZCBuYW1lcyAke1xuICAgICAgICAgICAgICBkdXBsaWNhdGVzLm1hcCgoc3RyKSA9PiBgXCIke3N0cn1cImApLmpvaW4oXCIsIFwiKVxuICAgICAgICAgICAgfSBhcmUgZHVwbGljYXRlZCBpbiB0aGUgcmVzdWx0IG9mIHRoZSBxdWVyeWAsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY29sdW1ucyA9IGNvbHVtbl9uYW1lcztcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBJdCdzIHNhZmUgdG8gYXNzZXJ0IGNvbHVtbnMgYXMgZGVmaW5lZCBmcm9tIG5vdyBvblxuICAgIGNvbnN0IGNvbHVtbnMgPSB0aGlzLmNvbHVtbnMhO1xuXG4gICAgaWYgKGNvbHVtbnMubGVuZ3RoICE9PSByb3dfZGF0YS5sZW5ndGgpIHtcbiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKFxuICAgICAgICBcIlRoZSByZXN1bHQgZmllbGRzIHJldHVybmVkIGJ5IHRoZSBkYXRhYmFzZSBkb24ndCBtYXRjaCB0aGUgZGVmaW5lZCBzdHJ1Y3R1cmUgb2YgdGhlIHJlc3VsdFwiLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCByb3cgPSByb3dfZGF0YS5yZWR1Y2UoXG4gICAgICAocm93LCByYXdfdmFsdWUsIGluZGV4KSA9PiB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRfY29sdW1uID0gdGhpcy5yb3dEZXNjcmlwdGlvbiEuY29sdW1uc1tpbmRleF07XG5cbiAgICAgICAgaWYgKHJhd192YWx1ZSA9PT0gbnVsbCkge1xuICAgICAgICAgIHJvd1tjb2x1bW5zW2luZGV4XV0gPSBudWxsO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJvd1tjb2x1bW5zW2luZGV4XV0gPSBkZWNvZGUocmF3X3ZhbHVlLCBjdXJyZW50X2NvbHVtbik7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcm93O1xuICAgICAgfSxcbiAgICAgIHt9IGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+LFxuICAgICk7XG5cbiAgICB0aGlzLnJvd3MucHVzaChyb3cgYXMgVCk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFF1ZXJ5PFQgZXh0ZW5kcyBSZXN1bHRUeXBlPiB7XG4gIHB1YmxpYyBhcmdzOiBFbmNvZGVkQXJnW107XG4gIHB1YmxpYyBjYW1lbGNhc2U/OiBib29sZWFuO1xuICAvKipcbiAgICogVGhlIGV4cGxpY2l0bHkgc2V0IGZpZWxkcyBmb3IgdGhlIHF1ZXJ5IHJlc3VsdCwgdGhleSBoYXZlIGJlZW4gdmFsaWRhdGVkIGJlZm9yZWhhbmRcbiAgICogZm9yIGR1cGxpY2F0ZXMgYW5kIGludmFsaWQgbmFtZXNcbiAgICovXG4gIHB1YmxpYyBmaWVsZHM/OiBzdHJpbmdbXTtcbiAgLy8gVE9ET1xuICAvLyBTaG91bGQgYmUgcHJpdmF0ZVxuICBwdWJsaWMgcmVzdWx0X3R5cGU6IFJlc3VsdFR5cGU7XG4gIC8vIFRPRE9cbiAgLy8gRG9jdW1lbnQgdGhhdCB0aGlzIHRleHQgaXMgdGhlIG9uZSBzZW50IHRvIHRoZSBkYXRhYmFzZSwgbm90IHRoZSBvcmlnaW5hbCBvbmVcbiAgcHVibGljIHRleHQ6IHN0cmluZztcbiAgY29uc3RydWN0b3IoY29uZmlnOiBRdWVyeU9iamVjdE9wdGlvbnMsIHJlc3VsdF90eXBlOiBUKTtcbiAgY29uc3RydWN0b3IodGV4dDogc3RyaW5nLCByZXN1bHRfdHlwZTogVCwgYXJncz86IFF1ZXJ5QXJndW1lbnRzKTtcbiAgY29uc3RydWN0b3IoXG4gICAgY29uZmlnX29yX3RleHQ6IHN0cmluZyB8IFF1ZXJ5T2JqZWN0T3B0aW9ucyxcbiAgICByZXN1bHRfdHlwZTogVCxcbiAgICBhcmdzOiBRdWVyeUFyZ3VtZW50cyA9IFtdLFxuICApIHtcbiAgICB0aGlzLnJlc3VsdF90eXBlID0gcmVzdWx0X3R5cGU7XG4gICAgaWYgKHR5cGVvZiBjb25maWdfb3JfdGV4dCA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGFyZ3MpKSB7XG4gICAgICAgIFtjb25maWdfb3JfdGV4dCwgYXJnc10gPSBvYmplY3RRdWVyeVRvUXVlcnlBcmdzKGNvbmZpZ19vcl90ZXh0LCBhcmdzKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy50ZXh0ID0gY29uZmlnX29yX3RleHQ7XG4gICAgICB0aGlzLmFyZ3MgPSBhcmdzLm1hcChlbmNvZGVBcmd1bWVudCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCB7XG4gICAgICAgIGFyZ3MgPSBbXSxcbiAgICAgICAgY2FtZWxjYXNlLFxuICAgICAgICBlbmNvZGVyID0gZW5jb2RlQXJndW1lbnQsXG4gICAgICAgIGZpZWxkcyxcbiAgICAgICAgLy8gZGVuby1saW50LWlnbm9yZSBuby11bnVzZWQtdmFyc1xuICAgICAgICBuYW1lLFxuICAgICAgICB0ZXh0LFxuICAgICAgfSA9IGNvbmZpZ19vcl90ZXh0O1xuXG4gICAgICAvLyBDaGVjayB0aGF0IHRoZSBmaWVsZHMgcGFzc2VkIGFyZSB2YWxpZCBhbmQgY2FuIGJlIHVzZWQgdG8gbWFwXG4gICAgICAvLyB0aGUgcmVzdWx0IG9mIHRoZSBxdWVyeVxuICAgICAgaWYgKGZpZWxkcykge1xuICAgICAgICBjb25zdCBmaWVsZHNfYXJlX2NsZWFuID0gZmllbGRzLmV2ZXJ5KChmaWVsZCkgPT5cbiAgICAgICAgICAvXlthLXpBLVpfXVthLXpBLVowLTlfXSokLy50ZXN0KGZpZWxkKVxuICAgICAgICApO1xuICAgICAgICBpZiAoIWZpZWxkc19hcmVfY2xlYW4pIHtcbiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFxuICAgICAgICAgICAgXCJUaGUgZmllbGRzIHByb3ZpZGVkIGZvciB0aGUgcXVlcnkgbXVzdCBjb250YWluIG9ubHkgbGV0dGVycyBhbmQgdW5kZXJzY29yZXNcIixcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG5ldyBTZXQoZmllbGRzKS5zaXplICE9PSBmaWVsZHMubGVuZ3RoKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcbiAgICAgICAgICAgIFwiVGhlIGZpZWxkcyBwcm92aWRlZCBmb3IgdGhlIHF1ZXJ5IG11c3QgYmUgdW5pcXVlXCIsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZmllbGRzID0gZmllbGRzO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmNhbWVsY2FzZSA9IGNhbWVsY2FzZTtcblxuICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGFyZ3MpKSB7XG4gICAgICAgIFt0ZXh0LCBhcmdzXSA9IG9iamVjdFF1ZXJ5VG9RdWVyeUFyZ3ModGV4dCwgYXJncyk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuYXJncyA9IGFyZ3MubWFwKGVuY29kZXIpO1xuICAgICAgdGhpcy50ZXh0ID0gdGV4dDtcbiAgICB9XG4gIH1cbn1cbiJdfQ==