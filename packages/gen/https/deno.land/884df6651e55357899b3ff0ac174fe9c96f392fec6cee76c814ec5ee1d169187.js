import { log } from "./deps.ts";
import { Watcher } from "./src/watcher.ts";
import { Runner } from "./src/runner.ts";
import { Daemon } from "./src/daemon.ts";
import { grantPermissions, initializeConfig, printAvailableScripts, printHelp, upgrade, } from "./src/cli.ts";
import { readConfig, reConfig } from "./src/config.ts";
import { parseArgs } from "./src/args.ts";
import { BRANCH, VERSION } from "./info.ts";
const logger = log.create("main");
export class Denon {
    config;
    watcher;
    runner;
    constructor(config) {
        this.config = config;
        this.watcher = new Watcher(config.watcher);
        this.runner = new Runner(config, config.args ? config.args.cmd : []);
    }
    run(script) {
        return new Daemon(this, script);
    }
}
if (import.meta.main) {
    const args = parseArgs(Deno.args);
    await grantPermissions();
    let config = await readConfig(args.config);
    config.args = args;
    await log.setup({
        filter: config.logger.quiet
            ? "ERROR"
            : config.logger.debug
                ? "DEBUG"
                : "INFO",
    });
    if (BRANCH !== "main") {
        logger.info(`v${VERSION}-${BRANCH}`);
    }
    else {
        logger.info(`v${VERSION}`);
    }
    if (args.version)
        Deno.exit(0);
    if (args.upgrade) {
        await upgrade(args.upgrade);
        Deno.exit(0);
    }
    if (args.help) {
        printHelp();
        Deno.exit(0);
    }
    if (args.init) {
        await initializeConfig(args.init);
        Deno.exit(0);
    }
    if (args.cmd.length === 0) {
        await printAvailableScripts(config);
        Deno.exit(0);
    }
    const script = args.cmd[0];
    const denon = new Denon(config);
    for await (const event of denon.run(script)) {
        if (event.type === "reload") {
            if (event.change.some((_) => reConfig.test(_.path) && _.path === config.configPath)) {
                config = await readConfig(args.config);
                logger.debug("reloading config");
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVub24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJodHRwczovL2Rlbm8ubGFuZC94L2Rlbm9uQDIuNS4wL2Rlbm9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFaEMsT0FBTyxFQUFhLE9BQU8sRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFekMsT0FBTyxFQUNMLGdCQUFnQixFQUNoQixnQkFBZ0IsRUFDaEIscUJBQXFCLEVBQ3JCLFNBQVMsRUFDVCxPQUFPLEdBQ1IsTUFBTSxjQUFjLENBQUM7QUFDdEIsT0FBTyxFQUF1QixVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDNUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUxQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUU1QyxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBa0RsQyxNQUFNLE9BQU8sS0FBSztJQUlHO0lBSG5CLE9BQU8sQ0FBVTtJQUNqQixNQUFNLENBQVM7SUFFZixZQUFtQixNQUEyQjtRQUEzQixXQUFNLEdBQU4sTUFBTSxDQUFxQjtRQUM1QyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksT0FBTyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMzQyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksTUFBTSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDdkUsQ0FBQztJQUVELEdBQUcsQ0FBQyxNQUFjO1FBQ2hCLE9BQU8sSUFBSSxNQUFNLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ2xDLENBQUM7Q0FDRjtBQU1ELElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUU7SUFDcEIsTUFBTSxJQUFJLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQWVsQyxNQUFNLGdCQUFnQixFQUFFLENBQUM7SUFFekIsSUFBSSxNQUFNLEdBQUcsTUFBTSxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzNDLE1BQU0sQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBRW5CLE1BQU0sR0FBRyxDQUFDLEtBQUssQ0FDYjtRQUNFLE1BQU0sRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUs7WUFDekIsQ0FBQyxDQUFDLE9BQU87WUFDVCxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLO2dCQUNyQixDQUFDLENBQUMsT0FBTztnQkFDVCxDQUFDLENBQUMsTUFBTTtLQUNYLENBQ0YsQ0FBQztJQUdGLElBQUksTUFBTSxLQUFLLE1BQU0sRUFBRTtRQUNyQixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksT0FBTyxJQUFJLE1BQU0sRUFBRSxDQUFDLENBQUM7S0FDdEM7U0FBTTtRQUNMLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxPQUFPLEVBQUUsQ0FBQyxDQUFDO0tBQzVCO0lBQ0QsSUFBSSxJQUFJLENBQUMsT0FBTztRQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFHL0IsSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFO1FBQ2hCLE1BQU0sT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM1QixJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ2Q7SUFHRCxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUU7UUFDYixTQUFTLEVBQUUsQ0FBQztRQUNaLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDZDtJQUlELElBQUksSUFBSSxDQUFDLElBQUksRUFBRTtRQUNiLE1BQU0sZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2xDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDZDtJQUdELElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1FBQ3pCLE1BQU0scUJBQXFCLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDcEMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNkO0lBR0QsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQVUzQixNQUFNLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUdoQyxJQUFJLEtBQUssRUFBRSxNQUFNLEtBQUssSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1FBQzNDLElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxRQUFRLEVBQUU7WUFDM0IsSUFDRSxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDZixDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksS0FBSyxNQUFNLENBQUMsVUFBVSxDQUM3RCxFQUNEO2dCQUNBLE1BQU0sR0FBRyxNQUFNLFVBQVUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBQ3ZDLE1BQU0sQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUMsQ0FBQzthQUNsQztTQUNGO0tBQ0Y7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIwLTIwMjEgdGhlIGRlbm9zYXVycyB0ZWFtLiBBbGwgcmlnaHRzIHJlc2VydmVkLiBNSVQgbGljZW5zZS5cblxuaW1wb3J0IHsgbG9nIH0gZnJvbSBcIi4vZGVwcy50c1wiO1xuXG5pbXBvcnQgeyBGaWxlRXZlbnQsIFdhdGNoZXIgfSBmcm9tIFwiLi9zcmMvd2F0Y2hlci50c1wiO1xuaW1wb3J0IHsgUnVubmVyIH0gZnJvbSBcIi4vc3JjL3J1bm5lci50c1wiO1xuaW1wb3J0IHsgRGFlbW9uIH0gZnJvbSBcIi4vc3JjL2RhZW1vbi50c1wiO1xuXG5pbXBvcnQge1xuICBncmFudFBlcm1pc3Npb25zLFxuICBpbml0aWFsaXplQ29uZmlnLFxuICBwcmludEF2YWlsYWJsZVNjcmlwdHMsXG4gIHByaW50SGVscCxcbiAgdXBncmFkZSxcbn0gZnJvbSBcIi4vc3JjL2NsaS50c1wiO1xuaW1wb3J0IHsgQ29tcGxldGVEZW5vbkNvbmZpZywgcmVhZENvbmZpZywgcmVDb25maWcgfSBmcm9tIFwiLi9zcmMvY29uZmlnLnRzXCI7XG5pbXBvcnQgeyBwYXJzZUFyZ3MgfSBmcm9tIFwiLi9zcmMvYXJncy50c1wiO1xuXG5pbXBvcnQgeyBCUkFOQ0gsIFZFUlNJT04gfSBmcm9tIFwiLi9pbmZvLnRzXCI7XG5cbmNvbnN0IGxvZ2dlciA9IGxvZy5jcmVhdGUoXCJtYWluXCIpO1xuXG4vKiogRXZlbnRzIHlvdSBjYW4gbGlzdGVuIHRvIHdoZW4gY3JlYXRpbmcgYSBgZGVub25gXG4gKiBpbnN0YW5jZSBhcyBtb2R1bGU6XG4gKiBgYGB0eXBlc2NyaXB0XG4gKiBjb25zdCBkZW5vbiA9IG5ldyBEZW5vbihjb25maWcpO1xuICogZm9yIGF3YWl0IChjb25zdCBldmVudCBvZiBkZW5vbi5ydW4oc2NyaXB0KSkge1xuICogICAvLyBldmVudCBoYW5kbGluZyBoZXJlXG4gKiB9XG4gKiBgYGAgKi9cbmV4cG9ydCBkZWNsYXJlIHR5cGUgRGVub25FdmVudFR5cGUgPVxuICB8IFwic3RhcnRcIlxuICB8IFwicmVsb2FkXCJcbiAgfCBcImNyYXNoXCJcbiAgfCBcInN1Y2Nlc3NcIlxuICB8IFwiZXhpdFwiO1xuXG5leHBvcnQgZGVjbGFyZSB0eXBlIERlbm9uRXZlbnQgPVxuICB8IERlbm9uU3RhcnRFdmVudFxuICB8IERlbm9uUmVsb2FkRXZlbnRcbiAgfCBEZW5vbkNyYXNoRXZlbnRcbiAgfCBEZW5vblN1Y2Nlc3NFdmVudFxuICB8IERlbm9uRXhpdEV2ZW50O1xuXG5leHBvcnQgZGVjbGFyZSBpbnRlcmZhY2UgRGVub25TdGFydEV2ZW50IHtcbiAgdHlwZTogXCJzdGFydFwiO1xufVxuXG5leHBvcnQgZGVjbGFyZSBpbnRlcmZhY2UgRGVub25SZWxvYWRFdmVudCB7XG4gIHR5cGU6IFwicmVsb2FkXCI7XG4gIGNoYW5nZTogRmlsZUV2ZW50W107XG59XG5cbmV4cG9ydCBkZWNsYXJlIGludGVyZmFjZSBEZW5vbkNyYXNoRXZlbnQge1xuICB0eXBlOiBcImNyYXNoXCI7XG4gIHN0YXR1czogRGVuby5Qcm9jZXNzU3RhdHVzO1xufVxuXG5leHBvcnQgZGVjbGFyZSBpbnRlcmZhY2UgRGVub25TdWNjZXNzRXZlbnQge1xuICB0eXBlOiBcInN1Y2Nlc3NcIjtcbiAgc3RhdHVzOiBEZW5vLlByb2Nlc3NTdGF0dXM7XG59XG5cbmV4cG9ydCBkZWNsYXJlIGludGVyZmFjZSBEZW5vbkV4aXRFdmVudCB7XG4gIHR5cGU6IFwiZXhpdFwiO1xufVxuXG4vKiogRGVub24gaW5zdGFuY2UuXG4gKiBIb2xkcyBsb2FkZWQgY29uZmlndXJhdGlvbiBhbmQgaGFuZGxlcyBjcmVhdGlvblxuICogb2YgZGFlbW9ucyB3aXRoIHRoZSBgc3RhcnQoc2NyaXB0KWAgbWV0aG9kLiAqL1xuZXhwb3J0IGNsYXNzIERlbm9uIHtcbiAgd2F0Y2hlcjogV2F0Y2hlcjtcbiAgcnVubmVyOiBSdW5uZXI7XG5cbiAgY29uc3RydWN0b3IocHVibGljIGNvbmZpZzogQ29tcGxldGVEZW5vbkNvbmZpZykge1xuICAgIHRoaXMud2F0Y2hlciA9IG5ldyBXYXRjaGVyKGNvbmZpZy53YXRjaGVyKTtcbiAgICB0aGlzLnJ1bm5lciA9IG5ldyBSdW5uZXIoY29uZmlnLCBjb25maWcuYXJncyA/IGNvbmZpZy5hcmdzLmNtZCA6IFtdKTtcbiAgfVxuXG4gIHJ1bihzY3JpcHQ6IHN0cmluZyk6IEFzeW5jSXRlcmFibGU8RGVub25FdmVudD4ge1xuICAgIHJldHVybiBuZXcgRGFlbW9uKHRoaXMsIHNjcmlwdCk7XG4gIH1cbn1cblxuLyoqIENMSSBzdGFydHMgaGVyZSxcbiAqIG90aGVyIHRoYW4gdGhlIGF3ZXNvbWUgYGRlbm9uYCBjbGkgdGhpcyBpcyBhblxuICogZXhhbXBsZSBvbiBob3cgdGhlIGxpYnJhcnkgY291bGQgYmUgdXNlZCBpZlxuICogaW5jbHVkZWQgYXMgYSBtb2R1bGUuICovXG5pZiAoaW1wb3J0Lm1ldGEubWFpbikge1xuICBjb25zdCBhcmdzID0gcGFyc2VBcmdzKERlbm8uYXJncyk7XG5cbiAgLy8gY2hlY2sgY29tcGF0aWJpbGl0eVxuICAvLyBpZiAoIUNPTVBBVFtWRVJTSU9OXS5pbmNsdWRlcyhEZW5vLnZlcnNpb24uZGVubykgJiYgIWFyZ3MudXBncmFkZSkge1xuICAvLyAgIGxvZ2dlci5lcnJvcihcbiAgLy8gICAgIGBZb3VyIHZlcnNpb24gb2YgZGVub24gKCR7VkVSU0lPTn0pIGRvZXMgbm90IHN1cHBvcnQgeW91ciBkZW5vIHZlcnNpb24gKCR7RGVuby52ZXJzaW9uLmRlbm99KWAsXG4gIC8vICAgKTtcbiAgLy8gICBsb2dnZXIud2FybmluZyhcbiAgLy8gICAgIGBVcGdyYWRlIGRlbm8gYnkgcnVubmluZyBcXGBkZW5vIHVwZ3JhZGUgLS12ZXJzaW9uICR7XG4gIC8vICAgICAgIFsuLi5DT01QQVRbVkVSU0lPTl1dLnBvcCgpXG4gIC8vICAgICB9XFxgYCxcbiAgLy8gICApO1xuICAvLyAgIERlbm8uZXhpdCgxKTtcbiAgLy8gfVxuXG4gIGF3YWl0IGdyYW50UGVybWlzc2lvbnMoKTtcblxuICBsZXQgY29uZmlnID0gYXdhaXQgcmVhZENvbmZpZyhhcmdzLmNvbmZpZyk7XG4gIGNvbmZpZy5hcmdzID0gYXJncztcblxuICBhd2FpdCBsb2cuc2V0dXAoXG4gICAge1xuICAgICAgZmlsdGVyOiBjb25maWcubG9nZ2VyLnF1aWV0XG4gICAgICAgID8gXCJFUlJPUlwiXG4gICAgICAgIDogY29uZmlnLmxvZ2dlci5kZWJ1Z1xuICAgICAgICA/IFwiREVCVUdcIlxuICAgICAgICA6IFwiSU5GT1wiLFxuICAgIH0sXG4gICk7XG5cbiAgLy8gc2hvdyB2ZXJzaW9uIG51bWJlci5cbiAgaWYgKEJSQU5DSCAhPT0gXCJtYWluXCIpIHtcbiAgICBsb2dnZXIuaW5mbyhgdiR7VkVSU0lPTn0tJHtCUkFOQ0h9YCk7XG4gIH0gZWxzZSB7XG4gICAgbG9nZ2VyLmluZm8oYHYke1ZFUlNJT059YCk7XG4gIH1cbiAgaWYgKGFyZ3MudmVyc2lvbikgRGVuby5leGl0KDApO1xuXG4gIC8vIHVwZGF0ZSBkZW5vbiB0byBsYXRlc3QgcmVsZWFzZVxuICBpZiAoYXJncy51cGdyYWRlKSB7XG4gICAgYXdhaXQgdXBncmFkZShhcmdzLnVwZ3JhZGUpO1xuICAgIERlbm8uZXhpdCgwKTtcbiAgfVxuXG4gIC8vIHNob3cgaGVscCBtZXNzYWdlLlxuICBpZiAoYXJncy5oZWxwKSB7XG4gICAgcHJpbnRIZWxwKCk7XG4gICAgRGVuby5leGl0KDApO1xuICB9XG5cbiAgLy8gY3JlYXRlIGNvbmZpZ3VyYXRpb24gZmlsZS5cbiAgLy8gVE9ETyhAcXU0ayk6IHNob3VsZCBiZSBtYWRlIGludGVyYWN0aXZlLlxuICBpZiAoYXJncy5pbml0KSB7XG4gICAgYXdhaXQgaW5pdGlhbGl6ZUNvbmZpZyhhcmdzLmluaXQpO1xuICAgIERlbm8uZXhpdCgwKTtcbiAgfVxuXG4gIC8vIHNob3cgYWxsIGF2YWlsYWJsZSBzY3JpcHRzLlxuICBpZiAoYXJncy5jbWQubGVuZ3RoID09PSAwKSB7XG4gICAgYXdhaXQgcHJpbnRBdmFpbGFibGVTY3JpcHRzKGNvbmZpZyk7XG4gICAgRGVuby5leGl0KDApO1xuICB9XG5cbiAgLy8gY29uc3QgYnVpbHRJbiA9IFtcInJ1blwiLCBcInRlc3RcIiwgXCJmbXRcIiwgXCJsaW50XCJdO1xuICBjb25zdCBzY3JpcHQgPSBhcmdzLmNtZFswXTtcblxuICAvLyBpZiAoIWNvbmZpZy5zY3JpcHRzW3NjcmlwdF0gJiYgIWJ1aWx0SW4uaW5jbHVkZXMoc2NyaXB0KSkge1xuICAvLyAgIGNvbnN0IG90aGVyID0gY2xvc2VzdChzY3JpcHQsIE9iamVjdC5rZXlzKGNvbmZpZy5zY3JpcHRzKS5jb25jYXQoYnVpbHRJbikpO1xuICAvLyAgIGxvZ2dlci5lcnJvcihcbiAgLy8gICAgIGBDb3VsZCBub3QgZmluZCBzY3JpcHQgXFxgJHtzY3JpcHR9XFxgIGRpZCB5b3UgbWVhbiBcXGAke290aGVyfVxcYD9gLFxuICAvLyAgICk7XG4gIC8vICAgRGVuby5leGl0KDEpO1xuICAvLyB9XG5cbiAgY29uc3QgZGVub24gPSBuZXcgRGVub24oY29uZmlnKTtcblxuICAvLyBUT0RPKEBxdTRrKTogZXZlbnRzXG4gIGZvciBhd2FpdCAoY29uc3QgZXZlbnQgb2YgZGVub24ucnVuKHNjcmlwdCkpIHtcbiAgICBpZiAoZXZlbnQudHlwZSA9PT0gXCJyZWxvYWRcIikge1xuICAgICAgaWYgKFxuICAgICAgICBldmVudC5jaGFuZ2Uuc29tZShcbiAgICAgICAgICAoXykgPT4gcmVDb25maWcudGVzdChfLnBhdGgpICYmIF8ucGF0aCA9PT0gY29uZmlnLmNvbmZpZ1BhdGgsXG4gICAgICAgIClcbiAgICAgICkge1xuICAgICAgICBjb25maWcgPSBhd2FpdCByZWFkQ29uZmlnKGFyZ3MuY29uZmlnKTtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKFwicmVsb2FkaW5nIGNvbmZpZ1wiKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==