const matchCache = {};
const FIELD_CONTENT_REGEXP = /^[\u0009\u0020-\u007e\u0080-\u00ff]+$/;
const KEY_REGEXP = /(?:^|;) *([^=]*)=[^;]*/g;
const SAME_SITE_REGEXP = /^(?:lax|none|strict)$/i;
function getPattern(name) {
    if (name in matchCache) {
        return matchCache[name];
    }
    return matchCache[name] = new RegExp(`(?:^|;) *${name.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, "\\$&")}=([^;]*)`);
}
function pushCookie(headers, cookie) {
    if (cookie.overwrite) {
        for (let i = headers.length - 1; i >= 0; i--) {
            if (headers[i].indexOf(`${cookie.name}=`) === 0) {
                headers.splice(i, 1);
            }
        }
    }
    headers.push(cookie.toHeader());
}
function validateCookieProperty(key, value) {
    if (value && !FIELD_CONTENT_REGEXP.test(value)) {
        throw new TypeError(`The ${key} of the cookie (${value}) is invalid.`);
    }
}
class Cookie {
    domain;
    expires;
    httpOnly = true;
    maxAge;
    name;
    overwrite = false;
    path = "/";
    sameSite = false;
    secure = false;
    signed;
    value;
    constructor(name, value, attributes) {
        validateCookieProperty("name", name);
        validateCookieProperty("value", value);
        this.name = name;
        this.value = value ?? "";
        Object.assign(this, attributes);
        if (!this.value) {
            this.expires = new Date(0);
            this.maxAge = undefined;
        }
        validateCookieProperty("path", this.path);
        validateCookieProperty("domain", this.domain);
        if (this.sameSite && typeof this.sameSite === "string" &&
            !SAME_SITE_REGEXP.test(this.sameSite)) {
            throw new TypeError(`The sameSite of the cookie ("${this.sameSite}") is invalid.`);
        }
    }
    toHeader() {
        let header = this.toString();
        if (this.maxAge) {
            this.expires = new Date(Date.now() + (this.maxAge * 1000));
        }
        if (this.path) {
            header += `; path=${this.path}`;
        }
        if (this.expires) {
            header += `; expires=${this.expires.toUTCString()}`;
        }
        if (this.domain) {
            header += `; domain=${this.domain}`;
        }
        if (this.sameSite) {
            header += `; samesite=${this.sameSite === true ? "strict" : this.sameSite.toLowerCase()}`;
        }
        if (this.secure) {
            header += "; secure";
        }
        if (this.httpOnly) {
            header += "; httponly";
        }
        return header;
    }
    toString() {
        return `${this.name}=${this.value}`;
    }
}
export class Cookies {
    #cookieKeys;
    #keys;
    #request;
    #response;
    #secure;
    #requestKeys() {
        if (this.#cookieKeys) {
            return this.#cookieKeys;
        }
        const result = this.#cookieKeys = [];
        const header = this.#request.headers.get("cookie");
        if (!header) {
            return result;
        }
        let matches;
        while ((matches = KEY_REGEXP.exec(header))) {
            const [, key] = matches;
            result.push(key);
        }
        return result;
    }
    constructor(request, response, options = {}) {
        const { keys, secure } = options;
        this.#keys = keys;
        this.#request = request;
        this.#response = response;
        this.#secure = secure;
    }
    delete(name, options = {}) {
        this.set(name, null, options);
        return true;
    }
    async *entries() {
        const keys = this.#requestKeys();
        for (const key of keys) {
            const value = await this.get(key);
            if (value) {
                yield [key, value];
            }
        }
    }
    async forEach(callback, thisArg = null) {
        const keys = this.#requestKeys();
        for (const key of keys) {
            const value = await this.get(key);
            if (value) {
                callback.call(thisArg, key, value, this);
            }
        }
    }
    async get(name, options = {}) {
        const signed = options.signed ?? !!this.#keys;
        const nameSig = `${name}.sig`;
        const header = this.#request.headers.get("cookie");
        if (!header) {
            return;
        }
        const match = header.match(getPattern(name));
        if (!match) {
            return;
        }
        const [, value] = match;
        if (!signed) {
            return value;
        }
        const digest = await this.get(nameSig, { signed: false });
        if (!digest) {
            return;
        }
        const data = `${name}=${value}`;
        if (!this.#keys) {
            throw new TypeError("keys required for signed cookies");
        }
        const index = await this.#keys.indexOf(data, digest);
        if (index < 0) {
            this.delete(nameSig, { path: "/", signed: false });
        }
        else {
            if (index) {
                this.set(nameSig, await this.#keys.sign(data), { signed: false });
            }
            return value;
        }
    }
    async *keys() {
        const keys = this.#requestKeys();
        for (const key of keys) {
            const value = await this.get(key);
            if (value) {
                yield key;
            }
        }
    }
    async set(name, value, options = {}) {
        const request = this.#request;
        const response = this.#response;
        const headers = [];
        for (const [key, value] of response.headers.entries()) {
            if (key === "set-cookie") {
                headers.push(value);
            }
        }
        const secure = this.#secure !== undefined ? this.#secure : request.secure;
        const signed = options.signed ?? !!this.#keys;
        if (!secure && options.secure && !options.ignoreInsecure) {
            throw new TypeError("Cannot send secure cookie over unencrypted connection.");
        }
        const cookie = new Cookie(name, value, options);
        cookie.secure = options.secure ?? secure;
        pushCookie(headers, cookie);
        if (signed) {
            if (!this.#keys) {
                throw new TypeError(".keys required for signed cookies.");
            }
            cookie.value = await this.#keys.sign(cookie.toString());
            cookie.name += ".sig";
            pushCookie(headers, cookie);
        }
        response.headers.delete("Set-Cookie");
        for (const header of headers) {
            response.headers.append("Set-Cookie", header);
        }
        return this;
    }
    async *values() {
        const keys = this.#requestKeys();
        for (const key of keys) {
            const value = await this.get(key);
            if (value) {
                yield value;
            }
        }
    }
    async *[Symbol.asyncIterator]() {
        const keys = this.#requestKeys();
        for (const key of keys) {
            const value = await this.get(key);
            if (value) {
                yield [key, value];
            }
        }
    }
    [Symbol.for("Deno.customInspect")]() {
        return `${this.constructor.name} []`;
    }
    [Symbol.for("nodejs.util.inspect.custom")](depth, options, inspect) {
        if (depth < 0) {
            return options.stylize(`[${this.constructor.name}]`, "special");
        }
        const newOptions = Object.assign({}, options, {
            depth: options.depth === null ? null : options.depth - 1,
        });
        return `${options.stylize(this.constructor.name, "special")} ${inspect([], newOptions)}`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29va2llcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvb2tpZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBbUNBLE1BQU0sVUFBVSxHQUEyQixFQUFFLENBQUM7QUFHOUMsTUFBTSxvQkFBb0IsR0FBRyx1Q0FBdUMsQ0FBQztBQUNyRSxNQUFNLFVBQVUsR0FBRyx5QkFBeUIsQ0FBQztBQUM3QyxNQUFNLGdCQUFnQixHQUFHLHdCQUF3QixDQUFDO0FBRWxELFNBQVMsVUFBVSxDQUFDLElBQVk7SUFDOUIsSUFBSSxJQUFJLElBQUksVUFBVSxFQUFFO1FBQ3RCLE9BQU8sVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO0tBQ3pCO0lBRUQsT0FBTyxVQUFVLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxNQUFNLENBQ2xDLFlBQVksSUFBSSxDQUFDLE9BQU8sQ0FBQywwQkFBMEIsRUFBRSxNQUFNLENBQUMsVUFBVSxDQUN2RSxDQUFDO0FBQ0osQ0FBQztBQUVELFNBQVMsVUFBVSxDQUFDLE9BQWlCLEVBQUUsTUFBYztJQUNuRCxJQUFJLE1BQU0sQ0FBQyxTQUFTLEVBQUU7UUFDcEIsS0FBSyxJQUFJLENBQUMsR0FBRyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQzVDLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLE1BQU0sQ0FBQyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDL0MsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDdEI7U0FDRjtLQUNGO0lBQ0QsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztBQUNsQyxDQUFDO0FBRUQsU0FBUyxzQkFBc0IsQ0FDN0IsR0FBVyxFQUNYLEtBQWdDO0lBRWhDLElBQUksS0FBSyxJQUFJLENB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dCAyMDE4LTIwMjIgdGhlIG9hayBhdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLiBNSVQgbGljZW5zZS5cblxuLy8gVGhpcyB3YXMgaGVhdmlseSBpbmZsdWVuY2VkIGJ5XG4vLyBbY29va2llc10oaHR0cHM6Ly9naXRodWIuY29tL3BpbGxhcmpzL2Nvb2tpZXMvYmxvYi9tYXN0ZXIvaW5kZXguanMpXG5cbmltcG9ydCB0eXBlIHsgS2V5U3RhY2sgfSBmcm9tIFwiLi9rZXlTdGFjay50c1wiO1xuaW1wb3J0IHR5cGUgeyBSZXF1ZXN0IH0gZnJvbSBcIi4vcmVxdWVzdC50c1wiO1xuaW1wb3J0IHR5cGUgeyBSZXNwb25zZSB9IGZyb20gXCIuL3Jlc3BvbnNlLnRzXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29va2llc09wdGlvbnMge1xuICBrZXlzPzogS2V5U3RhY2s7XG4gIHNlY3VyZT86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29va2llc0dldE9wdGlvbnMge1xuICBzaWduZWQ/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENvb2tpZXNTZXREZWxldGVPcHRpb25zIHtcbiAgZG9tYWluPzogc3RyaW5nO1xuICBleHBpcmVzPzogRGF0ZTtcbiAgaHR0cE9ubHk/OiBib29sZWFuO1xuICAvKiogRm9yIHVzZSBpbiBzaXR1YXRpb25zIHdoZXJlIHJlcXVlc3RzIGFyZSBwcmVzZW50ZWQgdG8gRGVubyBhcyBcImluc2VjdXJlXCJcbiAgICogYnV0IGFyZSBvdGhlcndpc2Ugc2VjdXJlIGFuZCBzbyBzZWN1cmUgY29va2llcyBjYW4gYmUgdHJlYXRlZCBhcyBzZWN1cmUuICovXG4gIGlnbm9yZUluc2VjdXJlPzogYm9vbGVhbjtcbiAgbWF4QWdlPzogbnVtYmVyO1xuICBvdmVyd3JpdGU/OiBib29sZWFuO1xuICBwYXRoPzogc3RyaW5nO1xuICBzZWN1cmU/OiBib29sZWFuO1xuICBzYW1lU2l0ZT86IFwic3RyaWN0XCIgfCBcImxheFwiIHwgXCJub25lXCIgfCBib29sZWFuO1xuICBzaWduZWQ/OiBib29sZWFuO1xufVxuXG50eXBlIENvb2tpZUF0dHJpYnV0ZXMgPSBDb29raWVzU2V0RGVsZXRlT3B0aW9ucztcblxuY29uc3QgbWF0Y2hDYWNoZTogUmVjb3JkPHN0cmluZywgUmVnRXhwPiA9IHt9O1xuXG4vLyBkZW5vLWxpbnQtaWdub3JlIG5vLWNvbnRyb2wtcmVnZXhcbmNvbnN0IEZJRUxEX0NPTlRFTlRfUkVHRVhQID0gL15bXFx1MDAwOVxcdTAwMjAtXFx1MDA3ZVxcdTAwODAtXFx1MDBmZl0rJC87XG5jb25zdCBLRVlfUkVHRVhQID0gLyg/Ol58OykgKihbXj1dKik9W147XSovZztcbmNvbnN0IFNBTUVfU0lURV9SRUdFWFAgPSAvXig/OmxheHxub25lfHN0cmljdCkkL2k7XG5cbmZ1bmN0aW9uIGdldFBhdHRlcm4obmFtZTogc3RyaW5nKTogUmVnRXhwIHtcbiAgaWYgKG5hbWUgaW4gbWF0Y2hDYWNoZSkge1xuICAgIHJldHVybiBtYXRjaENhY2hlW25hbWVdO1xuICB9XG5cbiAgcmV0dXJuIG1hdGNoQ2FjaGVbbmFtZV0gPSBuZXcgUmVnRXhwKFxuICAgIGAoPzpefDspICoke25hbWUucmVwbGFjZSgvWy1bXFxde30oKSorPy4sXFxcXF4kfCNcXHNdL2csIFwiXFxcXCQmXCIpfT0oW147XSopYCxcbiAgKTtcbn1cblxuZnVuY3Rpb24gcHVzaENvb2tpZShoZWFkZXJzOiBzdHJpbmdbXSwgY29va2llOiBDb29raWUpOiB2b2lkIHtcbiAgaWYgKGNvb2tpZS5vdmVyd3JpdGUpIHtcbiAgICBmb3IgKGxldCBpID0gaGVhZGVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgaWYgKGhlYWRlcnNbaV0uaW5kZXhPZihgJHtjb29raWUubmFtZX09YCkgPT09IDApIHtcbiAgICAgICAgaGVhZGVycy5zcGxpY2UoaSwgMSk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIGhlYWRlcnMucHVzaChjb29raWUudG9IZWFkZXIoKSk7XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlQ29va2llUHJvcGVydHkoXG4gIGtleTogc3RyaW5nLFxuICB2YWx1ZTogc3RyaW5nIHwgdW5kZWZpbmVkIHwgbnVsbCxcbik6IHZvaWQge1xuICBpZiAodmFsdWUgJiYgIUZJRUxEX0NPTlRFTlRfUkVHRVhQLnRlc3QodmFsdWUpKSB7XG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgVGhlICR7a2V5fSBvZiB0aGUgY29va2llICgke3ZhbHVlfSkgaXMgaW52YWxpZC5gKTtcbiAgfVxufVxuXG5jbGFzcyBDb29raWUgaW1wbGVtZW50cyBDb29raWVBdHRyaWJ1dGVzIHtcbiAgZG9tYWluPzogc3RyaW5nO1xuICBleHBpcmVzPzogRGF0ZTtcbiAgaHR0cE9ubHkgPSB0cnVlO1xuICBtYXhBZ2U/OiBudW1iZXI7XG4gIG5hbWU6IHN0cmluZztcbiAgb3ZlcndyaXRlID0gZmFsc2U7XG4gIHBhdGggPSBcIi9cIjtcbiAgc2FtZVNpdGU6IFwic3RyaWN0XCIgfCBcImxheFwiIHwgXCJub25lXCIgfCBib29sZWFuID0gZmFsc2U7XG4gIHNlY3VyZSA9IGZhbHNlO1xuICBzaWduZWQ/OiBib29sZWFuO1xuICB2YWx1ZTogc3RyaW5nO1xuXG4gIC8qKiBBIGxvZ2ljYWwgcmVwcmVzZW50YXRpb24gb2YgYSBjb29raWUsIHVzZWQgdG8gaW50ZXJuYWxseSBtYW5hZ2UgdGhlXG4gICAqIGNvb2tpZSBpbnN0YW5jZXMuICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICB2YWx1ZTogc3RyaW5nIHwgbnVsbCxcbiAgICBhdHRyaWJ1dGVzOiBDb29raWVBdHRyaWJ1dGVzLFxuICApIHtcbiAgICB2YWxpZGF0ZUNvb2tpZVByb3BlcnR5KFwibmFtZVwiLCBuYW1lKTtcbiAgICB2YWxpZGF0ZUNvb2tpZVByb3BlcnR5KFwidmFsdWVcIiwgdmFsdWUpO1xuICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgdGhpcy52YWx1ZSA9IHZhbHVlID8/IFwiXCI7XG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLCBhdHRyaWJ1dGVzKTtcbiAgICBpZiAoIXRoaXMudmFsdWUpIHtcbiAgICAgIHRoaXMuZXhwaXJlcyA9IG5ldyBEYXRlKDApO1xuICAgICAgdGhpcy5tYXhBZ2UgPSB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgdmFsaWRhdGVDb29raWVQcm9wZXJ0eShcInBhdGhcIiwgdGhpcy5wYXRoKTtcbiAgICB2YWxpZGF0ZUNvb2tpZVByb3BlcnR5KFwiZG9tYWluXCIsIHRoaXMuZG9tYWluKTtcbiAgICBpZiAoXG4gICAgICB0aGlzLnNhbWVTaXRlICYmIHR5cGVvZiB0aGlzLnNhbWVTaXRlID09PSBcInN0cmluZ1wiICYmXG4gICAgICAhU0FNRV9TSVRFX1JFR0VYUC50ZXN0KHRoaXMuc2FtZVNpdGUpXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFxuICAgICAgICBgVGhlIHNhbWVTaXRlIG9mIHRoZSBjb29raWUgKFwiJHt0aGlzLnNhbWVTaXRlfVwiKSBpcyBpbnZhbGlkLmAsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHRvSGVhZGVyKCk6IHN0cmluZyB7XG4gICAgbGV0IGhlYWRlciA9IHRoaXMudG9TdHJpbmcoKTtcbiAgICBpZiAodGhpcy5tYXhBZ2UpIHtcbiAgICAgIHRoaXMuZXhwaXJlcyA9IG5ldyBEYXRlKERhdGUubm93KCkgKyAodGhpcy5tYXhBZ2UgKiAxMDAwKSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMucGF0aCkge1xuICAgICAgaGVhZGVyICs9IGA7IHBhdGg9JHt0aGlzLnBhdGh9YDtcbiAgICB9XG4gICAgaWYgKHRoaXMuZXhwaXJlcykge1xuICAgICAgaGVhZGVyICs9IGA7IGV4cGlyZXM9JHt0aGlzLmV4cGlyZXMudG9VVENTdHJpbmcoKX1gO1xuICAgIH1cbiAgICBpZiAodGhpcy5kb21haW4pIHtcbiAgICAgIGhlYWRlciArPSBgOyBkb21haW49JHt0aGlzLmRvbWFpbn1gO1xuICAgIH1cbiAgICBpZiAodGhpcy5zYW1lU2l0ZSkge1xuICAgICAgaGVhZGVyICs9IGA7IHNhbWVzaXRlPSR7XG4gICAgICAgIHRoaXMuc2FtZVNpdGUgPT09IHRydWUgPyBcInN0cmljdFwiIDogdGhpcy5zYW1lU2l0ZS50b0xvd2VyQ2FzZSgpXG4gICAgICB9YDtcbiAgICB9XG4gICAgaWYgKHRoaXMuc2VjdXJlKSB7XG4gICAgICBoZWFkZXIgKz0gXCI7IHNlY3VyZVwiO1xuICAgIH1cbiAgICBpZiAodGhpcy5odHRwT25seSkge1xuICAgICAgaGVhZGVyICs9IFwiOyBodHRwb25seVwiO1xuICAgIH1cblxuICAgIHJldHVybiBoZWFkZXI7XG4gIH1cblxuICB0b1N0cmluZygpOiBzdHJpbmcge1xuICAgIHJldHVybiBgJHt0aGlzLm5hbWV9PSR7dGhpcy52YWx1ZX1gO1xuICB9XG59XG5cbi8qKiBBbiBpbnRlcmZhY2Ugd2hpY2ggYWxsb3dzIHNldHRpbmcgYW5kIGFjY2Vzc2luZyBjb29raWVzIHJlbGF0ZWQgdG8gYm90aCB0aGVcbiAqIGN1cnJlbnQgcmVxdWVzdCBhbmQgcmVzcG9uc2UuIEVhY2gge0BsaW5rY29kZSBDb250ZXh0fSBoYXMgYSBwcm9wZXJ0eVxuICogYC5jb29raWVzYCB3aGljaCBpcyBhbiBpbnN0YW5jZSBvZiB0aGlzIGNsYXNzLlxuICpcbiAqIEJlY2F1c2Ugb2FrIHN1cHBvcnRzIGF1dG9tYXRpYyBlbmNyeXB0aW9uLCBtb3N0IG1ldGhvZHMgKGV4Y2VwdCBgLmRlbGV0ZWApXG4gKiBhcmUgYXN5bmNocm9ub3VzLiBUaGlzIGlzIGJlY2F1c2Ugb2FrIGxldmVyYWdlcyB0aGUgV2ViIENyeXB0byBBUElzLCB3aGljaFxuICogYXJlIGFzeW5jaHJvbm91cyBieSBuYXR1cmUuXG4gKlxuICogIyMjIEV4YW1wbGVcbiAqXG4gKiBgYGB0c1xuICogaW1wb3J0IHsgQXBwbGljYXRpb24gfSBmcm9tIFwiaHR0cHM6Ly9kZW5vLmxhbmQveC9vYWsvbW9kLnRzXCI7XG4gKlxuICogY29uc3QgYXBwID0gbmV3IEFwcGxpY2F0aW9uKCk7XG4gKlxuICogYXBwLnVzZShhc3luYyAoY3R4KSA9PiB7XG4gKiAgIGZvciBhd2FpdCAoY29uc3QgY29va2llIG9mIGN0eC5jb29raWVzKSB7XG4gKiAgICAgLy8gaXRlcmF0aW5nIG92ZXIgZWFjaCBjb29raWVcbiAqICAgfVxuICogICBhd2FpdCBjdHguY29va2llLnNldChcIm15Q29va2llXCIsIFwiYSB2YWx1ZVwiKTsgLy8gc2V0dGluZyBvciB1cGRhdGluZyBhIGNvb2tpZVxuICogICBjb25zdCBpZCA9IGF3YWl0IGN0eC5jb29raWUuZ2V0KFwibXktaWRcIik7IC8vIGdldHRpbmcgYSB2YWx1ZSBvZiBhIGNvb2tpZSBpZiBwcmVzZW50XG4gKiAgIGN0eC5jb29raWUuZGVsZXRlKCk7XG4gKiB9KTtcbiAqIGBgYFxuICovXG5leHBvcnQgY2xhc3MgQ29va2llcyB7XG4gICNjb29raWVLZXlzPzogc3RyaW5nW107XG4gICNrZXlzPzogS2V5U3RhY2s7XG4gICNyZXF1ZXN0OiBSZXF1ZXN0O1xuICAjcmVzcG9uc2U6IFJlc3BvbnNlO1xuICAjc2VjdXJlPzogYm9vbGVhbjtcblxuICAjcmVxdWVzdEtleXMoKTogc3RyaW5nW10ge1xuICAgIGlmICh0aGlzLiNjb29raWVLZXlzKSB7XG4gICAgICByZXR1cm4gdGhpcy4jY29va2llS2V5cztcbiAgICB9XG4gICAgY29uc3QgcmVzdWx0ID0gdGhpcy4jY29va2llS2V5cyA9IFtdIGFzIHN0cmluZ1tdO1xuICAgIGNvbnN0IGhlYWRlciA9IHRoaXMuI3JlcXVlc3QuaGVhZGVycy5nZXQoXCJjb29raWVcIik7XG4gICAgaWYgKCFoZWFkZXIpIHtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuICAgIGxldCBtYXRjaGVzOiBSZWdFeHBFeGVjQXJyYXkgfCBudWxsO1xuICAgIHdoaWxlICgobWF0Y2hlcyA9IEtFWV9SRUdFWFAuZXhlYyhoZWFkZXIpKSkge1xuICAgICAgY29uc3QgWywga2V5XSA9IG1hdGNoZXM7XG4gICAgICByZXN1bHQucHVzaChrZXkpO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcmVxdWVzdDogUmVxdWVzdCxcbiAgICByZXNwb25zZTogUmVzcG9uc2UsXG4gICAgb3B0aW9uczogQ29va2llc09wdGlvbnMgPSB7fSxcbiAgKSB7XG4gICAgY29uc3QgeyBrZXlzLCBzZWN1cmUgfSA9IG9wdGlvbnM7XG4gICAgdGhpcy4ja2V5cyA9IGtleXM7XG4gICAgdGhpcy4jcmVxdWVzdCA9IHJlcXVlc3Q7XG4gICAgdGhpcy4jcmVzcG9uc2UgPSByZXNwb25zZTtcbiAgICB0aGlzLiNzZWN1cmUgPSBzZWN1cmU7XG4gIH1cblxuICAvKiogU2V0IGEgY29va2llIHRvIGJlIGRlbGV0ZWQgaW4gdGhlIHJlc3BvbnNlLiAgVGhpcyBpcyBhIFwic2hvcnRjdXRcIiB0b1xuICAgKiBgLnNldChuYW1lLCBudWxsLCBvcHRpb25zPylgLiAqL1xuICBkZWxldGUobmFtZTogc3RyaW5nLCBvcHRpb25zOiBDb29raWVzU2V0RGVsZXRlT3B0aW9ucyA9IHt9KTogYm9vbGVhbiB7XG4gICAgdGhpcy5zZXQobmFtZSwgbnVsbCwgb3B0aW9ucyk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKiogSXRlcmF0ZSBvdmVyIHRoZSByZXF1ZXN0J3MgY29va2llcywgeWllbGRpbmcgdXAgYSB0dXBsZSBjb250YWluaW5nIHRoZVxuICAgKiBrZXkgYW5kIHRoZSB2YWx1ZS5cbiAgICpcbiAgICogSWYgdGhlcmUgYXJlIGtleXMgc2V0IG9uIHRoZSBhcHBsaWNhdGlvbiwgb25seSBrZXlzIGFuZCB2YWx1ZXMgdGhhdCBhcmVcbiAgICogcHJvcGVybHkgc2lnbmVkIHdpbGwgYmUgcmV0dXJuZWQuICovXG4gIGFzeW5jICplbnRyaWVzKCk6IEFzeW5jSXRlcmFibGVJdGVyYXRvcjxbc3RyaW5nLCBzdHJpbmddPiB7XG4gICAgY29uc3Qga2V5cyA9IHRoaXMuI3JlcXVlc3RLZXlzKCk7XG4gICAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykge1xuICAgICAgY29uc3QgdmFsdWUgPSBhd2FpdCB0aGlzLmdldChrZXkpO1xuICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgIHlpZWxkIFtrZXksIHZhbHVlXTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBmb3JFYWNoKFxuICAgIGNhbGxiYWNrOiAoa2V5OiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcsIGNvb2tpZXM6IHRoaXMpID0+IHZvaWQsXG4gICAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgICB0aGlzQXJnOiBhbnkgPSBudWxsLFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBrZXlzID0gdGhpcy4jcmVxdWVzdEtleXMoKTtcbiAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7XG4gICAgICBjb25zdCB2YWx1ZSA9IGF3YWl0IHRoaXMuZ2V0KGtleSk7XG4gICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgY2FsbGJhY2suY2FsbCh0aGlzQXJnLCBrZXksIHZhbHVlLCB0aGlzKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKiogR2V0IHRoZSB2YWx1ZSBvZiBhIGNvb2tpZSBmcm9tIHRoZSByZXF1ZXN0LlxuICAgKlxuICAgKiBJZiB0aGUgY29va2llIGlzIHNpZ25lZCwgYW5kIHRoZSBzaWduYXR1cmUgaXMgaW52YWxpZCwgdGhlIGNvb2tpZSB3aWxsXG4gICAqIGJlIHNldCB0byBiZSBkZWxldGVkIGluIHRoZSB0aGUgcmVzcG9uc2UuICBJZiB0aGUgc2lnbmF0dXJlIHVzZXMgYW4gXCJvbGRcIlxuICAgKiBrZXksIHRoZSBjb29raWUgd2lsbCBiZSByZS1zaWduZWQgd2l0aCB0aGUgY3VycmVudCBrZXkgYW5kIGJlIGFkZGVkIHRvIHRoZVxuICAgKiByZXNwb25zZSB0byBiZSB1cGRhdGVkLiAqL1xuICBhc3luYyBnZXQoXG4gICAgbmFtZTogc3RyaW5nLFxuICAgIG9wdGlvbnM6IENvb2tpZXNHZXRPcHRpb25zID0ge30sXG4gICk6IFByb21pc2U8c3RyaW5nIHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3Qgc2lnbmVkID0gb3B0aW9ucy5zaWduZWQgPz8gISF0aGlzLiNrZXlzO1xuICAgIGNvbnN0IG5hbWVTaWcgPSBgJHtuYW1lfS5zaWdgO1xuXG4gICAgY29uc3QgaGVhZGVyID0gdGhpcy4jcmVxdWVzdC5oZWFkZXJzLmdldChcImNvb2tpZVwiKTtcbiAgICBpZiAoIWhlYWRlcikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBtYXRjaCA9IGhlYWRlci5tYXRjaChnZXRQYXR0ZXJuKG5hbWUpKTtcbiAgICBpZiAoIW1hdGNoKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IFssIHZhbHVlXSA9IG1hdGNoO1xuICAgIGlmICghc2lnbmVkKSB7XG4gICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuICAgIGNvbnN0IGRpZ2VzdCA9IGF3YWl0IHRoaXMuZ2V0KG5hbWVTaWcsIHsgc2lnbmVkOiBmYWxzZSB9KTtcbiAgICBpZiAoIWRpZ2VzdCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBkYXRhID0gYCR7bmFtZX09JHt2YWx1ZX1gO1xuICAgIGlmICghdGhpcy4ja2V5cykge1xuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcImtleXMgcmVxdWlyZWQgZm9yIHNpZ25lZCBjb29raWVzXCIpO1xuICAgIH1cbiAgICBjb25zdCBpbmRleCA9IGF3YWl0IHRoaXMuI2tleXMuaW5kZXhPZihkYXRhLCBkaWdlc3QpO1xuXG4gICAgaWYgKGluZGV4IDwgMCkge1xuICAgICAgdGhpcy5kZWxldGUobmFtZVNpZywgeyBwYXRoOiBcIi9cIiwgc2lnbmVkOiBmYWxzZSB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGluZGV4KSB7XG4gICAgICAgIC8vIHRoZSBrZXkgaGFzIFwiYWdlZFwiIGFuZCBuZWVkcyB0byBiZSByZS1zaWduZWRcbiAgICAgICAgdGhpcy5zZXQobmFtZVNpZywgYXdhaXQgdGhpcy4ja2V5cy5zaWduKGRhdGEpLCB7IHNpZ25lZDogZmFsc2UgfSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuICB9XG5cbiAgLyoqIEl0ZXJhdGUgb3ZlciB0aGUgcmVxdWVzdCdzIGNvb2tpZXMsIHlpZWxkaW5nIHVwIHRoZSBrZXlzLlxuICAgKlxuICAgKiBJZiB0aGVyZSBhcmUga2V5cyBzZXQgb24gdGhlIGFwcGxpY2F0aW9uLCBvbmx5IHRoZSBrZXlzIHRoYXQgYXJlIHByb3Blcmx5XG4gICAqIHNpZ25lZCB3aWxsIGJlIHJldHVybmVkLiAqL1xuICBhc3luYyAqa2V5cygpOiBBc3luY0l0ZXJhYmxlSXRlcmF0b3I8c3RyaW5nPiB7XG4gICAgY29uc3Qga2V5cyA9IHRoaXMuI3JlcXVlc3RLZXlzKCk7XG4gICAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykge1xuICAgICAgY29uc3QgdmFsdWUgPSBhd2FpdCB0aGlzLmdldChrZXkpO1xuICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgIHlpZWxkIGtleTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKiogU2V0IGEgY29va2llIGluIHRoZSByZXNwb25zZS5cbiAgICpcbiAgICogSWYgdGhlcmUgYXJlIGtleXMgc2V0IGluIHRoZSBhcHBsaWNhdGlvbiwgY29va2llcyB3aWxsIGJlIGF1dG9tYXRpY2FsbHlcbiAgICogc2lnbmVkLCB1bmxlc3Mgb3ZlcnJpZGRlbiBieSB0aGUgc2V0IG9wdGlvbnMuICBDb29raWVzIGNhbiBiZSBkZWxldGVkIGJ5XG4gICAqIHNldHRpbmcgdGhlIHZhbHVlIHRvIGBudWxsYC4gKi9cbiAgYXN5bmMgc2V0KFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICB2YWx1ZTogc3RyaW5nIHwgbnVsbCxcbiAgICBvcHRpb25zOiBDb29raWVzU2V0RGVsZXRlT3B0aW9ucyA9IHt9LFxuICApOiBQcm9taXNlPHRoaXM+IHtcbiAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy4jcmVxdWVzdDtcbiAgICBjb25zdCByZXNwb25zZSA9IHRoaXMuI3Jlc3BvbnNlO1xuICAgIGNvbnN0IGhlYWRlcnM6IHN0cmluZ1tdID0gW107XG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgcmVzcG9uc2UuaGVhZGVycy5lbnRyaWVzKCkpIHtcbiAgICAgIGlmIChrZXkgPT09IFwic2V0LWNvb2tpZVwiKSB7XG4gICAgICAgIGhlYWRlcnMucHVzaCh2YWx1ZSk7XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IHNlY3VyZSA9IHRoaXMuI3NlY3VyZSAhPT0gdW5kZWZpbmVkID8gdGhpcy4jc2VjdXJlIDogcmVxdWVzdC5zZWN1cmU7XG4gICAgY29uc3Qgc2lnbmVkID0gb3B0aW9ucy5zaWduZWQgPz8gISF0aGlzLiNrZXlzO1xuXG4gICAgaWYgKCFzZWN1cmUgJiYgb3B0aW9ucy5zZWN1cmUgJiYgIW9wdGlvbnMuaWdub3JlSW5zZWN1cmUpIHtcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXG4gICAgICAgIFwiQ2Fubm90IHNlbmQgc2VjdXJlIGNvb2tpZSBvdmVyIHVuZW5jcnlwdGVkIGNvbm5lY3Rpb24uXCIsXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IGNvb2tpZSA9IG5ldyBDb29raWUobmFtZSwgdmFsdWUsIG9wdGlvbnMpO1xuICAgIGNvb2tpZS5zZWN1cmUgPSBvcHRpb25zLnNlY3VyZSA/PyBzZWN1cmU7XG4gICAgcHVzaENvb2tpZShoZWFkZXJzLCBjb29raWUpO1xuXG4gICAgaWYgKHNpZ25lZCkge1xuICAgICAgaWYgKCF0aGlzLiNrZXlzKSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCIua2V5cyByZXF1aXJlZCBmb3Igc2lnbmVkIGNvb2tpZXMuXCIpO1xuICAgICAgfVxuICAgICAgY29va2llLnZhbHVlID0gYXdhaXQgdGhpcy4ja2V5cy5zaWduKGNvb2tpZS50b1N0cmluZygpKTtcbiAgICAgIGNvb2tpZS5uYW1lICs9IFwiLnNpZ1wiO1xuICAgICAgcHVzaENvb2tpZShoZWFkZXJzLCBjb29raWUpO1xuICAgIH1cblxuICAgIHJlc3BvbnNlLmhlYWRlcnMuZGVsZXRlKFwiU2V0LUNvb2tpZVwiKTtcbiAgICBmb3IgKGNvbnN0IGhlYWRlciBvZiBoZWFkZXJzKSB7XG4gICAgICByZXNwb25zZS5oZWFkZXJzLmFwcGVuZChcIlNldC1Db29raWVcIiwgaGVhZGVyKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvKiogSXRlcmF0ZSBvdmVyIHRoZSByZXF1ZXN0J3MgY29va2llcywgeWllbGRpbmcgdXAgZWFjaCB2YWx1ZS5cbiAgICpcbiAgICogSWYgdGhlcmUgYXJlIGtleXMgc2V0IG9uIHRoZSBhcHBsaWNhdGlvbiwgb25seSB0aGUgdmFsdWVzIHRoYXQgYXJlXG4gICAqIHByb3Blcmx5IHNpZ25lZCB3aWxsIGJlIHJldHVybmVkLiAqL1xuICBhc3luYyAqdmFsdWVzKCk6IEFzeW5jSXRlcmFibGVJdGVyYXRvcjxzdHJpbmc+IHtcbiAgICBjb25zdCBrZXlzID0gdGhpcy4jcmVxdWVzdEtleXMoKTtcbiAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7XG4gICAgICBjb25zdCB2YWx1ZSA9IGF3YWl0IHRoaXMuZ2V0KGtleSk7XG4gICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgeWllbGQgdmFsdWU7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqIEl0ZXJhdGUgb3ZlciB0aGUgcmVxdWVzdCdzIGNvb2tpZXMsIHlpZWxkaW5nIHVwIGEgdHVwbGUgY29udGFpbmluZyB0aGVcbiAgICoga2V5IGFuZCB0aGUgdmFsdWUuXG4gICAqXG4gICAqIElmIHRoZXJlIGFyZSBrZXlzIHNldCBvbiB0aGUgYXBwbGljYXRpb24sIG9ubHkga2V5cyBhbmQgdmFsdWVzIHRoYXQgYXJlXG4gICAqIHByb3Blcmx5IHNpZ25lZCB3aWxsIGJlIHJldHVybmVkLiAqL1xuICBhc3luYyAqW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpOiBBc3luY0l0ZXJhYmxlSXRlcmF0b3I8W3N0cmluZywgc3RyaW5nXT4ge1xuICAgIGNvbnN0IGtleXMgPSB0aGlzLiNyZXF1ZXN0S2V5cygpO1xuICAgIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHtcbiAgICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgdGhpcy5nZXQoa2V5KTtcbiAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICB5aWVsZCBba2V5LCB2YWx1ZV07XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgW1N5bWJvbC5mb3IoXCJEZW5vLmN1c3RvbUluc3BlY3RcIildKCkge1xuICAgIHJldHVybiBgJHt0aGlzLmNvbnN0cnVjdG9yLm5hbWV9IFtdYDtcbiAgfVxuXG4gIFtTeW1ib2wuZm9yKFwibm9kZWpzLnV0aWwuaW5zcGVjdC5jdXN0b21cIildKFxuICAgIGRlcHRoOiBudW1iZXIsXG4gICAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgICBvcHRpb25zOiBhbnksXG4gICAgaW5zcGVjdDogKHZhbHVlOiB1bmtub3duLCBvcHRpb25zPzogdW5rbm93bikgPT4gc3RyaW5nLFxuICApIHtcbiAgICBpZiAoZGVwdGggPCAwKSB7XG4gICAgICByZXR1cm4gb3B0aW9ucy5zdHlsaXplKGBbJHt0aGlzLmNvbnN0cnVjdG9yLm5hbWV9XWAsIFwic3BlY2lhbFwiKTtcbiAgICB9XG5cbiAgICBjb25zdCBuZXdPcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucywge1xuICAgICAgZGVwdGg6IG9wdGlvbnMuZGVwdGggPT09IG51bGwgPyBudWxsIDogb3B0aW9ucy5kZXB0aCAtIDEsXG4gICAgfSk7XG4gICAgcmV0dXJuIGAke29wdGlvbnMuc3R5bGl6ZSh0aGlzLmNvbnN0cnVjdG9yLm5hbWUsIFwic3BlY2lhbFwiKX0gJHtcbiAgICAgIGluc3BlY3QoW10sIG5ld09wdGlvbnMpXG4gICAgfWA7XG4gIH1cbn1cbiJdfQ==