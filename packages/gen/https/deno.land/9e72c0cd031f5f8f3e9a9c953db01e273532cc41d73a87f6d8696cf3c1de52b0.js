/*!
 * Adapted directly from https://github.com/brianc/node-buffer-writer
 * which is licensed as follows:
 *
 * The MIT License (MIT)
 *
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the
 * 'Software'), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to
 * the following conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 * IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
 * CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
 * TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
 * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
import { copy } from "../deps.ts";
import { readInt16BE, readInt32BE } from "../utils/utils.ts";
export class PacketReader {
    #buffer;
    #decoder = new TextDecoder();
    #offset = 0;
    constructor(buffer) {
        this.#buffer = buffer;
    }
    readInt16() {
        const value = readInt16BE(this.#buffer, this.#offset);
        this.#offset += 2;
        return value;
    }
    readInt32() {
        const value = readInt32BE(this.#buffer, this.#offset);
        this.#offset += 4;
        return value;
    }
    readByte() {
        return this.readBytes(1)[0];
    }
    readBytes(length) {
        const start = this.#offset;
        const end = start + length;
        const slice = this.#buffer.slice(start, end);
        this.#offset = end;
        return slice;
    }
    readAllBytes() {
        const slice = this.#buffer.slice(this.#offset);
        this.#offset = this.#buffer.length;
        return slice;
    }
    readString(length) {
        const bytes = this.readBytes(length);
        return this.#decoder.decode(bytes);
    }
    readCString() {
        const start = this.#offset;
        const end = this.#buffer.indexOf(0, start);
        const slice = this.#buffer.slice(start, end);
        this.#offset = end + 1;
        return this.#decoder.decode(slice);
    }
}
export class PacketWriter {
    #buffer;
    #encoder = new TextEncoder();
    #headerPosition;
    #offset;
    #size;
    constructor(size) {
        this.#size = size || 1024;
        this.#buffer = new Uint8Array(this.#size + 5);
        this.#offset = 5;
        this.#headerPosition = 0;
    }
    #ensure(size) {
        const remaining = this.#buffer.length - this.#offset;
        if (remaining < size) {
            const oldBuffer = this.#buffer;
            const newSize = oldBuffer.length + (oldBuffer.length >> 1) + size;
            this.#buffer = new Uint8Array(newSize);
            copy(oldBuffer, this.#buffer);
        }
    }
    addInt32(num) {
        this.#ensure(4);
        this.#buffer[this.#offset++] = (num >>> 24) & 0xff;
        this.#buffer[this.#offset++] = (num >>> 16) & 0xff;
        this.#buffer[this.#offset++] = (num >>> 8) & 0xff;
        this.#buffer[this.#offset++] = (num >>> 0) & 0xff;
        return this;
    }
    addInt16(num) {
        this.#ensure(2);
        this.#buffer[this.#offset++] = (num >>> 8) & 0xff;
        this.#buffer[this.#offset++] = (num >>> 0) & 0xff;
        return this;
    }
    addCString(string) {
        if (!string) {
            this.#ensure(1);
        }
        else {
            const encodedStr = this.#encoder.encode(string);
            this.#ensure(encodedStr.byteLength + 1);
            copy(encodedStr, this.#buffer, this.#offset);
            this.#offset += encodedStr.byteLength;
        }
        this.#buffer[this.#offset++] = 0;
        return this;
    }
    addChar(c) {
        if (c.length != 1) {
            throw new Error("addChar requires single character strings");
        }
        this.#ensure(1);
        copy(this.#encoder.encode(c), this.#buffer, this.#offset);
        this.#offset++;
        return this;
    }
    addString(string) {
        string = string || "";
        const encodedStr = this.#encoder.encode(string);
        this.#ensure(encodedStr.byteLength);
        copy(encodedStr, this.#buffer, this.#offset);
        this.#offset += encodedStr.byteLength;
        return this;
    }
    add(otherBuffer) {
        this.#ensure(otherBuffer.length);
        copy(otherBuffer, this.#buffer, this.#offset);
        this.#offset += otherBuffer.length;
        return this;
    }
    clear() {
        this.#offset = 5;
        this.#headerPosition = 0;
    }
    addHeader(code, last) {
        const origOffset = this.#offset;
        this.#offset = this.#headerPosition;
        this.#buffer[this.#offset++] = code;
        this.addInt32(origOffset - (this.#headerPosition + 1));
        this.#headerPosition = origOffset;
        this.#offset = origOffset;
        if (!last) {
            this.#ensure(5);
            this.#offset += 5;
        }
        return this;
    }
    join(code) {
        if (code) {
            this.addHeader(code, true);
        }
        return this.#buffer.slice(code ? 0 : 5, this.#offset);
    }
    flush(code) {
        const result = this.join(code);
        this.clear();
        return result;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicGFja2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBeUJHO0FBRUgsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLFlBQVksQ0FBQztBQUNsQyxPQUFPLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRTdELE1BQU0sT0FBTyxZQUFZO0lBQ3ZCLE9BQU8sQ0FBYTtJQUNwQixRQUFRLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztJQUM3QixPQUFPLEdBQUcsQ0FBQyxDQUFDO0lBRVosWUFBWSxNQUFrQjtRQUM1QixJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztJQUN4QixDQUFDO0lBRUQsU0FBUztRQUNQLE1BQU0sS0FBSyxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN0RCxJQUFJLENBQUMsT0FBTyxJQUFJLENBQUMsQ0FBQztRQUNsQixPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFFRCxTQUFTO1FBQ1AsTUFBTSxLQUFLLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3RELElBQUksQ0FBQyxPQUFPLElBQUksQ0FBQyxDQUFDO1FBQ2xCLE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVELFFBQVE7UUFDTixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDOUIsQ0FBQztJQUVELFNBQVMsQ0FBQyxNQUFjO1FBQ3RCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7UUFDM0IsTUFBTSxHQUFHLEdBQUcsS0FBSyxHQUFHLE1BQU0sQ0FBQztRQUMzQixNQUFNLEtBQUssR0FBRyxJQUFJLENB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bHkgZnJvbSBodHRwczovL2dpdGh1Yi5jb20vYnJpYW5jL25vZGUtYnVmZmVyLXdyaXRlclxuICogd2hpY2ggaXMgbGljZW5zZWQgYXMgZm9sbG93czpcbiAqXG4gKiBUaGUgTUlUIExpY2Vuc2UgKE1JVClcbiAqXG4gKlxuICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nXG4gKiBhIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGVcbiAqICdTb2Z0d2FyZScpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmdcbiAqIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCxcbiAqIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0b1xuICogcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvXG4gKiB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4gKlxuICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmVcbiAqIGluY2x1ZGVkIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuICpcbiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAnQVMgSVMnLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELFxuICogRVhQUkVTUyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GXG4gKiBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuXG4gKiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWVxuICogQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCxcbiAqIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFXG4gKiBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS5cbiAqL1xuXG5pbXBvcnQgeyBjb3B5IH0gZnJvbSBcIi4uL2RlcHMudHNcIjtcbmltcG9ydCB7IHJlYWRJbnQxNkJFLCByZWFkSW50MzJCRSB9IGZyb20gXCIuLi91dGlscy91dGlscy50c1wiO1xuXG5leHBvcnQgY2xhc3MgUGFja2V0UmVhZGVyIHtcbiAgI2J1ZmZlcjogVWludDhBcnJheTtcbiAgI2RlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoKTtcbiAgI29mZnNldCA9IDA7XG5cbiAgY29uc3RydWN0b3IoYnVmZmVyOiBVaW50OEFycmF5KSB7XG4gICAgdGhpcy4jYnVmZmVyID0gYnVmZmVyO1xuICB9XG5cbiAgcmVhZEludDE2KCk6IG51bWJlciB7XG4gICAgY29uc3QgdmFsdWUgPSByZWFkSW50MTZCRSh0aGlzLiNidWZmZXIsIHRoaXMuI29mZnNldCk7XG4gICAgdGhpcy4jb2Zmc2V0ICs9IDI7XG4gICAgcmV0dXJuIHZhbHVlO1xuICB9XG5cbiAgcmVhZEludDMyKCk6IG51bWJlciB7XG4gICAgY29uc3QgdmFsdWUgPSByZWFkSW50MzJCRSh0aGlzLiNidWZmZXIsIHRoaXMuI29mZnNldCk7XG4gICAgdGhpcy4jb2Zmc2V0ICs9IDQ7XG4gICAgcmV0dXJuIHZhbHVlO1xuICB9XG5cbiAgcmVhZEJ5dGUoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5yZWFkQnl0ZXMoMSlbMF07XG4gIH1cblxuICByZWFkQnl0ZXMobGVuZ3RoOiBudW1iZXIpOiBVaW50OEFycmF5IHtcbiAgICBjb25zdCBzdGFydCA9IHRoaXMuI29mZnNldDtcbiAgICBjb25zdCBlbmQgPSBzdGFydCArIGxlbmd0aDtcbiAgICBjb25zdCBzbGljZSA9IHRoaXMuI2J1ZmZlci5zbGljZShzdGFydCwgZW5kKTtcbiAgICB0aGlzLiNvZmZzZXQgPSBlbmQ7XG4gICAgcmV0dXJuIHNsaWNlO1xuICB9XG5cbiAgcmVhZEFsbEJ5dGVzKCk6IFVpbnQ4QXJyYXkge1xuICAgIGNvbnN0IHNsaWNlID0gdGhpcy4jYnVmZmVyLnNsaWNlKHRoaXMuI29mZnNldCk7XG4gICAgdGhpcy4jb2Zmc2V0ID0gdGhpcy4jYnVmZmVyLmxlbmd0aDtcbiAgICByZXR1cm4gc2xpY2U7XG4gIH1cblxuICByZWFkU3RyaW5nKGxlbmd0aDogbnVtYmVyKTogc3RyaW5nIHtcbiAgICBjb25zdCBieXRlcyA9IHRoaXMucmVhZEJ5dGVzKGxlbmd0aCk7XG4gICAgcmV0dXJuIHRoaXMuI2RlY29kZXIuZGVjb2RlKGJ5dGVzKTtcbiAgfVxuXG4gIHJlYWRDU3RyaW5nKCk6IHN0cmluZyB7XG4gICAgY29uc3Qgc3RhcnQgPSB0aGlzLiNvZmZzZXQ7XG4gICAgLy8gZmluZCBuZXh0IG51bGwgYnl0ZVxuICAgIGNvbnN0IGVuZCA9IHRoaXMuI2J1ZmZlci5pbmRleE9mKDAsIHN0YXJ0KTtcbiAgICBjb25zdCBzbGljZSA9IHRoaXMuI2J1ZmZlci5zbGljZShzdGFydCwgZW5kKTtcbiAgICAvLyBhZGQgKzEgZm9yIG51bGwgYnl0ZVxuICAgIHRoaXMuI29mZnNldCA9IGVuZCArIDE7XG4gICAgcmV0dXJuIHRoaXMuI2RlY29kZXIuZGVjb2RlKHNsaWNlKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgUGFja2V0V3JpdGVyIHtcbiAgI2J1ZmZlcjogVWludDhBcnJheTtcbiAgI2VuY29kZXIgPSBuZXcgVGV4dEVuY29kZXIoKTtcbiAgI2hlYWRlclBvc2l0aW9uOiBudW1iZXI7XG4gICNvZmZzZXQ6IG51bWJlcjtcbiAgI3NpemU6IG51bWJlcjtcblxuICBjb25zdHJ1Y3RvcihzaXplPzogbnVtYmVyKSB7XG4gICAgdGhpcy4jc2l6ZSA9IHNpemUgfHwgMTAyNDtcbiAgICB0aGlzLiNidWZmZXIgPSBuZXcgVWludDhBcnJheSh0aGlzLiNzaXplICsgNSk7XG4gICAgdGhpcy4jb2Zmc2V0ID0gNTtcbiAgICB0aGlzLiNoZWFkZXJQb3NpdGlvbiA9IDA7XG4gIH1cblxuICAjZW5zdXJlKHNpemU6IG51bWJlcikge1xuICAgIGNvbnN0IHJlbWFpbmluZyA9IHRoaXMuI2J1ZmZlci5sZW5ndGggLSB0aGlzLiNvZmZzZXQ7XG4gICAgaWYgKHJlbWFpbmluZyA8IHNpemUpIHtcbiAgICAgIGNvbnN0IG9sZEJ1ZmZlciA9IHRoaXMuI2J1ZmZlcjtcbiAgICAgIC8vIGV4cG9uZW50aWFsIGdyb3d0aCBmYWN0b3Igb2YgYXJvdW5kIH4gMS41XG4gICAgICAvLyBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8yMjY5MDYzLyNidWZmZXItZ3Jvd3RoLXN0cmF0ZWd5XG4gICAgICBjb25zdCBuZXdTaXplID0gb2xkQnVmZmVyLmxlbmd0aCArIChvbGRCdWZmZXIubGVuZ3RoID4+IDEpICsgc2l6ZTtcbiAgICAgIHRoaXMuI2J1ZmZlciA9IG5ldyBVaW50OEFycmF5KG5ld1NpemUpO1xuICAgICAgY29weShvbGRCdWZmZXIsIHRoaXMuI2J1ZmZlcik7XG4gICAgfVxuICB9XG5cbiAgYWRkSW50MzIobnVtOiBudW1iZXIpIHtcbiAgICB0aGlzLiNlbnN1cmUoNCk7XG4gICAgdGhpcy4jYnVmZmVyW3RoaXMuI29mZnNldCsrXSA9IChudW0gPj4+IDI0KSAmIDB4ZmY7XG4gICAgdGhpcy4jYnVmZmVyW3RoaXMuI29mZnNldCsrXSA9IChudW0gPj4+IDE2KSAmIDB4ZmY7XG4gICAgdGhpcy4jYnVmZmVyW3RoaXMuI29mZnNldCsrXSA9IChudW0gPj4+IDgpICYgMHhmZjtcbiAgICB0aGlzLiNidWZmZXJbdGhpcy4jb2Zmc2V0KytdID0gKG51bSA+Pj4gMCkgJiAweGZmO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgYWRkSW50MTYobnVtOiBudW1iZXIpIHtcbiAgICB0aGlzLiNlbnN1cmUoMik7XG4gICAgdGhpcy4jYnVmZmVyW3RoaXMuI29mZnNldCsrXSA9IChudW0gPj4+IDgpICYgMHhmZjtcbiAgICB0aGlzLiNidWZmZXJbdGhpcy4jb2Zmc2V0KytdID0gKG51bSA+Pj4gMCkgJiAweGZmO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgYWRkQ1N0cmluZyhzdHJpbmc/OiBzdHJpbmcpIHtcbiAgICAvLyBqdXN0IHdyaXRlIGEgMCBmb3IgZW1wdHkgb3IgbnVsbCBzdHJpbmdzXG4gICAgaWYgKCFzdHJpbmcpIHtcbiAgICAgIHRoaXMuI2Vuc3VyZSgxKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgZW5jb2RlZFN0ciA9IHRoaXMuI2VuY29kZXIuZW5jb2RlKHN0cmluZyk7XG4gICAgICB0aGlzLiNlbnN1cmUoZW5jb2RlZFN0ci5ieXRlTGVuZ3RoICsgMSk7IC8vICsxIGZvciBudWxsIHRlcm1pbmF0b3JcbiAgICAgIGNvcHkoZW5jb2RlZFN0ciwgdGhpcy4jYnVmZmVyLCB0aGlzLiNvZmZzZXQpO1xuICAgICAgdGhpcy4jb2Zmc2V0ICs9IGVuY29kZWRTdHIuYnl0ZUxlbmd0aDtcbiAgICB9XG5cbiAgICB0aGlzLiNidWZmZXJbdGhpcy4jb2Zmc2V0KytdID0gMDsgLy8gbnVsbCB0ZXJtaW5hdG9yXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBhZGRDaGFyKGM6IHN0cmluZykge1xuICAgIGlmIChjLmxlbmd0aCAhPSAxKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJhZGRDaGFyIHJlcXVpcmVzIHNpbmdsZSBjaGFyYWN0ZXIgc3RyaW5nc1wiKTtcbiAgICB9XG5cbiAgICB0aGlzLiNlbnN1cmUoMSk7XG4gICAgY29weSh0aGlzLiNlbmNvZGVyLmVuY29kZShjKSwgdGhpcy4jYnVmZmVyLCB0aGlzLiNvZmZzZXQpO1xuICAgIHRoaXMuI29mZnNldCsrO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgYWRkU3RyaW5nKHN0cmluZz86IHN0cmluZykge1xuICAgIHN0cmluZyA9IHN0cmluZyB8fCBcIlwiO1xuICAgIGNvbnN0IGVuY29kZWRTdHIgPSB0aGlzLiNlbmNvZGVyLmVuY29kZShzdHJpbmcpO1xuICAgIHRoaXMuI2Vuc3VyZShlbmNvZGVkU3RyLmJ5dGVMZW5ndGgpO1xuICAgIGNvcHkoZW5jb2RlZFN0ciwgdGhpcy4jYnVmZmVyLCB0aGlzLiNvZmZzZXQpO1xuICAgIHRoaXMuI29mZnNldCArPSBlbmNvZGVkU3RyLmJ5dGVMZW5ndGg7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBhZGQob3RoZXJCdWZmZXI6IFVpbnQ4QXJyYXkpIHtcbiAgICB0aGlzLiNlbnN1cmUob3RoZXJCdWZmZXIubGVuZ3RoKTtcbiAgICBjb3B5KG90aGVyQnVmZmVyLCB0aGlzLiNidWZmZXIsIHRoaXMuI29mZnNldCk7XG4gICAgdGhpcy4jb2Zmc2V0ICs9IG90aGVyQnVmZmVyLmxlbmd0aDtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGNsZWFyKCkge1xuICAgIHRoaXMuI29mZnNldCA9IDU7XG4gICAgdGhpcy4jaGVhZGVyUG9zaXRpb24gPSAwO1xuICB9XG5cbiAgLy8gYXBwZW5kcyBhIGhlYWRlciBibG9jayB0byBhbGwgdGhlIHdyaXR0ZW4gZGF0YSBzaW5jZSB0aGUgbGFzdFxuICAvLyBzdWJzZXF1ZW50IGhlYWRlciBvciB0byB0aGUgYmVnaW5uaW5nIGlmIHRoZXJlIGlzIG9ubHkgb25lIGRhdGEgYmxvY2tcbiAgYWRkSGVhZGVyKGNvZGU6IG51bWJlciwgbGFzdD86IGJvb2xlYW4pIHtcbiAgICBjb25zdCBvcmlnT2Zmc2V0ID0gdGhpcy4jb2Zmc2V0O1xuICAgIHRoaXMuI29mZnNldCA9IHRoaXMuI2hlYWRlclBvc2l0aW9uO1xuICAgIHRoaXMuI2J1ZmZlclt0aGlzLiNvZmZzZXQrK10gPSBjb2RlO1xuICAgIC8vIGxlbmd0aCBpcyBldmVyeXRoaW5nIGluIHRoaXMgcGFja2V0IG1pbnVzIHRoZSBjb2RlXG4gICAgdGhpcy5hZGRJbnQzMihvcmlnT2Zmc2V0IC0gKHRoaXMuI2hlYWRlclBvc2l0aW9uICsgMSkpO1xuICAgIC8vIHNldCBuZXh0IGhlYWRlciBwb3NpdGlvblxuICAgIHRoaXMuI2hlYWRlclBvc2l0aW9uID0gb3JpZ09mZnNldDtcbiAgICAvLyBtYWtlIHNwYWNlIGZvciBuZXh0IGhlYWRlclxuICAgIHRoaXMuI29mZnNldCA9IG9yaWdPZmZzZXQ7XG4gICAgaWYgKCFsYXN0KSB7XG4gICAgICB0aGlzLiNlbnN1cmUoNSk7XG4gICAgICB0aGlzLiNvZmZzZXQgKz0gNTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBqb2luKGNvZGU/OiBudW1iZXIpIHtcbiAgICBpZiAoY29kZSkge1xuICAgICAgdGhpcy5hZGRIZWFkZXIoY29kZSwgdHJ1ZSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLiNidWZmZXIuc2xpY2UoY29kZSA/IDAgOiA1LCB0aGlzLiNvZmZzZXQpO1xuICB9XG5cbiAgZmx1c2goY29kZT86IG51bWJlcikge1xuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuam9pbihjb2RlKTtcbiAgICB0aGlzLmNsZWFyKCk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxufVxuIl19