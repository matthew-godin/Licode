import { Context } from "./context.ts";
import { assert, STATUS_TEXT } from "./deps.ts";
import { hasNativeHttp, HttpServerNative, NativeRequest, } from "./http_server_native.ts";
import { HttpServerStd } from "./http_server_std.ts";
import { KeyStack } from "./keyStack.ts";
import { compose } from "./middleware.ts";
import { cloneState } from "./structured_clone.ts";
import { isConn } from "./util.ts";
const ADDR_REGEXP = /^\[?([^\]]*)\]?:([0-9]{1,5})$/;
export class ApplicationErrorEvent extends ErrorEvent {
    context;
    constructor(eventInitDict) {
        super("error", eventInitDict);
        this.context = eventInitDict.context;
    }
}
function logErrorListener({ error, context }) {
    if (error instanceof Error) {
        console.error(`[uncaught oak error]: ${error.name} - ${error.message}`);
    }
    else {
        console.error(`[uncaught oak error]\n`, error);
    }
    if (context) {
        console.error(`\nrequest:`, {
            url: context.request.url.toString(),
            method: context.request.method,
            hasBody: context.request.hasBody,
        });
        console.error(`response:`, {
            status: context.response.status,
            type: context.response.type,
            hasBody: !!context.response.body,
            writable: context.response.writable,
        });
    }
    if (error instanceof Error && error.stack) {
        console.error(`\n${error.stack.split("\n").slice(1).join("\n")}`);
    }
}
export class ApplicationListenEvent extends Event {
    hostname;
    port;
    secure;
    serverType;
    constructor(eventInitDict) {
        super("listen", eventInitDict);
        this.hostname = eventInitDict.hostname;
        this.port = eventInitDict.port;
        this.secure = eventInitDict.secure;
        this.serverType = eventInitDict.serverType;
    }
}
export class Application extends EventTarget {
    #composedMiddleware;
    #contextState;
    #eventHandler;
    #keys;
    #middleware = [];
    #serverConstructor;
    get keys() {
        return this.#keys;
    }
    set keys(keys) {
        if (!keys) {
            this.#keys = undefined;
            return;
        }
        else if (Array.isArray(keys)) {
            this.#keys = new KeyStack(keys);
        }
        else {
            this.#keys = keys;
        }
    }
    proxy;
    state;
    constructor(options = {}) {
        super();
        const { state, keys, proxy, serverConstructor = hasNativeHttp() ? HttpServerNative : HttpServerStd, contextState = "clone", logErrors = true, } = options;
        this.proxy = proxy ?? false;
        this.keys = keys;
        this.state = state ?? {};
        this.#serverConstructor = serverConstructor;
        this.#contextState = contextState;
        if (logErrors) {
            this.addEventListener("error", logErrorListener);
        }
    }
    #getComposed() {
        if (!this.#composedMiddleware) {
            this.#composedMiddleware = compose(this.#middleware);
        }
        return this.#composedMiddleware;
    }
    #getContextState() {
        switch (this.#contextState) {
            case "alias":
                return this.state;
            case "clone":
                return cloneState(this.state);
            case "empty":
                return {};
            case "prototype":
                return Object.create(this.state);
        }
    }
    #handleError(context, error) {
        if (!(error instanceof Error)) {
            error = new Error(`non-error thrown: ${JSON.stringify(error)}`);
        }
        const { message } = error;
        this.dispatchEvent(new ApplicationErrorEvent({ context, message, error }));
        if (!context.response.writable) {
            return;
        }
        for (const key of context.response.headers.keys()) {
            context.response.headers.delete(key);
        }
        if (error.headers && error.headers instanceof Headers) {
            for (const [key, value] of error.headers) {
                context.response.headers.set(key, value);
            }
        }
        context.response.type = "text";
        const status = context.response.status =
            Deno.errors && error instanceof Deno.errors.NotFound
                ? 404
                : error.status && typeof error.status === "number"
                    ? error.status
                    : 500;
        context.response.body = error.expose
            ? error.message
            : STATUS_TEXT.get(status);
    }
    async #handleRequest(request, secure, state) {
        const context = new Context(this, request, this.#getContextState(), secure);
        let resolve;
        const handlingPromise = new Promise((res) => resolve = res);
        state.handling.add(handlingPromise);
        if (!state.closing && !state.closed) {
            try {
                await this.#getComposed()(context);
            }
            catch (err) {
                this.#handleError(context, err);
            }
        }
        if (context.respond === false) {
            context.response.destroy();
            resolve();
            state.handling.delete(handlingPromise);
            return;
        }
        let closeResources = true;
        let response;
        try {
            if (request instanceof NativeRequest) {
                closeResources = false;
                response = await context.response.toDomResponse();
            }
            else {
                response = await context.response.toServerResponse();
            }
        }
        catch (err) {
            this.#handleError(context, err);
            if (request instanceof NativeRequest) {
                response = await context.response.toDomResponse();
            }
            else {
                response = await context.response.toServerResponse();
            }
        }
        assert(response);
        try {
            await request.respond(response);
        }
        catch (err) {
            this.#handleError(context, err);
        }
        finally {
            context.response.destroy(closeResources);
            resolve();
            state.handling.delete(handlingPromise);
            if (state.closing) {
                state.server.close();
                state.closed = true;
            }
        }
    }
    addEventListener(type, listener, options) {
        super.addEventListener(type, listener, options);
    }
    fetchEventHandler({ proxy = true, secure = true } = {}) {
        if (this.#eventHandler) {
            return this.#eventHandler;
        }
        this.proxy = proxy;
        return this.#eventHandler = {
            handleEvent: async (requestEvent) => {
                let resolve;
                let reject;
                const responsePromise = new Promise((res, rej) => {
                    resolve = res;
                    reject = rej;
                });
                const respondedPromise = requestEvent.respondWith(responsePromise);
                const response = await this.handle(requestEvent.request, undefined, secure);
                if (response) {
                    resolve(response);
                }
                else {
                    reject(new Error("No response returned from app handler."));
                }
                try {
                    await respondedPromise;
                }
                catch (error) {
                    this.dispatchEvent(new ApplicationErrorEvent({ error }));
                }
            },
        };
    }
    handle = (async (request, secureOrConn, secure = false) => {
        if (!this.#middleware.length) {
            throw new TypeError("There is no middleware to process requests.");
        }
        let contextRequest;
        if (request instanceof Request) {
            assert(isConn(secureOrConn) || typeof secureOrConn === "undefined");
            contextRequest = new NativeRequest({
                request,
                respondWith() {
                    return Promise.resolve(undefined);
                },
            }, { conn: secureOrConn });
        }
        else {
            assert(typeof secureOrConn === "boolean" ||
                typeof secureOrConn === "undefined");
            secure = secureOrConn ?? false;
            contextRequest = request;
        }
        const context = new Context(this, contextRequest, this.#getContextState(), secure);
        try {
            await this.#getComposed()(context);
        }
        catch (err) {
            this.#handleError(context, err);
        }
        if (context.respond === false) {
            context.response.destroy();
            return;
        }
        try {
            const response = contextRequest instanceof NativeRequest
                ? await context.response.toDomResponse()
                : await context.response.toServerResponse();
            context.response.destroy(false);
            return response;
        }
        catch (err) {
            this.#handleError(context, err);
            throw err;
        }
    });
    async listen(options) {
        if (!this.#middleware.length) {
            throw new TypeError("There is no middleware to process requests.");
        }
        if (typeof options === "string") {
            const match = ADDR_REGEXP.exec(options);
            if (!match) {
                throw TypeError(`Invalid address passed: "${options}"`);
            }
            const [, hostname, portStr] = match;
            options = { hostname, port: parseInt(portStr, 10) };
        }
        const server = new this.#serverConstructor(this, options);
        const { signal } = options;
        const state = {
            closed: false,
            closing: false,
            handling: new Set(),
            server,
        };
        if (signal) {
            signal.addEventListener("abort", () => {
                if (!state.handling.size) {
                    server.close();
                    state.closed = true;
                }
                state.closing = true;
            });
        }
        const { hostname, port, secure = false } = options;
        const serverType = server instanceof HttpServerStd
            ? "std"
            : server instanceof HttpServerNative
                ? "native"
                : "custom";
        this.dispatchEvent(new ApplicationListenEvent({ hostname, port, secure, serverType }));
        try {
            for await (const request of server) {
                this.#handleRequest(request, secure, state);
            }
            await Promise.all(state.handling);
        }
        catch (error) {
            const message = error instanceof Error
                ? error.message
                : "Application Error";
            this.dispatchEvent(new ApplicationErrorEvent({ message, error }));
        }
    }
    use(...middleware) {
        this.#middleware.push(...middleware);
        this.#composedMiddleware = undefined;
        return this;
    }
    [Symbol.for("Deno.customInspect")](inspect) {
        const { keys, proxy, state } = this;
        return `${this.constructor.name} ${inspect({ "#middleware": this.#middleware, keys, proxy, state })}`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbGljYXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhcHBsaWNhdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxNQUFNLEVBQVUsV0FBVyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3hELE9BQU8sRUFDTCxhQUFhLEVBQ2IsZ0JBQWdCLEVBQ2hCLGFBQWEsR0FDZCxNQUFNLHlCQUF5QixDQUFDO0FBQ2pDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUVyRCxPQUFPLEVBQU8sUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzlDLE9BQU8sRUFBRSxPQUFPLEVBQWMsTUFBTSxpQkFBaUIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFNbkQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQTRKbkMsTUFBTSxXQUFXLEdBQUcsK0JBQStCLENBQUM7QUFFcEQsTUFBTSxPQUFPLHFCQUNYLFNBQVEsVUFBVTtJQUNsQixPQUFPLENBQWtCO0lBRXpCLFlBQVksYUFBK0M7UUFDekQsS0FBSyxDQUFDLE9BQU8sRUFBRSxhQUFhLENBQUMsQ0FBQztRQUM5QixJQUFJLENBQUMsT0FBTyxHQUFHLGFBQWEsQ0FBQyxPQUFPLENBQUM7SUFDdkMsQ0FBQztDQUNGO0FBRUQsU0FBUyxnQkFBZ0IsQ0FDdkIsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFnQztJQUVoRCxJQUFJLEtBQUssWUFBWSxLQUFLLEVBQUU7UUFDMUIsT0FBTyxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsS0FBSyxDQUFDLElBQUksTUFBTSxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztLQUN6RTtTQUFNO1FBQ0wsT0FBTyxDQUFDLEtBQUssQ0FBQyx3QkFBd0IsRUFBRSxLQUFLLENBQUMsQ0FB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ZixDQUFDLENBQUMsbUJBQW1CLENBQUM7WUFDeEIsSUFBSSxDQUFDLGFBQWEsQ0FDaEIsSUFBSSxxQkFBcUIsQ0FBQyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUM5QyxDQUFDO1NBQ0g7SUFDSCxDQUFDO0lBNEJELEdBQUcsQ0FDRCxHQUFHLFVBQTJDO1FBRTlDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsVUFBVSxDQUFDLENBQUM7UUFDckMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLFNBQVMsQ0FBQztRQUVyQyxPQUFPLElBQXdCLENBQUM7SUFDbEMsQ0FBQztJQUVELENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsT0FBbUM7UUFDcEUsTUFBTSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBQ3BDLE9BQU8sR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksSUFDN0IsT0FBTyxDQUFDLEVBQUUsYUFBYSxFQUFFLElBQUksQ0FBQyxXQUFXLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FDakUsRUFBRSxDQUFDO0lBQ0wsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTgtMjAyMSB0aGUgb2FrIGF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuIE1JVCBsaWNlbnNlLlxuXG5pbXBvcnQgeyBDb250ZXh0IH0gZnJvbSBcIi4vY29udGV4dC50c1wiO1xuaW1wb3J0IHsgYXNzZXJ0LCBTdGF0dXMsIFNUQVRVU19URVhUIH0gZnJvbSBcIi4vZGVwcy50c1wiO1xuaW1wb3J0IHtcbiAgaGFzTmF0aXZlSHR0cCxcbiAgSHR0cFNlcnZlck5hdGl2ZSxcbiAgTmF0aXZlUmVxdWVzdCxcbn0gZnJvbSBcIi4vaHR0cF9zZXJ2ZXJfbmF0aXZlLnRzXCI7XG5pbXBvcnQgeyBIdHRwU2VydmVyU3RkIH0gZnJvbSBcIi4vaHR0cF9zZXJ2ZXJfc3RkLnRzXCI7XG5pbXBvcnQgdHlwZSB7IFNlcnZlclJlcXVlc3QsIFNlcnZlclJlc3BvbnNlIH0gZnJvbSBcIi4vaHR0cF9zZXJ2ZXJfc3RkLnRzXCI7XG5pbXBvcnQgeyBLZXksIEtleVN0YWNrIH0gZnJvbSBcIi4va2V5U3RhY2sudHNcIjtcbmltcG9ydCB7IGNvbXBvc2UsIE1pZGRsZXdhcmUgfSBmcm9tIFwiLi9taWRkbGV3YXJlLnRzXCI7XG5pbXBvcnQgeyBjbG9uZVN0YXRlIH0gZnJvbSBcIi4vc3RydWN0dXJlZF9jbG9uZS50c1wiO1xuaW1wb3J0IHtcbiAgRmV0Y2hFdmVudExpc3RlbmVyT2JqZWN0LFxuICBTZXJ2ZXIsXG4gIFNlcnZlckNvbnN0cnVjdG9yLFxufSBmcm9tIFwiLi90eXBlcy5kLnRzXCI7XG5pbXBvcnQgeyBpc0Nvbm4gfSBmcm9tIFwiLi91dGlsLnRzXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTGlzdGVuT3B0aW9uc0Jhc2UgZXh0ZW5kcyBEZW5vLkxpc3Rlbk9wdGlvbnMge1xuICBzZWN1cmU/OiBmYWxzZTtcbiAgc2lnbmFsPzogQWJvcnRTaWduYWw7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTGlzdGVuT3B0aW9uc1RscyBleHRlbmRzIERlbm8uTGlzdGVuVGxzT3B0aW9ucyB7XG4gIC8qKiBBcHBsaWNhdGlvbi1MYXllciBQcm90b2NvbCBOZWdvdGlhdGlvbiAoQUxQTikgcHJvdG9jb2xzIHRvIGFubm91bmNlIHRvXG4gICAqIHRoZSBjbGllbnQuIElmIG5vdCBzcGVjaWZpZWQsIG5vIEFMUE4gZXh0ZW5zaW9uIHdpbGwgYmUgaW5jbHVkZWQgaW4gdGhlXG4gICAqIFRMUyBoYW5kc2hha2UuXG4gICAqXG4gICAqICoqTk9URSoqIHRoaXMgaXMgcGFydCBvZiB0aGUgbmF0aXZlIEhUVFAgc2VydmVyIGluIERlbm8gMS45IG9yIGxhdGVyLFxuICAgKiB3aGljaCByZXF1aXJlcyB0aGUgYC0tdW5zdGFibGVgIGZsYWcgdG8gYmUgYXZhaWxhYmxlLlxuICAgKi9cbiAgYWxwblByb3RvY29scz86IHN0cmluZ1tdO1xuICBzZWN1cmU6IHRydWU7XG4gIHNpZ25hbD86IEFib3J0U2lnbmFsO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEhhbmRsZU1ldGhvZCB7XG4gIC8qKiBIYW5kbGUgYW4gaW5kaXZpZHVhbCBzZXJ2ZXIgcmVxdWVzdCwgcmV0dXJuaW5nIHRoZSBzZXJ2ZXIgcmVzcG9uc2UuICBUaGlzXG4gICAqIGlzIHNpbWlsYXIgdG8gYC5saXN0ZW4oKWAsIGJ1dCBvcGVuaW5nIHRoZSBjb25uZWN0aW9uIGFuZCByZXRyaWV2aW5nXG4gICAqIHJlcXVlc3RzIGFyZSBub3QgdGhlIHJlc3BvbnNpYmlsaXR5IG9mIHRoZSBhcHBsaWNhdGlvbi4gIElmIHRoZSBnZW5lcmF0ZWRcbiAgICogY29udGV4dCBnZXRzIHNldCB0byBub3QgdG8gcmVzcG9uZCwgdGhlbiB0aGUgbWV0aG9kIHJlc29sdmVzIHdpdGhcbiAgICogYHVuZGVmaW5lZGAsIG90aGVyd2lzZSBpdCByZXNvbHZlcyB3aXRoIGEgcmVxdWVzdCB0aGF0IGlzIGNvbXBhdGlibGUgd2l0aFxuICAgKiBgc3RkL2h0dHAvc2VydmVyYC4gKi9cbiAgKFxuICAgIHJlcXVlc3Q6IFNlcnZlclJlcXVlc3QsXG4gICAgc2VjdXJlPzogYm9vbGVhbixcbiAgKTogUHJvbWlzZTxTZXJ2ZXJSZXNwb25zZSB8IHVuZGVmaW5lZD47XG4gIC8qKiBIYW5kbGUgYW4gaW5kaXZpZHVhbCBzZXJ2ZXIgcmVxdWVzdCwgcmV0dXJuaW5nIHRoZSBzZXJ2ZXIgcmVzcG9uc2UuICBUaGlzXG4gICAqIGlzIHNpbWlsYXIgdG8gYC5saXN0ZW4oKWAsIGJ1dCBvcGVuaW5nIHRoZSBjb25uZWN0aW9uIGFuZCByZXRyaWV2aW5nXG4gICAqIHJlcXVlc3RzIGFyZSBub3QgdGhlIHJlc3BvbnNpYmlsaXR5IG9mIHRoZSBhcHBsaWNhdGlvbi4gIElmIHRoZSBnZW5lcmF0ZWRcbiAgICogY29udGV4dCBnZXRzIHNldCB0byBub3QgdG8gcmVzcG9uZCwgdGhlbiB0aGUgbWV0aG9kIHJlc29sdmVzIHdpdGhcbiAgICogYHVuZGVmaW5lZGAsIG90aGVyd2lzZSBpdCByZXNvbHZlcyB3aXRoIGEgcmVxdWVzdCB0aGF0IGlzIGNvbXBhdGlibGUgd2l0aFxuICAgKiBgc3RkL2h0dHAvc2VydmVyYC4gKi9cbiAgKFxuICAgIHJlcXVlc3Q6IFJlcXVlc3QsXG4gICAgY29ubj86IERlbm8uQ29ubixcbiAgICBzZWN1cmU/OiBib29sZWFuLFxuICApOiBQcm9taXNlPFJlc3BvbnNlIHwgdW5kZWZpbmVkPjtcbn1cblxuZXhwb3J0IHR5cGUgTGlzdGVuT3B0aW9ucyA9IExpc3Rlbk9wdGlvbnNUbHMgfCBMaXN0ZW5PcHRpb25zQmFzZTtcblxuaW50ZXJmYWNlIEFwcGxpY2F0aW9uRXJyb3JFdmVudExpc3RlbmVyPFMgZXh0ZW5kcyBBUywgQVM+IHtcbiAgKGV2dDogQXBwbGljYXRpb25FcnJvckV2ZW50PFMsIEFTPik6IHZvaWQgfCBQcm9taXNlPHZvaWQ+O1xufVxuXG5pbnRlcmZhY2UgQXBwbGljYXRpb25FcnJvckV2ZW50TGlzdGVuZXJPYmplY3Q8UyBleHRlbmRzIEFTLCBBUz4ge1xuICBoYW5kbGVFdmVudChldnQ6IEFwcGxpY2F0aW9uRXJyb3JFdmVudDxTLCBBUz4pOiB2b2lkIHwgUHJvbWlzZTx2b2lkPjtcbn1cblxuaW50ZXJmYWNlIEFwcGxpY2F0aW9uRXJyb3JFdmVudEluaXQ8UyBleHRlbmRzIEFTLCBBUyBleHRlbmRzIFN0YXRlPlxuICBleHRlbmRzIEVycm9yRXZlbnRJbml0IHtcbiAgY29udGV4dD86IENvbnRleHQ8UywgQVM+O1xufVxuXG50eXBlIEFwcGxpY2F0aW9uRXJyb3JFdmVudExpc3RlbmVyT3JFdmVudExpc3RlbmVyT2JqZWN0PFMgZXh0ZW5kcyBBUywgQVM+ID1cbiAgfCBBcHBsaWNhdGlvbkVycm9yRXZlbnRMaXN0ZW5lcjxTLCBBUz5cbiAgfCBBcHBsaWNhdGlvbkVycm9yRXZlbnRMaXN0ZW5lck9iamVjdDxTLCBBUz47XG5cbmludGVyZmFjZSBBcHBsaWNhdGlvbkxpc3RlbkV2ZW50TGlzdGVuZXIge1xuICAoZXZ0OiBBcHBsaWNhdGlvbkxpc3RlbkV2ZW50KTogdm9pZCB8IFByb21pc2U8dm9pZD47XG59XG5cbmludGVyZmFjZSBBcHBsaWNhdGlvbkxpc3RlbkV2ZW50TGlzdGVuZXJPYmplY3Qge1xuICBoYW5kbGVFdmVudChldnQ6IEFwcGxpY2F0aW9uTGlzdGVuRXZlbnQpOiB2b2lkIHwgUHJvbWlzZTx2b2lkPjtcbn1cblxuaW50ZXJmYWNlIEFwcGxpY2F0aW9uTGlzdGVuRXZlbnRJbml0IGV4dGVuZHMgRXZlbnRJbml0IHtcbiAgaG9zdG5hbWU/OiBzdHJpbmc7XG4gIHBvcnQ6IG51bWJlcjtcbiAgc2VjdXJlOiBib29sZWFuO1xuICBzZXJ2ZXJUeXBlOiBcInN0ZFwiIHwgXCJuYXRpdmVcIiB8IFwiY3VzdG9tXCI7XG59XG5cbnR5cGUgQXBwbGljYXRpb25MaXN0ZW5FdmVudExpc3RlbmVyT3JFdmVudExpc3RlbmVyT2JqZWN0ID1cbiAgfCBBcHBsaWNhdGlvbkxpc3RlbkV2ZW50TGlzdGVuZXJcbiAgfCBBcHBsaWNhdGlvbkxpc3RlbkV2ZW50TGlzdGVuZXJPYmplY3Q7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBwbGljYXRpb25PcHRpb25zPFM+IHtcbiAgLyoqIERldGVybWluZSBob3cgd2hlbiBjcmVhdGluZyBhIG5ldyBjb250ZXh0LCB0aGUgc3RhdGUgZnJvbSB0aGUgYXBwbGljYXRpb25cbiAgICogc2hvdWxkIGJlIGFwcGxpZWQuIEEgdmFsdWUgb2YgYFwiY2xvbmVcImAgd2lsbCBzZXQgdGhlIHN0YXRlIGFzIGEgY2xvbmUgb2ZcbiAgICogdGhlIGFwcCBzdGF0ZS4gQW55IG5vbi1jbG9uZWFibGUgb3Igbm9uLWVudW1lcmFibGUgcHJvcGVydGllcyB3aWxsIG5vdCBiZVxuICAgKiBjb3BpZWQuIEEgdmFsdWUgb2YgYFwicHJvdG90eXBlXCJgIG1lYW5zIHRoYXQgdGhlIGFwcGxpY2F0aW9uJ3Mgc3RhdGUgd2lsbCBiZVxuICAgKiB1c2VkIGFzIHRoZSBwcm90b3R5cGUgb2YgdGhlIHRoZSBjb250ZXh0J3Mgc3RhdGUsIG1lYW5pbmcgc2hhbGxvd1xuICAgKiBwcm9wZXJ0aWVzIG9uIHRoZSBjb250ZXh0J3Mgc3RhdGUgd2lsbCBub3QgYmUgcmVmbGVjdGVkIGluIHRoZVxuICAgKiBhcHBsaWNhdGlvbidzIHN0YXRlLiBBIHZhbHVlIG9mIGBcImFsaWFzXCJgIG1lYW5zIHRoYXQgYXBwbGljYXRpb24ncyBgLnN0YXRlYFxuICAgKiBhbmQgdGhlIGNvbnRleHQncyBgLnN0YXRlYCB3aWxsIGJlIGEgcmVmZXJlbmNlIHRvIHRoZSBzYW1lIG9iamVjdC4gQSB2YWx1ZVxuICAgKiBvZiBgXCJlbXB0eVwiYCB3aWxsIGluaXRpYWxpemUgdGhlIGNvbnRleHQncyBgLnN0YXRlYCB3aXRoIGFuIGVtcHR5IG9iamVjdC5cbiAgICpcbiAgICogVGhlIGRlZmF1bHQgdmFsdWUgaXMgYFwiY2xvbmVcImAuXG4gICAqL1xuICBjb250ZXh0U3RhdGU/OiBcImNsb25lXCIgfCBcInByb3RvdHlwZVwiIHwgXCJhbGlhc1wiIHwgXCJlbXB0eVwiO1xuXG4gIC8qKiBBbiBpbml0aWFsIHNldCBvZiBrZXlzIChvciBpbnN0YW5jZSBvZiBgS2V5R3JpcGApIHRvIGJlIHVzZWQgZm9yIHNpZ25pbmdcbiAgICogY29va2llcyBwcm9kdWNlZCBieSB0aGUgYXBwbGljYXRpb24uICovXG4gIGtleXM/OiBLZXlTdGFjayB8IEtleVtdO1xuXG4gIC8qKiBJZiBgdHJ1ZWAsIGFueSBlcnJvcnMgaGFuZGxlZCBieSB0aGUgYXBwbGljYXRpb24gd2lsbCBiZSBsb2dnZWQgdG8gdGhlXG4gICAqIHN0ZGVyci4gSWYgYGZhbHNlYCBub3RoaW5nIHdpbGwgYmUgbG9nZ2VkLiBUaGUgZGVmYXVsdCBpcyBgdHJ1ZWAuXG4gICAqXG4gICAqIEFsbCBlcnJvcnMgYXJlIGF2YWlsYWJsZSBhcyBldmVudHMgb24gdGhlIGFwcGxpY2F0aW9uIG9mIHR5cGUgYFwiZXJyb3JcImAgYW5kXG4gICAqIGNhbiBiZSBhY2Nlc3NlZCBmb3IgY3VzdG9tIGxvZ2dpbmcvYXBwbGljYXRpb24gbWFuYWdlbWVudCB2aWEgYWRkaW5nIGFuXG4gICAqIGV2ZW50IGxpc3RlbmVyIHRvIHRoZSBhcHBsaWNhdGlvbjpcbiAgICpcbiAgICogYGBgdHNcbiAgICogY29uc3QgYXBwID0gbmV3IEFwcGxpY2F0aW9uKHsgbG9nRXJyb3JzOiBmYWxzZSB9KTtcbiAgICogYXBwLmFkZEV2ZW50TGlzdGVuZXIoXCJlcnJvclwiLCAoZXZ0KSA9PiB7XG4gICAqICAgLy8gZXZ0LmVycm9yIHdpbGwgY29udGFpbiB3aGF0IGVycm9yIHdhcyB0aHJvd25cbiAgICogfSk7XG4gICAqIGBgYFxuICAgKlxuICAgKi9cbiAgbG9nRXJyb3JzPzogYm9vbGVhbjtcblxuICAvKiogSWYgc2V0IHRvIGB0cnVlYCwgcHJveHkgaGVhZGVycyB3aWxsIGJlIHRydXN0ZWQgd2hlbiBwcm9jZXNzaW5nIHJlcXVlc3RzLlxuICAgKiBUaGlzIGRlZmF1bHRzIHRvIGBmYWxzZWAuICovXG4gIHByb3h5PzogYm9vbGVhbjtcblxuICAvKiogQSBzZXJ2ZXIgY29uc3RydWN0b3IgdG8gdXNlIGluc3RlYWQgb2YgdGhlIGRlZmF1bHQgc2VydmVyIGZvciByZWNlaXZpbmdcbiAgICogcmVxdWVzdHMuICBXaGVuIHRoZSBuYXRpdmUgSFRUUCBzZXJ2ZXIgaXMgZGV0ZWN0ZWQgaW4gdGhlIGVudmlyb25tZW50LCB0aGVuXG4gICAqIHRoZSBuYXRpdmUgc2VydmVyIHdpbGwgYmUgdXNlZCwgb3RoZXJ3aXNlIHRoZSBgc3RkL2h0dHBgIHNlcnZlciB3aWxsIGJlXG4gICAqIHVzZWQuICBQYXNzaW5nIGVpdGhlciBgSFRUUFNlcnZlclN0ZGAgb3IgYEhUVFBTZXJ2ZXJOYXRpdmVgIHdpbGwgb3ZlcnJpZGVcbiAgICogdGhpcyBiZWhhdmlvci5cbiAgICovXG4gIHNlcnZlckNvbnN0cnVjdG9yPzogU2VydmVyQ29uc3RydWN0b3I8U2VydmVyUmVxdWVzdCB8IE5hdGl2ZVJlcXVlc3Q+O1xuXG4gIC8qKiBUaGUgaW5pdGlhbCBzdGF0ZSBvYmplY3QgZm9yIHRoZSBhcHBsaWNhdGlvbiwgb2Ygd2hpY2ggdGhlIHR5cGUgY2FuIGJlXG4gICAqIHVzZWQgdG8gaW5mZXIgdGhlIHR5cGUgb2YgdGhlIHN0YXRlIGZvciBib3RoIHRoZSBhcHBsaWNhdGlvbiBhbmQgYW55IG9mIHRoZVxuICAgKiBhcHBsaWNhdGlvbidzIGNvbnRleHQuICovXG4gIHN0YXRlPzogUztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBGZXRjaEV2ZW50SGFuZGxlck9wdGlvbnMge1xuICAvKiogU2V0cyB0aGUgYXBwbGljYXRpb25zIGAucHJveHlgIHZhbHVlLCB3aGljaCBkZXRlcm1pbmVzIGlmIHByb3h5IGhlYWRlcnNcbiAgICogYXJlIHVzZWQgd2hlbiBkZXRlcm1pbmluZyB2YWx1ZXMgaW4gdGhlIHJlcXVlc3QuIFRoaXMgZGVmYXVsdHMgdG8gYHRydWVgLlxuICAgKi9cbiAgcHJveHk/OiBib29sZWFuO1xuICAvKiogRGV0ZXJtaW5lcyBpZiByZXF1ZXN0cyBoYW5kbGVkIGJ5IHRoZSBmZXRjaCBldmVudCBoYW5kbGVyIHNob3VsZCBiZVxuICAgKiB0cmVhdGVkIGFzIFwic2VjdXJlXCIgKGUuZy4gc2VydmVkIG92ZXIgSFRUUCkuIFRoaXMgZGVmYXVsdHMgdG8gYHRydWVgLiAqL1xuICBzZWN1cmU/OiBib29sZWFuO1xufVxuXG5pbnRlcmZhY2UgUmVxdWVzdFN0YXRlIHtcbiAgaGFuZGxpbmc6IFNldDxQcm9taXNlPHZvaWQ+PjtcbiAgY2xvc2luZzogYm9vbGVhbjtcbiAgY2xvc2VkOiBib29sZWFuO1xuICBzZXJ2ZXI6IFNlcnZlcjxTZXJ2ZXJSZXF1ZXN0IHwgTmF0aXZlUmVxdWVzdD47XG59XG5cbi8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG5leHBvcnQgdHlwZSBTdGF0ZSA9IFJlY29yZDxzdHJpbmcgfCBudW1iZXIgfCBzeW1ib2wsIGFueT47XG5cbmNvbnN0IEFERFJfUkVHRVhQID0gL15cXFs/KFteXFxdXSopXFxdPzooWzAtOV17MSw1fSkkLztcblxuZXhwb3J0IGNsYXNzIEFwcGxpY2F0aW9uRXJyb3JFdmVudDxTIGV4dGVuZHMgQVMsIEFTIGV4dGVuZHMgU3RhdGU+XG4gIGV4dGVuZHMgRXJyb3JFdmVudCB7XG4gIGNvbnRleHQ/OiBDb250ZXh0PFMsIEFTPjtcblxuICBjb25zdHJ1Y3RvcihldmVudEluaXREaWN0OiBBcHBsaWNhdGlvbkVycm9yRXZlbnRJbml0PFMsIEFTPikge1xuICAgIHN1cGVyKFwiZXJyb3JcIiwgZXZlbnRJbml0RGljdCk7XG4gICAgdGhpcy5jb250ZXh0ID0gZXZlbnRJbml0RGljdC5jb250ZXh0O1xuICB9XG59XG5cbmZ1bmN0aW9uIGxvZ0Vycm9yTGlzdGVuZXI8UyBleHRlbmRzIEFTLCBBUyBleHRlbmRzIFN0YXRlPihcbiAgeyBlcnJvciwgY29udGV4dCB9OiBBcHBsaWNhdGlvbkVycm9yRXZlbnQ8UywgQVM+LFxuKSB7XG4gIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcihgW3VuY2F1Z2h0IG9hayBlcnJvcl06ICR7ZXJyb3IubmFtZX0gLSAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gIH0gZWxzZSB7XG4gICAgY29uc29sZS5lcnJvcihgW3VuY2F1Z2h0IG9hayBlcnJvcl1cXG5gLCBlcnJvcik7XG4gIH1cbiAgaWYgKGNvbnRleHQpIHtcbiAgICBjb25zb2xlLmVycm9yKGBcXG5yZXF1ZXN0OmAsIHtcbiAgICAgIHVybDogY29udGV4dC5yZXF1ZXN0LnVybC50b1N0cmluZygpLFxuICAgICAgbWV0aG9kOiBjb250ZXh0LnJlcXVlc3QubWV0aG9kLFxuICAgICAgaGFzQm9keTogY29udGV4dC5yZXF1ZXN0Lmhhc0JvZHksXG4gICAgfSk7XG4gICAgY29uc29sZS5lcnJvcihgcmVzcG9uc2U6YCwge1xuICAgICAgc3RhdHVzOiBjb250ZXh0LnJlc3BvbnNlLnN0YXR1cyxcbiAgICAgIHR5cGU6IGNvbnRleHQucmVzcG9uc2UudHlwZSxcbiAgICAgIGhhc0JvZHk6ICEhY29udGV4dC5yZXNwb25zZS5ib2R5LFxuICAgICAgd3JpdGFibGU6IGNvbnRleHQucmVzcG9uc2Uud3JpdGFibGUsXG4gICAgfSk7XG4gIH1cbiAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IgJiYgZXJyb3Iuc3RhY2spIHtcbiAgICBjb25zb2xlLmVycm9yKGBcXG4ke2Vycm9yLnN0YWNrLnNwbGl0KFwiXFxuXCIpLnNsaWNlKDEpLmpvaW4oXCJcXG5cIil9YCk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEFwcGxpY2F0aW9uTGlzdGVuRXZlbnQgZXh0ZW5kcyBFdmVudCB7XG4gIGhvc3RuYW1lPzogc3RyaW5nO1xuICBwb3J0OiBudW1iZXI7XG4gIHNlY3VyZTogYm9vbGVhbjtcbiAgc2VydmVyVHlwZTogXCJzdGRcIiB8IFwibmF0aXZlXCIgfCBcImN1c3RvbVwiO1xuXG4gIGNvbnN0cnVjdG9yKGV2ZW50SW5pdERpY3Q6IEFwcGxpY2F0aW9uTGlzdGVuRXZlbnRJbml0KSB7XG4gICAgc3VwZXIoXCJsaXN0ZW5cIiwgZXZlbnRJbml0RGljdCk7XG4gICAgdGhpcy5ob3N0bmFtZSA9IGV2ZW50SW5pdERpY3QuaG9zdG5hbWU7XG4gICAgdGhpcy5wb3J0ID0gZXZlbnRJbml0RGljdC5wb3J0O1xuICAgIHRoaXMuc2VjdXJlID0gZXZlbnRJbml0RGljdC5zZWN1cmU7XG4gICAgdGhpcy5zZXJ2ZXJUeXBlID0gZXZlbnRJbml0RGljdC5zZXJ2ZXJUeXBlO1xuICB9XG59XG5cbi8qKiBBIGNsYXNzIHdoaWNoIHJlZ2lzdGVycyBtaWRkbGV3YXJlICh2aWEgYC51c2UoKWApIGFuZCB0aGVuIHByb2Nlc3Nlc1xuICogaW5ib3VuZCByZXF1ZXN0cyBhZ2FpbnN0IHRoYXQgbWlkZGxld2FyZSAodmlhIGAubGlzdGVuKClgKS5cbiAqXG4gKiBUaGUgYGNvbnRleHQuc3RhdGVgIGNhbiBiZSB0eXBlZCB2aWEgcGFzc2luZyBhIGdlbmVyaWMgYXJndW1lbnQgd2hlblxuICogY29uc3RydWN0aW5nIGFuIGluc3RhbmNlIG9mIGBBcHBsaWNhdGlvbmAuXG4gKi9cbi8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG5leHBvcnQgY2xhc3MgQXBwbGljYXRpb248QVMgZXh0ZW5kcyBTdGF0ZSA9IFJlY29yZDxzdHJpbmcsIGFueT4+XG4gIGV4dGVuZHMgRXZlbnRUYXJnZXQge1xuICAjY29tcG9zZWRNaWRkbGV3YXJlPzogKGNvbnRleHQ6IENvbnRleHQ8QVMsIEFTPikgPT4gUHJvbWlzZTx1bmtub3duPjtcbiAgI2NvbnRleHRTdGF0ZTogXCJjbG9uZVwiIHwgXCJwcm90b3R5cGVcIiB8IFwiYWxpYXNcIiB8IFwiZW1wdHlcIjtcbiAgI2V2ZW50SGFuZGxlcj86IEZldGNoRXZlbnRMaXN0ZW5lck9iamVjdDtcbiAgI2tleXM/OiBLZXlTdGFjaztcbiAgI21pZGRsZXdhcmU6IE1pZGRsZXdhcmU8U3RhdGUsIENvbnRleHQ8U3RhdGUsIEFTPj5bXSA9IFtdO1xuICAjc2VydmVyQ29uc3RydWN0b3I6IFNlcnZlckNvbnN0cnVjdG9yPFNlcnZlclJlcXVlc3QgfCBOYXRpdmVSZXF1ZXN0PjtcblxuICAvKiogQSBzZXQgb2Yga2V5cywgb3IgYW4gaW5zdGFuY2Ugb2YgYEtleVN0YWNrYCB3aGljaCB3aWxsIGJlIHVzZWQgdG8gc2lnblxuICAgKiBjb29raWVzIHJlYWQgYW5kIHNldCBieSB0aGUgYXBwbGljYXRpb24gdG8gYXZvaWQgdGFtcGVyaW5nIHdpdGggdGhlXG4gICAqIGNvb2tpZXMuICovXG4gIGdldCBrZXlzKCk6IEtleVN0YWNrIHwgS2V5W10gfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLiNrZXlzO1xuICB9XG5cbiAgc2V0IGtleXMoa2V5czogS2V5U3RhY2sgfCBLZXlbXSB8IHVuZGVmaW5lZCkge1xuICAgIGlmICgha2V5cykge1xuICAgICAgdGhpcy4ja2V5cyA9IHVuZGVmaW5lZDtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoa2V5cykpIHtcbiAgICAgIHRoaXMuI2tleXMgPSBuZXcgS2V5U3RhY2soa2V5cyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuI2tleXMgPSBrZXlzO1xuICAgIH1cbiAgfVxuXG4gIC8qKiBJZiBgdHJ1ZWAsIHByb3h5IGhlYWRlcnMgd2lsbCBiZSB0cnVzdGVkIHdoZW4gcHJvY2Vzc2luZyByZXF1ZXN0cy4gIFRoaXNcbiAgICogZGVmYXVsdHMgdG8gYGZhbHNlYC4gKi9cbiAgcHJveHk6IGJvb2xlYW47XG5cbiAgLyoqIEdlbmVyaWMgc3RhdGUgb2YgdGhlIGFwcGxpY2F0aW9uLCB3aGljaCBjYW4gYmUgc3BlY2lmaWVkIGJ5IHBhc3NpbmcgdGhlXG4gICAqIGdlbmVyaWMgYXJndW1lbnQgd2hlbiBjb25zdHJ1Y3Rpbmc6XG4gICAqXG4gICAqICAgICAgIGNvbnN0IGFwcCA9IG5ldyBBcHBsaWNhdGlvbjx7IGZvbzogc3RyaW5nIH0+KCk7XG4gICAqXG4gICAqIE9yIGNhbiBiZSBjb250ZXh0dWFsbHkgaW5mZXJyZWQgYmFzZWQgb24gc2V0dGluZyBhbiBpbml0aWFsIHN0YXRlIG9iamVjdDpcbiAgICpcbiAgICogICAgICAgY29uc3QgYXBwID0gbmV3IEFwcGxpY2F0aW9uKHsgc3RhdGU6IHsgZm9vOiBcImJhclwiIH0gfSk7XG4gICAqXG4gICAqIFdoZW4gYSBuZXcgY29udGV4dCBpcyBjcmVhdGVkLCB0aGUgYXBwbGljYXRpb24ncyBzdGF0ZSBpcyBjbG9uZWQgYW5kIHRoZVxuICAgKiBzdGF0ZSBpcyB1bmlxdWUgdG8gdGhhdCByZXF1ZXN0L3Jlc3BvbnNlLiAgQ2hhbmdlcyBjYW4gYmUgbWFkZSB0byB0aGVcbiAgICogYXBwbGljYXRpb24gc3RhdGUgdGhhdCB3aWxsIGJlIHNoYXJlZCB3aXRoIGFsbCBjb250ZXh0cy5cbiAgICovXG4gIHN0YXRlOiBBUztcblxuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBBcHBsaWNhdGlvbk9wdGlvbnM8QVM+ID0ge30pIHtcbiAgICBzdXBlcigpO1xuICAgIGNvbnN0IHtcbiAgICAgIHN0YXRlLFxuICAgICAga2V5cyxcbiAgICAgIHByb3h5LFxuICAgICAgc2VydmVyQ29uc3RydWN0b3IgPSBoYXNOYXRpdmVIdHRwKCkgPyBIdHRwU2VydmVyTmF0aXZlIDogSHR0cFNlcnZlclN0ZCxcbiAgICAgIGNvbnRleHRTdGF0ZSA9IFwiY2xvbmVcIixcbiAgICAgIGxvZ0Vycm9ycyA9IHRydWUsXG4gICAgfSA9IG9wdGlvbnM7XG5cbiAgICB0aGlzLnByb3h5ID0gcHJveHkgPz8gZmFsc2U7XG4gICAgdGhpcy5rZXlzID0ga2V5cztcbiAgICB0aGlzLnN0YXRlID0gc3RhdGUgPz8ge30gYXMgQVM7XG4gICAgdGhpcy4jc2VydmVyQ29uc3RydWN0b3IgPSBzZXJ2ZXJDb25zdHJ1Y3RvcjtcbiAgICB0aGlzLiNjb250ZXh0U3RhdGUgPSBjb250ZXh0U3RhdGU7XG5cbiAgICBpZiAobG9nRXJyb3JzKSB7XG4gICAgICB0aGlzLmFkZEV2ZW50TGlzdGVuZXIoXCJlcnJvclwiLCBsb2dFcnJvckxpc3RlbmVyKTtcbiAgICB9XG4gIH1cblxuICAjZ2V0Q29tcG9zZWQoKTogKChjb250ZXh0OiBDb250ZXh0PEFTLCBBUz4pID0+IFByb21pc2U8dW5rbm93bj4pIHtcbiAgICBpZiAoIXRoaXMuI2NvbXBvc2VkTWlkZGxld2FyZSkge1xuICAgICAgdGhpcy4jY29tcG9zZWRNaWRkbGV3YXJlID0gY29tcG9zZSh0aGlzLiNtaWRkbGV3YXJlKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuI2NvbXBvc2VkTWlkZGxld2FyZTtcbiAgfVxuXG4gICNnZXRDb250ZXh0U3RhdGUoKTogQVMge1xuICAgIHN3aXRjaCAodGhpcy4jY29udGV4dFN0YXRlKSB7XG4gICAgICBjYXNlIFwiYWxpYXNcIjpcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGU7XG4gICAgICBjYXNlIFwiY2xvbmVcIjpcbiAgICAgICAgcmV0dXJuIGNsb25lU3RhdGUodGhpcy5zdGF0ZSk7XG4gICAgICBjYXNlIFwiZW1wdHlcIjpcbiAgICAgICAgcmV0dXJuIHt9IGFzIEFTO1xuICAgICAgY2FzZSBcInByb3RvdHlwZVwiOlxuICAgICAgICByZXR1cm4gT2JqZWN0LmNyZWF0ZSh0aGlzLnN0YXRlKTtcbiAgICB9XG4gIH1cblxuICAvKiogRGVhbCB3aXRoIHVuY2F1Z2h0IGVycm9ycyBpbiBlaXRoZXIgdGhlIG1pZGRsZXdhcmUgb3Igc2VuZGluZyB0aGVcbiAgICogcmVzcG9uc2UuICovXG4gIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gICNoYW5kbGVFcnJvcihjb250ZXh0OiBDb250ZXh0PEFTPiwgZXJyb3I6IGFueSk6IHZvaWQge1xuICAgIGlmICghKGVycm9yIGluc3RhbmNlb2YgRXJyb3IpKSB7XG4gICAgICBlcnJvciA9IG5ldyBFcnJvcihgbm9uLWVycm9yIHRocm93bjogJHtKU09OLnN0cmluZ2lmeShlcnJvcil9YCk7XG4gICAgfVxuICAgIGNvbnN0IHsgbWVzc2FnZSB9ID0gZXJyb3I7XG4gICAgdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBBcHBsaWNhdGlvbkVycm9yRXZlbnQoeyBjb250ZXh0LCBtZXNzYWdlLCBlcnJvciB9KSk7XG4gICAgaWYgKCFjb250ZXh0LnJlc3BvbnNlLndyaXRhYmxlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGZvciAoY29uc3Qga2V5IG9mIGNvbnRleHQucmVzcG9uc2UuaGVhZGVycy5rZXlzKCkpIHtcbiAgICAgIGNvbnRleHQucmVzcG9uc2UuaGVhZGVycy5kZWxldGUoa2V5KTtcbiAgICB9XG4gICAgaWYgKGVycm9yLmhlYWRlcnMgJiYgZXJyb3IuaGVhZGVycyBpbnN0YW5jZW9mIEhlYWRlcnMpIHtcbiAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIGVycm9yLmhlYWRlcnMpIHtcbiAgICAgICAgY29udGV4dC5yZXNwb25zZS5oZWFkZXJzLnNldChrZXksIHZhbHVlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29udGV4dC5yZXNwb25zZS50eXBlID0gXCJ0ZXh0XCI7XG4gICAgY29uc3Qgc3RhdHVzOiBTdGF0dXMgPSBjb250ZXh0LnJlc3BvbnNlLnN0YXR1cyA9XG4gICAgICBEZW5vLmVycm9ycyAmJiBlcnJvciBpbnN0YW5jZW9mIERlbm8uZXJyb3JzLk5vdEZvdW5kXG4gICAgICAgID8gNDA0XG4gICAgICAgIDogZXJyb3Iuc3RhdHVzICYmIHR5cGVvZiBlcnJvci5zdGF0dXMgPT09IFwibnVtYmVyXCJcbiAgICAgICAgPyBlcnJvci5zdGF0dXNcbiAgICAgICAgOiA1MDA7XG4gICAgY29udGV4dC5yZXNwb25zZS5ib2R5ID0gZXJyb3IuZXhwb3NlXG4gICAgICA/IGVycm9yLm1lc3NhZ2VcbiAgICAgIDogU1RBVFVTX1RFWFQuZ2V0KHN0YXR1cyk7XG4gIH1cblxuICAvKiogUHJvY2Vzc2luZyByZWdpc3RlcmVkIG1pZGRsZXdhcmUgb24gZWFjaCByZXF1ZXN0LiAqL1xuICBhc3luYyAjaGFuZGxlUmVxdWVzdChcbiAgICByZXF1ZXN0OiBTZXJ2ZXJSZXF1ZXN0IHwgTmF0aXZlUmVxdWVzdCxcbiAgICBzZWN1cmU6IGJvb2xlYW4sXG4gICAgc3RhdGU6IFJlcXVlc3RTdGF0ZSxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgY29udGV4dCA9IG5ldyBDb250ZXh0KHRoaXMsIHJlcXVlc3QsIHRoaXMuI2dldENvbnRleHRTdGF0ZSgpLCBzZWN1cmUpO1xuICAgIGxldCByZXNvbHZlOiAoKSA9PiB2b2lkO1xuICAgIGNvbnN0IGhhbmRsaW5nUHJvbWlzZSA9IG5ldyBQcm9taXNlPHZvaWQ+KChyZXMpID0+IHJlc29sdmUgPSByZXMpO1xuICAgIHN0YXRlLmhhbmRsaW5nLmFkZChoYW5kbGluZ1Byb21pc2UpO1xuICAgIGlmICghc3RhdGUuY2xvc2luZyAmJiAhc3RhdGUuY2xvc2VkKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLiNnZXRDb21wb3NlZCgpKGNvbnRleHQpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHRoaXMuI2hhbmRsZUVycm9yKGNvbnRleHQsIGVycik7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChjb250ZXh0LnJlc3BvbmQgPT09IGZhbHNlKSB7XG4gICAgICBjb250ZXh0LnJlc3BvbnNlLmRlc3Ryb3koKTtcbiAgICAgIHJlc29sdmUhKCk7XG4gICAgICBzdGF0ZS5oYW5kbGluZy5kZWxldGUoaGFuZGxpbmdQcm9taXNlKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbGV0IGNsb3NlUmVzb3VyY2VzID0gdHJ1ZTtcbiAgICBsZXQgcmVzcG9uc2U6IFJlc3BvbnNlIHwgU2VydmVyUmVzcG9uc2U7XG4gICAgdHJ5IHtcbiAgICAgIGlmIChyZXF1ZXN0IGluc3RhbmNlb2YgTmF0aXZlUmVxdWVzdCkge1xuICAgICAgICBjbG9zZVJlc291cmNlcyA9IGZhbHNlO1xuICAgICAgICByZXNwb25zZSA9IGF3YWl0IGNvbnRleHQucmVzcG9uc2UudG9Eb21SZXNwb25zZSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzcG9uc2UgPSBhd2FpdCBjb250ZXh0LnJlc3BvbnNlLnRvU2VydmVyUmVzcG9uc2UoKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRoaXMuI2hhbmRsZUVycm9yKGNvbnRleHQsIGVycik7XG4gICAgICBpZiAocmVxdWVzdCBpbnN0YW5jZW9mIE5hdGl2ZVJlcXVlc3QpIHtcbiAgICAgICAgcmVzcG9uc2UgPSBhd2FpdCBjb250ZXh0LnJlc3BvbnNlLnRvRG9tUmVzcG9uc2UoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc3BvbnNlID0gYXdhaXQgY29udGV4dC5yZXNwb25zZS50b1NlcnZlclJlc3BvbnNlKCk7XG4gICAgICB9XG4gICAgfVxuICAgIGFzc2VydChyZXNwb25zZSk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHJlcXVlc3QucmVzcG9uZChyZXNwb25zZSBhcyBSZXNwb25zZSAmIFNlcnZlclJlc3BvbnNlKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRoaXMuI2hhbmRsZUVycm9yKGNvbnRleHQsIGVycik7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGNvbnRleHQucmVzcG9uc2UuZGVzdHJveShjbG9zZVJlc291cmNlcyk7XG4gICAgICByZXNvbHZlISgpO1xuICAgICAgc3RhdGUuaGFuZGxpbmcuZGVsZXRlKGhhbmRsaW5nUHJvbWlzZSk7XG4gICAgICBpZiAoc3RhdGUuY2xvc2luZykge1xuICAgICAgICBzdGF0ZS5zZXJ2ZXIuY2xvc2UoKTtcbiAgICAgICAgc3RhdGUuY2xvc2VkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKiogQWRkIGFuIGV2ZW50IGxpc3RlbmVyIGZvciBhbiBgXCJlcnJvclwiYCBldmVudCB3aGljaCBvY2N1cnMgd2hlbiBhblxuICAgKiB1bi1jYXVnaHQgZXJyb3Igb2NjdXJzIHdoZW4gcHJvY2Vzc2luZyB0aGUgbWlkZGxld2FyZSBvciBkdXJpbmcgcHJvY2Vzc2luZ1xuICAgKiBvZiB0aGUgcmVzcG9uc2UuICovXG4gIGFkZEV2ZW50TGlzdGVuZXI8UyBleHRlbmRzIEFTPihcbiAgICB0eXBlOiBcImVycm9yXCIsXG4gICAgbGlzdGVuZXI6IEFwcGxpY2F0aW9uRXJyb3JFdmVudExpc3RlbmVyT3JFdmVudExpc3RlbmVyT2JqZWN0PFMsIEFTPiB8IG51bGwsXG4gICAgb3B0aW9ucz86IGJvb2xlYW4gfCBBZGRFdmVudExpc3RlbmVyT3B0aW9ucyxcbiAgKTogdm9pZDtcbiAgLyoqIEFkZCBhbiBldmVudCBsaXN0ZW5lciBmb3IgYSBgXCJsaXN0ZW5cImAgZXZlbnQgd2hpY2ggb2NjdXJzIHdoZW4gdGhlIHNlcnZlclxuICAgKiBoYXMgc3VjY2Vzc2Z1bGx5IG9wZW5lZCBidXQgYmVmb3JlIGFueSByZXF1ZXN0cyBzdGFydCBiZWluZyBwcm9jZXNzZWQuICovXG4gIGFkZEV2ZW50TGlzdGVuZXIoXG4gICAgdHlwZTogXCJsaXN0ZW5cIixcbiAgICBsaXN0ZW5lcjogQXBwbGljYXRpb25MaXN0ZW5FdmVudExpc3RlbmVyT3JFdmVudExpc3RlbmVyT2JqZWN0IHwgbnVsbCxcbiAgICBvcHRpb25zPzogYm9vbGVhbiB8IEFkZEV2ZW50TGlzdGVuZXJPcHRpb25zLFxuICApOiB2b2lkO1xuICAvKiogQWRkIGFuIGV2ZW50IGxpc3RlbmVyIGZvciBhbiBldmVudC4gIEN1cnJlbnRseSB2YWxpZCBldmVudCB0eXBlcyBhcmVcbiAgICogYFwiZXJyb3JcImAgYW5kIGBcImxpc3RlblwiYC4gKi9cbiAgYWRkRXZlbnRMaXN0ZW5lcihcbiAgICB0eXBlOiBcImVycm9yXCIgfCBcImxpc3RlblwiLFxuICAgIGxpc3RlbmVyOiBFdmVudExpc3RlbmVyT3JFdmVudExpc3RlbmVyT2JqZWN0IHwgbnVsbCxcbiAgICBvcHRpb25zPzogYm9vbGVhbiB8IEFkZEV2ZW50TGlzdGVuZXJPcHRpb25zLFxuICApOiB2b2lkIHtcbiAgICBzdXBlci5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGxpc3RlbmVyLCBvcHRpb25zKTtcbiAgfVxuXG4gIC8qKiBXaGVuIHVzaW5nIERlbm8gRGVwbG95LCB0aGlzIG1ldGhvZCBjYW4gY3JlYXRlIGFuIGV2ZW50IGhhbmRsZXIgb2JqZWN0XG4gICAqIGZvciB0aGUgYXBwbGljYXRpb24gd2hpY2ggY2FuIGJlIHJlZ2lzdGVyZWQgYXMgYSBmZXRjaCBldmVudCBoYW5kbGVyLlxuICAgKlxuICAgKiBfTm90ZV8gdGhlIHJlc3VsdCBvZiB0aGlzIG1ldGhvZCBpcyBtZW1vaXplZCwgbWVhbmluZyB0aGF0IHN1YnNlcXVlbnQgY2FsbHNcbiAgICogdG8gdGhlIG1ldGhvZCB3aXRoIGRpZmZlcmVudCBvcHRpb25zIHN0aWxsIHJlc3VsdHMgaW4gdGhlIHNhbWUgYmVoYXZpb3Igb2ZcbiAgICogdGhlIGhhbmRsZXIuXG4gICAqXG4gICAqIGBgYFxuICAgKiBpbXBvcnQgeyBBcHBsaWNhdGlvbiB9IGZyb20gXCJodHRwczovL2Rlbm8ubGFuZC94L29hay9tb2QudHNcIjtcbiAgICpcbiAgICogY29uc3QgYXBwID0gbmV3IEFwcCgpO1xuICAgKiBhcHAudXNlKChjdHgpID0+IGN0eC5yZXNwb25zZS5ib2R5ID0gXCJoZWxsbyBvYWtcIik7XG4gICAqXG4gICAqIGFkZEV2ZW50TGlzdGVuZXIoXCJmZXRjaFwiLCBhcHAuZmV0Y2hFdmVudEhhbmRsZXIoKSk7XG4gICAqIGBgYFxuICAgKi9cbiAgZmV0Y2hFdmVudEhhbmRsZXIoXG4gICAgeyBwcm94eSA9IHRydWUsIHNlY3VyZSA9IHRydWUgfTogRmV0Y2hFdmVudEhhbmRsZXJPcHRpb25zID0ge30sXG4gICk6IEZldGNoRXZlbnRMaXN0ZW5lck9iamVjdCB7XG4gICAgaWYgKHRoaXMuI2V2ZW50SGFuZGxlcikge1xuICAgICAgcmV0dXJuIHRoaXMuI2V2ZW50SGFuZGxlcjtcbiAgICB9XG4gICAgdGhpcy5wcm94eSA9IHByb3h5O1xuICAgIHJldHVybiB0aGlzLiNldmVudEhhbmRsZXIgPSB7XG4gICAgICBoYW5kbGVFdmVudDogYXN5bmMgKHJlcXVlc3RFdmVudCkgPT4ge1xuICAgICAgICBsZXQgcmVzb2x2ZTogKHJlc3BvbnNlOiBSZXNwb25zZSkgPT4gdm9pZDtcbiAgICAgICAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgICAgICAgbGV0IHJlamVjdDogKHJlYXNvbjogYW55KSA9PiB2b2lkO1xuICAgICAgICBjb25zdCByZXNwb25zZVByb21pc2UgPSBuZXcgUHJvbWlzZTxSZXNwb25zZT4oKHJlcywgcmVqKSA9PiB7XG4gICAgICAgICAgcmVzb2x2ZSA9IHJlcztcbiAgICAgICAgICByZWplY3QgPSByZWo7XG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCByZXNwb25kZWRQcm9taXNlID0gcmVxdWVzdEV2ZW50LnJlc3BvbmRXaXRoKHJlc3BvbnNlUHJvbWlzZSk7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5oYW5kbGUoXG4gICAgICAgICAgcmVxdWVzdEV2ZW50LnJlcXVlc3QsXG4gICAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICAgIHNlY3VyZSxcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKHJlc3BvbnNlKSB7XG4gICAgICAgICAgcmVzb2x2ZSEocmVzcG9uc2UpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlamVjdCEobmV3IEVycm9yKFwiTm8gcmVzcG9uc2UgcmV0dXJuZWQgZnJvbSBhcHAgaGFuZGxlci5cIikpO1xuICAgICAgICB9XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgYXdhaXQgcmVzcG9uZGVkUHJvbWlzZTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQobmV3IEFwcGxpY2F0aW9uRXJyb3JFdmVudCh7IGVycm9yIH0pKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgLyoqIEhhbmRsZSBhbiBpbmRpdmlkdWFsIHNlcnZlciByZXF1ZXN0LCByZXR1cm5pbmcgdGhlIHNlcnZlciByZXNwb25zZS4gIFRoaXNcbiAgICogaXMgc2ltaWxhciB0byBgLmxpc3RlbigpYCwgYnV0IG9wZW5pbmcgdGhlIGNvbm5lY3Rpb24gYW5kIHJldHJpZXZpbmdcbiAgICogcmVxdWVzdHMgYXJlIG5vdCB0aGUgcmVzcG9uc2liaWxpdHkgb2YgdGhlIGFwcGxpY2F0aW9uLiAgSWYgdGhlIGdlbmVyYXRlZFxuICAgKiBjb250ZXh0IGdldHMgc2V0IHRvIG5vdCB0byByZXNwb25kLCB0aGVuIHRoZSBtZXRob2QgcmVzb2x2ZXMgd2l0aFxuICAgKiBgdW5kZWZpbmVkYCwgb3RoZXJ3aXNlIGl0IHJlc29sdmVzIHdpdGggYSByZXF1ZXN0IHRoYXQgaXMgY29tcGF0aWJsZSB3aXRoXG4gICAqIGBzdGQvaHR0cC9zZXJ2ZXJgLiAqL1xuICBoYW5kbGUgPSAoYXN5bmMgKFxuICAgIHJlcXVlc3Q6IFNlcnZlclJlcXVlc3QgfCBSZXF1ZXN0LFxuICAgIHNlY3VyZU9yQ29ubjogRGVuby5Db25uIHwgYm9vbGVhbiB8IHVuZGVmaW5lZCxcbiAgICBzZWN1cmU6IGJvb2xlYW4gfCB1bmRlZmluZWQgPSBmYWxzZSxcbiAgKTogUHJvbWlzZTxTZXJ2ZXJSZXNwb25zZSB8IFJlc3BvbnNlIHwgdW5kZWZpbmVkPiA9PiB7XG4gICAgaWYgKCF0aGlzLiNtaWRkbGV3YXJlLmxlbmd0aCkge1xuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIlRoZXJlIGlzIG5vIG1pZGRsZXdhcmUgdG8gcHJvY2VzcyByZXF1ZXN0cy5cIik7XG4gICAgfVxuICAgIGxldCBjb250ZXh0UmVxdWVzdDogU2VydmVyUmVxdWVzdCB8IE5hdGl2ZVJlcXVlc3Q7XG4gICAgaWYgKHJlcXVlc3QgaW5zdGFuY2VvZiBSZXF1ZXN0KSB7XG4gICAgICBhc3NlcnQoaXNDb25uKHNlY3VyZU9yQ29ubikgfHwgdHlwZW9mIHNlY3VyZU9yQ29ubiA9PT0gXCJ1bmRlZmluZWRcIik7XG4gICAgICBjb250ZXh0UmVxdWVzdCA9IG5ldyBOYXRpdmVSZXF1ZXN0KHtcbiAgICAgICAgcmVxdWVzdCxcbiAgICAgICAgcmVzcG9uZFdpdGgoKSB7XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh1bmRlZmluZWQpO1xuICAgICAgICB9LFxuICAgICAgfSwgeyBjb25uOiBzZWN1cmVPckNvbm4gfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGFzc2VydChcbiAgICAgICAgdHlwZW9mIHNlY3VyZU9yQ29ubiA9PT0gXCJib29sZWFuXCIgfHxcbiAgICAgICAgICB0eXBlb2Ygc2VjdXJlT3JDb25uID09PSBcInVuZGVmaW5lZFwiLFxuICAgICAgKTtcbiAgICAgIHNlY3VyZSA9IHNlY3VyZU9yQ29ubiA/PyBmYWxzZTtcbiAgICAgIGNvbnRleHRSZXF1ZXN0ID0gcmVxdWVzdDtcbiAgICB9XG4gICAgY29uc3QgY29udGV4dCA9IG5ldyBDb250ZXh0KFxuICAgICAgdGhpcyxcbiAgICAgIGNvbnRleHRSZXF1ZXN0LFxuICAgICAgdGhpcy4jZ2V0Q29udGV4dFN0YXRlKCksXG4gICAgICBzZWN1cmUsXG4gICAgKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy4jZ2V0Q29tcG9zZWQoKShjb250ZXh0KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRoaXMuI2hhbmRsZUVycm9yKGNvbnRleHQsIGVycik7XG4gICAgfVxuICAgIGlmIChjb250ZXh0LnJlc3BvbmQgPT09IGZhbHNlKSB7XG4gICAgICBjb250ZXh0LnJlc3BvbnNlLmRlc3Ryb3koKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gY29udGV4dFJlcXVlc3QgaW5zdGFuY2VvZiBOYXRpdmVSZXF1ZXN0XG4gICAgICAgID8gYXdhaXQgY29udGV4dC5yZXNwb25zZS50b0RvbVJlc3BvbnNlKClcbiAgICAgICAgOiBhd2FpdCBjb250ZXh0LnJlc3BvbnNlLnRvU2VydmVyUmVzcG9uc2UoKTtcbiAgICAgIGNvbnRleHQucmVzcG9uc2UuZGVzdHJveShmYWxzZSk7XG4gICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aGlzLiNoYW5kbGVFcnJvcihjb250ZXh0LCBlcnIpO1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfSkgYXMgSGFuZGxlTWV0aG9kO1xuXG4gIC8qKiBTdGFydCBsaXN0ZW5pbmcgZm9yIHJlcXVlc3RzLCBwcm9jZXNzaW5nIHJlZ2lzdGVyZWQgbWlkZGxld2FyZSBvbiBlYWNoXG4gICAqIHJlcXVlc3QuICBJZiB0aGUgb3B0aW9ucyBgLnNlY3VyZWAgaXMgdW5kZWZpbmVkIG9yIGBmYWxzZWAsIHRoZSBsaXN0ZW5pbmdcbiAgICogd2lsbCBiZSBvdmVyIEhUVFAuICBJZiB0aGUgb3B0aW9ucyBgLnNlY3VyZWAgcHJvcGVydHkgaXMgYHRydWVgLCBhXG4gICAqIGAuY2VydEZpbGVgIGFuZCBhIGAua2V5RmlsZWAgcHJvcGVydHkgbmVlZCB0byBiZSBzdXBwbGllZCBhbmQgcmVxdWVzdHNcbiAgICogd2lsbCBiZSBwcm9jZXNzZWQgb3ZlciBIVFRQUy4gKi9cbiAgYXN5bmMgbGlzdGVuKGFkZHI6IHN0cmluZyk6IFByb21pc2U8dm9pZD47XG4gIC8qKiBTdGFydCBsaXN0ZW5pbmcgZm9yIHJlcXVlc3RzLCBwcm9jZXNzaW5nIHJlZ2lzdGVyZWQgbWlkZGxld2FyZSBvbiBlYWNoXG4gICAqIHJlcXVlc3QuICBJZiB0aGUgb3B0aW9ucyBgLnNlY3VyZWAgaXMgdW5kZWZpbmVkIG9yIGBmYWxzZWAsIHRoZSBsaXN0ZW5pbmdcbiAgICogd2lsbCBiZSBvdmVyIEhUVFAuICBJZiB0aGUgb3B0aW9ucyBgLnNlY3VyZWAgcHJvcGVydHkgaXMgYHRydWVgLCBhXG4gICAqIGAuY2VydEZpbGVgIGFuZCBhIGAua2V5RmlsZWAgcHJvcGVydHkgbmVlZCB0byBiZSBzdXBwbGllZCBhbmQgcmVxdWVzdHNcbiAgICogd2lsbCBiZSBwcm9jZXNzZWQgb3ZlciBIVFRQUy4gKi9cbiAgYXN5bmMgbGlzdGVuKG9wdGlvbnM6IExpc3Rlbk9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+O1xuICBhc3luYyBsaXN0ZW4ob3B0aW9uczogc3RyaW5nIHwgTGlzdGVuT3B0aW9ucyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghdGhpcy4jbWlkZGxld2FyZS5sZW5ndGgpIHtcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJUaGVyZSBpcyBubyBtaWRkbGV3YXJlIHRvIHByb2Nlc3MgcmVxdWVzdHMuXCIpO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIGNvbnN0IG1hdGNoID0gQUREUl9SRUdFWFAuZXhlYyhvcHRpb25zKTtcbiAgICAgIGlmICghbWF0Y2gpIHtcbiAgICAgICAgdGhyb3cgVHlwZUVycm9yKGBJbnZhbGlkIGFkZHJlc3MgcGFzc2VkOiBcIiR7b3B0aW9uc31cImApO1xuICAgICAgfVxuICAgICAgY29uc3QgWywgaG9zdG5hbWUsIHBvcnRTdHJdID0gbWF0Y2g7XG4gICAgICBvcHRpb25zID0geyBob3N0bmFtZSwgcG9ydDogcGFyc2VJbnQocG9ydFN0ciwgMTApIH07XG4gICAgfVxuICAgIGNvbnN0IHNlcnZlciA9IG5ldyB0aGlzLiNzZXJ2ZXJDb25zdHJ1Y3Rvcih0aGlzLCBvcHRpb25zKTtcbiAgICBjb25zdCB7IHNpZ25hbCB9ID0gb3B0aW9ucztcbiAgICBjb25zdCBzdGF0ZSA9IHtcbiAgICAgIGNsb3NlZDogZmFsc2UsXG4gICAgICBjbG9zaW5nOiBmYWxzZSxcbiAgICAgIGhhbmRsaW5nOiBuZXcgU2V0PFByb21pc2U8dm9pZD4+KCksXG4gICAgICBzZXJ2ZXIsXG4gICAgfTtcbiAgICBpZiAoc2lnbmFsKSB7XG4gICAgICBzaWduYWwuYWRkRXZlbnRMaXN0ZW5lcihcImFib3J0XCIsICgpID0+IHtcbiAgICAgICAgaWYgKCFzdGF0ZS5oYW5kbGluZy5zaXplKSB7XG4gICAgICAgICAgc2VydmVyLmNsb3NlKCk7XG4gICAgICAgICAgc3RhdGUuY2xvc2VkID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBzdGF0ZS5jbG9zaW5nID0gdHJ1ZTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICBjb25zdCB7IGhvc3RuYW1lLCBwb3J0LCBzZWN1cmUgPSBmYWxzZSB9ID0gb3B0aW9ucztcbiAgICBjb25zdCBzZXJ2ZXJUeXBlID0gc2VydmVyIGluc3RhbmNlb2YgSHR0cFNlcnZlclN0ZFxuICAgICAgPyBcInN0ZFwiXG4gICAgICA6IHNlcnZlciBpbnN0YW5jZW9mIEh0dHBTZXJ2ZXJOYXRpdmVcbiAgICAgID8gXCJuYXRpdmVcIlxuICAgICAgOiBcImN1c3RvbVwiO1xuICAgIHRoaXMuZGlzcGF0Y2hFdmVudChcbiAgICAgIG5ldyBBcHBsaWNhdGlvbkxpc3RlbkV2ZW50KHsgaG9zdG5hbWUsIHBvcnQsIHNlY3VyZSwgc2VydmVyVHlwZSB9KSxcbiAgICApO1xuICAgIHRyeSB7XG4gICAgICBmb3IgYXdhaXQgKGNvbnN0IHJlcXVlc3Qgb2Ygc2VydmVyKSB7XG4gICAgICAgIHRoaXMuI2hhbmRsZVJlcXVlc3QocmVxdWVzdCwgc2VjdXJlLCBzdGF0ZSk7XG4gICAgICB9XG4gICAgICBhd2FpdCBQcm9taXNlLmFsbChzdGF0ZS5oYW5kbGluZyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBlcnJvciBpbnN0YW5jZW9mIEVycm9yXG4gICAgICAgID8gZXJyb3IubWVzc2FnZVxuICAgICAgICA6IFwiQXBwbGljYXRpb24gRXJyb3JcIjtcbiAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChcbiAgICAgICAgbmV3IEFwcGxpY2F0aW9uRXJyb3JFdmVudCh7IG1lc3NhZ2UsIGVycm9yIH0pLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKiogUmVnaXN0ZXIgbWlkZGxld2FyZSB0byBiZSB1c2VkIHdpdGggdGhlIGFwcGxpY2F0aW9uLiAgTWlkZGxld2FyZSB3aWxsXG4gICAqIGJlIHByb2Nlc3NlZCBpbiB0aGUgb3JkZXIgaXQgaXMgYWRkZWQsIGJ1dCBtaWRkbGV3YXJlIGNhbiBjb250cm9sIHRoZSBmbG93XG4gICAqIG9mIGV4ZWN1dGlvbiB2aWEgdGhlIHVzZSBvZiB0aGUgYG5leHQoKWAgZnVuY3Rpb24gdGhhdCB0aGUgbWlkZGxld2FyZVxuICAgKiBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCB3aXRoLiAgVGhlIGBjb250ZXh0YCBvYmplY3QgcHJvdmlkZXMgaW5mb3JtYXRpb25cbiAgICogYWJvdXQgdGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhlIGFwcGxpY2F0aW9uLlxuICAgKlxuICAgKiBCYXNpYyB1c2FnZTpcbiAgICpcbiAgICogYGBgdHNcbiAgICogY29uc3QgaW1wb3J0IHsgQXBwbGljYXRpb24gfSBmcm9tIFwiaHR0cHM6Ly9kZW5vLmxhbmQveC9vYWsvbW9kLnRzXCI7XG4gICAqXG4gICAqIGNvbnN0IGFwcCA9IG5ldyBBcHBsaWNhdGlvbigpO1xuICAgKlxuICAgKiBhcHAudXNlKChjdHgsIG5leHQpID0+IHtcbiAgICogICBjdHgucmVxdWVzdDsgLy8gY29udGFpbnMgcmVxdWVzdCBpbmZvcm1hdGlvblxuICAgKiAgIGN0eC5yZXNwb25zZTsgLy8gc2V0dXBzIHVwIGluZm9ybWF0aW9uIHRvIHVzZSBpbiB0aGUgcmVzcG9uc2U7XG4gICAqICAgYXdhaXQgbmV4dCgpOyAvLyBtYW5hZ2VzIHRoZSBmbG93IGNvbnRyb2wgb2YgdGhlIG1pZGRsZXdhcmUgZXhlY3V0aW9uXG4gICAqIH0pO1xuICAgKlxuICAgKiBhd2FpdCBhcHAubGlzdGVuKHsgcG9ydDogODAgfSk7XG4gICAqIGBgYFxuICAgKi9cbiAgdXNlPFMgZXh0ZW5kcyBTdGF0ZSA9IEFTPihcbiAgICBtaWRkbGV3YXJlOiBNaWRkbGV3YXJlPFMsIENvbnRleHQ8UywgQVM+PixcbiAgICAuLi5taWRkbGV3YXJlczogTWlkZGxld2FyZTxTLCBDb250ZXh0PFMsIEFTPj5bXVxuICApOiBBcHBsaWNhdGlvbjxTIGV4dGVuZHMgQVMgPyBTIDogKFMgJiBBUyk+O1xuICB1c2U8UyBleHRlbmRzIFN0YXRlID0gQVM+KFxuICAgIC4uLm1pZGRsZXdhcmU6IE1pZGRsZXdhcmU8UywgQ29udGV4dDxTLCBBUz4+W11cbiAgKTogQXBwbGljYXRpb248UyBleHRlbmRzIEFTID8gUyA6IChTICYgQVMpPiB7XG4gICAgdGhpcy4jbWlkZGxld2FyZS5wdXNoKC4uLm1pZGRsZXdhcmUpO1xuICAgIHRoaXMuI2NvbXBvc2VkTWlkZGxld2FyZSA9IHVuZGVmaW5lZDtcbiAgICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICAgIHJldHVybiB0aGlzIGFzIEFwcGxpY2F0aW9uPGFueT47XG4gIH1cblxuICBbU3ltYm9sLmZvcihcIkRlbm8uY3VzdG9tSW5zcGVjdFwiKV0oaW5zcGVjdDogKHZhbHVlOiB1bmtub3duKSA9PiBzdHJpbmcpIHtcbiAgICBjb25zdCB7IGtleXMsIHByb3h5LCBzdGF0ZSB9ID0gdGhpcztcbiAgICByZXR1cm4gYCR7dGhpcy5jb25zdHJ1Y3Rvci5uYW1lfSAke1xuICAgICAgaW5zcGVjdCh7IFwiI21pZGRsZXdhcmVcIjogdGhpcy4jbWlkZGxld2FyZSwga2V5cywgcHJveHksIHN0YXRlIH0pXG4gICAgfWA7XG4gIH1cbn1cbiJdfQ==