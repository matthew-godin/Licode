import { base64 } from "./deps.ts";
import { BODY_TYPES, isAsyncIterable, isReader } from "./util.ts";
function isFileInfo(value) {
    return Boolean(value && typeof value === "object" && "mtime" in value && "size" in value);
}
function calcStatTag(entity) {
    const mtime = entity.mtime?.getTime().toString(16) ?? "0";
    const size = entity.size.toString(16);
    return `"${size}-${mtime}"`;
}
const encoder = new TextEncoder();
async function calcEntityTag(entity) {
    if (entity.length === 0) {
        return `"0-2jmj7l5rSw0yVb/vlWAYkK/YBwk="`;
    }
    if (typeof entity === "string") {
        entity = encoder.encode(entity);
    }
    const hash = base64.encode(await crypto.subtle.digest("SHA-1", entity))
        .substring(0, 27);
    return `"${entity.length.toString(16)}-${hash}"`;
}
function fstat(file) {
    if ("fstat" in Deno) {
        return Deno.fstat(file.rid);
    }
    return Promise.resolve(undefined);
}
export function getEntity(context) {
    const { body } = context.response;
    if (body instanceof Deno.FsFile) {
        return fstat(body);
    }
    if (body instanceof Uint8Array) {
        return Promise.resolve(body);
    }
    if (BODY_TYPES.includes(typeof body)) {
        return Promise.resolve(String(body));
    }
    if (isAsyncIterable(body) || isReader(body)) {
        return Promise.resolve(undefined);
    }
    if (typeof body === "object" && body !== null) {
        try {
            const bodyText = JSON.stringify(body);
            return Promise.resolve(bodyText);
        }
        catch {
        }
    }
    return Promise.resolve(undefined);
}
export async function calculate(entity, options = {}) {
    const weak = options.weak ?? isFileInfo(entity);
    const tag = isFileInfo(entity)
        ? calcStatTag(entity)
        : await calcEntityTag(entity);
    return weak ? `W/${tag}` : tag;
}
export function factory(options) {
    return async function etag(context, next) {
        await next();
        if (!context.response.headers.has("ETag")) {
            const entity = await getEntity(context);
            if (entity) {
                context.response.headers.set("ETag", await calculate(entity, options));
            }
        }
    };
}
export async function ifMatch(value, entity, options = {}) {
    const etag = await calculate(entity, options);
    if (etag.startsWith("W/")) {
        return false;
    }
    if (value.trim() === "*") {
        return true;
    }
    const tags = value.split(/\s*,\s*/);
    return tags.includes(etag);
}
export async function ifNoneMatch(value, entity, options = {}) {
    if (value.trim() === "*") {
        return false;
    }
    const etag = await calculate(entity, options);
    const tags = value.split(/\s*,\s*/);
    return !tags.includes(etag);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXRhZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImV0YWcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBVUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUVuQyxPQUFPLEVBQUUsVUFBVSxFQUFFLGVBQWUsRUFBRSxRQUFRLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFpQmxFLFNBQVMsVUFBVSxDQUFDLEtBQWM7SUFDaEMsT0FBTyxPQUFPLENBQ1osS0FBSyxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsSUFBSSxPQUFPLElBQUksS0FBSyxJQUFJLE1BQU0sSUFBSSxLQUFLLENBQzFFLENBQUM7QUFDSixDQUFDO0FBRUQsU0FBUyxXQUFXLENBQUMsTUFBZ0I7SUFDbkMsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLElBQUksR0FBRyxDQUFDO0lBQzFELE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBRXRDLE9BQU8sSUFBSSxJQUFJLElBQUksS0FBSyxHQUFHLENBQUM7QUFDOUIsQ0FBQztBQUVELE1BQU0sT0FBTyxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7QUFFbEMsS0FBSyxVQUFVLGFBQWEsQ0FBQyxNQUEyQjtJQUN0RCxJQUFJLE1BQU0sQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1FBQ3ZCLE9BQU8sa0NBQWtDLENBQUM7S0FDM0M7SUFFRCxJQUFJLE9BQU8sTUFBTSxLQUFLLFFBQVEsRUFBRTtRQUM5QixNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztLQUNqQztJQUVELE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7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LFVBQXVCLEVBQUU7SUFFekIsTUFBTSxJQUFJLEdBQUcsTUFBTSxTQUFTLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBRTlDLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUN6QixPQUFPLEtBQUssQ0FBQztLQUNkO0lBQ0QsSUFBSSxLQUFLLENBQUMsSUFBSSxFQUFFLEtBQUssR0FBRyxFQUFFO1FBQ3hCLE9BQU8sSUFBSSxDQUFDO0tBQ2I7SUFDRCxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3BDLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUM3QixDQUFDO0FBVUQsTUFBTSxDQUFDLEtBQUssVUFBVSxXQUFXLENBQy9CLEtBQWEsRUFDYixNQUFzQyxFQUN0QyxVQUF1QixFQUFFO0lBRXpCLElBQUksS0FBSyxDQUFDLElBQUksRUFBRSxLQUFLLEdBQUcsRUFBRTtRQUN4QixPQUFPLEtBQUssQ0FBQztLQUNkO0lBQ0QsTUFBTSxJQUFJLEdBQUcsTUFBTSxTQUFTLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzlDLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDcEMsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDOUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE4LTIwMjIgdGhlIG9hayBhdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLiBNSVQgbGljZW5zZS5cblxuLyoqXG4gKiBBIGNvbGxlY3Rpb24gb2YgQVBJcyBmb3IgZGVhbGluZyB3aXRoIEVUYWdzIGluIHJlcXVlc3RzIGFuZCByZXNwb25zZXMuXG4gKlxuICogQG1vZHVsZVxuICovXG5cbmltcG9ydCB0eXBlIHsgU3RhdGUgfSBmcm9tIFwiLi9hcHBsaWNhdGlvbi50c1wiO1xuaW1wb3J0IHR5cGUgeyBDb250ZXh0IH0gZnJvbSBcIi4vY29udGV4dC50c1wiO1xuaW1wb3J0IHsgYmFzZTY0IH0gZnJvbSBcIi4vZGVwcy50c1wiO1xuaW1wb3J0IHR5cGUgeyBNaWRkbGV3YXJlIH0gZnJvbSBcIi4vbWlkZGxld2FyZS50c1wiO1xuaW1wb3J0IHsgQk9EWV9UWVBFUywgaXNBc3luY0l0ZXJhYmxlLCBpc1JlYWRlciB9IGZyb20gXCIuL3V0aWwudHNcIjtcblxuZXhwb3J0IGludGVyZmFjZSBFVGFnT3B0aW9ucyB7XG4gIC8qKiBPdmVycmlkZSB0aGUgZGVmYXVsdCBiZWhhdmlvciBvZiBjYWxjdWxhdGluZyB0aGUgYEVUYWdgLCBlaXRoZXIgZm9yY2luZ1xuICAgKiBhIHRhZyB0byBiZSBsYWJlbGxlZCB3ZWFrIG9yIG5vdC4gKi9cbiAgd2Vhaz86IGJvb2xlYW47XG59XG5cbi8qKlxuICogSnVzdCB0aGUgcGFydCBvZiBgRGVuby5GaWxlSW5mb2AgdGhhdCBpcyByZXF1aXJlZCB0byBjYWxjdWxhdGUgYW4gYEVUYWdgLFxuICogc28gcGFydGlhbCBvciB1c2VyIGdlbmVyYXRlZCBmaWxlIGluZm9ybWF0aW9uIGNhbiBiZSBwYXNzZWQuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRmlsZUluZm8ge1xuICBtdGltZTogRGF0ZSB8IG51bGw7XG4gIHNpemU6IG51bWJlcjtcbn1cblxuZnVuY3Rpb24gaXNGaWxlSW5mbyh2YWx1ZTogdW5rbm93bik6IHZhbHVlIGlzIEZpbGVJbmZvIHtcbiAgcmV0dXJuIEJvb2xlYW4oXG4gICAgdmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSBcIm9iamVjdFwiICYmIFwibXRpbWVcIiBpbiB2YWx1ZSAmJiBcInNpemVcIiBpbiB2YWx1ZSxcbiAgKTtcbn1cblxuZnVuY3Rpb24gY2FsY1N0YXRUYWcoZW50aXR5OiBGaWxlSW5mbyk6IHN0cmluZyB7XG4gIGNvbnN0IG10aW1lID0gZW50aXR5Lm10aW1lPy5nZXRUaW1lKCkudG9TdHJpbmcoMTYpID8/IFwiMFwiO1xuICBjb25zdCBzaXplID0gZW50aXR5LnNpemUudG9TdHJpbmcoMTYpO1xuXG4gIHJldHVybiBgXCIke3NpemV9LSR7bXRpbWV9XCJgO1xufVxuXG5jb25zdCBlbmNvZGVyID0gbmV3IFRleHRFbmNvZGVyKCk7XG5cbmFzeW5jIGZ1bmN0aW9uIGNhbGNFbnRpdHlUYWcoZW50aXR5OiBzdHJpbmcgfCBVaW50OEFycmF5KTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgaWYgKGVudGl0eS5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gYFwiMC0yam1qN2w1clN3MHlWYi92bFdBWWtLL1lCd2s9XCJgO1xuICB9XG5cbiAgaWYgKHR5cGVvZiBlbnRpdHkgPT09IFwic3RyaW5nXCIpIHtcbiAgICBlbnRpdHkgPSBlbmNvZGVyLmVuY29kZShlbnRpdHkpO1xuICB9XG5cbiAgY29uc3QgaGFzaCA9IGJhc2U2NC5lbmNvZGUoYXdhaXQgY3J5cHRvLnN1YnRsZS5kaWdlc3QoXCJTSEEtMVwiLCBlbnRpdHkpKVxuICAgIC5zdWJzdHJpbmcoMCwgMjcpO1xuXG4gIHJldHVybiBgXCIke2VudGl0eS5sZW5ndGgudG9TdHJpbmcoMTYpfS0ke2hhc2h9XCJgO1xufVxuXG5mdW5jdGlvbiBmc3RhdChmaWxlOiBEZW5vLkZzRmlsZSk6IFByb21pc2U8RGVuby5GaWxlSW5mbyB8IHVuZGVmaW5lZD4ge1xuICBpZiAoXCJmc3RhdFwiIGluIERlbm8pIHtcbiAgICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICAgIHJldHVybiAoRGVubyBhcyBhbnkpLmZzdGF0KGZpbGUucmlkKTtcbiAgfVxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHVuZGVmaW5lZCk7XG59XG5cbi8qKiBGb3IgYSBnaXZlbiBDb250ZXh0LCB0cnkgdG8gZGV0ZXJtaW5lIHRoZSByZXNwb25zZSBib2R5IGVudGl0eSB0aGF0IGFuIEVUYWdcbiAqIGNhbiBiZSBjYWxjdWxhdGVkIGZyb20uICovXG4vLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuZXhwb3J0IGZ1bmN0aW9uIGdldEVudGl0eTxTIGV4dGVuZHMgU3RhdGUgPSBSZWNvcmQ8c3RyaW5nLCBhbnk+PihcbiAgY29udGV4dDogQ29udGV4dDxTPixcbik6IFByb21pc2U8c3RyaW5nIHwgVWludDhBcnJheSB8IERlbm8uRmlsZUluZm8gfCB1bmRlZmluZWQ+IHtcbiAgY29uc3QgeyBib2R5IH0gPSBjb250ZXh0LnJlc3BvbnNlO1xuICBpZiAoYm9keSBpbnN0YW5jZW9mIERlbm8uRnNGaWxlKSB7XG4gICAgcmV0dXJuIGZzdGF0KGJvZHkpO1xuICB9XG4gIGlmIChib2R5IGluc3RhbmNlb2YgVWludDhBcnJheSkge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoYm9keSk7XG4gIH1cbiAgaWYgKEJPRFlfVFlQRVMuaW5jbHVkZXModHlwZW9mIGJvZHkpKSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShTdHJpbmcoYm9keSkpO1xuICB9XG4gIGlmIChpc0FzeW5jSXRlcmFibGUoYm9keSkgfHwgaXNSZWFkZXIoYm9keSkpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHVuZGVmaW5lZCk7XG4gIH1cbiAgaWYgKHR5cGVvZiBib2R5ID09PSBcIm9iamVjdFwiICYmIGJvZHkgIT09IG51bGwpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgYm9keVRleHQgPSBKU09OLnN0cmluZ2lmeShib2R5KTtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoYm9keVRleHQpO1xuICAgIH0gY2F0Y2gge1xuICAgICAgLy8gV2UgZG9uJ3QgcmVhbGx5IGNhcmUgYWJvdXQgZXJyb3JzIGhlcmVcbiAgICB9XG4gIH1cbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh1bmRlZmluZWQpO1xufVxuXG4vKipcbiAqIENhbGN1bGF0ZSBhbiBFVGFnIHZhbHVlIGZvciBhbiBlbnRpdHkuIElmIHRoZSBlbnRpdHkgaXMgYEZpbGVJbmZvYCwgdGhlbiB0aGVcbiAqIHRhZyB3aWxsIGRlZmF1bHQgdG8gYSBfd2Vha18gRVRhZy4gIGBvcHRpb25zLndlYWtgIG92ZXJyaWRlcyBhbnkgZGVmYXVsdFxuICogYmVoYXZpb3IgaW4gZ2VuZXJhdGluZyB0aGUgdGFnLlxuICpcbiAqIEBwYXJhbSBlbnRpdHkgQSBzdHJpbmcsIFVpbnQ4QXJyYXksIG9yIGZpbGUgaW5mbyB0byB1c2UgdG8gZ2VuZXJhdGUgdGhlIEVUYWdcbiAqIEBwYXJhbSBvcHRpb25zXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjYWxjdWxhdGUoXG4gIGVudGl0eTogc3RyaW5nIHwgVWludDhBcnJheSB8IEZpbGVJbmZvLFxuICBvcHRpb25zOiBFVGFnT3B0aW9ucyA9IHt9LFxuKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgY29uc3Qgd2VhayA9IG9wdGlvbnMud2VhayA/PyBpc0ZpbGVJbmZvKGVudGl0eSk7XG4gIGNvbnN0IHRhZyA9IGlzRmlsZUluZm8oZW50aXR5KVxuICAgID8gY2FsY1N0YXRUYWcoZW50aXR5KVxuICAgIDogYXdhaXQgY2FsY0VudGl0eVRhZyhlbnRpdHkpO1xuXG4gIHJldHVybiB3ZWFrID8gYFcvJHt0YWd9YCA6IHRhZztcbn1cblxuLyoqXG4gKiBDcmVhdGUgbWlkZGxld2FyZSB0aGF0IHdpbGwgYXR0ZW1wdCB0byBkZWNvZGUgdGhlIHJlc3BvbnNlLmJvZHkgaW50b1xuICogc29tZXRoaW5nIHRoYXQgY2FuIGJlIHVzZWQgdG8gZ2VuZXJhdGUgYW4gYEVUYWdgIGFuZCBhZGQgdGhlIGBFVGFnYCBoZWFkZXIgdG9cbiAqIHRoZSByZXNwb25zZS5cbiAqL1xuLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbmV4cG9ydCBmdW5jdGlvbiBmYWN0b3J5PFMgZXh0ZW5kcyBTdGF0ZSA9IFJlY29yZDxzdHJpbmcsIGFueT4+KFxuICBvcHRpb25zPzogRVRhZ09wdGlvbnMsXG4pOiBNaWRkbGV3YXJlPFM+IHtcbiAgcmV0dXJuIGFzeW5jIGZ1bmN0aW9uIGV0YWcoY29udGV4dDogQ29udGV4dDxTPiwgbmV4dCkge1xuICAgIGF3YWl0IG5leHQoKTtcbiAgICBpZiAoIWNvbnRleHQucmVzcG9uc2UuaGVhZGVycy5oYXMoXCJFVGFnXCIpKSB7XG4gICAgICBjb25zdCBlbnRpdHkgPSBhd2FpdCBnZXRFbnRpdHkoY29udGV4dCk7XG4gICAgICBpZiAoZW50aXR5KSB7XG4gICAgICAgIGNvbnRleHQucmVzcG9uc2UuaGVhZGVycy5zZXQoXCJFVGFnXCIsIGF3YWl0IGNhbGN1bGF0ZShlbnRpdHksIG9wdGlvbnMpKTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG59XG5cbi8qKlxuICogQSBoZWxwZXIgZnVuY3Rpb24gdGhhdCB0YWtlcyB0aGUgdmFsdWUgZnJvbSB0aGUgYElmLU1hdGNoYCBoZWFkZXIgYW5kIGFuXG4gKiBlbnRpdHkgYW5kIHJldHVybnMgYHRydWVgIGlmIHRoZSBgRVRhZ2AgZm9yIHRoZSBlbnRpdHkgbWF0Y2hlcyB0aGUgc3VwcGxpZWRcbiAqIHZhbHVlLCBvdGhlcndpc2UgYGZhbHNlYC5cbiAqXG4gKiBTZWUgTUROJ3MgW2BJZi1NYXRjaGBdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0hUVFAvSGVhZGVycy9JZi1NYXRjaClcbiAqIGFydGljbGUgZm9yIG1vcmUgaW5mb3JtYXRpb24gb24gaG93IHRvIHVzZSB0aGlzIGZ1bmN0aW9uLlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaWZNYXRjaChcbiAgdmFsdWU6IHN0cmluZyxcbiAgZW50aXR5OiBzdHJpbmcgfCBVaW50OEFycmF5IHwgRmlsZUluZm8sXG4gIG9wdGlvbnM6IEVUYWdPcHRpb25zID0ge30sXG4pOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgY29uc3QgZXRhZyA9IGF3YWl0IGNhbGN1bGF0ZShlbnRpdHksIG9wdGlvbnMpO1xuICAvLyBXZWFrIHRhZ3MgY2Fubm90IGJlIG1hdGNoZWQgYW5kIHJldHVybiBmYWxzZS5cbiAgaWYgKGV0YWcuc3RhcnRzV2l0aChcIlcvXCIpKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIGlmICh2YWx1ZS50cmltKCkgPT09IFwiKlwiKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgY29uc3QgdGFncyA9IHZhbHVlLnNwbGl0KC9cXHMqLFxccyovKTtcbiAgcmV0dXJuIHRhZ3MuaW5jbHVkZXMoZXRhZyk7XG59XG5cbi8qKlxuICogQSBoZWxwZXIgZnVuY3Rpb24gdGhhdCB0YWtlcyB0aGUgdmFsdWUgZnJvbSB0aGUgYElmLU5vLU1hdGNoYCBoZWFkZXIgYW5kXG4gKiBhbiBlbnRpdHkgYW5kIHJldHVybnMgYGZhbHNlYCBpZiB0aGUgYEVUYWdgIGZvciB0aGUgZW50aXR5IG1hdGNoZXMgdGhlXG4gKiBzdXBwbGllZCB2YWx1ZSwgb3RoZXJ3aXNlIGBmYWxzZWAuXG4gKlxuICogU2VlIE1ETidzIFtgSWYtTm9uZS1NYXRjaGBdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0hUVFAvSGVhZGVycy9JZi1Ob25lLU1hdGNoKVxuICogYXJ0aWNsZSBmb3IgbW9yZSBpbmZvcm1hdGlvbiBvbiBob3cgdG8gdXNlIHRoaXMgZnVuY3Rpb24uXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBpZk5vbmVNYXRjaChcbiAgdmFsdWU6IHN0cmluZyxcbiAgZW50aXR5OiBzdHJpbmcgfCBVaW50OEFycmF5IHwgRmlsZUluZm8sXG4gIG9wdGlvbnM6IEVUYWdPcHRpb25zID0ge30sXG4pOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgaWYgKHZhbHVlLnRyaW0oKSA9PT0gXCIqXCIpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgY29uc3QgZXRhZyA9IGF3YWl0IGNhbGN1bGF0ZShlbnRpdHksIG9wdGlvbnMpO1xuICBjb25zdCB0YWdzID0gdmFsdWUuc3BsaXQoL1xccyosXFxzKi8pO1xuICByZXR1cm4gIXRhZ3MuaW5jbHVkZXMoZXRhZyk7XG59XG4iXX0=