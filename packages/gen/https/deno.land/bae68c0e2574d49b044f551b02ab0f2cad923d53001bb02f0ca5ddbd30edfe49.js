import { Cookies } from "./cookies.ts";
import { acceptable, acceptWebSocket } from "./deps.ts";
import { NativeRequest } from "./http_server_native.ts";
import { createHttpError } from "./httpError.ts";
import { Request } from "./request.ts";
import { Response } from "./response.ts";
import { send } from "./send.ts";
import { SSEStdLibTarget, SSEStreamTarget, } from "./server_sent_event.ts";
import { WebSocketShim } from "./websocket.ts";
export class Context {
    #socket;
    #sse;
    app;
    cookies;
    get isUpgradable() {
        return acceptable(this.request);
    }
    respond;
    request;
    response;
    get socket() {
        return this.#socket;
    }
    state;
    constructor(app, serverRequest, state, secure = false) {
        this.app = app;
        this.state = state;
        this.request = new Request(serverRequest, app.proxy, secure);
        this.respond = true;
        this.response = new Response(this.request);
        this.cookies = new Cookies(this.request, this.response, {
            keys: this.app.keys,
            secure: this.request.secure,
        });
    }
    assert(condition, errorStatus = 500, message, props) {
        if (condition) {
            return;
        }
        const err = createHttpError(errorStatus, message);
        if (props) {
            Object.assign(err, props);
        }
        throw err;
    }
    send(options) {
        const { path = this.request.url.pathname, ...sendOptions } = options;
        return send(this, path, sendOptions);
    }
    sendEvents(options) {
        if (!this.#sse) {
            if (this.request.originalRequest instanceof NativeRequest) {
                this.#sse = new SSEStreamTarget(this, options);
            }
            else {
                this.respond = false;
                this.#sse = new SSEStdLibTarget(this, options);
            }
        }
        return this.#sse;
    }
    throw(errorStatus, message, props) {
        const err = createHttpError(errorStatus, message);
        if (props) {
            Object.assign(err, props);
        }
        throw err;
    }
    async upgrade(options) {
        if (this.#socket) {
            return this.#socket;
        }
        if (this.request.originalRequest instanceof NativeRequest) {
            this.#socket = this.request.originalRequest.upgrade(options);
        }
        else {
            const { conn, r: bufReader, w: bufWriter, headers } = this.request.originalRequest;
            this.#socket = new WebSocketShim(await acceptWebSocket({ conn, bufReader, bufWriter, headers }), this.request.url.toString(), options?.protocol);
        }
        this.respond = false;
        return this.#socket;
    }
    [Symbol.for("Deno.customInspect")](inspect) {
        const { app, cookies, isUpgradable, respond, request, response, socket, state, } = this;
        return `${this.constructor.name} ${inspect({
            app,
            cookies,
            isUpgradable,
            respond,
            request,
            response,
            socket,
            state,
        })}`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvbnRleHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBR0EsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUN2QyxPQUFPLEVBQUUsVUFBVSxFQUFFLGVBQWUsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN4RCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFFeEQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRWpELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDdkMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN6QyxPQUFPLEVBQUUsSUFBSSxFQUFlLE1BQU0sV0FBVyxDQUFDO0FBQzlDLE9BQU8sRUFFTCxlQUFlLEVBQ2YsZUFBZSxHQUNoQixNQUFNLHdCQUF3QixDQUFDO0FBR2hDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQVkvQyxNQUFNLE9BQU8sT0FBTztJQUtsQixPQUFPLENBQWE7SUFDcEIsSUFBSSxDQUF5QjtJQUc3QixHQUFHLENBQWtCO0lBSXJCLE9BQU8sQ0FBVTtJQUtqQixJQUFJLFlBQVk7UUFDZCxPQUFPLFVBQVUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQVVELE9BQU8sQ0FBVTtJQUdqQixPQUFPLENBQVU7SUFJakIsUUFBUSxDQUFXO0lBSW5CLElBQUksTUFBTTtRQUNSLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUN0QixDQUFDO0lBc0JELEtBQUssQ0FBSTtJQUVULFlBQ0UsR0FBb0IsRUFDcEIsYUFBNEMsRUFDNUMsS0FBUSxFQUNSLE1BQU0sR0FBRyxLQUFLO1FBRWQsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7UUFDZixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FB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LEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxDQUN4QyxFQUNELElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxFQUMzQixPQUFPLEVBQUUsUUFBUSxDQUNsQixDQUFDO1NBQ0g7UUFDRCxJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztRQUNyQixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDdEIsQ0FBQztJQUVELENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsT0FBbUM7UUFDcEUsTUFBTSxFQUNKLEdBQUcsRUFDSCxPQUFPLEVBQ1AsWUFBWSxFQUNaLE9BQU8sRUFDUCxPQUFPLEVBQ1AsUUFBUSxFQUNSLE1BQU0sRUFDTixLQUFLLEdBQ04sR0FBRyxJQUFJLENBQUM7UUFDVCxPQUFPLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLElBQzdCLE9BQU8sQ0FBQztZQUNOLEdBQUc7WUFDSCxPQUFPO1lBQ1AsWUFBWTtZQUNaLE9BQU87WUFDUCxPQUFPO1lBQ1AsUUFBUTtZQUNSLE1BQU07WUFDTixLQUFLO1NBQ04sQ0FDSCxFQUFFLENBQUM7SUFDTCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDIxIHRoZSBvYWsgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4gTUlUIGxpY2Vuc2UuXG5cbmltcG9ydCB0eXBlIHsgQXBwbGljYXRpb24sIFN0YXRlIH0gZnJvbSBcIi4vYXBwbGljYXRpb24udHNcIjtcbmltcG9ydCB7IENvb2tpZXMgfSBmcm9tIFwiLi9jb29raWVzLnRzXCI7XG5pbXBvcnQgeyBhY2NlcHRhYmxlLCBhY2NlcHRXZWJTb2NrZXQgfSBmcm9tIFwiLi9kZXBzLnRzXCI7XG5pbXBvcnQgeyBOYXRpdmVSZXF1ZXN0IH0gZnJvbSBcIi4vaHR0cF9zZXJ2ZXJfbmF0aXZlLnRzXCI7XG5pbXBvcnQgdHlwZSB7IFNlcnZlclJlcXVlc3QgfSBmcm9tIFwiLi9odHRwX3NlcnZlcl9zdGQudHNcIjtcbmltcG9ydCB7IGNyZWF0ZUh0dHBFcnJvciB9IGZyb20gXCIuL2h0dHBFcnJvci50c1wiO1xuaW1wb3J0IHR5cGUgeyBLZXlTdGFjayB9IGZyb20gXCIuL2tleVN0YWNrLnRzXCI7XG5pbXBvcnQgeyBSZXF1ZXN0IH0gZnJvbSBcIi4vcmVxdWVzdC50c1wiO1xuaW1wb3J0IHsgUmVzcG9uc2UgfSBmcm9tIFwiLi9yZXNwb25zZS50c1wiO1xuaW1wb3J0IHsgc2VuZCwgU2VuZE9wdGlvbnMgfSBmcm9tIFwiLi9zZW5kLnRzXCI7XG5pbXBvcnQge1xuICBTZXJ2ZXJTZW50RXZlbnRUYXJnZXRPcHRpb25zLFxuICBTU0VTdGRMaWJUYXJnZXQsXG4gIFNTRVN0cmVhbVRhcmdldCxcbn0gZnJvbSBcIi4vc2VydmVyX3NlbnRfZXZlbnQudHNcIjtcbmltcG9ydCB0eXBlIHsgU2VydmVyU2VudEV2ZW50VGFyZ2V0IH0gZnJvbSBcIi4vc2VydmVyX3NlbnRfZXZlbnQudHNcIjtcbmltcG9ydCB0eXBlIHsgRXJyb3JTdGF0dXMgfSBmcm9tIFwiLi90eXBlcy5kLnRzXCI7XG5pbXBvcnQgeyBXZWJTb2NrZXRTaGltIH0gZnJvbSBcIi4vd2Vic29ja2V0LnRzXCI7XG5pbXBvcnQgdHlwZSB7IFVwZ3JhZGVXZWJTb2NrZXRPcHRpb25zIH0gZnJvbSBcIi4vd2Vic29ja2V0LnRzXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29udGV4dFNlbmRPcHRpb25zIGV4dGVuZHMgU2VuZE9wdGlvbnMge1xuICAvKiogVGhlIGZpbGVuYW1lIHRvIHNlbmQsIHdoaWNoIHdpbGwgYmUgcmVzb2x2ZWQgYmFzZWQgb24gdGhlIG90aGVyIG9wdGlvbnMuXG4gICAqIElmIHRoaXMgcHJvcGVydHkgaXMgb21pdHRlZCwgdGhlIGN1cnJlbnQgY29udGV4dCdzIGAucmVxdWVzdC51cmwucGF0aG5hbWVgXG4gICAqIHdpbGwgYmUgdXNlZC4gKi9cbiAgcGF0aD86IHN0cmluZztcbn1cblxuLyoqIFByb3ZpZGVzIGNvbnRleHQgYWJvdXQgdGhlIGN1cnJlbnQgcmVxdWVzdCBhbmQgcmVzcG9uc2UgdG8gbWlkZGxld2FyZVxuICogZnVuY3Rpb25zLiAqL1xuZXhwb3J0IGNsYXNzIENvbnRleHQ8XG4gIFMgZXh0ZW5kcyBBUyA9IFN0YXRlLFxuICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICBBUyBleHRlbmRzIFN0YXRlID0gUmVjb3JkPHN0cmluZywgYW55Pixcbj4ge1xuICAjc29ja2V0PzogV2ViU29ja2V0O1xuICAjc3NlPzogU2VydmVyU2VudEV2ZW50VGFyZ2V0O1xuXG4gIC8qKiBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudCBhcHBsaWNhdGlvbi4gKi9cbiAgYXBwOiBBcHBsaWNhdGlvbjxBUz47XG5cbiAgLyoqIEFuIG9iamVjdCB3aGljaCBhbGxvd3MgYWNjZXNzIHRvIGNvb2tpZXMsIG1lZGlhdGluZyBib3RoIHRoZSByZXF1ZXN0IGFuZFxuICAgKiByZXNwb25zZS4gKi9cbiAgY29va2llczogQ29va2llcztcblxuICAvKiogSXMgYHRydWVgIGlmIHRoZSBjdXJyZW50IGNvbm5lY3Rpb24gaXMgdXBncmFkZWFibGUgdG8gYSB3ZWIgc29ja2V0LlxuICAgKiBPdGhlcndpc2UgdGhlIHZhbHVlIGlzIGBmYWxzZWAuICBVc2UgYC51cGdyYWRlKClgIHRvIHVwZ3JhZGUgdGhlIGNvbm5lY3Rpb25cbiAgICogYW5kIHJldHVybiB0aGUgd2ViIHNvY2tldC4gKi9cbiAgZ2V0IGlzVXBncmFkYWJsZSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gYWNjZXB0YWJsZSh0aGlzLnJlcXVlc3QpO1xuICB9XG5cbiAgLyoqIERldGVybWluZXMgaWYgdGhlIHJlcXVlc3Qgc2hvdWxkIGJlIHJlc3BvbmRlZCB0by4gIElmIGBmYWxzZWAgd2hlbiB0aGVcbiAgICogbWlkZGxld2FyZSBjb21wbGV0ZXMgcHJvY2Vzc2luZywgdGhlIHJlc3BvbnNlIHdpbGwgbm90IGJlIHNlbnQgYmFjayB0byB0aGVcbiAgICogcmVxdWVzdG9yLiAgVHlwaWNhbGx5IHRoaXMgaXMgdXNlZCBpZiB0aGUgbWlkZGxld2FyZSB3aWxsIHRha2Ugb3ZlciBsb3dcbiAgICogbGV2ZWwgcHJvY2Vzc2luZyBvZiByZXF1ZXN0cyBhbmQgcmVzcG9uc2VzLCBmb3IgZXhhbXBsZSBpZiB1c2luZyB3ZWJcbiAgICogc29ja2V0cy4gIFRoaXMgYXV0b21hdGljYWxseSBnZXRzIHNldCB0byBgZmFsc2VgIHdoZW4gdGhlIGNvbnRleHQgaXNcbiAgICogdXBncmFkZWQgdG8gYSB3ZWIgc29ja2V0IHZpYSB0aGUgYC51cGdyYWRlKClgIG1ldGhvZC5cbiAgICpcbiAgICogVGhlIGRlZmF1bHQgaXMgYHRydWVgLiAqL1xuICByZXNwb25kOiBib29sZWFuO1xuXG4gIC8qKiBBbiBvYmplY3Qgd2hpY2ggY29udGFpbnMgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGN1cnJlbnQgcmVxdWVzdC4gKi9cbiAgcmVxdWVzdDogUmVxdWVzdDtcblxuICAvKiogQW4gb2JqZWN0IHdoaWNoIGNvbnRhaW5zIGluZm9ybWF0aW9uIGFib3V0IHRoZSByZXNwb25zZSB0aGF0IHdpbGwgYmUgc2VudFxuICAgKiB3aGVuIHRoZSBtaWRkbGV3YXJlIGZpbmlzaGVzIHByb2Nlc3NpbmcuICovXG4gIHJlc3BvbnNlOiBSZXNwb25zZTtcblxuICAvKiogSWYgdGhlIHRoZSBjdXJyZW50IGNvbnRleHQgaGFzIGJlZW4gdXBncmFkZWQsIHRoZW4gdGhpcyB3aWxsIGJlIHNldCB0b1xuICAgKiB3aXRoIHRoZSBjdXJyZW50IHdlYiBzb2NrZXQsIG90aGVyd2lzZSBpdCBpcyBgdW5kZWZpbmVkYC4gKi9cbiAgZ2V0IHNvY2tldCgpOiBXZWJTb2NrZXQgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLiNzb2NrZXQ7XG4gIH1cblxuICAvKiogVGhlIG9iamVjdCB0byBwYXNzIHN0YXRlIHRvIGZyb250LWVuZCB2aWV3cy4gIFRoaXMgY2FuIGJlIHR5cGVkIGJ5XG4gICAqIHN1cHBseWluZyB0aGUgZ2VuZXJpYyBzdGF0ZSBhcmd1bWVudCB3aGVuIGNyZWF0aW5nIGEgbmV3IGFwcC4gIEZvclxuICAgKiBleGFtcGxlOlxuICAgKlxuICAgKiBgYGB0c1xuICAgKiBjb25zdCBhcHAgPSBuZXcgQXBwbGljYXRpb248eyBmb286IHN0cmluZyB9PigpO1xuICAgKiBgYGBcbiAgICpcbiAgICogT3IgY2FuIGJlIGNvbnRleHR1YWxseSBpbmZlcnJlZCBiYXNlZCBvbiBzZXR0aW5nIGFuIGluaXRpYWwgc3RhdGUgb2JqZWN0OlxuICAgKlxuICAgKiBgYGB0c1xuICAgKiBjb25zdCBhcHAgPSBuZXcgQXBwbGljYXRpb24oeyBzdGF0ZTogeyBmb286IFwiYmFyXCIgfSB9KTtcbiAgICogYGBgXG4gICAqXG4gICAqIE9uIGVhY2ggcmVxdWVzdC9yZXNwb25zZSBjeWNsZSwgdGhlIGNvbnRleHQncyBzdGF0ZSBpcyBjbG9uZWQgZnJvbSB0aGVcbiAgICogYXBwbGljYXRpb24gc3RhdGUuIFRoaXMgbWVhbnMgY2hhbmdlcyB0byB0aGUgY29udGV4dCdzIGAuc3RhdGVgIHdpbGwgYmVcbiAgICogZHJvcHBlZCB3aGVuIHRoZSByZXF1ZXN0IGRyb3BzLCBidXQgXCJkZWZhdWx0c1wiIGNhbiBiZSBhcHBsaWVkIHRvIHRoZVxuICAgKiBhcHBsaWNhdGlvbidzIHN0YXRlLiAgQ2hhbmdlcyB0byB0aGUgYXBwbGljYXRpb24ncyBzdGF0ZSB0aG91Z2ggd29uJ3QgYmVcbiAgICogcmVmbGVjdGVkIHVudGlsIHRoZSBuZXh0IHJlcXVlc3QgaW4gdGhlIGNvbnRleHQncyBzdGF0ZS5cbiAgICovXG4gIHN0YXRlOiBTO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGFwcDogQXBwbGljYXRpb248QVM+LFxuICAgIHNlcnZlclJlcXVlc3Q6IFNlcnZlclJlcXVlc3QgfCBOYXRpdmVSZXF1ZXN0LFxuICAgIHN0YXRlOiBTLFxuICAgIHNlY3VyZSA9IGZhbHNlLFxuICApIHtcbiAgICB0aGlzLmFwcCA9IGFwcDtcbiAgICB0aGlzLnN0YXRlID0gc3RhdGU7XG4gICAgdGhpcy5yZXF1ZXN0ID0gbmV3IFJlcXVlc3Qoc2VydmVyUmVxdWVzdCwgYXBwLnByb3h5LCBzZWN1cmUpO1xuICAgIHRoaXMucmVzcG9uZCA9IHRydWU7XG4gICAgdGhpcy5yZXNwb25zZSA9IG5ldyBSZXNwb25zZSh0aGlzLnJlcXVlc3QpO1xuICAgIHRoaXMuY29va2llcyA9IG5ldyBDb29raWVzKHRoaXMucmVxdWVzdCwgdGhpcy5yZXNwb25zZSwge1xuICAgICAga2V5czogdGhpcy5hcHAua2V5cyBhcyBLZXlTdGFjayB8IHVuZGVmaW5lZCxcbiAgICAgIHNlY3VyZTogdGhpcy5yZXF1ZXN0LnNlY3VyZSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKiBBc3NlcnRzIHRoZSBjb25kaXRpb24gYW5kIGlmIHRoZSBjb25kaXRpb24gZmFpbHMsIGNyZWF0ZXMgYW4gSFRUUCBlcnJvclxuICAgKiB3aXRoIHRoZSBwcm92aWRlZCBzdGF0dXMgKHdoaWNoIGRlZmF1bHRzIHRvIGA1MDBgKS4gIFRoZSBlcnJvciBzdGF0dXMgYnlcbiAgICogZGVmYXVsdCB3aWxsIGJlIHNldCBvbiB0aGUgYC5yZXNwb25zZS5zdGF0dXNgLlxuICAgKi9cbiAgYXNzZXJ0KFxuICAgIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gICAgY29uZGl0aW9uOiBhbnksXG4gICAgZXJyb3JTdGF0dXM6IEVycm9yU3RhdHVzID0gNTAwLFxuICAgIG1lc3NhZ2U/OiBzdHJpbmcsXG4gICAgcHJvcHM/OiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPixcbiAgKTogYXNzZXJ0cyBjb25kaXRpb24ge1xuICAgIGlmIChjb25kaXRpb24pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgZXJyID0gY3JlYXRlSHR0cEVycm9yKGVycm9yU3RhdHVzLCBtZXNzYWdlKTtcbiAgICBpZiAocHJvcHMpIHtcbiAgICAgIE9iamVjdC5hc3NpZ24oZXJyLCBwcm9wcyk7XG4gICAgfVxuICAgIHRocm93IGVycjtcbiAgfVxuXG4gIC8qKiBBc3luY2hyb25vdXNseSBmdWxmaWxsIGEgcmVzcG9uc2Ugd2l0aCBhIGZpbGUgZnJvbSB0aGUgbG9jYWwgZmlsZVxuICAgKiBzeXN0ZW0uXG4gICAqXG4gICAqIElmIHRoZSBgb3B0aW9ucy5wYXRoYCBpcyBub3Qgc3VwcGxpZWQsIHRoZSBmaWxlIHRvIGJlIHNlbnQgd2lsbCBkZWZhdWx0XG4gICAqIHRvIHRoaXMgYC5yZXF1ZXN0LnVybC5wYXRobmFtZWAuXG4gICAqXG4gICAqIFJlcXVpcmVzIERlbm8gcmVhZCBwZXJtaXNzaW9uLiAqL1xuICBzZW5kKG9wdGlvbnM6IENvbnRleHRTZW5kT3B0aW9ucyk6IFByb21pc2U8c3RyaW5nIHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3QgeyBwYXRoID0gdGhpcy5yZXF1ZXN0LnVybC5wYXRobmFtZSwgLi4uc2VuZE9wdGlvbnMgfSA9IG9wdGlvbnM7XG4gICAgcmV0dXJuIHNlbmQodGhpcywgcGF0aCwgc2VuZE9wdGlvbnMpO1xuICB9XG5cbiAgLyoqIENvbnZlcnQgdGhlIGNvbm5lY3Rpb24gdG8gc3RyZWFtIGV2ZW50cywgcmV0dXJuaW5nIGFuIGV2ZW50IHRhcmdldCBmb3JcbiAgICogc2VuZGluZyBzZXJ2ZXIgc2VudCBldmVudHMuICBFdmVudHMgZGlzcGF0Y2hlZCBvbiB0aGUgcmV0dXJuZWQgdGFyZ2V0IHdpbGxcbiAgICogYmUgc2VudCB0byB0aGUgY2xpZW50IGFuZCBiZSBhdmFpbGFibGUgaW4gdGhlIGNsaWVudCdzIGBFdmVudFNvdXJjZWAgdGhhdFxuICAgKiBpbml0aWF0ZWQgdGhlIGNvbm5lY3Rpb24uXG4gICAqXG4gICAqIFRoaXMgd2lsbCBzZXQgYC5yZXNwb25kYCB0byBgZmFsc2VgLiAqL1xuICBzZW5kRXZlbnRzKG9wdGlvbnM/OiBTZXJ2ZXJTZW50RXZlbnRUYXJnZXRPcHRpb25zKTogU2VydmVyU2VudEV2ZW50VGFyZ2V0IHtcbiAgICBpZiAoIXRoaXMuI3NzZSkge1xuICAgICAgaWYgKHRoaXMucmVxdWVzdC5vcmlnaW5hbFJlcXVlc3QgaW5zdGFuY2VvZiBOYXRpdmVSZXF1ZXN0KSB7XG4gICAgICAgIHRoaXMuI3NzZSA9IG5ldyBTU0VTdHJlYW1UYXJnZXQodGhpcywgb3B0aW9ucyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnJlc3BvbmQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy4jc3NlID0gbmV3IFNTRVN0ZExpYlRhcmdldCh0aGlzLCBvcHRpb25zKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuI3NzZTtcbiAgfVxuXG4gIC8qKiBDcmVhdGUgYW5kIHRocm93IGFuIEhUVFAgRXJyb3IsIHdoaWNoIGNhbiBiZSB1c2VkIHRvIHBhc3Mgc3RhdHVzXG4gICAqIGluZm9ybWF0aW9uIHdoaWNoIGNhbiBiZSBjYXVnaHQgYnkgb3RoZXIgbWlkZGxld2FyZSB0byBzZW5kIG1vcmVcbiAgICogbWVhbmluZ2Z1bCBlcnJvciBtZXNzYWdlcyBiYWNrIHRvIHRoZSBjbGllbnQuICBUaGUgcGFzc2VkIGVycm9yIHN0YXR1cyB3aWxsXG4gICAqIGJlIHNldCBvbiB0aGUgYC5yZXNwb25zZS5zdGF0dXNgIGJ5IGRlZmF1bHQgYXMgd2VsbC5cbiAgICovXG4gIHRocm93KFxuICAgIGVycm9yU3RhdHVzOiBFcnJvclN0YXR1cyxcbiAgICBtZXNzYWdlPzogc3RyaW5nLFxuICAgIHByb3BzPzogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gICk6IG5ldmVyIHtcbiAgICBjb25zdCBlcnIgPSBjcmVhdGVIdHRwRXJyb3IoZXJyb3JTdGF0dXMsIG1lc3NhZ2UpO1xuICAgIGlmIChwcm9wcykge1xuICAgICAgT2JqZWN0LmFzc2lnbihlcnIsIHByb3BzKTtcbiAgICB9XG4gICAgdGhyb3cgZXJyO1xuICB9XG5cbiAgLyoqIFRha2UgdGhlIGN1cnJlbnQgcmVxdWVzdCBhbmQgdXBncmFkZSBpdCB0byBhIHdlYiBzb2NrZXQsIHJlc29sdmluZyB3aXRoXG4gICAqIHRoZSBhIHdlYiBzdGFuZGFyZCBgV2ViU29ja2V0YCBvYmplY3QuIFRoaXMgd2lsbCBzZXQgYC5yZXNwb25kYCB0b1xuICAgKiBgZmFsc2VgLlxuICAgKlxuICAgKiAqTm90ZSogd2hlbiB1c2luZyB0aGUgYHN0ZGAgbGlicmFyeSBIVFRQIHNlcnZlciB2ZXJzdXMgdGhlIERlbm8gbmF0aXZlXG4gICAqIEhUVFAgc2VydmVyLCB0aGUgYHN0ZGAgV2ViU29ja2V0IGlzIHdyYXBwZWQgYnkgYSBjbGFzcyB0aGF0IHByb3ZpZGVzIGFcbiAgICogd2ViIHN0YW5kYXJkIGBXZWJTb2NrZXRgIGludGVyZmFjZS4gVGhlIGBzdGRgIFdlYlNvY2tldCBkb2VzIG5vdCBoYW5kbGUgdGhlXG4gICAqIG9wdGlvbmFsIG9wdGlvbnMgdGhhdCBhcmUgcHJvdmlkZWQgd2hlbiB1cGdyYWRpbmcuXG4gICAqL1xuICBhc3luYyB1cGdyYWRlKG9wdGlvbnM/OiBVcGdyYWRlV2ViU29ja2V0T3B0aW9ucyk6IFByb21pc2U8V2ViU29ja2V0PiB7XG4gICAgaWYgKHRoaXMuI3NvY2tldCkge1xuICAgICAgcmV0dXJuIHRoaXMuI3NvY2tldDtcbiAgICB9XG4gICAgaWYgKHRoaXMucmVxdWVzdC5vcmlnaW5hbFJlcXVlc3QgaW5zdGFuY2VvZiBOYXRpdmVSZXF1ZXN0KSB7XG4gICAgICB0aGlzLiNzb2NrZXQgPSB0aGlzLnJlcXVlc3Qub3JpZ2luYWxSZXF1ZXN0LnVwZ3JhZGUob3B0aW9ucyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHsgY29ubiwgcjogYnVmUmVhZGVyLCB3OiBidWZXcml0ZXIsIGhlYWRlcnMgfSA9XG4gICAgICAgIHRoaXMucmVxdWVzdC5vcmlnaW5hbFJlcXVlc3Q7XG4gICAgICB0aGlzLiNzb2NrZXQgPSBuZXcgV2ViU29ja2V0U2hpbShcbiAgICAgICAgYXdhaXQgYWNjZXB0V2ViU29ja2V0KFxuICAgICAgICAgIHsgY29ubiwgYnVmUmVhZGVyLCBidWZXcml0ZXIsIGhlYWRlcnMgfSxcbiAgICAgICAgKSxcbiAgICAgICAgdGhpcy5yZXF1ZXN0LnVybC50b1N0cmluZygpLFxuICAgICAgICBvcHRpb25zPy5wcm90b2NvbCxcbiAgICAgICk7XG4gICAgfVxuICAgIHRoaXMucmVzcG9uZCA9IGZhbHNlO1xuICAgIHJldHVybiB0aGlzLiNzb2NrZXQ7XG4gIH1cblxuICBbU3ltYm9sLmZvcihcIkRlbm8uY3VzdG9tSW5zcGVjdFwiKV0oaW5zcGVjdDogKHZhbHVlOiB1bmtub3duKSA9PiBzdHJpbmcpIHtcbiAgICBjb25zdCB7XG4gICAgICBhcHAsXG4gICAgICBjb29raWVzLFxuICAgICAgaXNVcGdyYWRhYmxlLFxuICAgICAgcmVzcG9uZCxcbiAgICAgIHJlcXVlc3QsXG4gICAgICByZXNwb25zZSxcbiAgICAgIHNvY2tldCxcbiAgICAgIHN0YXRlLFxuICAgIH0gPSB0aGlzO1xuICAgIHJldHVybiBgJHt0aGlzLmNvbnN0cnVjdG9yLm5hbWV9ICR7XG4gICAgICBpbnNwZWN0KHtcbiAgICAgICAgYXBwLFxuICAgICAgICBjb29raWVzLFxuICAgICAgICBpc1VwZ3JhZGFibGUsXG4gICAgICAgIHJlc3BvbmQsXG4gICAgICAgIHJlcXVlc3QsXG4gICAgICAgIHJlc3BvbnNlLFxuICAgICAgICBzb2NrZXQsXG4gICAgICAgIHN0YXRlLFxuICAgICAgfSlcbiAgICB9YDtcbiAgfVxufVxuIl19