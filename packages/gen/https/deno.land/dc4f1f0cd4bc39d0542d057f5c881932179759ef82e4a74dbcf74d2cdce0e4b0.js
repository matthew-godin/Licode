import { assert } from "./deps.ts";
import { NativeRequest } from "./http_server_native.ts";
const encoder = new TextEncoder();
const DEFAULT_KEEP_ALIVE_INTERVAL = 30_000;
class CloseEvent extends Event {
    constructor(eventInit) {
        super("close", eventInit);
    }
}
export class ServerSentEvent extends Event {
    #data;
    #id;
    #type;
    constructor(type, data, { replacer, space, ...eventInit } = {}) {
        super(type, eventInit);
        this.#type = type;
        try {
            this.#data = typeof data === "string"
                ? data
                : JSON.stringify(data, replacer, space);
        }
        catch (e) {
            assert(e instanceof Error);
            throw new TypeError(`data could not be coerced into a serialized string.\n  ${e.message}`);
        }
        const { id } = eventInit;
        this.#id = id;
    }
    get data() {
        return this.#data;
    }
    get id() {
        return this.#id;
    }
    toString() {
        const data = `data: ${this.#data.split("\n").join("\ndata: ")}\n`;
        return `${this.#type === "__message" ? "" : `event: ${this.#type}\n`}${this.#id ? `id: ${String(this.#id)}\n` : ""}${data}\n`;
    }
}
const response = `HTTP/1.1 200 OK\n`;
const responseHeaders = new Headers([
    ["Connection", "Keep-Alive"],
    ["Content-Type", "text/event-stream"],
    ["Cache-Control", "no-cache"],
    ["Keep-Alive", `timeout=${Number.MAX_SAFE_INTEGER}`],
]);
export class SSEStreamTarget extends EventTarget {
    #closed = false;
    #context;
    #controller;
    #keepAliveId;
    #error(error) {
        console.log("error", error);
        this.dispatchEvent(new CloseEvent({ cancelable: false }));
        const errorEvent = new ErrorEvent("error", { error });
        this.dispatchEvent(errorEvent);
        this.#context.app.dispatchEvent(errorEvent);
    }
    #push(payload) {
        if (!this.#controller) {
            this.#error(new Error("The controller has not been set."));
            return;
        }
        if (this.#closed) {
            return;
        }
        this.#controller.enqueue(encoder.encode(payload));
    }
    get closed() {
        return this.#closed;
    }
    constructor(context, { headers, keepAlive = false } = {}) {
        super();
        this.#context = context;
        context.response.body = new ReadableStream({
            start: (controller) => {
                this.#controller = controller;
            },
            cancel: (error) => {
                if (error instanceof Error && error.message.includes("connection closed")) {
                    this.close();
                }
                else {
                    this.#error(error);
                }
            },
        });
        if (headers) {
            for (const [key, value] of headers) {
                context.response.headers.set(key, value);
            }
        }
        for (const [key, value] of responseHeaders) {
            context.response.headers.set(key, value);
        }
        this.addEventListener("close", () => {
            this.#closed = true;
            if (this.#keepAliveId != null) {
                clearInterval(this.#keepAliveId);
                this.#keepAliveId = undefined;
            }
            if (this.#controller) {
                try {
                    this.#controller.close();
                }
                catch {
                }
            }
        });
        if (keepAlive) {
            const interval = typeof keepAlive === "number"
                ? keepAlive
                : DEFAULT_KEEP_ALIVE_INTERVAL;
            this.#keepAliveId = setInterval(() => {
                this.dispatchComment("keep-alive comment");
            }, interval);
        }
    }
    close() {
        this.dispatchEvent(new CloseEvent({ cancelable: false }));
        return Promise.resolve();
    }
    dispatchComment(comment) {
        this.#push(`: ${comment.split("\n").join("\n: ")}\n\n`);
        return true;
    }
    dispatchMessage(data) {
        const event = new ServerSentEvent("__message", data);
        return this.dispatchEvent(event);
    }
    dispatchEvent(event) {
        const dispatched = super.dispatchEvent(event);
        if (dispatched && event instanceof ServerSentEvent) {
            this.#push(String(event));
        }
        return dispatched;
    }
    [Symbol.for("Deno.customInspect")](inspect) {
        return `${this.constructor.name} ${inspect({ "#closed": this.#closed, "#context": this.#context })}`;
    }
}
export class SSEStdLibTarget extends EventTarget {
    #app;
    #closed = false;
    #keepAliveId;
    #prev = Promise.resolve();
    #ready;
    #serverRequest;
    #writer;
    async #send(payload, prev) {
        if (this.#closed) {
            return;
        }
        if (this.#ready !== true) {
            await this.#ready;
            this.#ready = true;
        }
        try {
            await prev;
            await this.#writer.write(encoder.encode(payload));
            await this.#writer.flush();
        }
        catch (error) {
            this.dispatchEvent(new CloseEvent({ cancelable: false }));
            const errorEvent = new ErrorEvent("error", { error });
            this.dispatchEvent(errorEvent);
            this.#app.dispatchEvent(errorEvent);
        }
    }
    async #setup(overrideHeaders) {
        const headers = new Headers(responseHeaders);
        if (overrideHeaders) {
            for (const [key, value] of overrideHeaders) {
                headers.set(key, value);
            }
        }
        let payload = response;
        for (const [key, value] of headers) {
            payload += `${key}: ${value}\n`;
        }
        payload += `\n`;
        try {
            await this.#writer.write(encoder.encode(payload));
            await this.#writer.flush();
        }
        catch (error) {
            this.dispatchEvent(new CloseEvent({ cancelable: false }));
            const errorEvent = new ErrorEvent("error", { error });
            this.dispatchEvent(errorEvent);
            this.#app.dispatchEvent(errorEvent);
            throw error;
        }
    }
    get closed() {
        return this.#closed;
    }
    constructor(context, { headers, keepAlive = false } = {}) {
        super();
        this.#app = context.app;
        assert(!(context.request.originalRequest instanceof NativeRequest));
        this.#serverRequest = context.request.originalRequest;
        this.#writer = this.#serverRequest.w;
        this.addEventListener("close", () => {
            this.#closed = true;
            if (this.#keepAliveId != null) {
                clearInterval(this.#keepAliveId);
                this.#keepAliveId = undefined;
            }
            try {
                this.#serverRequest.conn.close();
            }
            catch (error) {
                if (!(error instanceof Deno.errors.BadResource)) {
                    const errorEvent = new ErrorEvent("error", { error });
                    this.dispatchEvent(errorEvent);
                    this.#app.dispatchEvent(errorEvent);
                }
            }
        });
        if (keepAlive) {
            const interval = typeof keepAlive === "number"
                ? keepAlive
                : DEFAULT_KEEP_ALIVE_INTERVAL;
            this.#keepAliveId = setInterval(() => {
                this.dispatchComment("keep-alive comment");
            }, interval);
        }
        this.#ready = this.#setup(headers);
    }
    async close() {
        if (this.#ready !== true) {
            await this.#ready;
        }
        await this.#prev;
        this.dispatchEvent(new CloseEvent({ cancelable: false }));
    }
    dispatchComment(comment) {
        this.#prev = this.#send(`: ${comment.split("\n").join("\n: ")}\n\n`, this.#prev);
        return true;
    }
    dispatchMessage(data) {
        const event = new ServerSentEvent("__message", data);
        return this.dispatchEvent(event);
    }
    dispatchEvent(event) {
        const dispatched = super.dispatchEvent(event);
        if (dispatched && event instanceof ServerSentEvent) {
            this.#prev = this.#send(String(event), this.#prev);
        }
        return dispatched;
    }
    [Symbol.for("Deno.customInspect")](inspect) {
        return `${this.constructor.name} ${inspect({ "closed": this.closed })}`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyX3NlbnRfZXZlbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZXJ2ZXJfc2VudF9ldmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFJQSxPQUFPLEVBQUUsTUFBTSxFQUFhLE1BQU0sV0FBVyxDQUFDO0FBQzlDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUd4RCxNQUFNLE9BQU8sR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO0FBRWxDLE1BQU0sMkJBQTJCLEdBQUcsTUFBTSxDQUFDO0FBK0IzQyxNQUFNLFVBQVcsU0FBUSxLQUFLO0lBQzVCLFlBQVksU0FBb0I7UUFDOUIsS0FBSyxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQztJQUM1QixDQUFDO0NBQ0Y7QUFJRCxNQUFNLE9BQU8sZUFBZ0IsU0FBUSxLQUFLO0lBQ3hDLEtBQUssQ0FBUztJQUNkLEdBQUcsQ0FBVTtJQUNiLEtBQUssQ0FBUztJQUVkLFlBQ0UsSUFBWSxFQUVaLElBQVMsRUFDVCxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsR0FBRyxTQUFTLEtBQTBCLEVBQUU7UUFFM0QsS0FBSyxDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQztRQUN2QixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztRQUNsQixJQUFJO1lBQ0YsSUFBSSxDQUFDLEtBQUssR0FBRyxPQUFPLElBQUksS0FBSyxRQUFRO2dCQUNuQyxDQUFDLENBQUMsSUFBSTtnQkFDTixDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsUUFBK0IsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUNsRTtRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1YsTUFBTSxDQUFDLENBQUMsWUFBWSxLQUFLLENBQUMsQ0FBQztZQUMzQixNQUFNLElBQUksU0FBUyxDQUNqQiwwREFBMEQsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUN0RSxDQUFDO1NBQ0g7UUFDRCxNQUFN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S0FBZ0Q7UUFDNUQsTUFBTSxVQUFVLEdBQUcsS0FBSyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM5QyxJQUFJLFVBQVUsSUFBSSxLQUFLLFlBQVksZUFBZSxFQUFFO1lBQ2xELElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3BEO1FBQ0QsT0FBTyxVQUFVLENBQUM7SUFDcEIsQ0FBQztJQUVELENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsT0FBbUM7UUFDcEUsT0FBTyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxJQUFJLE9BQU8sQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDO0lBQzFFLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE4LTIwMjEgdGhlIG9hayBhdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLiBNSVQgbGljZW5zZS5cblxuaW1wb3J0IHR5cGUgeyBBcHBsaWNhdGlvbiB9IGZyb20gXCIuL2FwcGxpY2F0aW9uLnRzXCI7XG5pbXBvcnQgdHlwZSB7IENvbnRleHQgfSBmcm9tIFwiLi9jb250ZXh0LnRzXCI7XG5pbXBvcnQgeyBhc3NlcnQsIEJ1ZldyaXRlciB9IGZyb20gXCIuL2RlcHMudHNcIjtcbmltcG9ydCB7IE5hdGl2ZVJlcXVlc3QgfSBmcm9tIFwiLi9odHRwX3NlcnZlcl9uYXRpdmUudHNcIjtcbmltcG9ydCB0eXBlIHsgU2VydmVyUmVxdWVzdCB9IGZyb20gXCIuL2h0dHBfc2VydmVyX3N0ZC50c1wiO1xuXG5jb25zdCBlbmNvZGVyID0gbmV3IFRleHRFbmNvZGVyKCk7XG5cbmNvbnN0IERFRkFVTFRfS0VFUF9BTElWRV9JTlRFUlZBTCA9IDMwXzAwMDtcblxuZXhwb3J0IGludGVyZmFjZSBTZXJ2ZXJTZW50RXZlbnRJbml0IGV4dGVuZHMgRXZlbnRJbml0IHtcbiAgLyoqIEFuIG9wdGlvbmFsIGBpZGAgd2hpY2ggd2lsbCBiZSBzZW50IHdpdGggdGhlIGV2ZW50IGFuZCBleHBvc2VkIGluIHRoZVxuICAgKiBjbGllbnQgYEV2ZW50U291cmNlYC4gKi9cbiAgaWQ/OiBudW1iZXI7XG5cbiAgLyoqIFRoZSByZXBsYWNlciBpcyBwYXNzZWQgdG8gYEpTT04uc3RyaW5naWZ5YCB3aGVuIGNvbnZlcnRpbmcgdGhlIGBkYXRhYFxuICAgKiBwcm9wZXJ0eSB0byBhIEpTT04gc3RyaW5nLiAqL1xuICByZXBsYWNlcj86XG4gICAgfCAoc3RyaW5nIHwgbnVtYmVyKVtdXG4gICAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgICB8ICgodGhpczogYW55LCBrZXk6IHN0cmluZywgdmFsdWU6IGFueSkgPT4gYW55KTtcblxuICAvKiogU3BhY2UgaXMgcGFzc2VkIHRvIGBKU09OLnN0cmluZ2lmeWAgd2hlbiBjb252ZXJ0aW5nIHRoZSBgZGF0YWAgcHJvcGVydHlcbiAgICogdG8gYSBKU09OIHN0cmluZy4gKi9cbiAgc3BhY2U/OiBzdHJpbmcgfCBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2VydmVyU2VudEV2ZW50VGFyZ2V0T3B0aW9ucyB7XG4gIC8qKiBBZGRpdGlvbmFsIGhlYWRlcnMgdG8gc2VuZCB0byB0aGUgY2xpZW50IGR1cmluZyBzdGFydHVwLiAgVGhlc2UgaGVhZGVyc1xuICAgKiB3aWxsIG92ZXJ3cml0ZSBhbnkgb2YgdGhlIGRlZmF1bHQgaGVhZGVycyBpZiB0aGUga2V5IGlzIGR1cGxpY2F0ZWQuICovXG4gIGhlYWRlcnM/OiBIZWFkZXJzO1xuICAvKiogS2VlcCBjbGllbnQgY29ubmVjdGlvbnMgYWxpdmUgYnkgc2VuZGluZyBhIGNvbW1lbnQgZXZlbnQgdG8gdGhlIGNsaWVudFxuICAgKiBhdCBhIHNwZWNpZmllZCBpbnRlcnZhbC4gIElmIGB0cnVlYCwgdGhlbiBpdCBwb2xscyBldmVyeSAzMDAwMCBtaWxsaXNlY29uZHNcbiAgICogKDMwIHNlY29uZHMpLiBJZiBzZXQgdG8gYSBudW1iZXIsIHRoZW4gaXQgcG9sbHMgdGhhdCBudW1iZXIgb2ZcbiAgICogbWlsbGlzZWNvbmRzLiAgVGhlIGZlYXR1cmUgaXMgZGlzYWJsZWQgaWYgc2V0IHRvIGBmYWxzZWAuICBJdCBkZWZhdWx0cyB0b1xuICAgKiBgZmFsc2VgLiAqL1xuICBrZWVwQWxpdmU/OiBib29sZWFuIHwgbnVtYmVyO1xufVxuXG5jbGFzcyBDbG9zZUV2ZW50IGV4dGVuZHMgRXZlbnQge1xuICBjb25zdHJ1Y3RvcihldmVudEluaXQ6IEV2ZW50SW5pdCkge1xuICAgIHN1cGVyKFwiY2xvc2VcIiwgZXZlbnRJbml0KTtcbiAgfVxufVxuXG4vKiogQW4gZXZlbnQgd2hpY2ggY29udGFpbnMgaW5mb3JtYXRpb24gd2hpY2ggd2lsbCBiZSBzZW50IHRvIHRoZSByZW1vdGVcbiAqIGNvbm5lY3Rpb24gYW5kIGJlIG1hZGUgYXZhaWxhYmxlIGluIGFuIGBFdmVudFNvdXJjZWAgYXMgYW4gZXZlbnQuICovXG5leHBvcnQgY2xhc3MgU2VydmVyU2VudEV2ZW50IGV4dGVuZHMgRXZlbnQge1xuICAjZGF0YTogc3RyaW5nO1xuICAjaWQ/OiBudW1iZXI7XG4gICN0eXBlOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgdHlwZTogc3RyaW5nLFxuICAgIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gICAgZGF0YTogYW55LFxuICAgIHsgcmVwbGFjZXIsIHNwYWNlLCAuLi5ldmVudEluaXQgfTogU2VydmVyU2VudEV2ZW50SW5pdCA9IHt9LFxuICApIHtcbiAgICBzdXBlcih0eXBlLCBldmVudEluaXQpO1xuICAgIHRoaXMuI3R5cGUgPSB0eXBlO1xuICAgIHRyeSB7XG4gICAgICB0aGlzLiNkYXRhID0gdHlwZW9mIGRhdGEgPT09IFwic3RyaW5nXCJcbiAgICAgICAgPyBkYXRhXG4gICAgICAgIDogSlNPTi5zdHJpbmdpZnkoZGF0YSwgcmVwbGFjZXIgYXMgKHN0cmluZyB8IG51bWJlcilbXSwgc3BhY2UpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGFzc2VydChlIGluc3RhbmNlb2YgRXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcbiAgICAgICAgYGRhdGEgY291bGQgbm90IGJlIGNvZXJjZWQgaW50byBhIHNlcmlhbGl6ZWQgc3RyaW5nLlxcbiAgJHtlLm1lc3NhZ2V9YCxcbiAgICAgICk7XG4gICAgfVxuICAgIGNvbnN0IHsgaWQgfSA9IGV2ZW50SW5pdDtcbiAgICB0aGlzLiNpZCA9IGlkO1xuICB9XG5cbiAgLyoqIFRoZSBkYXRhIGFzc29jaWF0ZWQgd2l0aCB0aGUgZXZlbnQsIHdoaWNoIHdpbGwgYmUgc2VudCB0byB0aGUgY2xpZW50IGFuZFxuICAgKiBiZSBtYWRlIGF2YWlsYWJsZSBpbiB0aGUgYEV2ZW50U291cmNlYC4gKi9cbiAgZ2V0IGRhdGEoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy4jZGF0YTtcbiAgfVxuXG4gIC8qKiBUaGUgb3B0aW9uYWwgSUQgYXNzb2NpYXRlZCB3aXRoIHRoZSBldmVudCB0aGF0IHdpbGwgYmUgc2VudCB0byB0aGUgY2xpZW50XG4gICAqIGFuZCBiZSBtYWRlIGF2YWlsYWJsZSBpbiB0aGUgYEV2ZW50U291cmNlYC4gKi9cbiAgZ2V0IGlkKCk6IG51bWJlciB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuI2lkO1xuICB9XG5cbiAgdG9TdHJpbmcoKTogc3RyaW5nIHtcbiAgICBjb25zdCBkYXRhID0gYGRhdGE6ICR7dGhpcy4jZGF0YS5zcGxpdChcIlxcblwiKS5qb2luKFwiXFxuZGF0YTogXCIpfVxcbmA7XG4gICAgcmV0dXJuIGAke3RoaXMuI3R5cGUgPT09IFwiX19tZXNzYWdlXCIgPyBcIlwiIDogYGV2ZW50OiAke3RoaXMuI3R5cGV9XFxuYH0ke1xuICAgICAgdGhpcy4jaWQgPyBgaWQ6ICR7U3RyaW5nKHRoaXMuI2lkKX1cXG5gIDogXCJcIlxuICAgIH0ke2RhdGF9XFxuYDtcbiAgfVxufVxuXG5jb25zdCByZXNwb25zZSA9IGBIVFRQLzEuMSAyMDAgT0tcXG5gO1xuXG5jb25zdCByZXNwb25zZUhlYWRlcnMgPSBuZXcgSGVhZGVycyhcbiAgW1xuICAgIFtcIkNvbm5lY3Rpb25cIiwgXCJLZWVwLUFsaXZlXCJdLFxuICAgIFtcIkNvbnRlbnQtVHlwZVwiLCBcInRleHQvZXZlbnQtc3RyZWFtXCJdLFxuICAgIFtcIkNhY2hlLUNvbnRyb2xcIiwgXCJuby1jYWNoZVwiXSxcbiAgICBbXCJLZWVwLUFsaXZlXCIsIGB0aW1lb3V0PSR7TnVtYmVyLk1BWF9TQUZFX0lOVEVHRVJ9YF0sXG4gIF0sXG4pO1xuXG5leHBvcnQgaW50ZXJmYWNlIFNlcnZlclNlbnRFdmVudFRhcmdldCBleHRlbmRzIEV2ZW50VGFyZ2V0IHtcbiAgLyoqIElzIHNldCB0byBgdHJ1ZWAgaWYgZXZlbnRzIGNhbm5vdCBiZSBzZW50IHRvIHRoZSByZW1vdGUgY29ubmVjdGlvbi5cbiAgICogT3RoZXJ3aXNlIGl0IGlzIHNldCB0byBgZmFsc2VgLlxuICAgKlxuICAgKiAqTm90ZSo6IFRoaXMgZmxhZyBpcyBsYXppbHkgc2V0LCBhbmQgbWlnaHQgbm90IHJlZmxlY3QgYSBjbG9zZWQgc3RhdGUgdW50aWxcbiAgICogYW5vdGhlciBldmVudCwgY29tbWVudCBvciBtZXNzYWdlIGlzIGF0dGVtcHRlZCB0byBiZSBwcm9jZXNzZWQuICovXG4gIHJlYWRvbmx5IGNsb3NlZDogYm9vbGVhbjtcblxuICAvKiogQ2xvc2UgdGhlIHRhcmdldCwgcmVmdXNpbmcgdG8gYWNjZXB0IGFueSBtb3JlIGV2ZW50cy4gKi9cbiAgY2xvc2UoKTogUHJvbWlzZTx2b2lkPjtcblxuICAvKiogU2VuZCBhIGNvbW1lbnQgdG8gdGhlIHJlbW90ZSBjb25uZWN0aW9uLiAgQ29tbWVudHMgYXJlIG5vdCBleHBvc2VkIHRvIHRoZVxuICAgKiBjbGllbnQgYEV2ZW50U291cmNlYCBidXQgYXJlIHVzZWQgZm9yIGRpYWdub3N0aWNzIGFuZCBoZWxwaW5nIGVuc3VyZSBhXG4gICAqIGNvbm5lY3Rpb24gaXMga2VwdCBhbGl2ZS5cbiAgICpcbiAgICogYGBgdHNcbiAgICogaW1wb3J0IHsgQXBwbGljYXRpb24gfSBmcm9tIFwiaHR0cHM6Ly9kZW5vLmxhbmQveC9vYWsvbW9kLnRzXCI7XG4gICAqXG4gICAqIGNvbnN0IGFwcCA9IG5ldyBBcHBsaWNhdGlvbigpO1xuICAgKlxuICAgKiBhcHAudXNlKChjdHgpID0+IHtcbiAgICogICAgY29uc3Qgc3NlID0gY3R4LmdldFNTRVRhcmdldCgpO1xuICAgKiAgICBzc2UuZGlzcGF0Y2hDb21tZW50KFwidGhpcyBpcyBhIGNvbW1lbnRcIik7XG4gICAqIH0pO1xuICAgKlxuICAgKiBhd2FpdCBhcHAubGlzdGVuKCk7XG4gICAqIGBgYFxuICAgKi9cbiAgZGlzcGF0Y2hDb21tZW50KGNvbW1lbnQ6IHN0cmluZyk6IGJvb2xlYW47XG5cbiAgLyoqIERpc3BhdGNoIGEgbWVzc2FnZSB0byB0aGUgY2xpZW50LiAgVGhpcyBtZXNzYWdlIHdpbGwgY29udGFpbiBgZGF0YTogYCBvbmx5XG4gICAqIGFuZCBiZSBhdmFpbGFibGUgb24gdGhlIGNsaWVudCBgRXZlbnRTb3VyY2VgIG9uIHRoZSBgb25tZXNzYWdlYCBvciBhbiBldmVudFxuICAgKiBsaXN0ZW5lciBvZiB0eXBlIGBcIm1lc3NhZ2VcImAuICovXG4gIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gIGRpc3BhdGNoTWVzc2FnZShkYXRhOiBhbnkpOiBib29sZWFuO1xuXG4gIC8qKiBEaXNwYXRjaCBhIHNlcnZlciBzZW50IGV2ZW50IHRvIHRoZSBjbGllbnQuICBUaGUgZXZlbnQgYHR5cGVgIHdpbGwgYmVcbiAgICogc2VudCBhcyBgZXZlbnQ6IGAgdG8gdGhlIGNsaWVudCB3aGljaCB3aWxsIGJlIHJhaXNlZCBhcyBhIGBNZXNzYWdlRXZlbnRgXG4gICAqIG9uIHRoZSBgRXZlbnRTb3VyY2VgIGluIHRoZSBjbGllbnQuXG4gICAqXG4gICAqIEFueSBsb2NhbCBldmVudCBoYW5kbGVycyB3aWxsIGJlIGRpc3BhdGNoZWQgdG8gZmlyc3QsIGFuZCBpZiB0aGUgZXZlbnRcbiAgICogaXMgY2FuY2VsbGVkLCBpdCB3aWxsIG5vdCBiZSBzZW50IHRvIHRoZSBjbGllbnQuXG4gICAqXG4gICAqIGBgYHRzXG4gICAqIGltcG9ydCB7IEFwcGxpY2F0aW9uLCBTZXJ2ZXJTZW50RXZlbnQgfSBmcm9tIFwiaHR0cHM6Ly9kZW5vLmxhbmQveC9vYWsvbW9kLnRzXCI7XG4gICAqXG4gICAqIGNvbnN0IGFwcCA9IG5ldyBBcHBsaWNhdGlvbigpO1xuICAgKlxuICAgKiBhcHAudXNlKChjdHgpID0+IHtcbiAgICogICAgY29uc3Qgc3NlID0gY3R4LmdldFNTRVRhcmdldCgpO1xuICAgKiAgICBjb25zdCBldnQgPSBuZXcgU2VydmVyU2VudEV2ZW50KFwicGluZ1wiLCBcImhlbGxvXCIpO1xuICAgKiAgICBzc2UuZGlzcGF0Y2hFdmVudChldnQpO1xuICAgKiB9KTtcbiAgICpcbiAgICogYXdhaXQgYXBwLmxpc3RlbigpO1xuICAgKiBgYGBcbiAgICovXG4gIGRpc3BhdGNoRXZlbnQoZXZlbnQ6IFNlcnZlclNlbnRFdmVudCk6IGJvb2xlYW47XG5cbiAgLyoqIERpc3BhdGNoIGEgc2VydmVyIHNlbnQgZXZlbnQgdG8gdGhlIGNsaWVudC4gIFRoZSBldmVudCBgdHlwZWAgd2lsbCBiZVxuICAgKiBzZW50IGFzIGBldmVudDogYCB0byB0aGUgY2xpZW50IHdoaWNoIHdpbGwgYmUgcmFpc2VkIGFzIGEgYE1lc3NhZ2VFdmVudGBcbiAgICogb24gdGhlIGBFdmVudFNvdXJjZWAgaW4gdGhlIGNsaWVudC5cbiAgICpcbiAgICogQW55IGxvY2FsIGV2ZW50IGhhbmRsZXJzIHdpbGwgYmUgZGlzcGF0Y2hlZCB0byBmaXJzdCwgYW5kIGlmIHRoZSBldmVudFxuICAgKiBpcyBjYW5jZWxsZWQsIGl0IHdpbGwgbm90IGJlIHNlbnQgdG8gdGhlIGNsaWVudC5cbiAgICpcbiAgICogYGBgdHNcbiAgICogaW1wb3J0IHsgQXBwbGljYXRpb24sIFNlcnZlclNlbnRFdmVudCB9IGZyb20gXCJodHRwczovL2Rlbm8ubGFuZC94L29hay9tb2QudHNcIjtcbiAgICpcbiAgICogY29uc3QgYXBwID0gbmV3IEFwcGxpY2F0aW9uKCk7XG4gICAqXG4gICAqIGFwcC51c2UoKGN0eCkgPT4ge1xuICAgKiAgICBjb25zdCBzc2UgPSBjdHguZ2V0U1NFVGFyZ2V0KCk7XG4gICAqICAgIGNvbnN0IGV2dCA9IG5ldyBTZXJ2ZXJTZW50RXZlbnQoXCJwaW5nXCIsIFwiaGVsbG9cIik7XG4gICAqICAgIHNzZS5kaXNwYXRjaEV2ZW50KGV2dCk7XG4gICAqIH0pO1xuICAgKlxuICAgKiBhd2FpdCBhcHAubGlzdGVuKCk7XG4gICAqIGBgYFxuICAgKi9cbiAgZGlzcGF0Y2hFdmVudChldmVudDogQ2xvc2VFdmVudCB8IEVycm9yRXZlbnQpOiBib29sZWFuO1xufVxuXG5leHBvcnQgY2xhc3MgU1NFU3RyZWFtVGFyZ2V0IGV4dGVuZHMgRXZlbnRUYXJnZXRcbiAgaW1wbGVtZW50cyBTZXJ2ZXJTZW50RXZlbnRUYXJnZXQge1xuICAjY2xvc2VkID0gZmFsc2U7XG4gICNjb250ZXh0OiBDb250ZXh0O1xuICAjY29udHJvbGxlcj86IFJlYWRhYmxlU3RyZWFtRGVmYXVsdENvbnRyb2xsZXI8VWludDhBcnJheT47XG4gICNrZWVwQWxpdmVJZD86IG51bWJlcjtcblxuICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICAjZXJyb3IoZXJyb3I6IGFueSkge1xuICAgIGNvbnNvbGUubG9nKFwiZXJyb3JcIiwgZXJyb3IpO1xuICAgIHRoaXMuZGlzcGF0Y2hFdmVudChuZXcgQ2xvc2VFdmVudCh7IGNhbmNlbGFibGU6IGZhbHNlIH0pKTtcbiAgICBjb25zdCBlcnJvckV2ZW50ID0gbmV3IEVycm9yRXZlbnQoXCJlcnJvclwiLCB7IGVycm9yIH0pO1xuICAgIHRoaXMuZGlzcGF0Y2hFdmVudChlcnJvckV2ZW50KTtcbiAgICB0aGlzLiNjb250ZXh0LmFwcC5kaXNwYXRjaEV2ZW50KGVycm9yRXZlbnQpO1xuICB9XG5cbiAgI3B1c2gocGF5bG9hZDogc3RyaW5nKSB7XG4gICAgaWYgKCF0aGlzLiNjb250cm9sbGVyKSB7XG4gICAgICB0aGlzLiNlcnJvcihuZXcgRXJyb3IoXCJUaGUgY29udHJvbGxlciBoYXMgbm90IGJlZW4gc2V0LlwiKSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh0aGlzLiNjbG9zZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy4jY29udHJvbGxlci5lbnF1ZXVlKGVuY29kZXIuZW5jb2RlKHBheWxvYWQpKTtcbiAgfVxuXG4gIGdldCBjbG9zZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuI2Nsb3NlZDtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGNvbnRleHQ6IENvbnRleHQsXG4gICAgeyBoZWFkZXJzLCBrZWVwQWxpdmUgPSBmYWxzZSB9OiBTZXJ2ZXJTZW50RXZlbnRUYXJnZXRPcHRpb25zID0ge30sXG4gICkge1xuICAgIHN1cGVyKCk7XG5cbiAgICB0aGlzLiNjb250ZXh0ID0gY29udGV4dDtcblxuICAgIGNvbnRleHQucmVzcG9uc2UuYm9keSA9IG5ldyBSZWFkYWJsZVN0cmVhbTxVaW50OEFycmF5Pih7XG4gICAgICBzdGFydDogKGNvbnRyb2xsZXIpID0+IHtcbiAgICAgICAgdGhpcy4jY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XG4gICAgICB9LFxuICAgICAgY2FuY2VsOiAoZXJyb3IpID0+IHtcbiAgICAgICAgLy8gY29ubmVjdGlvbnMgY2xvc2luZyBhcmUgY29uc2lkZXJlZCBcIm5vcm1hbFwiIGZvciBTU0UgZXZlbnRzIGFuZCBqdXN0XG4gICAgICAgIC8vIG1lYW4gdGhlIGZhciBzaWRlIGhhcyBjbG9zZWQuXG4gICAgICAgIGlmIChcbiAgICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yICYmIGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoXCJjb25uZWN0aW9uIGNsb3NlZFwiKVxuICAgICAgICApIHtcbiAgICAgICAgICB0aGlzLmNsb3NlKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy4jZXJyb3IoZXJyb3IpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKGhlYWRlcnMpIHtcbiAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIGhlYWRlcnMpIHtcbiAgICAgICAgY29udGV4dC5yZXNwb25zZS5oZWFkZXJzLnNldChrZXksIHZhbHVlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgcmVzcG9uc2VIZWFkZXJzKSB7XG4gICAgICBjb250ZXh0LnJlc3BvbnNlLmhlYWRlcnMuc2V0KGtleSwgdmFsdWUpO1xuICAgIH1cblxuICAgIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcihcImNsb3NlXCIsICgpID0+IHtcbiAgICAgIHRoaXMuI2Nsb3NlZCA9IHRydWU7XG4gICAgICBpZiAodGhpcy4ja2VlcEFsaXZlSWQgIT0gbnVsbCkge1xuICAgICAgICBjbGVhckludGVydmFsKHRoaXMuI2tlZXBBbGl2ZUlkKTtcbiAgICAgICAgdGhpcy4ja2VlcEFsaXZlSWQgPSB1bmRlZmluZWQ7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy4jY29udHJvbGxlcikge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHRoaXMuI2NvbnRyb2xsZXIuY2xvc2UoKTtcbiAgICAgICAgfSBjYXRjaCB7XG4gICAgICAgICAgLy8gd2UgaWdub3JlIGFueSBlcnJvcnMgaGVyZSwgYXMgaXQgaXMgbGlrZWx5IHRoYXQgdGhlIGNvbnRyb2xsZXJcbiAgICAgICAgICAvLyBpcyBhbHJlYWR5IGNsb3NlZFxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBpZiAoa2VlcEFsaXZlKSB7XG4gICAgICBjb25zdCBpbnRlcnZhbCA9IHR5cGVvZiBrZWVwQWxpdmUgPT09IFwibnVtYmVyXCJcbiAgICAgICAgPyBrZWVwQWxpdmVcbiAgICAgICAgOiBERUZBVUxUX0tFRVBfQUxJVkVfSU5URVJWQUw7XG4gICAgICB0aGlzLiNrZWVwQWxpdmVJZCA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgICAgdGhpcy5kaXNwYXRjaENvbW1lbnQoXCJrZWVwLWFsaXZlIGNvbW1lbnRcIik7XG4gICAgICB9LCBpbnRlcnZhbCk7XG4gICAgfVxuICB9XG5cbiAgY2xvc2UoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBDbG9zZUV2ZW50KHsgY2FuY2VsYWJsZTogZmFsc2UgfSkpO1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgfVxuXG4gIGRpc3BhdGNoQ29tbWVudChjb21tZW50OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICB0aGlzLiNwdXNoKGA6ICR7Y29tbWVudC5zcGxpdChcIlxcblwiKS5qb2luKFwiXFxuOiBcIil9XFxuXFxuYCk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICBkaXNwYXRjaE1lc3NhZ2UoZGF0YTogYW55KTogYm9vbGVhbiB7XG4gICAgY29uc3QgZXZlbnQgPSBuZXcgU2VydmVyU2VudEV2ZW50KFwiX19tZXNzYWdlXCIsIGRhdGEpO1xuICAgIHJldHVybiB0aGlzLmRpc3BhdGNoRXZlbnQoZXZlbnQpO1xuICB9XG5cbiAgZGlzcGF0Y2hFdmVudChldmVudDogU2VydmVyU2VudEV2ZW50KTogYm9vbGVhbjtcbiAgZGlzcGF0Y2hFdmVudChldmVudDogQ2xvc2VFdmVudCB8IEVycm9yRXZlbnQpOiBib29sZWFuO1xuICBkaXNwYXRjaEV2ZW50KGV2ZW50OiBTZXJ2ZXJTZW50RXZlbnQgfCBDbG9zZUV2ZW50IHwgRXJyb3JFdmVudCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGRpc3BhdGNoZWQgPSBzdXBlci5kaXNwYXRjaEV2ZW50KGV2ZW50KTtcbiAgICBpZiAoZGlzcGF0Y2hlZCAmJiBldmVudCBpbnN0YW5jZW9mIFNlcnZlclNlbnRFdmVudCkge1xuICAgICAgdGhpcy4jcHVzaChTdHJpbmcoZXZlbnQpKTtcbiAgICB9XG4gICAgcmV0dXJuIGRpc3BhdGNoZWQ7XG4gIH1cblxuICBbU3ltYm9sLmZvcihcIkRlbm8uY3VzdG9tSW5zcGVjdFwiKV0oaW5zcGVjdDogKHZhbHVlOiB1bmtub3duKSA9PiBzdHJpbmcpIHtcbiAgICByZXR1cm4gYCR7dGhpcy5jb25zdHJ1Y3Rvci5uYW1lfSAke1xuICAgICAgaW5zcGVjdCh7IFwiI2Nsb3NlZFwiOiB0aGlzLiNjbG9zZWQsIFwiI2NvbnRleHRcIjogdGhpcy4jY29udGV4dCB9KVxuICAgIH1gO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBTU0VTdGRMaWJUYXJnZXQgZXh0ZW5kcyBFdmVudFRhcmdldFxuICBpbXBsZW1lbnRzIFNlcnZlclNlbnRFdmVudFRhcmdldCB7XG4gICNhcHA6IEFwcGxpY2F0aW9uO1xuICAjY2xvc2VkID0gZmFsc2U7XG4gICNrZWVwQWxpdmVJZD86IG51bWJlcjtcbiAgI3ByZXYgPSBQcm9taXNlLnJlc29sdmUoKTtcbiAgI3JlYWR5OiBQcm9taXNlPHZvaWQ+IHwgdHJ1ZTtcbiAgI3NlcnZlclJlcXVlc3Q6IFNlcnZlclJlcXVlc3Q7XG4gICN3cml0ZXI6IEJ1ZldyaXRlcjtcblxuICBhc3luYyAjc2VuZChwYXlsb2FkOiBzdHJpbmcsIHByZXY6IFByb21pc2U8dm9pZD4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAodGhpcy4jY2xvc2VkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh0aGlzLiNyZWFkeSAhPT0gdHJ1ZSkge1xuICAgICAgYXdhaXQgdGhpcy4jcmVhZHk7XG4gICAgICB0aGlzLiNyZWFkeSA9IHRydWU7XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBhd2FpdCBwcmV2O1xuICAgICAgYXdhaXQgdGhpcy4jd3JpdGVyLndyaXRlKGVuY29kZXIuZW5jb2RlKHBheWxvYWQpKTtcbiAgICAgIGF3YWl0IHRoaXMuI3dyaXRlci5mbHVzaCgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmRpc3BhdGNoRXZlbnQobmV3IENsb3NlRXZlbnQoeyBjYW5jZWxhYmxlOiBmYWxzZSB9KSk7XG4gICAgICBjb25zdCBlcnJvckV2ZW50ID0gbmV3IEVycm9yRXZlbnQoXCJlcnJvclwiLCB7IGVycm9yIH0pO1xuICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KGVycm9yRXZlbnQpO1xuICAgICAgdGhpcy4jYXBwLmRpc3BhdGNoRXZlbnQoZXJyb3JFdmVudCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgI3NldHVwKG92ZXJyaWRlSGVhZGVycz86IEhlYWRlcnMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBoZWFkZXJzID0gbmV3IEhlYWRlcnMocmVzcG9uc2VIZWFkZXJzKTtcbiAgICBpZiAob3ZlcnJpZGVIZWFkZXJzKSB7XG4gICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBvdmVycmlkZUhlYWRlcnMpIHtcbiAgICAgICAgaGVhZGVycy5zZXQoa2V5LCB2YWx1ZSk7XG4gICAgICB9XG4gICAgfVxuICAgIGxldCBwYXlsb2FkID0gcmVzcG9uc2U7XG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgaGVhZGVycykge1xuICAgICAgcGF5bG9hZCArPSBgJHtrZXl9OiAke3ZhbHVlfVxcbmA7XG4gICAgfVxuICAgIHBheWxvYWQgKz0gYFxcbmA7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuI3dyaXRlci53cml0ZShlbmNvZGVyLmVuY29kZShwYXlsb2FkKSk7XG4gICAgICBhd2FpdCB0aGlzLiN3cml0ZXIuZmx1c2goKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBDbG9zZUV2ZW50KHsgY2FuY2VsYWJsZTogZmFsc2UgfSkpO1xuICAgICAgY29uc3QgZXJyb3JFdmVudCA9IG5ldyBFcnJvckV2ZW50KFwiZXJyb3JcIiwgeyBlcnJvciB9KTtcbiAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChlcnJvckV2ZW50KTtcbiAgICAgIHRoaXMuI2FwcC5kaXNwYXRjaEV2ZW50KGVycm9yRXZlbnQpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgZ2V0IGNsb3NlZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy4jY2xvc2VkO1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgY29udGV4dDogQ29udGV4dCxcbiAgICB7IGhlYWRlcnMsIGtlZXBBbGl2ZSA9IGZhbHNlIH06IFNlcnZlclNlbnRFdmVudFRhcmdldE9wdGlvbnMgPSB7fSxcbiAgKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLiNhcHAgPSBjb250ZXh0LmFwcDtcbiAgICBhc3NlcnQoIShjb250ZXh0LnJlcXVlc3Qub3JpZ2luYWxSZXF1ZXN0IGluc3RhbmNlb2YgTmF0aXZlUmVxdWVzdCkpO1xuICAgIHRoaXMuI3NlcnZlclJlcXVlc3QgPSBjb250ZXh0LnJlcXVlc3Qub3JpZ2luYWxSZXF1ZXN0O1xuICAgIHRoaXMuI3dyaXRlciA9IHRoaXMuI3NlcnZlclJlcXVlc3QudztcbiAgICB0aGlzLmFkZEV2ZW50TGlzdGVuZXIoXCJjbG9zZVwiLCAoKSA9PiB7XG4gICAgICB0aGlzLiNjbG9zZWQgPSB0cnVlO1xuICAgICAgaWYgKHRoaXMuI2tlZXBBbGl2ZUlkICE9IG51bGwpIHtcbiAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLiNrZWVwQWxpdmVJZCk7XG4gICAgICAgIHRoaXMuI2tlZXBBbGl2ZUlkID0gdW5kZWZpbmVkO1xuICAgICAgfVxuICAgICAgdHJ5IHtcbiAgICAgICAgdGhpcy4jc2VydmVyUmVxdWVzdC5jb25uLmNsb3NlKCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBpZiAoIShlcnJvciBpbnN0YW5jZW9mIERlbm8uZXJyb3JzLkJhZFJlc291cmNlKSkge1xuICAgICAgICAgIGNvbnN0IGVycm9yRXZlbnQgPSBuZXcgRXJyb3JFdmVudChcImVycm9yXCIsIHsgZXJyb3IgfSk7XG4gICAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KGVycm9yRXZlbnQpO1xuICAgICAgICAgIHRoaXMuI2FwcC5kaXNwYXRjaEV2ZW50KGVycm9yRXZlbnQpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gICAgaWYgKGtlZXBBbGl2ZSkge1xuICAgICAgY29uc3QgaW50ZXJ2YWwgPSB0eXBlb2Yga2VlcEFsaXZlID09PSBcIm51bWJlclwiXG4gICAgICAgID8ga2VlcEFsaXZlXG4gICAgICAgIDogREVGQVVMVF9LRUVQX0FMSVZFX0lOVEVSVkFMO1xuICAgICAgdGhpcy4ja2VlcEFsaXZlSWQgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgIHRoaXMuZGlzcGF0Y2hDb21tZW50KFwia2VlcC1hbGl2ZSBjb21tZW50XCIpO1xuICAgICAgfSwgaW50ZXJ2YWwpO1xuICAgIH1cbiAgICB0aGlzLiNyZWFkeSA9IHRoaXMuI3NldHVwKGhlYWRlcnMpO1xuICB9XG5cbiAgLyoqIFN0b3Agc2VuZGluZyBldmVudHMgdG8gdGhlIHJlbW90ZSBjb25uZWN0aW9uIGFuZCBjbG9zZSB0aGUgY29ubmVjdGlvbi4gKi9cbiAgYXN5bmMgY2xvc2UoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKHRoaXMuI3JlYWR5ICE9PSB0cnVlKSB7XG4gICAgICBhd2FpdCB0aGlzLiNyZWFkeTtcbiAgICB9XG4gICAgYXdhaXQgdGhpcy4jcHJldjtcbiAgICB0aGlzLmRpc3BhdGNoRXZlbnQobmV3IENsb3NlRXZlbnQoeyBjYW5jZWxhYmxlOiBmYWxzZSB9KSk7XG4gIH1cblxuICAvKiogU2VuZCBhIGNvbW1lbnQgdG8gdGhlIHJlbW90ZSBjb25uZWN0aW9uLiAgQ29tbWVudHMgYXJlIG5vdCBleHBvc2VkIHRvIHRoZVxuICAgKiBjbGllbnQgYEV2ZW50U291cmNlYCBidXQgYXJlIHVzZWQgZm9yIGRpYWdub3N0aWNzIGFuZCBoZWxwaW5nIGVuc3VyZSBhXG4gICAqIGNvbm5lY3Rpb24gaXMga2VwdCBhbGl2ZS5cbiAgICpcbiAgICogYGBgdHNcbiAgICogaW1wb3J0IHsgQXBwbGljYXRpb24gfSBmcm9tIFwiaHR0cHM6Ly9kZW5vLmxhbmQveC9vYWsvbW9kLnRzXCI7XG4gICAqXG4gICAqIGNvbnN0IGFwcCA9IG5ldyBBcHBsaWNhdGlvbigpO1xuICAgKlxuICAgKiBhcHAudXNlKChjdHgpID0+IHtcbiAgICogICAgY29uc3Qgc3NlID0gY3R4LmdldFNTRVRhcmdldCgpO1xuICAgKiAgICBzc2UuZGlzcGF0Y2hDb21tZW50KFwidGhpcyBpcyBhIGNvbW1lbnRcIik7XG4gICAqIH0pO1xuICAgKlxuICAgKiBhd2FpdCBhcHAubGlzdGVuKCk7XG4gICAqIGBgYFxuICAgKi9cbiAgZGlzcGF0Y2hDb21tZW50KGNvbW1lbnQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHRoaXMuI3ByZXYgPSB0aGlzLiNzZW5kKFxuICAgICAgYDogJHtjb21tZW50LnNwbGl0KFwiXFxuXCIpLmpvaW4oXCJcXG46IFwiKX1cXG5cXG5gLFxuICAgICAgdGhpcy4jcHJldixcbiAgICApO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLyoqIERpc3BhdGNoIGEgbWVzc2FnZSB0byB0aGUgY2xpZW50LiAgVGhpcyBtZXNzYWdlIHdpbGwgY29udGFpbiBgZGF0YTogYCBvbmx5XG4gICAqIGFuZCBiZSBhdmFpbGFibGUgb24gdGhlIGNsaWVudCBgRXZlbnRTb3VyY2VgIG9uIHRoZSBgb25tZXNzYWdlYCBvciBhbiBldmVudFxuICAgKiBsaXN0ZW5lciBvZiB0eXBlIGBcIm1lc3NhZ2VcImAuICovXG4gIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gIGRpc3BhdGNoTWVzc2FnZShkYXRhOiBhbnkpOiBib29sZWFuIHtcbiAgICBjb25zdCBldmVudCA9IG5ldyBTZXJ2ZXJTZW50RXZlbnQoXCJfX21lc3NhZ2VcIiwgZGF0YSk7XG4gICAgcmV0dXJuIHRoaXMuZGlzcGF0Y2hFdmVudChldmVudCk7XG4gIH1cblxuICAvKiogRGlzcGF0Y2ggYSBzZXJ2ZXIgc2VudCBldmVudCB0byB0aGUgY2xpZW50LiAgVGhlIGV2ZW50IGB0eXBlYCB3aWxsIGJlXG4gICAqIHNlbnQgYXMgYGV2ZW50OiBgIHRvIHRoZSBjbGllbnQgd2hpY2ggd2lsbCBiZSByYWlzZWQgYXMgYSBgTWVzc2FnZUV2ZW50YFxuICAgKiBvbiB0aGUgYEV2ZW50U291cmNlYCBpbiB0aGUgY2xpZW50LlxuICAgKlxuICAgKiBBbnkgbG9jYWwgZXZlbnQgaGFuZGxlcnMgd2lsbCBiZSBkaXNwYXRjaGVkIHRvIGZpcnN0LCBhbmQgaWYgdGhlIGV2ZW50XG4gICAqIGlzIGNhbmNlbGxlZCwgaXQgd2lsbCBub3QgYmUgc2VudCB0byB0aGUgY2xpZW50LlxuICAgKlxuICAgKiBgYGB0c1xuICAgKiBpbXBvcnQgeyBBcHBsaWNhdGlvbiwgU2VydmVyU2VudEV2ZW50IH0gZnJvbSBcImh0dHBzOi8vZGVuby5sYW5kL3gvb2FrL21vZC50c1wiO1xuICAgKlxuICAgKiBjb25zdCBhcHAgPSBuZXcgQXBwbGljYXRpb24oKTtcbiAgICpcbiAgICogYXBwLnVzZSgoY3R4KSA9PiB7XG4gICAqICAgIGNvbnN0IHNzZSA9IGN0eC5nZXRTU0VUYXJnZXQoKTtcbiAgICogICAgY29uc3QgZXZ0ID0gbmV3IFNlcnZlclNlbnRFdmVudChcInBpbmdcIiwgXCJoZWxsb1wiKTtcbiAgICogICAgc3NlLmRpc3BhdGNoRXZlbnQoZXZ0KTtcbiAgICogfSk7XG4gICAqXG4gICAqIGF3YWl0IGFwcC5saXN0ZW4oKTtcbiAgICogYGBgXG4gICAqL1xuICBkaXNwYXRjaEV2ZW50KGV2ZW50OiBTZXJ2ZXJTZW50RXZlbnQpOiBib29sZWFuO1xuICBkaXNwYXRjaEV2ZW50KGV2ZW50OiBDbG9zZUV2ZW50IHwgRXJyb3JFdmVudCk6IGJvb2xlYW47XG4gIGRpc3BhdGNoRXZlbnQoZXZlbnQ6IFNlcnZlclNlbnRFdmVudCB8IENsb3NlRXZlbnQgfCBFcnJvckV2ZW50KTogYm9vbGVhbiB7XG4gICAgY29uc3QgZGlzcGF0Y2hlZCA9IHN1cGVyLmRpc3BhdGNoRXZlbnQoZXZlbnQpO1xuICAgIGlmIChkaXNwYXRjaGVkICYmIGV2ZW50IGluc3RhbmNlb2YgU2VydmVyU2VudEV2ZW50KSB7XG4gICAgICB0aGlzLiNwcmV2ID0gdGhpcy4jc2VuZChTdHJpbmcoZXZlbnQpLCB0aGlzLiNwcmV2KTtcbiAgICB9XG4gICAgcmV0dXJuIGRpc3BhdGNoZWQ7XG4gIH1cblxuICBbU3ltYm9sLmZvcihcIkRlbm8uY3VzdG9tSW5zcGVjdFwiKV0oaW5zcGVjdDogKHZhbHVlOiB1bmtub3duKSA9PiBzdHJpbmcpIHtcbiAgICByZXR1cm4gYCR7dGhpcy5jb25zdHJ1Y3Rvci5uYW1lfSAke2luc3BlY3QoeyBcImNsb3NlZFwiOiB0aGlzLmNsb3NlZCB9KX1gO1xuICB9XG59XG4iXX0=