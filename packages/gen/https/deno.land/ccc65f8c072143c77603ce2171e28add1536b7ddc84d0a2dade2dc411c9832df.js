import { Query, ResultType, templateStringToQuery, } from "./query.ts";
import { isTemplateString } from "../utils/utils.ts";
import { PostgresError, TransactionError } from "../client/error.ts";
export class Savepoint {
    name;
    #instance_count = 0;
    #release_callback;
    #update_callback;
    constructor(name, update_callback, release_callback) {
        this.name = name;
        this.#release_callback = release_callback;
        this.#update_callback = update_callback;
    }
    get instances() {
        return this.#instance_count;
    }
    async release() {
        if (this.#instance_count === 0) {
            throw new Error("This savepoint has no instances to release");
        }
        await this.#release_callback(this.name);
        --this.#instance_count;
    }
    async update() {
        await this.#update_callback(this.name);
        ++this.#instance_count;
    }
}
export class Transaction {
    name;
    #client;
    #executeQuery;
    #isolation_level;
    #read_only;
    #savepoints = [];
    #snapshot;
    #updateClientLock;
    constructor(name, options, client, execute_query_callback, update_client_lock_callback) {
        this.name = name;
        this.#client = client;
        this.#executeQuery = execute_query_callback;
        this.#isolation_level = options?.isolation_level ?? "read_committed";
        this.#read_only = options?.read_only ?? false;
        this.#snapshot = options?.snapshot;
        this.#updateClientLock = update_client_lock_callback;
    }
    get isolation_level() {
        return this.#isolation_level;
    }
    get savepoints() {
        return this.#savepoints;
    }
    #assertTransactionOpen() {
        if (this.#client.session.current_transaction !== this.name) {
            throw new Error(`This transaction has not been started yet, make sure to use the "begin" method to do so`);
        }
    }
    #resetTransaction() {
        this.#savepoints = [];
    }
    async begin() {
        if (this.#client.session.current_transaction !== null) {
            if (this.#client.session.current_transaction === this.name) {
                throw new Error("This transaction is already open");
            }
            throw new Error(`This client already has an ongoing transaction "${this.#client.session.current_transaction}"`);
        }
        let isolation_level;
        switch (this.#isolation_level) {
            case "read_committed": {
                isolation_level = "READ COMMITTED";
                break;
            }
            case "repeatable_read": {
                isolation_level = "REPEATABLE READ";
                break;
            }
            case "serializable": {
                isolation_level = "SERIALIZABLE";
                break;
            }
            default:
                throw new Error(`Unexpected isolation level "${this.#isolation_level}"`);
        }
        let permissions;
        if (this.#read_only) {
            permissions = "READ ONLY";
        }
        else {
            permissions = "READ WRITE";
        }
        let snapshot = "";
        if (this.#snapshot) {
            snapshot = `SET TRANSACTION SNAPSHOT '${this.#snapshot}'`;
        }
        try {
            await this.#client.queryArray(`BEGIN ${permissions} ISOLATION LEVEL ${isolation_level};${snapshot}`);
        }
        catch (e) {
            if (e instanceof PostgresError) {
                throw new TransactionError(this.name, e);
            }
            else {
                throw e;
            }
        }
        this.#updateClientLock(this.name);
    }
    async commit(options) {
        this.#assertTransactionOpen();
        const chain = options?.chain ?? false;
        try {
            await this.queryArray(`COMMIT ${chain ? "AND CHAIN" : ""}`);
        }
        catch (e) {
            if (e instanceof PostgresError) {
                throw new TransactionError(this.name, e);
            }
            else {
                throw e;
            }
        }
        this.#resetTransaction();
        if (!chain) {
            this.#updateClientLock(null);
        }
    }
    getSavepoint(name) {
        return this.#savepoints.find((sv) => sv.name === name.toLowerCase());
    }
    getSavepoints() {
        return this.#savepoints
            .filter(({ instances }) => instances > 0)
            .map(({ name }) => name);
    }
    async getSnapshot() {
        this.#assertTransactionOpen();
        const { rows } = await this.queryObject `SELECT PG_EXPORT_SNAPSHOT() AS SNAPSHOT;`;
        return rows[0].snapshot;
    }
    async queryArray(query_template_or_config, ...args) {
        this.#assertTransactionOpen();
        let query;
        if (typeof query_template_or_config === "string") {
            query = new Query(query_template_or_config, ResultType.ARRAY, args);
        }
        else if (isTemplateString(query_template_or_config)) {
            query = templateStringToQuery(query_template_or_config, args, ResultType.ARRAY);
        }
        else {
            query = new Query(query_template_or_config, ResultType.ARRAY);
        }
        try {
            return await this.#executeQuery(query);
        }
        catch (e) {
            if (e instanceof PostgresError) {
                await this.commit();
                throw new TransactionError(this.name, e);
            }
            else {
                throw e;
            }
        }
    }
    async queryObject(query_template_or_config, ...args) {
        this.#assertTransactionOpen();
        let query;
        if (typeof query_template_or_config === "string") {
            query = new Query(query_template_or_config, ResultType.OBJECT, args[0]);
        }
        else if (isTemplateString(query_template_or_config)) {
            query = templateStringToQuery(query_template_or_config, args, ResultType.OBJECT);
        }
        else {
            query = new Query(query_template_or_config, ResultType.OBJECT);
        }
        try {
            return await this.#executeQuery(query);
        }
        catch (e) {
            if (e instanceof PostgresError) {
                await this.commit();
                throw new TransactionError(this.name, e);
            }
            else {
                throw e;
            }
        }
    }
    async rollback(savepoint_or_options) {
        this.#assertTransactionOpen();
        let savepoint_option;
        if (typeof savepoint_or_options === "string" ||
            savepoint_or_options instanceof Savepoint) {
            savepoint_option = savepoint_or_options;
        }
        else {
            savepoint_option =
                savepoint_or_options?.savepoint;
        }
        let savepoint_name;
        if (savepoint_option instanceof Savepoint) {
            savepoint_name = savepoint_option.name;
        }
        else if (typeof savepoint_option === "string") {
            savepoint_name = savepoint_option.toLowerCase();
        }
        let chain_option = false;
        if (typeof savepoint_or_options === "object") {
            chain_option = savepoint_or_options?.chain ??
                false;
        }
        if (chain_option && savepoint_name) {
            throw new Error("The chain option can't be used alongside a savepoint on a rollback operation");
        }
        if (typeof savepoint_option !== "undefined") {
            const ts_savepoint = this.#savepoints.find(({ name }) => name === savepoint_name);
            if (!ts_savepoint) {
                throw new Error(`There is no "${savepoint_name}" savepoint registered in this transaction`);
            }
            if (!ts_savepoint.instances) {
                throw new Error(`There are no savepoints of "${savepoint_name}" left to rollback to`);
            }
            await this.queryArray(`ROLLBACK TO ${savepoint_name}`);
            return;
        }
        try {
            await this.queryArray(`ROLLBACK ${chain_option ? "AND CHAIN" : ""}`);
        }
        catch (e) {
            if (e instanceof PostgresError) {
                await this.commit();
                throw new TransactionError(this.name, e);
            }
            else {
                throw e;
            }
        }
        this.#resetTransaction();
        if (!chain_option) {
            this.#updateClientLock(null);
        }
    }
    async savepoint(name) {
        this.#assertTransactionOpen();
        if (!/^[a-zA-Z_]{1}[\w]{0,62}$/.test(name)) {
            if (!Number.isNaN(Number(name[0]))) {
                throw new Error("The savepoint name can't begin with a number");
            }
            if (name.length > 63) {
                throw new Error("The savepoint name can't be longer than 63 characters");
            }
            throw new Error("The savepoint name can only contain alphanumeric characters");
        }
        name = name.toLowerCase();
        let savepoint = this.#savepoints.find((sv) => sv.name === name);
        if (savepoint) {
            try {
                await savepoint.update();
            }
            catch (e) {
                if (e instanceof PostgresError) {
                    await this.commit();
                    throw new TransactionError(this.name, e);
                }
                else {
                    throw e;
                }
            }
        }
        else {
            savepoint = new Savepoint(name, async (name) => {
                await this.queryArray(`SAVEPOINT ${name}`);
            }, async (name) => {
                await this.queryArray(`RELEASE SAVEPOINT ${name}`);
            });
            try {
                await savepoint.update();
            }
            catch (e) {
                if (e instanceof PostgresError) {
                    await this.commit();
                    throw new TransactionError(this.name, e);
                }
                else {
                    throw e;
                }
            }
            this.#savepoints.push(savepoint);
        }
        return savepoint;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNhY3Rpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0cmFuc2FjdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQ0wsS0FBSyxFQU9MLFVBQVUsRUFDVixxQkFBcUIsR0FDdEIsTUFBTSxZQUFZLENBQUM7QUFDcEIsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDckQsT0FBTyxFQUFFLGFBQWEsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRXJFLE1BQU0sT0FBTyxTQUFTO0lBU0Y7SUFMbEIsZUFBZSxHQUFHLENBQUMsQ0FBQztJQUNwQixpQkFBaUIsQ0FBa0M7SUFDbkQsZ0JBQWdCLENBQWtDO0lBRWxELFlBQ2tCLElBQVksRUFDNUIsZUFBZ0QsRUFDaEQsZ0JBQWlEO1FBRmpDLFNBQUksR0FBSixJQUFJLENBQVE7UUFJNUIsSUFBSSxDQUFDLGlCQUFpQixHQUFHLGdCQUFnQixDQUFDO1FBQzFDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxlQUFlLENBQUM7SUFDMUMsQ0FBQztJQUVELElBQUksU0FBUztRQUNYLE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQztJQUM5QixDQUFDO0lBZ0NELEtBQUssQ0FBQyxPQUFPO1FBQ1gsSUFBSSxJQUFJLENBQUMsZUFBZSxLQUFLLENBQUMsRUFBRTtZQUM5QixNQUFNLElBQUksS0FBSyxDQUFDLDRDQUE0QyxDQUFDLENBQUM7U0FDL0Q7UUFFRCxNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDeEMsRUFBRSxJQUFJLENBQUMsZUFBZSxDQUFDO0lBQ3pCLENBQUM7SUFpQ0QsS0FBSyxDQUFDLE1BQU07UUFDVixNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdkMsRUFBRSxJQUFJLENBQUMsZUFBZSxDQUFDO0lBQ3pCLENBQUM7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QzFDO3FCQUFNO29CQUNMLE1BQU0sQ0FBQyxDQUFDO2lCQUNUO2FBQ0Y7WUFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUNsQztRQUVELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgUXVlcnlDbGllbnQgfSBmcm9tIFwiLi4vY2xpZW50LnRzXCI7XG5pbXBvcnQge1xuICBRdWVyeSxcbiAgUXVlcnlBcmd1bWVudHMsXG4gIFF1ZXJ5QXJyYXlSZXN1bHQsXG4gIFF1ZXJ5T2JqZWN0T3B0aW9ucyxcbiAgUXVlcnlPYmplY3RSZXN1bHQsXG4gIFF1ZXJ5T3B0aW9ucyxcbiAgUXVlcnlSZXN1bHQsXG4gIFJlc3VsdFR5cGUsXG4gIHRlbXBsYXRlU3RyaW5nVG9RdWVyeSxcbn0gZnJvbSBcIi4vcXVlcnkudHNcIjtcbmltcG9ydCB7IGlzVGVtcGxhdGVTdHJpbmcgfSBmcm9tIFwiLi4vdXRpbHMvdXRpbHMudHNcIjtcbmltcG9ydCB7IFBvc3RncmVzRXJyb3IsIFRyYW5zYWN0aW9uRXJyb3IgfSBmcm9tIFwiLi4vY2xpZW50L2Vycm9yLnRzXCI7XG5cbmV4cG9ydCBjbGFzcyBTYXZlcG9pbnQge1xuICAvKipcbiAgICogVGhpcyBpcyB0aGUgY291bnQgb2YgdGhlIGN1cnJlbnQgc2F2ZXBvaW50IGluc3RhbmNlcyBpbiB0aGUgdHJhbnNhY3Rpb25cbiAgICovXG4gICNpbnN0YW5jZV9jb3VudCA9IDA7XG4gICNyZWxlYXNlX2NhbGxiYWNrOiAobmFtZTogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+O1xuICAjdXBkYXRlX2NhbGxiYWNrOiAobmFtZTogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyByZWFkb25seSBuYW1lOiBzdHJpbmcsXG4gICAgdXBkYXRlX2NhbGxiYWNrOiAobmFtZTogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+LFxuICAgIHJlbGVhc2VfY2FsbGJhY2s6IChuYW1lOiBzdHJpbmcpID0+IFByb21pc2U8dm9pZD4sXG4gICkge1xuICAgIHRoaXMuI3JlbGVhc2VfY2FsbGJhY2sgPSByZWxlYXNlX2NhbGxiYWNrO1xuICAgIHRoaXMuI3VwZGF0ZV9jYWxsYmFjayA9IHVwZGF0ZV9jYWxsYmFjaztcbiAgfVxuXG4gIGdldCBpbnN0YW5jZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuI2luc3RhbmNlX2NvdW50O1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbGVhc2luZyBhIHNhdmVwb2ludCB3aWxsIHJlbW92ZSBpdCdzIGxhc3QgaW5zdGFuY2UgaW4gdGhlIHRyYW5zYWN0aW9uXG4gICAqXG4gICAqIGBgYHRzXG4gICAqIGltcG9ydCB7IENsaWVudCB9IGZyb20gXCIuLi9jbGllbnQudHNcIjtcbiAgICpcbiAgICogY29uc3QgY2xpZW50ID0gbmV3IENsaWVudCgpO1xuICAgKiBjb25zdCB0cmFuc2FjdGlvbiA9IGNsaWVudC5jcmVhdGVUcmFuc2FjdGlvbihcInRyYW5zYWN0aW9uXCIpO1xuICAgKlxuICAgKiBjb25zdCBzYXZlcG9pbnQgPSBhd2FpdCB0cmFuc2FjdGlvbi5zYXZlcG9pbnQoXCJuMVwiKTtcbiAgICogYXdhaXQgc2F2ZXBvaW50LnJlbGVhc2UoKTtcbiAgICogdHJhbnNhY3Rpb24ucm9sbGJhY2soc2F2ZXBvaW50KTsgLy8gRXJyb3IsIGNhbid0IHJvbGxiYWNrIGJlY2F1c2UgdGhlIHNhdmVwb2ludCB3YXMgcmVsZWFzZWRcbiAgICogYGBgXG4gICAqXG4gICAqIEl0IHdpbGwgYWxzbyBhbGxvdyB5b3UgdG8gc2V0IHRoZSBzYXZlcG9pbnQgdG8gdGhlIHBvc2l0aW9uIGl0IGhhZCBiZWZvcmUgdGhlIGxhc3QgdXBkYXRlXG4gICAqXG4gICAqIGBgYHRzXG4gICAqIGltcG9ydCB7IENsaWVudCB9IGZyb20gXCIuLi9jbGllbnQudHNcIjtcbiAgICpcbiAgICogY29uc3QgY2xpZW50ID0gbmV3IENsaWVudCgpO1xuICAgKiBjb25zdCB0cmFuc2FjdGlvbiA9IGNsaWVudC5jcmVhdGVUcmFuc2FjdGlvbihcInRyYW5zYWN0aW9uXCIpO1xuICAgKlxuICAgKiBjb25zdCBzYXZlcG9pbnQgPSBhd2FpdCB0cmFuc2FjdGlvbi5zYXZlcG9pbnQoXCJuMVwiKTtcbiAgICogYXdhaXQgc2F2ZXBvaW50LnVwZGF0ZSgpO1xuICAgKiBhd2FpdCBzYXZlcG9pbnQucmVsZWFzZSgpOyAvLyBUaGlzIGRyb3BzIHRoZSB1cGRhdGUgb2YgdGhlIGxhc3Qgc3RhdGVtZW50XG4gICAqIHRyYW5zYWN0aW9uLnJvbGxiYWNrKHNhdmVwb2ludCk7IC8vIFdpbGwgcm9sbGJhY2sgdG8gdGhlIGZpcnN0IGluc3RhbmNlIG9mIHRoZSBzYXZlcG9pbnRcbiAgICogYGBgXG4gICAqXG4gICAqIFRoaXMgZnVuY3Rpb24gd2lsbCB0aHJvdyBpZiB0aGVyZSBhcmUgbm8gc2F2ZXBvaW50IGluc3RhbmNlcyB0byBkcm9wXG4gICAqL1xuICBhc3luYyByZWxlYXNlKCkge1xuICAgIGlmICh0aGlzLiNpbnN0YW5jZV9jb3VudCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVGhpcyBzYXZlcG9pbnQgaGFzIG5vIGluc3RhbmNlcyB0byByZWxlYXNlXCIpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuI3JlbGVhc2VfY2FsbGJhY2sodGhpcy5uYW1lKTtcbiAgICAtLXRoaXMuI2luc3RhbmNlX2NvdW50O1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0aW5nIGEgc2F2ZXBvaW50IHdpbGwgdXBkYXRlIGl0cyBwb3NpdGlvbiBpbiB0aGUgdHJhbnNhY3Rpb24gZXhlY3V0aW9uXG4gICAqXG4gICAqIGBgYHRzXG4gICAqIGltcG9ydCB7IENsaWVudCB9IGZyb20gXCIuLi9jbGllbnQudHNcIjtcbiAgICpcbiAgICogY29uc3QgY2xpZW50ID0gbmV3IENsaWVudCgpO1xuICAgKiBjb25zdCB0cmFuc2FjdGlvbiA9IGNsaWVudC5jcmVhdGVUcmFuc2FjdGlvbihcInRyYW5zYWN0aW9uXCIpO1xuICAgKlxuICAgKiBjb25zdCBteV92YWx1ZSA9IFwic29tZSB2YWx1ZVwiO1xuICAgKlxuICAgKiBjb25zdCBzYXZlcG9pbnQgPSBhd2FpdCB0cmFuc2FjdGlvbi5zYXZlcG9pbnQoXCJuMVwiKTtcbiAgICogdHJhbnNhY3Rpb24ucXVlcnlBcnJheWBJTlNFUlQgSU5UTyBNWV9UQUJMRSAoWCkgVkFMVUVTICgke215X3ZhbHVlfSlgO1xuICAgKiBhd2FpdCBzYXZlcG9pbnQudXBkYXRlKCk7IC8vIFJvbGxpbmcgYmFjayB3aWxsIG5vdyByZXR1cm4geW91IHRvIHRoaXMgcG9pbnQgb24gdGhlIHRyYW5zYWN0aW9uXG4gICAqIGBgYFxuICAgKlxuICAgKiBZb3UgY2FuIGFsc28gdW5kbyBhIHNhdmVwb2ludCB1cGRhdGUgYnkgdXNpbmcgdGhlIGByZWxlYXNlYCBtZXRob2RcbiAgICpcbiAgICogYGBgdHNcbiAgICogaW1wb3J0IHsgQ2xpZW50IH0gZnJvbSBcIi4uL2NsaWVudC50c1wiO1xuICAgKlxuICAgKiBjb25zdCBjbGllbnQgPSBuZXcgQ2xpZW50KCk7XG4gICAqIGNvbnN0IHRyYW5zYWN0aW9uID0gY2xpZW50LmNyZWF0ZVRyYW5zYWN0aW9uKFwidHJhbnNhY3Rpb25cIik7XG4gICAqXG4gICAqIGNvbnN0IHNhdmVwb2ludCA9IGF3YWl0IHRyYW5zYWN0aW9uLnNhdmVwb2ludChcIm4xXCIpO1xuICAgKiB0cmFuc2FjdGlvbi5xdWVyeUFycmF5YERFTEVURSBGUk9NIFZFUllfSU1QT1JUQU5UX1RBQkxFYDtcbiAgICogYXdhaXQgc2F2ZXBvaW50LnVwZGF0ZSgpOyAvLyBPb3BzLCBzaG91bGRuJ3QgaGF2ZSB1cGRhdGVkIHRoZSBzYXZlcG9pbnRcbiAgICogYXdhaXQgc2F2ZXBvaW50LnJlbGVhc2UoKTsgLy8gVGhpcyB3aWxsIHVuZG8gdGhlIGxhc3QgdXBkYXRlIGFuZCByZXR1cm4gdGhlIHNhdmVwb2ludCB0byB0aGUgZmlyc3QgaW5zdGFuY2VcbiAgICogYXdhaXQgdHJhbnNhY3Rpb24ucm9sbGJhY2soKTsgLy8gV2lsbCByb2xsYmFjayBiZWZvcmUgdGhlIHRhYmxlIHdhcyBkZWxldGVkXG4gICAqIGBgYFxuICAgKi9cbiAgYXN5bmMgdXBkYXRlKCkge1xuICAgIGF3YWl0IHRoaXMuI3VwZGF0ZV9jYWxsYmFjayh0aGlzLm5hbWUpO1xuICAgICsrdGhpcy4jaW5zdGFuY2VfY291bnQ7XG4gIH1cbn1cblxudHlwZSBJc29sYXRpb25MZXZlbCA9IFwicmVhZF9jb21taXR0ZWRcIiB8IFwicmVwZWF0YWJsZV9yZWFkXCIgfCBcInNlcmlhbGl6YWJsZVwiO1xuXG5leHBvcnQgdHlwZSBUcmFuc2FjdGlvbk9wdGlvbnMgPSB7XG4gIGlzb2xhdGlvbl9sZXZlbD86IElzb2xhdGlvbkxldmVsO1xuICByZWFkX29ubHk/OiBib29sZWFuO1xuICBzbmFwc2hvdD86IHN0cmluZztcbn07XG5cbmV4cG9ydCBjbGFzcyBUcmFuc2FjdGlvbiB7XG4gICNjbGllbnQ6IFF1ZXJ5Q2xpZW50O1xuICAjZXhlY3V0ZVF1ZXJ5OiAocXVlcnk6IFF1ZXJ5PFJlc3VsdFR5cGU+KSA9PiBQcm9taXNlPFF1ZXJ5UmVzdWx0PjtcbiAgI2lzb2xhdGlvbl9sZXZlbDogSXNvbGF0aW9uTGV2ZWw7XG4gICNyZWFkX29ubHk6IGJvb2xlYW47XG4gICNzYXZlcG9pbnRzOiBTYXZlcG9pbnRbXSA9IFtdO1xuICAjc25hcHNob3Q/OiBzdHJpbmc7XG4gICN1cGRhdGVDbGllbnRMb2NrOiAobmFtZTogc3RyaW5nIHwgbnVsbCkgPT4gdm9pZDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgbmFtZTogc3RyaW5nLFxuICAgIG9wdGlvbnM6IFRyYW5zYWN0aW9uT3B0aW9ucyB8IHVuZGVmaW5lZCxcbiAgICBjbGllbnQ6IFF1ZXJ5Q2xpZW50LFxuICAgIGV4ZWN1dGVfcXVlcnlfY2FsbGJhY2s6IChxdWVyeTogUXVlcnk8UmVzdWx0VHlwZT4pID0+IFByb21pc2U8UXVlcnlSZXN1bHQ+LFxuICAgIHVwZGF0ZV9jbGllbnRfbG9ja19jYWxsYmFjazogKG5hbWU6IHN0cmluZyB8IG51bGwpID0+IHZvaWQsXG4gICkge1xuICAgIHRoaXMuI2NsaWVudCA9IGNsaWVudDtcbiAgICB0aGlzLiNleGVjdXRlUXVlcnkgPSBleGVjdXRlX3F1ZXJ5X2NhbGxiYWNrO1xuICAgIHRoaXMuI2lzb2xhdGlvbl9sZXZlbCA9IG9wdGlvbnM/Lmlzb2xhdGlvbl9sZXZlbCA/PyBcInJlYWRfY29tbWl0dGVkXCI7XG4gICAgdGhpcy4jcmVhZF9vbmx5ID0gb3B0aW9ucz8ucmVhZF9vbmx5ID8/IGZhbHNlO1xuICAgIHRoaXMuI3NuYXBzaG90ID0gb3B0aW9ucz8uc25hcHNob3Q7XG4gICAgdGhpcy4jdXBkYXRlQ2xpZW50TG9jayA9IHVwZGF0ZV9jbGllbnRfbG9ja19jYWxsYmFjaztcbiAgfVxuXG4gIGdldCBpc29sYXRpb25fbGV2ZWwoKSB7XG4gICAgcmV0dXJuIHRoaXMuI2lzb2xhdGlvbl9sZXZlbDtcbiAgfVxuXG4gIGdldCBzYXZlcG9pbnRzKCkge1xuICAgIHJldHVybiB0aGlzLiNzYXZlcG9pbnRzO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgbWV0aG9kIHdpbGwgdGhyb3cgaWYgdGhlIHRyYW5zYWN0aW9uIG9wZW5lZCBpbiB0aGUgY2xpZW50IGRvZXNuJ3QgbWF0Y2ggdGhpcyBvbmVcbiAgICovXG4gICNhc3NlcnRUcmFuc2FjdGlvbk9wZW4oKSB7XG4gICAgaWYgKHRoaXMuI2NsaWVudC5zZXNzaW9uLmN1cnJlbnRfdHJhbnNhY3Rpb24gIT09IHRoaXMubmFtZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgVGhpcyB0cmFuc2FjdGlvbiBoYXMgbm90IGJlZW4gc3RhcnRlZCB5ZXQsIG1ha2Ugc3VyZSB0byB1c2UgdGhlIFwiYmVnaW5cIiBtZXRob2QgdG8gZG8gc29gLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAjcmVzZXRUcmFuc2FjdGlvbigpIHtcbiAgICB0aGlzLiNzYXZlcG9pbnRzID0gW107XG4gIH1cblxuICAvKipcbiAgICogVGhlIGJlZ2luIG1ldGhvZCB3aWxsIG9mZmljaWFsbHkgYmVnaW4gdGhlIHRyYW5zYWN0aW9uLCBhbmQgaXQgbXVzdCBiZSBjYWxsZWQgYmVmb3JlXG4gICAqIGFueSBxdWVyeSBvciB0cmFuc2FjdGlvbiBvcGVyYXRpb24gaXMgZXhlY3V0ZWQgaW4gb3JkZXIgdG8gbG9jayB0aGUgc2Vzc2lvblxuICAgKiBgYGB0c1xuICAgKiBpbXBvcnQgeyBDbGllbnQgfSBmcm9tIFwiLi4vY2xpZW50LnRzXCI7XG4gICAqXG4gICAqIGNvbnN0IGNsaWVudCA9IG5ldyBDbGllbnQoKTtcbiAgICogY29uc3QgdHJhbnNhY3Rpb24gPSBjbGllbnQuY3JlYXRlVHJhbnNhY3Rpb24oXCJ0cmFuc2FjdGlvbl9uYW1lXCIpO1xuICAgKlxuICAgKiBhd2FpdCB0cmFuc2FjdGlvbi5iZWdpbigpOyAvLyBTZXNzaW9uIGlzIGxvY2tlZCwgdHJhbnNhY3Rpb24gb3BlcmF0aW9ucyBhcmUgbm93IHNhZmVcbiAgICogLy8gSW1wb3J0YW50IG9wZXJhdGlvbnNcbiAgICogYXdhaXQgdHJhbnNhY3Rpb24uY29tbWl0KCk7IC8vIFNlc3Npb24gaXMgdW5sb2NrZWQsIGV4dGVybmFsIG9wZXJhdGlvbnMgY2FuIG5vdyB0YWtlIHBsYWNlXG4gICAqIGBgYFxuICAgKiBodHRwczovL3d3dy5wb3N0Z3Jlc3FsLm9yZy9kb2NzLzE0L3NxbC1iZWdpbi5odG1sXG4gICAqL1xuICBhc3luYyBiZWdpbigpIHtcbiAgICBpZiAodGhpcy4jY2xpZW50LnNlc3Npb24uY3VycmVudF90cmFuc2FjdGlvbiAhPT0gbnVsbCkge1xuICAgICAgaWYgKHRoaXMuI2NsaWVudC5zZXNzaW9uLmN1cnJlbnRfdHJhbnNhY3Rpb24gPT09IHRoaXMubmFtZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgXCJUaGlzIHRyYW5zYWN0aW9uIGlzIGFscmVhZHkgb3BlblwiLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBUaGlzIGNsaWVudCBhbHJlYWR5IGhhcyBhbiBvbmdvaW5nIHRyYW5zYWN0aW9uIFwiJHt0aGlzLiNjbGllbnQuc2Vzc2lvbi5jdXJyZW50X3RyYW5zYWN0aW9ufVwiYCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgbGV0IGlzb2xhdGlvbl9sZXZlbDtcbiAgICBzd2l0Y2ggKHRoaXMuI2lzb2xhdGlvbl9sZXZlbCkge1xuICAgICAgY2FzZSBcInJlYWRfY29tbWl0dGVkXCI6IHtcbiAgICAgICAgaXNvbGF0aW9uX2xldmVsID0gXCJSRUFEIENPTU1JVFRFRFwiO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgXCJyZXBlYXRhYmxlX3JlYWRcIjoge1xuICAgICAgICBpc29sYXRpb25fbGV2ZWwgPSBcIlJFUEVBVEFCTEUgUkVBRFwiO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgXCJzZXJpYWxpemFibGVcIjoge1xuICAgICAgICBpc29sYXRpb25fbGV2ZWwgPSBcIlNFUklBTElaQUJMRVwiO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVW5leHBlY3RlZCBpc29sYXRpb24gbGV2ZWwgXCIke3RoaXMuI2lzb2xhdGlvbl9sZXZlbH1cImAsXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgbGV0IHBlcm1pc3Npb25zO1xuICAgIGlmICh0aGlzLiNyZWFkX29ubHkpIHtcbiAgICAgIHBlcm1pc3Npb25zID0gXCJSRUFEIE9OTFlcIjtcbiAgICB9IGVsc2Uge1xuICAgICAgcGVybWlzc2lvbnMgPSBcIlJFQUQgV1JJVEVcIjtcbiAgICB9XG5cbiAgICBsZXQgc25hcHNob3QgPSBcIlwiO1xuICAgIGlmICh0aGlzLiNzbmFwc2hvdCkge1xuICAgICAgc25hcHNob3QgPSBgU0VUIFRSQU5TQUNUSU9OIFNOQVBTSE9UICcke3RoaXMuI3NuYXBzaG90fSdgO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLiNjbGllbnQucXVlcnlBcnJheShcbiAgICAgICAgYEJFR0lOICR7cGVybWlzc2lvbnN9IElTT0xBVElPTiBMRVZFTCAke2lzb2xhdGlvbl9sZXZlbH07JHtzbmFwc2hvdH1gLFxuICAgICAgKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAoZSBpbnN0YW5jZW9mIFBvc3RncmVzRXJyb3IpIHtcbiAgICAgICAgdGhyb3cgbmV3IFRyYW5zYWN0aW9uRXJyb3IodGhpcy5uYW1lLCBlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy4jdXBkYXRlQ2xpZW50TG9jayh0aGlzLm5hbWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBjb21taXQgbWV0aG9kIHdpbGwgbWFrZSBwZXJtYW5lbnQgYWxsIGNoYW5nZXMgbWFkZSB0byB0aGUgZGF0YWJhc2UgaW4gdGhlXG4gICAqIGN1cnJlbnQgdHJhbnNhY3Rpb24gYW5kIGVuZCB0aGUgY3VycmVudCB0cmFuc2FjdGlvblxuICAgKlxuICAgKiBgYGB0c1xuICAgKiBpbXBvcnQgeyBDbGllbnQgfSBmcm9tIFwiLi4vY2xpZW50LnRzXCI7XG4gICAqXG4gICAqIGNvbnN0IGNsaWVudCA9IG5ldyBDbGllbnQoKTtcbiAgICogY29uc3QgdHJhbnNhY3Rpb24gPSBjbGllbnQuY3JlYXRlVHJhbnNhY3Rpb24oXCJ0cmFuc2FjdGlvblwiKTtcbiAgICpcbiAgICogYXdhaXQgdHJhbnNhY3Rpb24uYmVnaW4oKTtcbiAgICogLy8gSW1wb3J0YW50IG9wZXJhdGlvbnNcbiAgICogYXdhaXQgdHJhbnNhY3Rpb24uY29tbWl0KCk7IC8vIFdpbGwgdGVybWluYXRlIHRoZSB0cmFuc2FjdGlvbiBhbmQgc2F2ZSBhbGwgY2hhbmdlc1xuICAgKiBgYGBcbiAgICpcbiAgICogVGhlIGNvbW1pdCBtZXRob2QgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGEgXCJjaGFpblwiIG9wdGlvbiwgdGhhdCBhbGxvd3MgeW91IHRvIGJvdGggY29tbWl0IHRoZSBjdXJyZW50IGNoYW5nZXMgYW5kXG4gICAqIHN0YXJ0IGEgbmV3IHdpdGggdGhlIHNhbWUgdHJhbnNhY3Rpb24gcGFyYW1ldGVycyBpbiBhIHNpbmdsZSBzdGF0ZW1lbnRcbiAgICpcbiAgICogYGBgdHNcbiAgICogaW1wb3J0IHsgQ2xpZW50IH0gZnJvbSBcIi4uL2NsaWVudC50c1wiO1xuICAgKlxuICAgKiBjb25zdCBjbGllbnQgPSBuZXcgQ2xpZW50KCk7XG4gICAqIGNvbnN0IHRyYW5zYWN0aW9uID0gY2xpZW50LmNyZWF0ZVRyYW5zYWN0aW9uKFwidHJhbnNhY3Rpb25cIik7XG4gICAqXG4gICAqIC8vIFRyYW5zYWN0aW9uIG9wZXJhdGlvbnMgSSB3YW50IHRvIGNvbW1pdFxuICAgKiBhd2FpdCB0cmFuc2FjdGlvbi5jb21taXQoeyBjaGFpbjogdHJ1ZSB9KTsgLy8gQWxsIGNoYW5nZXMgYXJlIHNhdmVkLCBmb2xsb3dpbmcgc3RhdGVtZW50cyB3aWxsIGJlIGV4ZWN1dGVkIGluc2lkZSBhIHRyYW5zYWN0aW9uXG4gICAqIGF3YWl0IHRyYW5zYWN0aW9uLnF1ZXJ5QXJyYXlgREVMRVRFIFNPTUVUSElORyBGUk9NIFNPTUVXSEVSRWA7IC8vIFN0aWxsIGluc2lkZSB0aGUgdHJhbnNhY3Rpb25cbiAgICogYXdhaXQgdHJhbnNhY3Rpb24uY29tbWl0KCk7IC8vIFRoZSB0cmFuc2FjdGlvbiBmaW5pc2hlcyBmb3IgZ29vZFxuICAgKiBgYGBcbiAgICpcbiAgICogaHR0cHM6Ly93d3cucG9zdGdyZXNxbC5vcmcvZG9jcy8xNC9zcWwtY29tbWl0Lmh0bWxcbiAgICovXG4gIGFzeW5jIGNvbW1pdChvcHRpb25zPzogeyBjaGFpbj86IGJvb2xlYW4gfSkge1xuICAgIHRoaXMuI2Fzc2VydFRyYW5zYWN0aW9uT3BlbigpO1xuXG4gICAgY29uc3QgY2hhaW4gPSBvcHRpb25zPy5jaGFpbiA/PyBmYWxzZTtcblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnF1ZXJ5QXJyYXkoYENPTU1JVCAke2NoYWluID8gXCJBTkQgQ0hBSU5cIiA6IFwiXCJ9YCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKGUgaW5zdGFuY2VvZiBQb3N0Z3Jlc0Vycm9yKSB7XG4gICAgICAgIHRocm93IG5ldyBUcmFuc2FjdGlvbkVycm9yKHRoaXMubmFtZSwgZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBlO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMuI3Jlc2V0VHJhbnNhY3Rpb24oKTtcbiAgICBpZiAoIWNoYWluKSB7XG4gICAgICB0aGlzLiN1cGRhdGVDbGllbnRMb2NrKG51bGwpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIG1ldGhvZCB3aWxsIHNlYXJjaCBmb3IgdGhlIHByb3ZpZGVkIHNhdmVwb2ludCBuYW1lIGFuZCByZXR1cm4gYVxuICAgKiByZWZlcmVuY2UgdG8gdGhlIHJlcXVlc3RlZCBzYXZlcG9pbnQsIG90aGVyd2lzZSBpdCB3aWxsIHJldHVybiB1bmRlZmluZWRcbiAgICovXG4gIGdldFNhdmVwb2ludChuYW1lOiBzdHJpbmcpOiBTYXZlcG9pbnQgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLiNzYXZlcG9pbnRzLmZpbmQoKHN2KSA9PiBzdi5uYW1lID09PSBuYW1lLnRvTG93ZXJDYXNlKCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgbWV0aG9kIHdpbGwgbGlzdCB5b3UgYWxsIG9mIHRoZSBhY3RpdmUgc2F2ZXBvaW50cyBpbiB0aGlzIHRyYW5zYWN0aW9uXG4gICAqL1xuICBnZXRTYXZlcG9pbnRzKCk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gdGhpcy4jc2F2ZXBvaW50c1xuICAgICAgLmZpbHRlcigoeyBpbnN0YW5jZXMgfSkgPT4gaW5zdGFuY2VzID4gMClcbiAgICAgIC5tYXAoKHsgbmFtZSB9KSA9PiBuYW1lKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIG1ldGhvZCByZXR1cm5zIHRoZSBzbmFwc2hvdCBpZCBvZiB0aGUgb24gZ29pbmcgdHJhbnNhY3Rpb24sIGFsbG93aW5nIHlvdSB0byBzaGFyZVxuICAgKiB0aGUgc25hcHNob3Qgc3RhdGUgYmV0d2VlbiB0d28gdHJhbnNhY3Rpb25zXG4gICAqXG4gICAqIGBgYHRzXG4gICAqIGltcG9ydCB7IENsaWVudCB9IGZyb20gXCIuLi9jbGllbnQudHNcIjtcbiAgICpcbiAgICogY29uc3QgY2xpZW50XzEgPSBuZXcgQ2xpZW50KCk7XG4gICAqIGNvbnN0IGNsaWVudF8yID0gbmV3IENsaWVudCgpO1xuICAgKiBjb25zdCB0cmFuc2FjdGlvbl8xID0gY2xpZW50XzEuY3JlYXRlVHJhbnNhY3Rpb24oXCJ0cmFuc2FjdGlvblwiKTtcbiAgICpcbiAgICogY29uc3Qgc25hcHNob3QgPSBhd2FpdCB0cmFuc2FjdGlvbl8xLmdldFNuYXBzaG90KCk7XG4gICAqIGNvbnN0IHRyYW5zYWN0aW9uXzIgPSBjbGllbnRfMi5jcmVhdGVUcmFuc2FjdGlvbihcIm5ld190cmFuc2FjdGlvblwiLCB7IGlzb2xhdGlvbl9sZXZlbDogXCJyZXBlYXRhYmxlX3JlYWRcIiwgc25hcHNob3QgfSk7XG4gICAqIC8vIHRyYW5zYWN0aW9uXzIgbm93IHNoYXJlcyB0aGUgc2FtZSBzdGFydGluZyBzdGF0ZSB0aGF0IHRyYW5zYWN0aW9uXzEgaGFkXG4gICAqIGBgYFxuICAgKiBodHRwczovL3d3dy5wb3N0Z3Jlc3FsLm9yZy9kb2NzLzE0L2Z1bmN0aW9ucy1hZG1pbi5odG1sI0ZVTkNUSU9OUy1TTkFQU0hPVC1TWU5DSFJPTklaQVRJT05cbiAgICovXG4gIGFzeW5jIGdldFNuYXBzaG90KCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgdGhpcy4jYXNzZXJ0VHJhbnNhY3Rpb25PcGVuKCk7XG5cbiAgICBjb25zdCB7IHJvd3MgfSA9IGF3YWl0IHRoaXMucXVlcnlPYmplY3Q8eyBzbmFwc2hvdDogc3RyaW5nIH0+XG4gICAgICBgU0VMRUNUIFBHX0VYUE9SVF9TTkFQU0hPVCgpIEFTIFNOQVBTSE9UO2A7XG4gICAgcmV0dXJuIHJvd3NbMF0uc25hcHNob3Q7XG4gIH1cblxuICAvKipcbiAgICogVGhpcyBtZXRob2QgYWxsb3dzIGV4ZWN1dGVkIHF1ZXJpZXMgdG8gYmUgcmV0cmlldmVkIGFzIGFycmF5IGVudHJpZXMuXG4gICAqIEl0IHN1cHBvcnRzIGEgZ2VuZXJpYyBpbnRlcmZhY2UgaW4gb3JkZXIgdG8gdHlwZSB0aGUgZW50cmllcyByZXRyaWV2ZWQgYnkgdGhlIHF1ZXJ5XG4gICAqXG4gICAqIGBgYHRzXG4gICAqIGltcG9ydCB7IENsaWVudCB9IGZyb20gXCIuLi9jbGllbnQudHNcIjtcbiAgICpcbiAgICogY29uc3QgY2xpZW50ID0gbmV3IENsaWVudCgpO1xuICAgKiBjb25zdCB0cmFuc2FjdGlvbiA9IGNsaWVudC5jcmVhdGVUcmFuc2FjdGlvbihcInRyYW5zYWN0aW9uXCIpO1xuICAgKlxuICAgKiBjb25zdCB7cm93c30gPSBhd2FpdCB0cmFuc2FjdGlvbi5xdWVyeUFycmF5KFxuICAgKiAgXCJTRUxFQ1QgSUQsIE5BTUUgRlJPTSBDTElFTlRTXCJcbiAgICogKTsgLy8gQXJyYXk8dW5rbm93bltdPlxuICAgKiBgYGBcbiAgICpcbiAgICogWW91IGNhbiBwYXNzIHR5cGUgYXJndW1lbnRzIHRvIHRoZSBxdWVyeSBpbiBvcmRlciB0byBoaW50IFR5cGVTY3JpcHQgd2hhdCB0aGUgcmV0dXJuIHZhbHVlIHdpbGwgYmVcbiAgICogYGBgdHNcbiAgICogaW1wb3J0IHsgQ2xpZW50IH0gZnJvbSBcIi4uL2NsaWVudC50c1wiO1xuICAgKlxuICAgKiBjb25zdCBjbGllbnQgPSBuZXcgQ2xpZW50KCk7XG4gICAqIGNvbnN0IHRyYW5zYWN0aW9uID0gY2xpZW50LmNyZWF0ZVRyYW5zYWN0aW9uKFwidHJhbnNhY3Rpb25cIik7XG4gICAqXG4gICAqIGNvbnN0IHsgcm93cyB9ID0gYXdhaXQgdHJhbnNhY3Rpb24ucXVlcnlBcnJheTxbbnVtYmVyLCBzdHJpbmddPihcbiAgICogIFwiU0VMRUNUIElELCBOQU1FIEZST00gQ0xJRU5UU1wiXG4gICAqICk7IC8vIEFycmF5PFtudW1iZXIsIHN0cmluZ10+XG4gICAqIGBgYFxuICAgKlxuICAgKiBJdCBhbHNvIGFsbG93cyB5b3UgdG8gZXhlY3V0ZSBwcmVwYXJlZCBzdGFtZW1lbnRzIHdpdGggdGVtcGxhdGUgc3RyaW5nc1xuICAgKlxuICAgKiBgYGB0c1xuICAgKiBpbXBvcnQgeyBDbGllbnQgfSBmcm9tIFwiLi4vY2xpZW50LnRzXCI7XG4gICAqXG4gICAqIGNvbnN0IGNsaWVudCA9IG5ldyBDbGllbnQoKTtcbiAgICogY29uc3QgdHJhbnNhY3Rpb24gPSBjbGllbnQuY3JlYXRlVHJhbnNhY3Rpb24oXCJ0cmFuc2FjdGlvblwiKTtcbiAgICpcbiAgICogY29uc3QgaWQgPSAxMjtcbiAgICogLy8gQXJyYXk8W251bWJlciwgc3RyaW5nXT5cbiAgICogY29uc3QgeyByb3dzIH0gPSBhd2FpdCB0cmFuc2FjdGlvbi5xdWVyeUFycmF5PFtudW1iZXIsIHN0cmluZ10+YFNFTEVDVCBJRCwgTkFNRSBGUk9NIENMSUVOVFMgV0hFUkUgSUQgPSAke2lkfWA7XG4gICAqIGBgYFxuICAgKi9cbiAgYXN5bmMgcXVlcnlBcnJheTxUIGV4dGVuZHMgQXJyYXk8dW5rbm93bj4+KFxuICAgIHF1ZXJ5OiBzdHJpbmcsXG4gICAgYXJncz86IFF1ZXJ5QXJndW1lbnRzLFxuICApOiBQcm9taXNlPFF1ZXJ5QXJyYXlSZXN1bHQ8VD4+O1xuICBhc3luYyBxdWVyeUFycmF5PFQgZXh0ZW5kcyBBcnJheTx1bmtub3duPj4oXG4gICAgY29uZmlnOiBRdWVyeU9wdGlvbnMsXG4gICk6IFByb21pc2U8UXVlcnlBcnJheVJlc3VsdDxUPj47XG4gIGFzeW5jIHF1ZXJ5QXJyYXk8VCBleHRlbmRzIEFycmF5PHVua25vd24+PihcbiAgICBzdHJpbmdzOiBUZW1wbGF0ZVN0cmluZ3NBcnJheSxcbiAgICAuLi5hcmdzOiB1bmtub3duW11cbiAgKTogUHJvbWlzZTxRdWVyeUFycmF5UmVzdWx0PFQ+PjtcbiAgYXN5bmMgcXVlcnlBcnJheTxUIGV4dGVuZHMgQXJyYXk8dW5rbm93bj4gPSBBcnJheTx1bmtub3duPj4oXG4gICAgcXVlcnlfdGVtcGxhdGVfb3JfY29uZmlnOiBUZW1wbGF0ZVN0cmluZ3NBcnJheSB8IHN0cmluZyB8IFF1ZXJ5T3B0aW9ucyxcbiAgICAuLi5hcmdzOiB1bmtub3duW10gfCBbUXVlcnlBcmd1bWVudHMgfCB1bmRlZmluZWRdXG4gICk6IFByb21pc2U8UXVlcnlBcnJheVJlc3VsdDxUPj4ge1xuICAgIHRoaXMuI2Fzc2VydFRyYW5zYWN0aW9uT3BlbigpO1xuXG4gICAgbGV0IHF1ZXJ5OiBRdWVyeTxSZXN1bHRUeXBlLkFSUkFZPjtcbiAgICBpZiAodHlwZW9mIHF1ZXJ5X3RlbXBsYXRlX29yX2NvbmZpZyA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcXVlcnkgPSBuZXcgUXVlcnkoXG4gICAgICAgIHF1ZXJ5X3RlbXBsYXRlX29yX2NvbmZpZyxcbiAgICAgICAgUmVzdWx0VHlwZS5BUlJBWSxcbiAgICAgICAgYXJncyBhcyBRdWVyeUFyZ3VtZW50cyB8IHVuZGVmaW5lZCxcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChpc1RlbXBsYXRlU3RyaW5nKHF1ZXJ5X3RlbXBsYXRlX29yX2NvbmZpZykpIHtcbiAgICAgIHF1ZXJ5ID0gdGVtcGxhdGVTdHJpbmdUb1F1ZXJ5KFxuICAgICAgICBxdWVyeV90ZW1wbGF0ZV9vcl9jb25maWcsXG4gICAgICAgIGFyZ3MsXG4gICAgICAgIFJlc3VsdFR5cGUuQVJSQVksXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICBxdWVyeSA9IG5ldyBRdWVyeShxdWVyeV90ZW1wbGF0ZV9vcl9jb25maWcsIFJlc3VsdFR5cGUuQVJSQVkpO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy4jZXhlY3V0ZVF1ZXJ5KHF1ZXJ5KSBhcyBRdWVyeUFycmF5UmVzdWx0PFQ+O1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChlIGluc3RhbmNlb2YgUG9zdGdyZXNFcnJvcikge1xuICAgICAgICBhd2FpdCB0aGlzLmNvbW1pdCgpO1xuICAgICAgICB0aHJvdyBuZXcgVHJhbnNhY3Rpb25FcnJvcih0aGlzLm5hbWUsIGUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVGhpcyBtZXRob2QgYWxsb3dzIGV4ZWN1dGVkIHF1ZXJpZXMgdG8gYmUgcmV0cmlldmVkIGFzIG9iamVjdCBlbnRyaWVzLlxuICAgKiBJdCBzdXBwb3J0cyBhIGdlbmVyaWMgaW50ZXJmYWNlIGluIG9yZGVyIHRvIHR5cGUgdGhlIGVudHJpZXMgcmV0cmlldmVkIGJ5IHRoZSBxdWVyeVxuICAgKlxuICAgKiBgYGB0c1xuICAgKiBpbXBvcnQgeyBDbGllbnQgfSBmcm9tIFwiLi4vY2xpZW50LnRzXCI7XG4gICAqXG4gICAqIGNvbnN0IGNsaWVudCA9IG5ldyBDbGllbnQoKTtcbiAgICogY29uc3QgdHJhbnNhY3Rpb24gPSBjbGllbnQuY3JlYXRlVHJhbnNhY3Rpb24oXCJ0cmFuc2FjdGlvblwiKTtcbiAgICpcbiAgICoge1xuICAgKiAgIGNvbnN0IHsgcm93cyB9ID0gYXdhaXQgdHJhbnNhY3Rpb24ucXVlcnlPYmplY3QoXG4gICAqICAgICBcIlNFTEVDVCBJRCwgTkFNRSBGUk9NIENMSUVOVFNcIlxuICAgKiAgICk7IC8vIFJlY29yZDxzdHJpbmcsIHVua25vd24+XG4gICAqIH1cbiAgICpcbiAgICoge1xuICAgKiAgIGNvbnN0IHsgcm93cyB9ID0gYXdhaXQgdHJhbnNhY3Rpb24ucXVlcnlPYmplY3Q8e2lkOiBudW1iZXIsIG5hbWU6IHN0cmluZ30+KFxuICAgKiAgICAgXCJTRUxFQ1QgSUQsIE5BTUUgRlJPTSBDTElFTlRTXCJcbiAgICogICApOyAvLyBBcnJheTx7aWQ6IG51bWJlciwgbmFtZTogc3RyaW5nfT5cbiAgICogfVxuICAgKiBgYGBcbiAgICpcbiAgICogWW91IGNhbiBhbHNvIG1hcCB0aGUgZXhwZWN0ZWQgcmVzdWx0cyB0byBvYmplY3QgZmllbGRzIHVzaW5nIHRoZSBjb25maWd1cmF0aW9uIGludGVyZmFjZS5cbiAgICogVGhpcyB3aWxsIGJlIGFzc2lnbmVkIGluIHRoZSBvcmRlciB0aGV5IHdlcmUgcHJvdmlkZWRcbiAgICpcbiAgICogYGBgdHNcbiAgICogaW1wb3J0IHsgQ2xpZW50IH0gZnJvbSBcIi4uL2NsaWVudC50c1wiO1xuICAgKlxuICAgKiBjb25zdCBjbGllbnQgPSBuZXcgQ2xpZW50KCk7XG4gICAqIGNvbnN0IHRyYW5zYWN0aW9uID0gY2xpZW50LmNyZWF0ZVRyYW5zYWN0aW9uKFwidHJhbnNhY3Rpb25cIik7XG4gICAqXG4gICAqIHtcbiAgICogICBjb25zdCB7IHJvd3MgfSA9IGF3YWl0IHRyYW5zYWN0aW9uLnF1ZXJ5T2JqZWN0KFxuICAgKiAgICAgXCJTRUxFQ1QgSUQsIE5BTUUgRlJPTSBDTElFTlRTXCJcbiAgICogICApO1xuICAgKlxuICAgKiAgIGNvbnNvbGUubG9nKHJvd3MpOyAvLyBbe2lkOiA3OCwgbmFtZTogXCJGcmFua1wifSwge2lkOiAxNSwgbmFtZTogXCJTYXJhaFwifV1cbiAgICogfVxuICAgKlxuICAgKiB7XG4gICAqICAgY29uc3QgeyByb3dzIH0gPSBhd2FpdCB0cmFuc2FjdGlvbi5xdWVyeU9iamVjdCh7XG4gICAqICAgICB0ZXh0OiBcIlNFTEVDVCBJRCwgTkFNRSBGUk9NIENMSUVOVFNcIixcbiAgICogICAgIGZpZWxkczogW1wicGVyc29uYWxfaWRcIiwgXCJjb21wbGV0ZV9uYW1lXCJdLFxuICAgKiAgIH0pO1xuICAgKlxuICAgKiAgIGNvbnNvbGUubG9nKHJvd3MpOyAvLyBbe3BlcnNvbmFsX2lkOiA3OCwgY29tcGxldGVfbmFtZTogXCJGcmFua1wifSwge3BlcnNvbmFsX2lkOiAxNSwgY29tcGxldGVfbmFtZTogXCJTYXJhaFwifV1cbiAgICogfVxuICAgKiBgYGBcbiAgICpcbiAgICogSXQgYWxzbyBhbGxvd3MgeW91IHRvIGV4ZWN1dGUgcHJlcGFyZWQgc3RhbWVtZW50cyB3aXRoIHRlbXBsYXRlIHN0cmluZ3NcbiAgICpcbiAgICogYGBgdHNcbiAgICogaW1wb3J0IHsgQ2xpZW50IH0gZnJvbSBcIi4uL2NsaWVudC50c1wiO1xuICAgKlxuICAgKiBjb25zdCBjbGllbnQgPSBuZXcgQ2xpZW50KCk7XG4gICAqIGNvbnN0IHRyYW5zYWN0aW9uID0gY2xpZW50LmNyZWF0ZVRyYW5zYWN0aW9uKFwidHJhbnNhY3Rpb25cIik7XG4gICAqXG4gICAqIGNvbnN0IGlkID0gMTI7XG4gICAqIC8vIEFycmF5PHtpZDogbnVtYmVyLCBuYW1lOiBzdHJpbmd9PlxuICAgKiBjb25zdCB7cm93c30gPSBhd2FpdCB0cmFuc2FjdGlvbi5xdWVyeU9iamVjdDx7aWQ6IG51bWJlciwgbmFtZTogc3RyaW5nfT5gU0VMRUNUIElELCBOQU1FIEZST00gQ0xJRU5UUyBXSEVSRSBJRCA9ICR7aWR9YDtcbiAgICogYGBgXG4gICAqL1xuICBhc3luYyBxdWVyeU9iamVjdDxUPihcbiAgICBxdWVyeTogc3RyaW5nLFxuICAgIGFyZ3M/OiBRdWVyeUFyZ3VtZW50cyxcbiAgKTogUHJvbWlzZTxRdWVyeU9iamVjdFJlc3VsdDxUPj47XG4gIGFzeW5jIHF1ZXJ5T2JqZWN0PFQ+KFxuICAgIGNvbmZpZzogUXVlcnlPYmplY3RPcHRpb25zLFxuICApOiBQcm9taXNlPFF1ZXJ5T2JqZWN0UmVzdWx0PFQ+PjtcbiAgYXN5bmMgcXVlcnlPYmplY3Q8VD4oXG4gICAgcXVlcnk6IFRlbXBsYXRlU3RyaW5nc0FycmF5LFxuICAgIC4uLmFyZ3M6IHVua25vd25bXVxuICApOiBQcm9taXNlPFF1ZXJ5T2JqZWN0UmVzdWx0PFQ+PjtcbiAgYXN5bmMgcXVlcnlPYmplY3Q8XG4gICAgVCA9IFJlY29yZDxzdHJpbmcsIHVua25vd24+LFxuICA+KFxuICAgIHF1ZXJ5X3RlbXBsYXRlX29yX2NvbmZpZzpcbiAgICAgIHwgc3RyaW5nXG4gICAgICB8IFF1ZXJ5T2JqZWN0T3B0aW9uc1xuICAgICAgfCBUZW1wbGF0ZVN0cmluZ3NBcnJheSxcbiAgICAuLi5hcmdzOiB1bmtub3duW10gfCBbUXVlcnlBcmd1bWVudHMgfCB1bmRlZmluZWRdXG4gICk6IFByb21pc2U8UXVlcnlPYmplY3RSZXN1bHQ8VD4+IHtcbiAgICB0aGlzLiNhc3NlcnRUcmFuc2FjdGlvbk9wZW4oKTtcblxuICAgIGxldCBxdWVyeTogUXVlcnk8UmVzdWx0VHlwZS5PQkpFQ1Q+O1xuICAgIGlmICh0eXBlb2YgcXVlcnlfdGVtcGxhdGVfb3JfY29uZmlnID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBxdWVyeSA9IG5ldyBRdWVyeShcbiAgICAgICAgcXVlcnlfdGVtcGxhdGVfb3JfY29uZmlnLFxuICAgICAgICBSZXN1bHRUeXBlLk9CSkVDVCxcbiAgICAgICAgYXJnc1swXSBhcyBRdWVyeUFyZ3VtZW50cyB8IHVuZGVmaW5lZCxcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChpc1RlbXBsYXRlU3RyaW5nKHF1ZXJ5X3RlbXBsYXRlX29yX2NvbmZpZykpIHtcbiAgICAgIHF1ZXJ5ID0gdGVtcGxhdGVTdHJpbmdUb1F1ZXJ5KFxuICAgICAgICBxdWVyeV90ZW1wbGF0ZV9vcl9jb25maWcsXG4gICAgICAgIGFyZ3MsXG4gICAgICAgIFJlc3VsdFR5cGUuT0JKRUNULFxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcXVlcnkgPSBuZXcgUXVlcnkoXG4gICAgICAgIHF1ZXJ5X3RlbXBsYXRlX29yX2NvbmZpZyBhcyBRdWVyeU9iamVjdE9wdGlvbnMsXG4gICAgICAgIFJlc3VsdFR5cGUuT0JKRUNULFxuICAgICAgKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuI2V4ZWN1dGVRdWVyeShxdWVyeSkgYXMgUXVlcnlPYmplY3RSZXN1bHQ8VD47XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKGUgaW5zdGFuY2VvZiBQb3N0Z3Jlc0Vycm9yKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuY29tbWl0KCk7XG4gICAgICAgIHRocm93IG5ldyBUcmFuc2FjdGlvbkVycm9yKHRoaXMubmFtZSwgZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSb2xsYmFja3MgYXJlIGEgbWVjaGFuaXNtIHRvIHVuZG8gdHJhbnNhY3Rpb24gb3BlcmF0aW9ucyB3aXRob3V0IGNvbXByb21pc2luZyB0aGUgZGF0YSB0aGF0IHdhcyBtb2RpZmllZCBkdXJpbmdcbiAgICogdGhlIHRyYW5zYWN0aW9uXG4gICAqXG4gICAqIEEgcm9sbGJhY2sgY2FuIGJlIGV4ZWN1dGVkIHRoZSBmb2xsb3dpbmcgd2F5XG4gICAqIGBgYHRzXG4gICAqIGltcG9ydCB7IENsaWVudCB9IGZyb20gXCIuLi9jbGllbnQudHNcIjtcbiAgICpcbiAgICogY29uc3QgY2xpZW50ID0gbmV3IENsaWVudCgpO1xuICAgKiBjb25zdCB0cmFuc2FjdGlvbiA9IGNsaWVudC5jcmVhdGVUcmFuc2FjdGlvbihcInRyYW5zYWN0aW9uXCIpO1xuICAgKlxuICAgKiAvLyBWZXJ5IHZlcnkgaW1wb3J0YW50IG9wZXJhdGlvbnMgdGhhdCB3ZW50IHZlcnksIHZlcnkgd3JvbmdcbiAgICogYXdhaXQgdHJhbnNhY3Rpb24ucm9sbGJhY2soKTsgLy8gTGlrZSBub3RoaW5nIGV2ZXIgaGFwcGVuZWRcbiAgICogYGBgXG4gICAqXG4gICAqIENhbGxpbmcgYSByb2xsYmFjayB3aXRob3V0IGFyZ3VtZW50cyB3aWxsIHRlcm1pbmF0ZSB0aGUgY3VycmVudCB0cmFuc2FjdGlvbiBhbmQgdW5kbyBhbGwgY2hhbmdlcyxcbiAgICogYnV0IGl0IGNhbiBiZSB1c2VkIGluIGNvbmp1Y3Rpb24gd2l0aCB0aGUgc2F2ZXBvaW50IGZlYXR1cmUgdG8gcm9sbGJhY2sgc3BlY2lmaWMgY2hhbmdlcyBsaWtlIHRoZSBmb2xsb3dpbmdcbiAgICpcbiAgICogYGBgdHNcbiAgICogaW1wb3J0IHsgQ2xpZW50IH0gZnJvbSBcIi4uL2NsaWVudC50c1wiO1xuICAgKlxuICAgKiBjb25zdCBjbGllbnQgPSBuZXcgQ2xpZW50KCk7XG4gICAqIGNvbnN0IHRyYW5zYWN0aW9uID0gY2xpZW50LmNyZWF0ZVRyYW5zYWN0aW9uKFwidHJhbnNhY3Rpb25cIik7XG4gICAqXG4gICAqIC8vIEltcG9ydGFudCBvcGVyYXRpb25zIEkgZG9uJ3Qgd2FudCB0byByb2xsYmFja1xuICAgKiBjb25zdCBzYXZlcG9pbnQgPSBhd2FpdCB0cmFuc2FjdGlvbi5zYXZlcG9pbnQoXCJiZWZvcmVfZGlzYXN0ZXJcIik7XG4gICAqIGF3YWl0IHRyYW5zYWN0aW9uLnF1ZXJ5QXJyYXlgVVBEQVRFIE1ZX1RBQkxFIFNFVCBYID0gMGA7IC8vIE9vcHMsIHVwZGF0ZSB3aXRob3V0IHdoZXJlXG4gICAqIGF3YWl0IHRyYW5zYWN0aW9uLnJvbGxiYWNrKHNhdmVwb2ludCk7IC8vIFwiYmVmb3JlX2Rpc2FzdGVyXCIgd291bGQgd29yayBhcyB3ZWxsXG4gICAqIC8vIEV2ZXJ5dGhpbmcgdGhhdCBoYXBwZW5lZCBiZXR3ZWVuIHRoZSBzYXZlcG9pbnQgYW5kIHRoZSByb2xsYmFjayBnZXRzIHVuZG9uZVxuICAgKiBhd2FpdCB0cmFuc2FjdGlvbi5jb21taXQoKTsgLy8gQ29tbWl0cyBhbGwgb3RoZXIgY2hhbmdlc1xuICAgKiBgYGBcbiAgICpcbiAgICogVGhlIHJvbGxiYWNrIG1ldGhvZCBhbGxvd3MgeW91IHRvIHNwZWNpZnkgYSBcImNoYWluXCIgb3B0aW9uLCB0aGF0IGFsbG93cyB5b3UgdG8gbm90IG9ubHkgdW5kbyB0aGUgY3VycmVudCB0cmFuc2FjdGlvblxuICAgKiBidXQgdG8gcmVzdGFydCBpdCB3aXRoIHRoZSBzYW1lIHBhcmFtZXRlcnMgaW4gYSBzaW5nbGUgc3RhdGVtZW50XG4gICAqXG4gICAqIGBgYHRzXG4gICAqIGltcG9ydCB7IENsaWVudCB9IGZyb20gXCIuLi9jbGllbnQudHNcIjtcbiAgICpcbiAgICogY29uc3QgY2xpZW50ID0gbmV3IENsaWVudCgpO1xuICAgKiBjb25zdCB0cmFuc2FjdGlvbiA9IGNsaWVudC5jcmVhdGVUcmFuc2FjdGlvbihcInRyYW5zYWN0aW9uXCIpO1xuICAgKlxuICAgKiAvLyBUcmFuc2FjdGlvbiBvcGVyYXRpb25zIEkgd2FudCB0byB1bmRvXG4gICAqIGF3YWl0IHRyYW5zYWN0aW9uLnJvbGxiYWNrKHsgY2hhaW46IHRydWUgfSk7IC8vIEFsbCBjaGFuZ2VzIGFyZSB1bmRvbmUsIGJ1dCB0aGUgZm9sbG93aW5nIHN0YXRlbWVudHMgd2lsbCBiZSBleGVjdXRlZCBpbnNpZGUgYSB0cmFuc2FjdGlvbiBhcyB3ZWxsXG4gICAqIGF3YWl0IHRyYW5zYWN0aW9uLnF1ZXJ5QXJyYXlgREVMRVRFIFNPTUVUSElORyBGUk9NIFNPTUVXSEVSRWA7IC8vIFN0aWxsIGluc2lkZSB0aGUgdHJhbnNhY3Rpb25cbiAgICogYXdhaXQgdHJhbnNhY3Rpb24uY29tbWl0KCk7IC8vIFRoZSB0cmFuc2FjdGlvbiBmaW5pc2hlcyBmb3IgZ29vZFxuICAgKiBgYGBcbiAgICpcbiAgICogSG93ZXZlciwgdGhlIFwiY2hhaW5cIiBvcHRpb24gY2FuJ3QgYmUgdXNlZCBhbG9uZ3NpZGUgYSBzYXZlcG9pbnQsIGV2ZW4gdGhvdWdoIHRoZXkgYXJlIHNpbWlsYXJcbiAgICpcbiAgICogQSBzYXZlcG9pbnQgaXMgbWVhbnQgdG8gcmVzZXQgcHJvZ3Jlc3MgdXAgdG8gYSBjZXJ0YWluIHBvaW50LCB3aGlsZSBhIGNoYWluZWQgcm9sbGJhY2sgaXMgbWVhbnQgdG8gcmVzZXQgYWxsIHByb2dyZXNzXG4gICAqIGFuZCBzdGFydCBmcm9tIHNjcmF0Y2hcbiAgICpcbiAgICogYGBgdHNcbiAgICogaW1wb3J0IHsgQ2xpZW50IH0gZnJvbSBcIi4uL2NsaWVudC50c1wiO1xuICAgKlxuICAgKiBjb25zdCBjbGllbnQgPSBuZXcgQ2xpZW50KCk7XG4gICAqIGNvbnN0IHRyYW5zYWN0aW9uID0gY2xpZW50LmNyZWF0ZVRyYW5zYWN0aW9uKFwidHJhbnNhY3Rpb25cIik7XG4gICAqXG4gICAqIC8vIEB0cy1leHBlY3QtZXJyb3JcbiAgICogYXdhaXQgdHJhbnNhY3Rpb24ucm9sbGJhY2soeyBjaGFpbjogdHJ1ZSwgc2F2ZXBvaW50OiBcIm15X3NhdmVwb2ludFwiIH0pOyAvLyBFcnJvciwgY2FuJ3QgYm90aCByZXR1cm4gdG8gc2F2ZXBvaW50IGFuZCByZXNldCB0cmFuc2FjdGlvblxuICAgKiBgYGBcbiAgICogaHR0cHM6Ly93d3cucG9zdGdyZXNxbC5vcmcvZG9jcy8xNC9zcWwtcm9sbGJhY2suaHRtbFxuICAgKi9cbiAgYXN5bmMgcm9sbGJhY2soc2F2ZXBvaW50Pzogc3RyaW5nIHwgU2F2ZXBvaW50KTogUHJvbWlzZTx2b2lkPjtcbiAgYXN5bmMgcm9sbGJhY2sob3B0aW9ucz86IHsgc2F2ZXBvaW50Pzogc3RyaW5nIHwgU2F2ZXBvaW50IH0pOiBQcm9taXNlPHZvaWQ+O1xuICBhc3luYyByb2xsYmFjayhvcHRpb25zPzogeyBjaGFpbj86IGJvb2xlYW4gfSk6IFByb21pc2U8dm9pZD47XG4gIGFzeW5jIHJvbGxiYWNrKFxuICAgIHNhdmVwb2ludF9vcl9vcHRpb25zPzogc3RyaW5nIHwgU2F2ZXBvaW50IHwge1xuICAgICAgc2F2ZXBvaW50Pzogc3RyaW5nIHwgU2F2ZXBvaW50O1xuICAgIH0gfCB7IGNoYWluPzogYm9vbGVhbiB9LFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLiNhc3NlcnRUcmFuc2FjdGlvbk9wZW4oKTtcblxuICAgIGxldCBzYXZlcG9pbnRfb3B0aW9uOiBTYXZlcG9pbnQgfCBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgaWYgKFxuICAgICAgdHlwZW9mIHNhdmVwb2ludF9vcl9vcHRpb25zID09PSBcInN0cmluZ1wiIHx8XG4gICAgICBzYXZlcG9pbnRfb3Jfb3B0aW9ucyBpbnN0YW5jZW9mIFNhdmVwb2ludFxuICAgICkge1xuICAgICAgc2F2ZXBvaW50X29wdGlvbiA9IHNhdmVwb2ludF9vcl9vcHRpb25zO1xuICAgIH0gZWxzZSB7XG4gICAgICBzYXZlcG9pbnRfb3B0aW9uID1cbiAgICAgICAgKHNhdmVwb2ludF9vcl9vcHRpb25zIGFzIHsgc2F2ZXBvaW50Pzogc3RyaW5nIHwgU2F2ZXBvaW50IH0pPy5zYXZlcG9pbnQ7XG4gICAgfVxuXG4gICAgbGV0IHNhdmVwb2ludF9uYW1lOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgaWYgKHNhdmVwb2ludF9vcHRpb24gaW5zdGFuY2VvZiBTYXZlcG9pbnQpIHtcbiAgICAgIHNhdmVwb2ludF9uYW1lID0gc2F2ZXBvaW50X29wdGlvbi5uYW1lO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIHNhdmVwb2ludF9vcHRpb24gPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHNhdmVwb2ludF9uYW1lID0gc2F2ZXBvaW50X29wdGlvbi50b0xvd2VyQ2FzZSgpO1xuICAgIH1cblxuICAgIGxldCBjaGFpbl9vcHRpb24gPSBmYWxzZTtcbiAgICBpZiAodHlwZW9mIHNhdmVwb2ludF9vcl9vcHRpb25zID09PSBcIm9iamVjdFwiKSB7XG4gICAgICBjaGFpbl9vcHRpb24gPSAoc2F2ZXBvaW50X29yX29wdGlvbnMgYXMgeyBjaGFpbj86IGJvb2xlYW4gfSk/LmNoYWluID8/XG4gICAgICAgIGZhbHNlO1xuICAgIH1cblxuICAgIGlmIChjaGFpbl9vcHRpb24gJiYgc2F2ZXBvaW50X25hbWUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgXCJUaGUgY2hhaW4gb3B0aW9uIGNhbid0IGJlIHVzZWQgYWxvbmdzaWRlIGEgc2F2ZXBvaW50IG9uIGEgcm9sbGJhY2sgb3BlcmF0aW9uXCIsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIElmIGEgc2F2ZXBvaW50IGlzIHByb3ZpZGVkLCByb2xsYmFjayB0byB0aGF0IHNhdmVwb2ludCwgY29udGludWUgdGhlIHRyYW5zYWN0aW9uXG4gICAgaWYgKHR5cGVvZiBzYXZlcG9pbnRfb3B0aW9uICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICBjb25zdCB0c19zYXZlcG9pbnQgPSB0aGlzLiNzYXZlcG9pbnRzLmZpbmQoKHsgbmFtZSB9KSA9PlxuICAgICAgICBuYW1lID09PSBzYXZlcG9pbnRfbmFtZVxuICAgICAgKTtcbiAgICAgIGlmICghdHNfc2F2ZXBvaW50KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVGhlcmUgaXMgbm8gXCIke3NhdmVwb2ludF9uYW1lfVwiIHNhdmVwb2ludCByZWdpc3RlcmVkIGluIHRoaXMgdHJhbnNhY3Rpb25gLFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKCF0c19zYXZlcG9pbnQuaW5zdGFuY2VzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVGhlcmUgYXJlIG5vIHNhdmVwb2ludHMgb2YgXCIke3NhdmVwb2ludF9uYW1lfVwiIGxlZnQgdG8gcm9sbGJhY2sgdG9gLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBhd2FpdCB0aGlzLnF1ZXJ5QXJyYXkoYFJPTExCQUNLIFRPICR7c2F2ZXBvaW50X25hbWV9YCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gSWYgbm8gc2F2ZXBvaW50IGlzIHByb3ZpZGVkLCByb2xsYmFjayB0aGUgd2hvbGUgdHJhbnNhY3Rpb24gYW5kIGNoZWNrIGZvciB0aGUgY2hhaW4gb3BlcmF0b3JcbiAgICAvLyBpbiBvcmRlciB0byBkZWNpZGUgd2hldGhlciB0byByZXN0YXJ0IHRoZSB0cmFuc2FjdGlvbiBvciBlbmQgaXRcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5xdWVyeUFycmF5KGBST0xMQkFDSyAke2NoYWluX29wdGlvbiA/IFwiQU5EIENIQUlOXCIgOiBcIlwifWApO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChlIGluc3RhbmNlb2YgUG9zdGdyZXNFcnJvcikge1xuICAgICAgICBhd2FpdCB0aGlzLmNvbW1pdCgpO1xuICAgICAgICB0aHJvdyBuZXcgVHJhbnNhY3Rpb25FcnJvcih0aGlzLm5hbWUsIGUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLiNyZXNldFRyYW5zYWN0aW9uKCk7XG4gICAgaWYgKCFjaGFpbl9vcHRpb24pIHtcbiAgICAgIHRoaXMuI3VwZGF0ZUNsaWVudExvY2sobnVsbCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgbWV0aG9kIHdpbGwgZ2VuZXJhdGUgYSBzYXZlcG9pbnQsIHdoaWNoIHdpbGwgYWxsb3cgeW91IHRvIHJlc2V0IHRyYW5zYWN0aW9uIHN0YXRlc1xuICAgKiB0byBhIHByZXZpb3VzIHBvaW50IG9mIHRpbWVcbiAgICpcbiAgICogRWFjaCBzYXZlcG9pbnQgaGFzIGEgdW5pcXVlIG5hbWUgdXNlZCB0byBpZGVudGlmeSBpdCwgYW5kIGl0IG11c3QgYWJpZGUgdGhlIGZvbGxvd2luZyBydWxlc1xuICAgKlxuICAgKiAtIFNhdmVwb2ludCBuYW1lcyBtdXN0IHN0YXJ0IHdpdGggYSBsZXR0ZXIgb3IgYW4gdW5kZXJzY29yZVxuICAgKiAtIFNhdmVwb2ludCBuYW1lcyBhcmUgY2FzZSBpbnNlbnNpdGl2ZVxuICAgKiAtIFNhdmVwb2ludCBuYW1lcyBjYW4ndCBiZSBsb25nZXIgdGhhbiA2MyBjaGFyYWN0ZXJzXG4gICAqIC0gU2F2ZXBvaW50IG5hbWVzIGNhbiBvbmx5IGhhdmUgYWxwaGFudW1lcmljIGNoYXJhY3RlcnNcbiAgICpcbiAgICogQSBzYXZlcG9pbnQgY2FuIGJlIGVhc2lseSBjcmVhdGVkIGxpa2UgdGhpc1xuICAgKiBgYGB0c1xuICAgKiBpbXBvcnQgeyBDbGllbnQgfSBmcm9tIFwiLi4vY2xpZW50LnRzXCI7XG4gICAqXG4gICAqIGNvbnN0IGNsaWVudCA9IG5ldyBDbGllbnQoKTtcbiAgICogY29uc3QgdHJhbnNhY3Rpb24gPSBjbGllbnQuY3JlYXRlVHJhbnNhY3Rpb24oXCJ0cmFuc2FjdGlvblwiKTtcbiAgICpcbiAgICogY29uc3Qgc2F2ZXBvaW50ID0gYXdhaXQgdHJhbnNhY3Rpb24uc2F2ZXBvaW50KFwiTVlfc2F2ZXBvaW50XCIpOyAvLyByZXR1cm5zIGEgYFNhdmVwb2ludGAgd2l0aCBuYW1lIFwibXlfc2F2ZXBvaW50XCJcbiAgICogYXdhaXQgdHJhbnNhY3Rpb24ucm9sbGJhY2soc2F2ZXBvaW50KTtcbiAgICogYXdhaXQgc2F2ZXBvaW50LnJlbGVhc2UoKTsgLy8gVGhlIHNhdmVwb2ludCB3aWxsIGJlIHJlbW92ZWRcbiAgICogYGBgXG4gICAqIEFsbCBzYXZlcG9pbnRzIGNhbiBoYXZlIG11bHRpcGxlIHBvc2l0aW9ucyBpbiBhIHRyYW5zYWN0aW9uLCBhbmQgeW91IGNhbiBjaGFuZ2Ugb3IgdXBkYXRlXG4gICAqIHRoaXMgcG9zaXRpb25zIGJ5IHVzaW5nIHRoZSBgdXBkYXRlYCBhbmQgYHJlbGVhc2VgIG1ldGhvZHNcbiAgICogYGBgdHNcbiAgICogaW1wb3J0IHsgQ2xpZW50IH0gZnJvbSBcIi4uL2NsaWVudC50c1wiO1xuICAgKlxuICAgKiBjb25zdCBjbGllbnQgPSBuZXcgQ2xpZW50KCk7XG4gICAqIGNvbnN0IHRyYW5zYWN0aW9uID0gY2xpZW50LmNyZWF0ZVRyYW5zYWN0aW9uKFwidHJhbnNhY3Rpb25cIik7XG4gICAqXG4gICAqIGNvbnN0IHNhdmVwb2ludCA9IGF3YWl0IHRyYW5zYWN0aW9uLnNhdmVwb2ludChcIm4xXCIpO1xuICAgKiBhd2FpdCB0cmFuc2FjdGlvbi5xdWVyeUFycmF5YElOU0VSVCBJTlRPIE1ZX1RBQkxFIFZBTFVFUyAoJHsnQSd9LCAkezJ9KWA7XG4gICAqIGF3YWl0IHNhdmVwb2ludC51cGRhdGUoKTsgLy8gVGhlIHNhdmVwb2ludCB3aWxsIGNvbnRpbnVlIGZyb20gaGVyZVxuICAgKiBhd2FpdCB0cmFuc2FjdGlvbi5xdWVyeUFycmF5YERFTEVURSBGUk9NIE1ZX1RBQkxFYDtcbiAgICogYXdhaXQgdHJhbnNhY3Rpb24ucm9sbGJhY2soc2F2ZXBvaW50KTsgLy8gVGhlIHRyYW5zYWN0aW9uIHdpbGwgcm9sbGJhY2sgYmVmb3JlIHRoZSBkZWxldGUsIGJ1dCBhZnRlciB0aGUgaW5zZXJ0XG4gICAqIGF3YWl0IHNhdmVwb2ludC5yZWxlYXNlKCk7IC8vIFRoZSBsYXN0IHNhdmVwb2ludCB3aWxsIGJlIHJlbW92ZWQsIHRoZSBvcmlnaW5hbCBvbmUgd2lsbCByZW1haW5cbiAgICogYXdhaXQgdHJhbnNhY3Rpb24ucm9sbGJhY2soc2F2ZXBvaW50KTsgLy8gSXQgcm9sbHMgYmFjayBiZWZvcmUgdGhlIGluc2VydFxuICAgKiBhd2FpdCBzYXZlcG9pbnQucmVsZWFzZSgpOyAvLyBBbGwgc2F2ZXBvaW50cyBhcmUgcmVsZWFzZWRcbiAgICogYGBgXG4gICAqXG4gICAqIENyZWF0aW5nIGEgbmV3IHNhdmVwb2ludCB3aXRoIGFuIGFscmVhZHkgdXNlZCBuYW1lIHdpbGwgcmV0dXJuIHlvdSBhIHJlZmVyZW5jZSB0b1xuICAgKiB0aGUgb3JpZ2luYWwgc2F2ZXBvaW50XG4gICAqIGBgYHRzXG4gICAqIGltcG9ydCB7IENsaWVudCB9IGZyb20gXCIuLi9jbGllbnQudHNcIjtcbiAgICpcbiAgICogY29uc3QgY2xpZW50ID0gbmV3IENsaWVudCgpO1xuICAgKiBjb25zdCB0cmFuc2FjdGlvbiA9IGNsaWVudC5jcmVhdGVUcmFuc2FjdGlvbihcInRyYW5zYWN0aW9uXCIpO1xuICAgKlxuICAgKiBjb25zdCBzYXZlcG9pbnRfYSA9IGF3YWl0IHRyYW5zYWN0aW9uLnNhdmVwb2ludChcImFcIik7XG4gICAqIGF3YWl0IHRyYW5zYWN0aW9uLnF1ZXJ5QXJyYXlgREVMRVRFIEZST00gTVlfVEFCTEVgO1xuICAgKiBjb25zdCBzYXZlcG9pbnRfYiA9IGF3YWl0IHRyYW5zYWN0aW9uLnNhdmVwb2ludChcImFcIik7IC8vIFRoZXkgd2lsbCBiZSB0aGUgc2FtZSBzYXZlcG9pbnQsIGJ1dCB0aGUgc2F2ZXBvaW50IHdpbGwgYmUgdXBkYXRlZCB0byB0aGlzIHBvc2l0aW9uXG4gICAqIGF3YWl0IHRyYW5zYWN0aW9uLnJvbGxiYWNrKHNhdmVwb2ludF9hKTsgLy8gUm9sbHMgYmFjayB0byBzYXZlcG9pbnRfYlxuICAgKiBgYGBcbiAgICogaHR0cHM6Ly93d3cucG9zdGdyZXNxbC5vcmcvZG9jcy8xNC9zcWwtc2F2ZXBvaW50Lmh0bWxcbiAgICovXG4gIGFzeW5jIHNhdmVwb2ludChuYW1lOiBzdHJpbmcpOiBQcm9taXNlPFNhdmVwb2ludD4ge1xuICAgIHRoaXMuI2Fzc2VydFRyYW5zYWN0aW9uT3BlbigpO1xuXG4gICAgaWYgKCEvXlthLXpBLVpfXXsxfVtcXHddezAsNjJ9JC8udGVzdChuYW1lKSkge1xuICAgICAgaWYgKCFOdW1iZXIuaXNOYU4oTnVtYmVyKG5hbWVbMF0pKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJUaGUgc2F2ZXBvaW50IG5hbWUgY2FuJ3QgYmVnaW4gd2l0aCBhIG51bWJlclwiKTtcbiAgICAgIH1cbiAgICAgIGlmIChuYW1lLmxlbmd0aCA+IDYzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBcIlRoZSBzYXZlcG9pbnQgbmFtZSBjYW4ndCBiZSBsb25nZXIgdGhhbiA2MyBjaGFyYWN0ZXJzXCIsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIFwiVGhlIHNhdmVwb2ludCBuYW1lIGNhbiBvbmx5IGNvbnRhaW4gYWxwaGFudW1lcmljIGNoYXJhY3RlcnNcIixcbiAgICAgICk7XG4gICAgfVxuXG4gICAgbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTtcblxuICAgIGxldCBzYXZlcG9pbnQgPSB0aGlzLiNzYXZlcG9pbnRzLmZpbmQoKHN2KSA9PiBzdi5uYW1lID09PSBuYW1lKTtcblxuICAgIGlmIChzYXZlcG9pbnQpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHNhdmVwb2ludC51cGRhdGUoKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgaWYgKGUgaW5zdGFuY2VvZiBQb3N0Z3Jlc0Vycm9yKSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy5jb21taXQoKTtcbiAgICAgICAgICB0aHJvdyBuZXcgVHJhbnNhY3Rpb25FcnJvcih0aGlzLm5hbWUsIGUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IGU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgc2F2ZXBvaW50ID0gbmV3IFNhdmVwb2ludChcbiAgICAgICAgbmFtZSxcbiAgICAgICAgYXN5bmMgKG5hbWU6IHN0cmluZykgPT4ge1xuICAgICAgICAgIGF3YWl0IHRoaXMucXVlcnlBcnJheShgU0FWRVBPSU5UICR7bmFtZX1gKTtcbiAgICAgICAgfSxcbiAgICAgICAgYXN5bmMgKG5hbWU6IHN0cmluZykgPT4ge1xuICAgICAgICAgIGF3YWl0IHRoaXMucXVlcnlBcnJheShgUkVMRUFTRSBTQVZFUE9JTlQgJHtuYW1lfWApO1xuICAgICAgICB9LFxuICAgICAgKTtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgc2F2ZXBvaW50LnVwZGF0ZSgpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBpZiAoZSBpbnN0YW5jZW9mIFBvc3RncmVzRXJyb3IpIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLmNvbW1pdCgpO1xuICAgICAgICAgIHRocm93IG5ldyBUcmFuc2FjdGlvbkVycm9yKHRoaXMubmFtZSwgZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdGhpcy4jc2F2ZXBvaW50cy5wdXNoKHNhdmVwb2ludCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNhdmVwb2ludDtcbiAgfVxufVxuIl19