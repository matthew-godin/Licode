import { existsSync, extname, globToRegExp, JSON_SCHEMA, log, parseYaml, resolve, } from "../deps.ts";
import { merge } from "./merge.ts";
const logger = log.create("conf");
export const configs = [
    "denon.yaml",
    "denon.yml",
    "denon.json",
    "scripts.json",
    "scripts.yml",
    "scripts.yaml",
    "denon.config.ts",
    "scripts.config.ts",
    "denon.config.js",
    "scripts.config.js",
    "scripts.ts",
    "scripts.js",
];
export const reConfig = new RegExp(configs
    .map((_) => `**/${_}`)
    .map((_) => globToRegExp(_).source)
    .join("|"));
export const DEFAULT_DENON_CONFIG = {
    scripts: {},
    watcher: {
        interval: 350,
        paths: [],
        exts: ["ts", "tsx", "js", "jsx", "json"],
        match: ["**/*.*"],
        skip: ["**/.git/**"],
    },
    watch: true,
    logger: {
        quiet: false,
        debug: false,
        fullscreen: false,
    },
    configPath: "",
};
async function readYaml(file) {
    const source = await Deno.readTextFile(file);
    return parseYaml(source, {
        schema: JSON_SCHEMA,
        json: true,
    });
}
async function readJson(file) {
    const source = await Deno.readTextFile(file);
    return JSON.parse(source);
}
async function importConfig(file) {
    try {
        const configRaw = await import(`file://${resolve(file)}`);
        return configRaw.default;
    }
    catch (error) {
        logger.error(error.message ?? "Error opening ts config config");
        return;
    }
}
function cleanConfig(config, file) {
    if (config.watcher) {
        if (config.watcher.exts) {
            config.watcher.exts = config.watcher.exts.map((_) => _.startsWith(".") ? _.substr(1) : _);
        }
        if (config.watcher.skip) {
            config.watcher.skip = config.watcher.skip.map((_) => _.startsWith("./") ? _.substr(2) : _);
        }
        if (config.watcher.match) {
            config.watcher.match = config.watcher.match.map((_) => _.startsWith("./") ? _.substr(2) : _);
        }
    }
    if (file) {
        config.configPath = resolve(file);
    }
    return config;
}
export function getConfigFilename() {
    return configs.find((filename) => {
        return existsSync(filename) && Deno.statSync(filename).isFile;
    });
}
export async function readConfig(file = getConfigFilename()) {
    let config = DEFAULT_DENON_CONFIG;
    if (!config.watcher.paths)
        config.watcher.paths = [];
    config.watcher.paths.push(Deno.cwd());
    if (file) {
        if (file.endsWith(".js") || file.endsWith(".ts")) {
            const parsed = await importConfig(file);
            if (parsed) {
                config = merge(config, cleanConfig(parsed, file));
            }
        }
        else {
            try {
                const extension = extname(file);
                if (/^\.ya?ml$/.test(extension)) {
                    const parsed = await readYaml(file);
                    config = merge(config, cleanConfig(parsed, file));
                }
                else if (/^\.json$/.test(extension)) {
                    const parsed = await readJson(file);
                    config = merge(config, cleanConfig(parsed, file));
                }
                else {
                    try {
                        const parsed = await readJson(file);
                        config = merge(config, cleanConfig(parsed, file));
                    }
                    catch {
                        const parsed = await readYaml(file);
                        config = merge(config, cleanConfig(parsed, file));
                    }
                }
            }
            catch {
                logger.warning(`unsupported configuration \`${file}\``);
            }
        }
    }
    return config;
}
export async function writeConfigTemplate(template) {
    try {
        logger.info(`writing template to \`${template.filename}\``);
        await Deno.writeTextFile(resolve(Deno.cwd(), template.filename), template.source);
        logger.info(`\`${template.filename}\` created in current working directory`);
    }
    catch {
        logger.error(`\`${template.filename}\` cannot be saved in current working directory`);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZmlnLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaHR0cHM6Ly9kZW5vLmxhbmQveC9kZW5vbkAyLjUuMC9zcmMvY29uZmlnLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFDTCxVQUFVLEVBQ1YsT0FBTyxFQUNQLFlBQVksRUFDWixXQUFXLEVBQ1gsR0FBRyxFQUNILFNBQVMsRUFDVCxPQUFPLEdBQ1IsTUFBTSxZQUFZLENBQUM7QUFPcEIsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFlBQVksQ0FBQztBQUVuQyxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBR2xDLE1BQU0sQ0FBQyxNQUFNLE9BQU8sR0FBRztJQUNyQixZQUFZO0lBQ1osV0FBVztJQUNYLFlBQVk7SUFFWixjQUFjO0lBQ2QsYUFBYTtJQUNiLGNBQWM7SUFFZCxpQkFBaUI7SUFDakIsbUJBQW1CO0lBQ25CLGlCQUFpQjtJQUNqQixtQkFBbUI7SUFFbkIsWUFBWTtJQUNaLFlBQVk7Q0FDYixDQUFDO0FBRUYsTUFBTSxDQUFDLE1BQU0sUUFBUSxHQUFHLElBQUksTUFBTSxDQUNoQyxPQUFPO0tBQ0osR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO0tBQ3JCLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztLQUNsQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQ2IsQ0FBQztBQWtCRixNQUFNLENBQUMsTUFBTSxvQkFBb0IsR0FBd0I7SUFDdkQsT0FBTyxFQUFFLEVBQUU7SUFDWCxPQUFPLEVBQUU7UUFDUCxRQUFRLEVBQUUsR0FBRztRQUNiLEtBQUssRUFBRSxFQUFFO1FBQ1QsSUFBSSxFQUFFLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0s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O1FBQ04sTUFBTSxDQUFDLEtBQUssQ0FDVixLQUFLLFFBQVEsQ0FBQyxRQUFRLGlEQUFpRCxDQUN4RSxDQUFDO0tBQ0g7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjAtMjAyMSB0aGUgZGVub3NhdXJzIHRlYW0uIEFsbCByaWdodHMgcmVzZXJ2ZWQuIE1JVCBsaWNlbnNlLlxuXG5pbXBvcnQge1xuICBleGlzdHNTeW5jLFxuICBleHRuYW1lLFxuICBnbG9iVG9SZWdFeHAsXG4gIEpTT05fU0NIRU1BLFxuICBsb2csXG4gIHBhcnNlWWFtbCxcbiAgcmVzb2x2ZSxcbn0gZnJvbSBcIi4uL2RlcHMudHNcIjtcblxuaW1wb3J0IHR5cGUgeyBBcmdzIH0gZnJvbSBcIi4vYXJncy50c1wiO1xuaW1wb3J0IHR5cGUgeyBSdW5uZXJDb25maWcgfSBmcm9tIFwiLi9ydW5uZXIudHNcIjtcbmltcG9ydCB0eXBlIHsgVGVtcGxhdGUgfSBmcm9tIFwiLi90ZW1wbGF0ZXMudHNcIjtcbmltcG9ydCB0eXBlIHsgV2F0Y2hlckNvbmZpZyB9IGZyb20gXCIuL3dhdGNoZXIudHNcIjtcblxuaW1wb3J0IHsgbWVyZ2UgfSBmcm9tIFwiLi9tZXJnZS50c1wiO1xuXG5jb25zdCBsb2dnZXIgPSBsb2cuY3JlYXRlKFwiY29uZlwiKTtcblxuLyoqIFBvc3NpYmxlIGRlZmF1bHQgY29uZmlndXJhdGlvbiBmaWxlcy4gKi9cbmV4cG9ydCBjb25zdCBjb25maWdzID0gW1xuICBcImRlbm9uLnlhbWxcIixcbiAgXCJkZW5vbi55bWxcIixcbiAgXCJkZW5vbi5qc29uXCIsXG5cbiAgXCJzY3JpcHRzLmpzb25cIixcbiAgXCJzY3JpcHRzLnltbFwiLFxuICBcInNjcmlwdHMueWFtbFwiLFxuXG4gIFwiZGVub24uY29uZmlnLnRzXCIsXG4gIFwic2NyaXB0cy5jb25maWcudHNcIixcbiAgXCJkZW5vbi5jb25maWcuanNcIixcbiAgXCJzY3JpcHRzLmNvbmZpZy5qc1wiLFxuXG4gIFwic2NyaXB0cy50c1wiLFxuICBcInNjcmlwdHMuanNcIixcbl07XG5cbmV4cG9ydCBjb25zdCByZUNvbmZpZyA9IG5ldyBSZWdFeHAoXG4gIGNvbmZpZ3NcbiAgICAubWFwKChfKSA9PiBgKiovJHtffWApXG4gICAgLm1hcCgoXykgPT4gZ2xvYlRvUmVnRXhwKF8pLnNvdXJjZSlcbiAgICAuam9pbihcInxcIiksIC8vIGkga25vdywgcmlnaHRcbik7XG5cbmV4cG9ydCB0eXBlIERlbm9uQ29uZmlnID0gUnVubmVyQ29uZmlnICYgUGFydGlhbDxDb21wbGV0ZURlbm9uQ29uZmlnPjtcblxuLyoqIFBhcmFtZXRlcnMgYXJlIG5vdCBvcHRpb25hbCAqL1xuZXhwb3J0IGludGVyZmFjZSBDb21wbGV0ZURlbm9uQ29uZmlnIGV4dGVuZHMgUnVubmVyQ29uZmlnIHtcbiAgW2tleTogc3RyaW5nXTogdW5rbm93bjtcbiAgd2F0Y2hlcjogV2F0Y2hlckNvbmZpZztcbiAgYXJncz86IEFyZ3M7XG4gIGxvZ2dlcjoge1xuICAgIHF1aWV0OiBib29sZWFuO1xuICAgIGRlYnVnOiBib29sZWFuO1xuICAgIGZ1bGxzY3JlZW46IGJvb2xlYW47XG4gIH07XG4gIGNvbmZpZ1BhdGg6IHN0cmluZztcbn1cblxuLyoqIFRoZSBkZWZhdWx0IGRlbm9uIGNvbmZpZ3VyYXRpb24gKi9cbmV4cG9ydCBjb25zdCBERUZBVUxUX0RFTk9OX0NPTkZJRzogQ29tcGxldGVEZW5vbkNvbmZpZyA9IHtcbiAgc2NyaXB0czoge30sXG4gIHdhdGNoZXI6IHtcbiAgICBpbnRlcnZhbDogMzUwLFxuICAgIHBhdGhzOiBbXSxcbiAgICBleHRzOiBbXCJ0c1wiLCBcInRzeFwiLCBcImpzXCIsIFwianN4XCIsIFwianNvblwiXSxcbiAgICBtYXRjaDogW1wiKiovKi4qXCJdLFxuICAgIHNraXA6IFtcIioqLy5naXQvKipcIl0sXG4gIH0sXG4gIHdhdGNoOiB0cnVlLFxuICBsb2dnZXI6IHtcbiAgICBxdWlldDogZmFsc2UsXG4gICAgZGVidWc6IGZhbHNlLFxuICAgIGZ1bGxzY3JlZW46IGZhbHNlLFxuICB9LFxuICBjb25maWdQYXRoOiBcIlwiLFxufTtcblxuLyoqIFJlYWQgWUFNTCBjb25maWcsIHRocm93cyBpZiBZQU1MIGZvcm1hdCBpcyBub3QgdmFsaWQgKi9cbmFzeW5jIGZ1bmN0aW9uIHJlYWRZYW1sKGZpbGU6IHN0cmluZyk6IFByb21pc2U8dW5rbm93bj4ge1xuICBjb25zdCBzb3VyY2UgPSBhd2FpdCBEZW5vLnJlYWRUZXh0RmlsZShmaWxlKTtcbiAgcmV0dXJuIHBhcnNlWWFtbChzb3VyY2UsIHtcbiAgICBzY2hlbWE6IEpTT05fU0NIRU1BLFxuICAgIGpzb246IHRydWUsXG4gIH0pO1xufVxuXG4vKiogUmVhZCBKU09OIGNvbmZpZywgdGhyb3dzIGlmIEpTT04gZm9ybWF0IGlzIG5vdCB2YWxpZCAqL1xuYXN5bmMgZnVuY3Rpb24gcmVhZEpzb24oZmlsZTogc3RyaW5nKTogUHJvbWlzZTx1bmtub3duPiB7XG4gIGNvbnN0IHNvdXJjZSA9IGF3YWl0IERlbm8ucmVhZFRleHRGaWxlKGZpbGUpO1xuICByZXR1cm4gSlNPTi5wYXJzZShzb3VyY2UpO1xufVxuXG4vKiogU2FmZSBpbXBvcnQgYSBUeXBlU2NyaXB0IGZpbGUgKi9cbmFzeW5jIGZ1bmN0aW9uIGltcG9ydENvbmZpZyhcbiAgZmlsZTogc3RyaW5nLFxuKTogUHJvbWlzZTxQYXJ0aWFsPERlbm9uQ29uZmlnPiB8IHVuZGVmaW5lZD4ge1xuICB0cnkge1xuICAgIGNvbnN0IGNvbmZpZ1JhdyA9IGF3YWl0IGltcG9ydChgZmlsZTovLyR7cmVzb2x2ZShmaWxlKX1gKTtcbiAgICByZXR1cm4gY29uZmlnUmF3LmRlZmF1bHQgYXMgUGFydGlhbDxEZW5vbkNvbmZpZz47XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbG9nZ2VyLmVycm9yKGVycm9yLm1lc3NhZ2UgPz8gXCJFcnJvciBvcGVuaW5nIHRzIGNvbmZpZyBjb25maWdcIik7XG4gICAgcmV0dXJuO1xuICB9XG59XG5cbi8qKiBDbGVhbiBjb25maWcgZnJvbSBtYWxmb3JtZWQgc3RyaW5ncyAqL1xuZnVuY3Rpb24gY2xlYW5Db25maWcoXG4gIGNvbmZpZzogUGFydGlhbDxEZW5vbkNvbmZpZz4sXG4gIGZpbGU/OiBzdHJpbmcsXG4pOiBQYXJ0aWFsPERlbm9uQ29uZmlnPiB7XG4gIGlmIChjb25maWcud2F0Y2hlcikge1xuICAgIGlmIChjb25maWcud2F0Y2hlci5leHRzKSB7XG4gICAgICBjb25maWcud2F0Y2hlci5leHRzID0gY29uZmlnLndhdGNoZXIuZXh0cy5tYXAoKF8pID0+XG4gICAgICAgIF8uc3RhcnRzV2l0aChcIi5cIikgPyBfLnN1YnN0cigxKSA6IF9cbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKGNvbmZpZy53YXRjaGVyLnNraXApIHtcbiAgICAgIGNvbmZpZy53YXRjaGVyLnNraXAgPSBjb25maWcud2F0Y2hlci5za2lwLm1hcCgoXykgPT5cbiAgICAgICAgXy5zdGFydHNXaXRoKFwiLi9cIikgPyBfLnN1YnN0cigyKSA6IF9cbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKGNvbmZpZy53YXRjaGVyLm1hdGNoKSB7XG4gICAgICBjb25maWcud2F0Y2hlci5tYXRjaCA9IGNvbmZpZy53YXRjaGVyLm1hdGNoLm1hcCgoXykgPT5cbiAgICAgICAgXy5zdGFydHNXaXRoKFwiLi9cIikgPyBfLnN1YnN0cigyKSA6IF9cbiAgICAgICk7XG4gICAgfVxuICB9XG4gIGlmIChmaWxlKSB7XG4gICAgY29uZmlnLmNvbmZpZ1BhdGggPSByZXNvbHZlKGZpbGUpO1xuICB9XG4gIHJldHVybiBjb25maWc7XG59XG5cbi8qKiBSZXR1cm5zLCBpZiBleGlzdHMsIHRoZSBjb25maWcgZmlsZW5hbWUgKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRDb25maWdGaWxlbmFtZSgpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICByZXR1cm4gY29uZmlncy5maW5kKChmaWxlbmFtZSkgPT4ge1xuICAgIHJldHVybiBleGlzdHNTeW5jKGZpbGVuYW1lKSAmJiBEZW5vLnN0YXRTeW5jKGZpbGVuYW1lKS5pc0ZpbGU7XG4gIH0pO1xufVxuXG4vKiogUmVhZHMgdGhlIGRlbm9uIGNvbmZpZyBmcm9tIGEgZmlsZSAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlYWRDb25maWcoXG4gIGZpbGU6IHN0cmluZyB8IHVuZGVmaW5lZCA9IGdldENvbmZpZ0ZpbGVuYW1lKCksXG4pOiBQcm9taXNlPENvbXBsZXRlRGVub25Db25maWc+IHtcbiAgbGV0IGNvbmZpZzogQ29tcGxldGVEZW5vbkNvbmZpZyA9IERFRkFVTFRfREVOT05fQ09ORklHO1xuICBpZiAoIWNvbmZpZy53YXRjaGVyLnBhdGhzKSBjb25maWcud2F0Y2hlci5wYXRocyA9IFtdO1xuICBjb25maWcud2F0Y2hlci5wYXRocy5wdXNoKERlbm8uY3dkKCkpO1xuXG4gIGlmIChmaWxlKSB7XG4gICAgaWYgKGZpbGUuZW5kc1dpdGgoXCIuanNcIikgfHwgZmlsZS5lbmRzV2l0aChcIi50c1wiKSkge1xuICAgICAgY29uc3QgcGFyc2VkID0gYXdhaXQgaW1wb3J0Q29uZmlnKGZpbGUpO1xuICAgICAgaWYgKHBhcnNlZCkge1xuICAgICAgICBjb25maWcgPSBtZXJnZShcbiAgICAgICAgICBjb25maWcsXG4gICAgICAgICAgY2xlYW5Db25maWcocGFyc2VkIGFzIFBhcnRpYWw8RGVub25Db25maWc+LCBmaWxlKSxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgZXh0ZW5zaW9uID0gZXh0bmFtZShmaWxlKTtcbiAgICAgICAgaWYgKC9eXFwueWE/bWwkLy50ZXN0KGV4dGVuc2lvbikpIHtcbiAgICAgICAgICBjb25zdCBwYXJzZWQgPSBhd2FpdCByZWFkWWFtbChmaWxlKTtcbiAgICAgICAgICBjb25maWcgPSBtZXJnZShcbiAgICAgICAgICAgIGNvbmZpZyxcbiAgICAgICAgICAgIGNsZWFuQ29uZmlnKHBhcnNlZCBhcyBQYXJ0aWFsPERlbm9uQ29uZmlnPiwgZmlsZSksXG4gICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIGlmICgvXlxcLmpzb24kLy50ZXN0KGV4dGVuc2lvbikpIHtcbiAgICAgICAgICBjb25zdCBwYXJzZWQgPSBhd2FpdCByZWFkSnNvbihmaWxlKTtcbiAgICAgICAgICBjb25maWcgPSBtZXJnZShcbiAgICAgICAgICAgIGNvbmZpZyxcbiAgICAgICAgICAgIGNsZWFuQ29uZmlnKHBhcnNlZCBhcyBQYXJ0aWFsPERlbm9uQ29uZmlnPiwgZmlsZSksXG4gICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgcGFyc2VkID0gYXdhaXQgcmVhZEpzb24oZmlsZSk7XG4gICAgICAgICAgICBjb25maWcgPSBtZXJnZShcbiAgICAgICAgICAgICAgY29uZmlnLFxuICAgICAgICAgICAgICBjbGVhbkNvbmZpZyhwYXJzZWQgYXMgUGFydGlhbDxEZW5vbkNvbmZpZz4sIGZpbGUpLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9IGNhdGNoIHtcbiAgICAgICAgICAgIGNvbnN0IHBhcnNlZCA9IGF3YWl0IHJlYWRZYW1sKGZpbGUpO1xuICAgICAgICAgICAgY29uZmlnID0gbWVyZ2UoXG4gICAgICAgICAgICAgIGNvbmZpZyxcbiAgICAgICAgICAgICAgY2xlYW5Db25maWcocGFyc2VkIGFzIFBhcnRpYWw8RGVub25Db25maWc+LCBmaWxlKSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGNhdGNoIHtcbiAgICAgICAgbG9nZ2VyLndhcm5pbmcoYHVuc3VwcG9ydGVkIGNvbmZpZ3VyYXRpb24gXFxgJHtmaWxlfVxcYGApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gY29uZmlnO1xufVxuXG4vKiogUmVhZHMgdGhlIGRlbm9uIGNvbmZpZyBmcm9tIGEgZmlsZSAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHdyaXRlQ29uZmlnVGVtcGxhdGUodGVtcGxhdGU6IFRlbXBsYXRlKTogUHJvbWlzZTx2b2lkPiB7XG4gIHRyeSB7XG4gICAgbG9nZ2VyLmluZm8oYHdyaXRpbmcgdGVtcGxhdGUgdG8gXFxgJHt0ZW1wbGF0ZS5maWxlbmFtZX1cXGBgKTtcbiAgICBhd2FpdCBEZW5vLndyaXRlVGV4dEZpbGUoXG4gICAgICByZXNvbHZlKERlbm8uY3dkKCksIHRlbXBsYXRlLmZpbGVuYW1lKSxcbiAgICAgIHRlbXBsYXRlLnNvdXJjZSxcbiAgICApO1xuICAgIGxvZ2dlci5pbmZvKFxuICAgICAgYFxcYCR7dGVtcGxhdGUuZmlsZW5hbWV9XFxgIGNyZWF0ZWQgaW4gY3VycmVudCB3b3JraW5nIGRpcmVjdG9yeWAsXG4gICAgKTtcbiAgfSBjYXRjaCB7XG4gICAgbG9nZ2VyLmVycm9yKFxuICAgICAgYFxcYCR7dGVtcGxhdGUuZmlsZW5hbWV9XFxgIGNhbm5vdCBiZSBzYXZlZCBpbiBjdXJyZW50IHdvcmtpbmcgZGlyZWN0b3J5YCxcbiAgICApO1xuICB9XG59XG4iXX0=