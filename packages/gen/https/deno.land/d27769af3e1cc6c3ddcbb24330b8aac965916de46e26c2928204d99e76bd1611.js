import { Cookies } from "./cookies.ts";
import { createHttpError } from "./httpError.ts";
import { Request } from "./request.ts";
import { Response } from "./response.ts";
import { send } from "./send.ts";
import { SSEStreamTarget, } from "./server_sent_event.ts";
export class Context {
    #socket;
    #sse;
    app;
    cookies;
    get isUpgradable() {
        const upgrade = this.request.headers.get("upgrade");
        if (!upgrade || upgrade.toLowerCase() !== "websocket") {
            return false;
        }
        const secKey = this.request.headers.get("sec-websocket-key");
        return typeof secKey === "string" && secKey != "";
    }
    respond;
    request;
    response;
    get socket() {
        return this.#socket;
    }
    state;
    constructor(app, serverRequest, state, secure = false) {
        this.app = app;
        this.state = state;
        this.request = new Request(serverRequest, app.proxy, secure);
        this.respond = true;
        this.response = new Response(this.request);
        this.cookies = new Cookies(this.request, this.response, {
            keys: this.app.keys,
            secure: this.request.secure,
        });
    }
    assert(condition, errorStatus = 500, message, props) {
        if (condition) {
            return;
        }
        const err = createHttpError(errorStatus, message);
        if (props) {
            Object.assign(err, props);
        }
        throw err;
    }
    send(options) {
        const { path = this.request.url.pathname, ...sendOptions } = options;
        return send(this, path, sendOptions);
    }
    sendEvents(options) {
        if (!this.#sse) {
            this.#sse = new SSEStreamTarget(this, options);
        }
        return this.#sse;
    }
    throw(errorStatus, message, props) {
        const err = createHttpError(errorStatus, message);
        if (props) {
            Object.assign(err, props);
        }
        throw err;
    }
    upgrade(options) {
        if (this.#socket) {
            return this.#socket;
        }
        if (!this.request.originalRequest.upgrade) {
            throw new TypeError("Web socket upgrades not currently supported for this type of server.");
        }
        this.#socket = this.request.originalRequest.upgrade(options);
        this.respond = false;
        return this.#socket;
    }
    [Symbol.for("Deno.customInspect")](inspect) {
        const { app, cookies, isUpgradable, respond, request, response, socket, state, } = this;
        return `${this.constructor.name} ${inspect({
            app,
            cookies,
            isUpgradable,
            respond,
            request,
            response,
            socket,
            state,
        })}`;
    }
    [Symbol.for("nodejs.util.inspect.custom")](depth, options, inspect) {
        if (depth < 0) {
            return options.stylize(`[${this.constructor.name}]`, "special");
        }
        const newOptions = Object.assign({}, options, {
            depth: options.depth === null ? null : options.depth - 1,
        });
        const { app, cookies, isUpgradable, respond, request, response, socket, state, } = this;
        return `${options.stylize(this.constructor.name, "special")} ${inspect({
            app,
            cookies,
            isUpgradable,
            respond,
            request,
            response,
            socket,
            state,
        }, newOptions)}`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvbnRleHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBR0EsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUN2QyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFakQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUN2QyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sRUFBRSxJQUFJLEVBQWUsTUFBTSxXQUFXLENBQUM7QUFDOUMsT0FBTyxFQUVMLGVBQWUsR0FDaEIsTUFBTSx3QkFBd0IsQ0FBQztBQWlEaEMsTUFBTSxPQUFPLE9BQU87SUFLbEIsT0FBTyxDQUFhO0lBQ3BCLElBQUksQ0FBeUI7SUFHN0IsR0FBRyxDQUFrQjtJQUlyQixPQUFPLENBQVU7SUFLakIsSUFBSSxZQUFZO1FBQ2QsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3BELElBQUksQ0FBQyxPQUFPLElBQUksT0FBTyxDQUFDLFdBQVcsRUFBRSxLQUFLLFdBQVcsRUFBRTtZQUNyRCxPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDN0QsT0FBTyxPQUFPLE1BQU0sS0FBSyxRQUFRLElBQUksTUFBTSxJQUFJLEVBQUUsQ0FBQztJQUNwRCxDQUFDO0lBVUQsT0FBTyxDQUFVO0lBR2pCLE9BQU8sQ0FBVTtJQUlqQixRQUFRLENBQVc7SUFJbkIsSUFBSSxNQUFNO1FBQ1IsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ3RCLENBQUM7SUFzQkQsS0FBSyxDQUFJO0lBRVQsWUFDRSxHQUFvQixFQUNwQixh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cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTgtMjAyMiB0aGUgb2FrIGF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuIE1JVCBsaWNlbnNlLlxuXG5pbXBvcnQgdHlwZSB7IEFwcGxpY2F0aW9uLCBTdGF0ZSB9IGZyb20gXCIuL2FwcGxpY2F0aW9uLnRzXCI7XG5pbXBvcnQgeyBDb29raWVzIH0gZnJvbSBcIi4vY29va2llcy50c1wiO1xuaW1wb3J0IHsgY3JlYXRlSHR0cEVycm9yIH0gZnJvbSBcIi4vaHR0cEVycm9yLnRzXCI7XG5pbXBvcnQgdHlwZSB7IEtleVN0YWNrIH0gZnJvbSBcIi4va2V5U3RhY2sudHNcIjtcbmltcG9ydCB7IFJlcXVlc3QgfSBmcm9tIFwiLi9yZXF1ZXN0LnRzXCI7XG5pbXBvcnQgeyBSZXNwb25zZSB9IGZyb20gXCIuL3Jlc3BvbnNlLnRzXCI7XG5pbXBvcnQgeyBzZW5kLCBTZW5kT3B0aW9ucyB9IGZyb20gXCIuL3NlbmQudHNcIjtcbmltcG9ydCB7XG4gIFNlcnZlclNlbnRFdmVudFRhcmdldE9wdGlvbnMsXG4gIFNTRVN0cmVhbVRhcmdldCxcbn0gZnJvbSBcIi4vc2VydmVyX3NlbnRfZXZlbnQudHNcIjtcbmltcG9ydCB0eXBlIHsgU2VydmVyU2VudEV2ZW50VGFyZ2V0IH0gZnJvbSBcIi4vc2VydmVyX3NlbnRfZXZlbnQudHNcIjtcbmltcG9ydCB0eXBlIHtcbiAgRXJyb3JTdGF0dXMsXG4gIFNlcnZlclJlcXVlc3QsXG4gIFVwZ3JhZGVXZWJTb2NrZXRPcHRpb25zLFxufSBmcm9tIFwiLi90eXBlcy5kLnRzXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29udGV4dFNlbmRPcHRpb25zIGV4dGVuZHMgU2VuZE9wdGlvbnMge1xuICAvKiogVGhlIGZpbGVuYW1lIHRvIHNlbmQsIHdoaWNoIHdpbGwgYmUgcmVzb2x2ZWQgYmFzZWQgb24gdGhlIG90aGVyIG9wdGlvbnMuXG4gICAqIElmIHRoaXMgcHJvcGVydHkgaXMgb21pdHRlZCwgdGhlIGN1cnJlbnQgY29udGV4dCdzIGAucmVxdWVzdC51cmwucGF0aG5hbWVgXG4gICAqIHdpbGwgYmUgdXNlZC4gKi9cbiAgcGF0aD86IHN0cmluZztcbn1cblxuLyoqIFByb3ZpZGVzIGNvbnRleHQgYWJvdXQgdGhlIGN1cnJlbnQgcmVxdWVzdCBhbmQgcmVzcG9uc2UgdG8gbWlkZGxld2FyZVxuICogZnVuY3Rpb25zLCBhbmQgdGhlIGN1cnJlbnQgaW5zdGFuY2UgYmVpbmcgcHJvY2Vzc2VkIGlzIHRoZSBmaXJzdCBhcmd1bWVudFxuICogcHJvdmlkZWQgYSB7QGxpbmtjb2RlIE1pZGRsZXdhcmV9IGZ1bmN0aW9uLlxuICpcbiAqIF9UeXBpY2FsbHkgdGhpcyBpcyBvbmx5IHVzZWQgYXMgYSB0eXBlIGFubm90YXRpb24gYW5kIHNob3VsZG4ndCBiZVxuICogY29uc3RydWN0ZWQgZGlyZWN0bHkuX1xuICpcbiAqICMjIyBFeGFtcGxlXG4gKlxuICogYGBgdHNcbiAqIGltcG9ydCB7IEFwcGxpY2F0aW9uLCBDb250ZXh0IH0gZnJvbSBcImh0dHBzOi8vZGVuby5sYW5kL3gvb2FrL21vZC50c1wiO1xuICpcbiAqIGNvbnN0IGFwcCA9IG5ldyBBcHBsaWNhdGlvbigpO1xuICpcbiAqIGFwcC51c2UoKGN0eCkgPT4ge1xuICogICAvLyBpbmZvcm1hdGlvbiBhYm91dCB0aGUgcmVxdWVzdCBpcyBoZXJlOlxuICogICBjdHgucmVxdWVzdDtcbiAqICAgLy8gaW5mb3JtYXRpb24gYWJvdXQgdGhlIHJlc3BvbnNlIGlzIGhlcmU6XG4gKiAgIGN0eC5yZXNwb25zZTtcbiAqICAgLy8gdGhlIGNvb2tpZSBzdG9yZSBpcyBoZXJlOlxuICogICBjdHguY29va2llcztcbiAqIH0pO1xuICpcbiAqIC8vIE5lZWRzIGEgdHlwZSBhbm5vdGF0aW9uIGJlY2F1c2UgaXQgY2Fubm90IGJlIGluZmVycmVkLlxuICogZnVuY3Rpb24gbXcoY3R4OiBDb250ZXh0KSB7XG4gKiAgIC8vIHByb2Nlc3MgaGVyZS4uLlxuICogfVxuICpcbiAqIGFwcC51c2UobXcpO1xuICogYGBgXG4gKlxuICogQHRlbXBsYXRlIFMgdGhlIHN0YXRlIHdoaWNoIGV4dGVuZHMgdGhlIGFwcGxpY2F0aW9uIHN0YXRlIChgQVNgKVxuICogQHRlbXBsYXRlIEFTIHRoZSB0eXBlIG9mIHRoZSBzdGF0ZSBkZXJpdmVkIGZyb20gdGhlIGFwcGxpY2F0aW9uXG4gKi9cbmV4cG9ydCBjbGFzcyBDb250ZXh0PFxuICBTIGV4dGVuZHMgQVMgPSBTdGF0ZSxcbiAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgQVMgZXh0ZW5kcyBTdGF0ZSA9IFJlY29yZDxzdHJpbmcsIGFueT4sXG4+IHtcbiAgI3NvY2tldD86IFdlYlNvY2tldDtcbiAgI3NzZT86IFNlcnZlclNlbnRFdmVudFRhcmdldDtcblxuICAvKiogQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnQgYXBwbGljYXRpb24uICovXG4gIGFwcDogQXBwbGljYXRpb248QVM+O1xuXG4gIC8qKiBBbiBvYmplY3Qgd2hpY2ggYWxsb3dzIGFjY2VzcyB0byBjb29raWVzLCBtZWRpYXRpbmcgYm90aCB0aGUgcmVxdWVzdCBhbmRcbiAgICogcmVzcG9uc2UuICovXG4gIGNvb2tpZXM6IENvb2tpZXM7XG5cbiAgLyoqIElzIGB0cnVlYCBpZiB0aGUgY3VycmVudCBjb25uZWN0aW9uIGlzIHVwZ3JhZGVhYmxlIHRvIGEgd2ViIHNvY2tldC5cbiAgICogT3RoZXJ3aXNlIHRoZSB2YWx1ZSBpcyBgZmFsc2VgLiAgVXNlIGAudXBncmFkZSgpYCB0byB1cGdyYWRlIHRoZSBjb25uZWN0aW9uXG4gICAqIGFuZCByZXR1cm4gdGhlIHdlYiBzb2NrZXQuICovXG4gIGdldCBpc1VwZ3JhZGFibGUoKTogYm9vbGVhbiB7XG4gICAgY29uc3QgdXBncmFkZSA9IHRoaXMucmVxdWVzdC5oZWFkZXJzLmdldChcInVwZ3JhZGVcIik7XG4gICAgaWYgKCF1cGdyYWRlIHx8IHVwZ3JhZGUudG9Mb3dlckNhc2UoKSAhPT0gXCJ3ZWJzb2NrZXRcIikge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBjb25zdCBzZWNLZXkgPSB0aGlzLnJlcXVlc3QuaGVhZGVycy5nZXQoXCJzZWMtd2Vic29ja2V0LWtleVwiKTtcbiAgICByZXR1cm4gdHlwZW9mIHNlY0tleSA9PT0gXCJzdHJpbmdcIiAmJiBzZWNLZXkgIT0gXCJcIjtcbiAgfVxuXG4gIC8qKiBEZXRlcm1pbmVzIGlmIHRoZSByZXF1ZXN0IHNob3VsZCBiZSByZXNwb25kZWQgdG8uICBJZiBgZmFsc2VgIHdoZW4gdGhlXG4gICAqIG1pZGRsZXdhcmUgY29tcGxldGVzIHByb2Nlc3NpbmcsIHRoZSByZXNwb25zZSB3aWxsIG5vdCBiZSBzZW50IGJhY2sgdG8gdGhlXG4gICAqIHJlcXVlc3Rvci4gIFR5cGljYWxseSB0aGlzIGlzIHVzZWQgaWYgdGhlIG1pZGRsZXdhcmUgd2lsbCB0YWtlIG92ZXIgbG93XG4gICAqIGxldmVsIHByb2Nlc3Npbmcgb2YgcmVxdWVzdHMgYW5kIHJlc3BvbnNlcywgZm9yIGV4YW1wbGUgaWYgdXNpbmcgd2ViXG4gICAqIHNvY2tldHMuICBUaGlzIGF1dG9tYXRpY2FsbHkgZ2V0cyBzZXQgdG8gYGZhbHNlYCB3aGVuIHRoZSBjb250ZXh0IGlzXG4gICAqIHVwZ3JhZGVkIHRvIGEgd2ViIHNvY2tldCB2aWEgdGhlIGAudXBncmFkZSgpYCBtZXRob2QuXG4gICAqXG4gICAqIFRoZSBkZWZhdWx0IGlzIGB0cnVlYC4gKi9cbiAgcmVzcG9uZDogYm9vbGVhbjtcblxuICAvKiogQW4gb2JqZWN0IHdoaWNoIGNvbnRhaW5zIGluZm9ybWF0aW9uIGFib3V0IHRoZSBjdXJyZW50IHJlcXVlc3QuICovXG4gIHJlcXVlc3Q6IFJlcXVlc3Q7XG5cbiAgLyoqIEFuIG9iamVjdCB3aGljaCBjb250YWlucyBpbmZvcm1hdGlvbiBhYm91dCB0aGUgcmVzcG9uc2UgdGhhdCB3aWxsIGJlIHNlbnRcbiAgICogd2hlbiB0aGUgbWlkZGxld2FyZSBmaW5pc2hlcyBwcm9jZXNzaW5nLiAqL1xuICByZXNwb25zZTogUmVzcG9uc2U7XG5cbiAgLyoqIElmIHRoZSB0aGUgY3VycmVudCBjb250ZXh0IGhhcyBiZWVuIHVwZ3JhZGVkLCB0aGVuIHRoaXMgd2lsbCBiZSBzZXQgdG9cbiAgICogd2l0aCB0aGUgY3VycmVudCB3ZWIgc29ja2V0LCBvdGhlcndpc2UgaXQgaXMgYHVuZGVmaW5lZGAuICovXG4gIGdldCBzb2NrZXQoKTogV2ViU29ja2V0IHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy4jc29ja2V0O1xuICB9XG5cbiAgLyoqIFRoZSBvYmplY3QgdG8gcGFzcyBzdGF0ZSB0byBmcm9udC1lbmQgdmlld3MuICBUaGlzIGNhbiBiZSB0eXBlZCBieVxuICAgKiBzdXBwbHlpbmcgdGhlIGdlbmVyaWMgc3RhdGUgYXJndW1lbnQgd2hlbiBjcmVhdGluZyBhIG5ldyBhcHAuICBGb3JcbiAgICogZXhhbXBsZTpcbiAgICpcbiAgICogYGBgdHNcbiAgICogY29uc3QgYXBwID0gbmV3IEFwcGxpY2F0aW9uPHsgZm9vOiBzdHJpbmcgfT4oKTtcbiAgICogYGBgXG4gICAqXG4gICAqIE9yIGNhbiBiZSBjb250ZXh0dWFsbHkgaW5mZXJyZWQgYmFzZWQgb24gc2V0dGluZyBhbiBpbml0aWFsIHN0YXRlIG9iamVjdDpcbiAgICpcbiAgICogYGBgdHNcbiAgICogY29uc3QgYXBwID0gbmV3IEFwcGxpY2F0aW9uKHsgc3RhdGU6IHsgZm9vOiBcImJhclwiIH0gfSk7XG4gICAqIGBgYFxuICAgKlxuICAgKiBPbiBlYWNoIHJlcXVlc3QvcmVzcG9uc2UgY3ljbGUsIHRoZSBjb250ZXh0J3Mgc3RhdGUgaXMgY2xvbmVkIGZyb20gdGhlXG4gICAqIGFwcGxpY2F0aW9uIHN0YXRlLiBUaGlzIG1lYW5zIGNoYW5nZXMgdG8gdGhlIGNvbnRleHQncyBgLnN0YXRlYCB3aWxsIGJlXG4gICAqIGRyb3BwZWQgd2hlbiB0aGUgcmVxdWVzdCBkcm9wcywgYnV0IFwiZGVmYXVsdHNcIiBjYW4gYmUgYXBwbGllZCB0byB0aGVcbiAgICogYXBwbGljYXRpb24ncyBzdGF0ZS4gIENoYW5nZXMgdG8gdGhlIGFwcGxpY2F0aW9uJ3Mgc3RhdGUgdGhvdWdoIHdvbid0IGJlXG4gICAqIHJlZmxlY3RlZCB1bnRpbCB0aGUgbmV4dCByZXF1ZXN0IGluIHRoZSBjb250ZXh0J3Mgc3RhdGUuXG4gICAqL1xuICBzdGF0ZTogUztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBhcHA6IEFwcGxpY2F0aW9uPEFTPixcbiAgICBzZXJ2ZXJSZXF1ZXN0OiBTZXJ2ZXJSZXF1ZXN0LFxuICAgIHN0YXRlOiBTLFxuICAgIHNlY3VyZSA9IGZhbHNlLFxuICApIHtcbiAgICB0aGlzLmFwcCA9IGFwcDtcbiAgICB0aGlzLnN0YXRlID0gc3RhdGU7XG4gICAgdGhpcy5yZXF1ZXN0ID0gbmV3IFJlcXVlc3Qoc2VydmVyUmVxdWVzdCwgYXBwLnByb3h5LCBzZWN1cmUpO1xuICAgIHRoaXMucmVzcG9uZCA9IHRydWU7XG4gICAgdGhpcy5yZXNwb25zZSA9IG5ldyBSZXNwb25zZSh0aGlzLnJlcXVlc3QpO1xuICAgIHRoaXMuY29va2llcyA9IG5ldyBDb29raWVzKHRoaXMucmVxdWVzdCwgdGhpcy5yZXNwb25zZSwge1xuICAgICAga2V5czogdGhpcy5hcHAua2V5cyBhcyBLZXlTdGFjayB8IHVuZGVmaW5lZCxcbiAgICAgIHNlY3VyZTogdGhpcy5yZXF1ZXN0LnNlY3VyZSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKiBBc3NlcnRzIHRoZSBjb25kaXRpb24gYW5kIGlmIHRoZSBjb25kaXRpb24gZmFpbHMsIGNyZWF0ZXMgYW4gSFRUUCBlcnJvclxuICAgKiB3aXRoIHRoZSBwcm92aWRlZCBzdGF0dXMgKHdoaWNoIGRlZmF1bHRzIHRvIGA1MDBgKS4gIFRoZSBlcnJvciBzdGF0dXMgYnlcbiAgICogZGVmYXVsdCB3aWxsIGJlIHNldCBvbiB0aGUgYC5yZXNwb25zZS5zdGF0dXNgLlxuICAgKlxuICAgKiBCZWNhdXNlIG9mIGxpbWl0YXRpb24gb2YgVHlwZVNjcmlwdCwgYW55IGFzc2VydGlvbiB0eXBlIGZ1bmN0aW9uIHJlcXVpcmVzXG4gICAqIHNwZWNpZmljIHR5cGUgYW5ub3RhdGlvbnMsIHNvIHRoZSB7QGxpbmtjb2RlIENvbnRleHR9IHR5cGUgc2hvdWxkIGJlIHVzZWRcbiAgICogZXZlbiBpZiBpdCBjYW4gYmUgaW5mZXJyZWQgZnJvbSB0aGUgY29udGV4dC5cbiAgICpcbiAgICogIyMjIEV4YW1wbGVcbiAgICpcbiAgICogYGBgdHNcbiAgICogaW1wb3J0IHsgQ29udGV4dCwgU3RhdHVzIH0gZnJvbSBcImh0dHBzOi8vZGVuby5sYW5kL3gvb2FrL21vZC50c1wiO1xuICAgKlxuICAgKiBleHBvcnQgZnVuY3Rpb24gbXcoY3R4OiBDb250ZXh0KSB7XG4gICAqICAgY29uc3QgYm9keSA9IGN0eC5yZXF1ZXN0LmJvZHkoKTtcbiAgICogICBjdHguYXNzZXJ0KGJvZHkudHlwZSA9PT0gXCJqc29uXCIsIFN0YXR1cy5Ob3RBY2NlcHRhYmxlKTtcbiAgICogICAvLyBwcm9jZXNzIHRoZSBib2R5IGFuZCBzZW5kIGEgcmVzcG9uc2UuLi5cbiAgICogfVxuICAgKiBgYGBcbiAgICovXG4gIGFzc2VydChcbiAgICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICAgIGNvbmRpdGlvbjogYW55LFxuICAgIGVycm9yU3RhdHVzOiBFcnJvclN0YXR1cyA9IDUwMCxcbiAgICBtZXNzYWdlPzogc3RyaW5nLFxuICAgIHByb3BzPzogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gICk6IGFzc2VydHMgY29uZGl0aW9uIHtcbiAgICBpZiAoY29uZGl0aW9uKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGVyciA9IGNyZWF0ZUh0dHBFcnJvcihlcnJvclN0YXR1cywgbWVzc2FnZSk7XG4gICAgaWYgKHByb3BzKSB7XG4gICAgICBPYmplY3QuYXNzaWduKGVyciwgcHJvcHMpO1xuICAgIH1cbiAgICB0aHJvdyBlcnI7XG4gIH1cblxuICAvKiogQXN5bmNocm9ub3VzbHkgZnVsZmlsbCBhIHJlc3BvbnNlIHdpdGggYSBmaWxlIGZyb20gdGhlIGxvY2FsIGZpbGVcbiAgICogc3lzdGVtLlxuICAgKlxuICAgKiBJZiB0aGUgYG9wdGlvbnMucGF0aGAgaXMgbm90IHN1cHBsaWVkLCB0aGUgZmlsZSB0byBiZSBzZW50IHdpbGwgZGVmYXVsdFxuICAgKiB0byB0aGlzIGAucmVxdWVzdC51cmwucGF0aG5hbWVgLlxuICAgKlxuICAgKiBSZXF1aXJlcyBEZW5vIHJlYWQgcGVybWlzc2lvbi4gKi9cbiAgc2VuZChvcHRpb25zOiBDb250ZXh0U2VuZE9wdGlvbnMpOiBQcm9taXNlPHN0cmluZyB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IHsgcGF0aCA9IHRoaXMucmVxdWVzdC51cmwucGF0aG5hbWUsIC4uLnNlbmRPcHRpb25zIH0gPSBvcHRpb25zO1xuICAgIHJldHVybiBzZW5kKHRoaXMsIHBhdGgsIHNlbmRPcHRpb25zKTtcbiAgfVxuXG4gIC8qKiBDb252ZXJ0IHRoZSBjb25uZWN0aW9uIHRvIHN0cmVhbSBldmVudHMsIHJldHVybmluZyBhbiBldmVudCB0YXJnZXQgZm9yXG4gICAqIHNlbmRpbmcgc2VydmVyIHNlbnQgZXZlbnRzLiAgRXZlbnRzIGRpc3BhdGNoZWQgb24gdGhlIHJldHVybmVkIHRhcmdldCB3aWxsXG4gICAqIGJlIHNlbnQgdG8gdGhlIGNsaWVudCBhbmQgYmUgYXZhaWxhYmxlIGluIHRoZSBjbGllbnQncyBgRXZlbnRTb3VyY2VgIHRoYXRcbiAgICogaW5pdGlhdGVkIHRoZSBjb25uZWN0aW9uLlxuICAgKlxuICAgKiBUaGlzIHdpbGwgc2V0IGAucmVzcG9uZGAgdG8gYGZhbHNlYC4gKi9cbiAgc2VuZEV2ZW50cyhvcHRpb25zPzogU2VydmVyU2VudEV2ZW50VGFyZ2V0T3B0aW9ucyk6IFNlcnZlclNlbnRFdmVudFRhcmdldCB7XG4gICAgaWYgKCF0aGlzLiNzc2UpIHtcbiAgICAgIHRoaXMuI3NzZSA9IG5ldyBTU0VTdHJlYW1UYXJnZXQodGhpcywgb3B0aW9ucyk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLiNzc2U7XG4gIH1cblxuICAvKiogQ3JlYXRlIGFuZCB0aHJvdyBhbiBIVFRQIEVycm9yLCB3aGljaCBjYW4gYmUgdXNlZCB0byBwYXNzIHN0YXR1c1xuICAgKiBpbmZvcm1hdGlvbiB3aGljaCBjYW4gYmUgY2F1Z2h0IGJ5IG90aGVyIG1pZGRsZXdhcmUgdG8gc2VuZCBtb3JlXG4gICAqIG1lYW5pbmdmdWwgZXJyb3IgbWVzc2FnZXMgYmFjayB0byB0aGUgY2xpZW50LiAgVGhlIHBhc3NlZCBlcnJvciBzdGF0dXMgd2lsbFxuICAgKiBiZSBzZXQgb24gdGhlIGAucmVzcG9uc2Uuc3RhdHVzYCBieSBkZWZhdWx0IGFzIHdlbGwuXG4gICAqL1xuICB0aHJvdyhcbiAgICBlcnJvclN0YXR1czogRXJyb3JTdGF0dXMsXG4gICAgbWVzc2FnZT86IHN0cmluZyxcbiAgICBwcm9wcz86IFJlY29yZDxzdHJpbmcsIHVua25vd24+LFxuICApOiBuZXZlciB7XG4gICAgY29uc3QgZXJyID0gY3JlYXRlSHR0cEVycm9yKGVycm9yU3RhdHVzLCBtZXNzYWdlKTtcbiAgICBpZiAocHJvcHMpIHtcbiAgICAgIE9iamVjdC5hc3NpZ24oZXJyLCBwcm9wcyk7XG4gICAgfVxuICAgIHRocm93IGVycjtcbiAgfVxuXG4gIC8qKiBUYWtlIHRoZSBjdXJyZW50IHJlcXVlc3QgYW5kIHVwZ3JhZGUgaXQgdG8gYSB3ZWIgc29ja2V0LCByZXNvbHZpbmcgd2l0aFxuICAgKiB0aGUgYSB3ZWIgc3RhbmRhcmQgYFdlYlNvY2tldGAgb2JqZWN0LiBUaGlzIHdpbGwgc2V0IGAucmVzcG9uZGAgdG9cbiAgICogYGZhbHNlYC4gIElmIHRoZSBzb2NrZXQgY2Fubm90IGJlIHVwZ3JhZGVkLCB0aGlzIG1ldGhvZCB3aWxsIHRocm93LiAqL1xuICB1cGdyYWRlKG9wdGlvbnM/OiBVcGdyYWRlV2ViU29ja2V0T3B0aW9ucyk6IFdlYlNvY2tldCB7XG4gICAgaWYgKHRoaXMuI3NvY2tldCkge1xuICAgICAgcmV0dXJuIHRoaXMuI3NvY2tldDtcbiAgICB9XG4gICAgaWYgKCF0aGlzLnJlcXVlc3Qub3JpZ2luYWxSZXF1ZXN0LnVwZ3JhZGUpIHtcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXG4gICAgICAgIFwiV2ViIHNvY2tldCB1cGdyYWRlcyBub3QgY3VycmVudGx5IHN1cHBvcnRlZCBmb3IgdGhpcyB0eXBlIG9mIHNlcnZlci5cIixcbiAgICAgICk7XG4gICAgfVxuICAgIHRoaXMuI3NvY2tldCA9IHRoaXMucmVxdWVzdC5vcmlnaW5hbFJlcXVlc3QudXBncmFkZShvcHRpb25zKTtcbiAgICB0aGlzLnJlc3BvbmQgPSBmYWxzZTtcbiAgICByZXR1cm4gdGhpcy4jc29ja2V0O1xuICB9XG5cbiAgW1N5bWJvbC5mb3IoXCJEZW5vLmN1c3RvbUluc3BlY3RcIildKGluc3BlY3Q6ICh2YWx1ZTogdW5rbm93bikgPT4gc3RyaW5nKSB7XG4gICAgY29uc3Qge1xuICAgICAgYXBwLFxuICAgICAgY29va2llcyxcbiAgICAgIGlzVXBncmFkYWJsZSxcbiAgICAgIHJlc3BvbmQsXG4gICAgICByZXF1ZXN0LFxuICAgICAgcmVzcG9uc2UsXG4gICAgICBzb2NrZXQsXG4gICAgICBzdGF0ZSxcbiAgICB9ID0gdGhpcztcbiAgICByZXR1cm4gYCR7dGhpcy5jb25zdHJ1Y3Rvci5uYW1lfSAke1xuICAgICAgaW5zcGVjdCh7XG4gICAgICAgIGFwcCxcbiAgICAgICAgY29va2llcyxcbiAgICAgICAgaXNVcGdyYWRhYmxlLFxuICAgICAgICByZXNwb25kLFxuICAgICAgICByZXF1ZXN0LFxuICAgICAgICByZXNwb25zZSxcbiAgICAgICAgc29ja2V0LFxuICAgICAgICBzdGF0ZSxcbiAgICAgIH0pXG4gICAgfWA7XG4gIH1cblxuICBbU3ltYm9sLmZvcihcIm5vZGVqcy51dGlsLmluc3BlY3QuY3VzdG9tXCIpXShcbiAgICBkZXB0aDogbnVtYmVyLFxuICAgIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gICAgb3B0aW9uczogYW55LFxuICAgIGluc3BlY3Q6ICh2YWx1ZTogdW5rbm93biwgb3B0aW9ucz86IHVua25vd24pID0+IHN0cmluZyxcbiAgKSB7XG4gICAgaWYgKGRlcHRoIDwgMCkge1xuICAgICAgcmV0dXJuIG9wdGlvbnMuc3R5bGl6ZShgWyR7dGhpcy5jb25zdHJ1Y3Rvci5uYW1lfV1gLCBcInNwZWNpYWxcIik7XG4gICAgfVxuXG4gICAgY29uc3QgbmV3T3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMsIHtcbiAgICAgIGRlcHRoOiBvcHRpb25zLmRlcHRoID09PSBudWxsID8gbnVsbCA6IG9wdGlvbnMuZGVwdGggLSAxLFxuICAgIH0pO1xuICAgIGNvbnN0IHtcbiAgICAgIGFwcCxcbiAgICAgIGNvb2tpZXMsXG4gICAgICBpc1VwZ3JhZGFibGUsXG4gICAgICByZXNwb25kLFxuICAgICAgcmVxdWVzdCxcbiAgICAgIHJlc3BvbnNlLFxuICAgICAgc29ja2V0LFxuICAgICAgc3RhdGUsXG4gICAgfSA9IHRoaXM7XG4gICAgcmV0dXJuIGAke29wdGlvbnMuc3R5bGl6ZSh0aGlzLmNvbnN0cnVjdG9yLm5hbWUsIFwic3BlY2lhbFwiKX0gJHtcbiAgICAgIGluc3BlY3Qoe1xuICAgICAgICBhcHAsXG4gICAgICAgIGNvb2tpZXMsXG4gICAgICAgIGlzVXBncmFkYWJsZSxcbiAgICAgICAgcmVzcG9uZCxcbiAgICAgICAgcmVxdWVzdCxcbiAgICAgICAgcmVzcG9uc2UsXG4gICAgICAgIHNvY2tldCxcbiAgICAgICAgc3RhdGUsXG4gICAgICB9LCBuZXdPcHRpb25zKVxuICAgIH1gO1xuICB9XG59XG4iXX0=