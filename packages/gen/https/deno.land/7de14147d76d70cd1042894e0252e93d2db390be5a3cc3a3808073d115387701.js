import { RequestBody } from "./body.ts";
import { preferredCharsets } from "./negotiation/charset.ts";
import { preferredEncodings } from "./negotiation/encoding.ts";
import { preferredLanguages } from "./negotiation/language.ts";
import { preferredMediaTypes } from "./negotiation/mediaType.ts";
export class Request {
    #body;
    #proxy;
    #secure;
    #serverRequest;
    #url;
    #getRemoteAddr() {
        return this.#serverRequest.remoteAddr ?? "";
    }
    get hasBody() {
        return this.#body.has();
    }
    get headers() {
        return this.#serverRequest.headers;
    }
    get ip() {
        return (this.#proxy ? this.ips[0] : this.#getRemoteAddr()) ?? "";
    }
    get ips() {
        return this.#proxy
            ? (this.#serverRequest.headers.get("x-forwarded-for") ??
                this.#getRemoteAddr()).split(/\s*,\s*/)
            : [];
    }
    get method() {
        return this.#serverRequest.method;
    }
    get secure() {
        return this.#secure;
    }
    get originalRequest() {
        return this.#serverRequest;
    }
    get url() {
        if (!this.#url) {
            const serverRequest = this.#serverRequest;
            if (!this.#proxy) {
                try {
                    if (serverRequest.rawUrl) {
                        this.#url = new URL(serverRequest.rawUrl);
                        return this.#url;
                    }
                }
                catch {
                }
            }
            let proto;
            let host;
            if (this.#proxy) {
                proto = serverRequest
                    .headers.get("x-forwarded-proto")?.split(/\s*,\s*/, 1)[0] ??
                    "http";
                host = serverRequest.headers.get("x-forwarded-host") ??
                    serverRequest.headers.get("host") ?? "";
            }
            else {
                proto = this.#secure ? "https" : "http";
                host = serverRequest.headers.get("host") ?? "";
            }
            try {
                this.#url = new URL(`${proto}://${host}${serverRequest.url}`);
            }
            catch {
                throw new TypeError(`The server request URL of "${proto}://${host}${serverRequest.url}" is invalid.`);
            }
        }
        return this.#url;
    }
    constructor(serverRequest, proxy = false, secure = false) {
        this.#proxy = proxy;
        this.#secure = secure;
        this.#serverRequest = serverRequest;
        this.#body = new RequestBody(serverRequest.getBody(), serverRequest.headers);
    }
    accepts(...types) {
        const acceptValue = this.#serverRequest.headers.get("Accept");
        if (!acceptValue) {
            return types.length ? types[0] : ["*/*"];
        }
        if (types.length) {
            return preferredMediaTypes(acceptValue, types)[0];
        }
        return preferredMediaTypes(acceptValue);
    }
    acceptsCharsets(...charsets) {
        const acceptCharsetValue = this.#serverRequest.headers.get("Accept-Charset");
        if (!acceptCharsetValue) {
            return charsets.length ? charsets[0] : ["*"];
        }
        if (charsets.length) {
            return preferredCharsets(acceptCharsetValue, charsets)[0];
        }
        return preferredCharsets(acceptCharsetValue);
    }
    acceptsEncodings(...encodings) {
        const acceptEncodingValue = this.#serverRequest.headers.get("Accept-Encoding");
        if (!acceptEncodingValue) {
            return encodings.length ? encodings[0] : ["*"];
        }
        if (encodings.length) {
            return preferredEncodings(acceptEncodingValue, encodings)[0];
        }
        return preferredEncodings(acceptEncodingValue);
    }
    acceptsLanguages(...langs) {
        const acceptLanguageValue = this.#serverRequest.headers.get("Accept-Language");
        if (!acceptLanguageValue) {
            return langs.length ? langs[0] : ["*"];
        }
        if (langs.length) {
            return preferredLanguages(acceptLanguageValue, langs)[0];
        }
        return preferredLanguages(acceptLanguageValue);
    }
    body(options = {}) {
        return this.#body.get(options);
    }
    [Symbol.for("Deno.customInspect")](inspect) {
        const { hasBody, headers, ip, ips, method, secure, url } = this;
        return `${this.constructor.name} ${inspect({
            hasBody,
            headers,
            ip,
            ips,
            method,
            secure,
            url: url.toString(),
        })}`;
    }
    [Symbol.for("nodejs.util.inspect.custom")](depth, options, inspect) {
        if (depth < 0) {
            return options.stylize(`[${this.constructor.name}]`, "special");
        }
        const newOptions = Object.assign({}, options, {
            depth: options.depth === null ? null : options.depth - 1,
        });
        const { hasBody, headers, ip, ips, method, secure, url } = this;
        return `${options.stylize(this.constructor.name, "special")} ${inspect({ hasBody, headers, ip, ips, method, secure, url }, newOptions)}`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVxdWVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInJlcXVlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBYUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUV4QyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQVVqRSxNQUFNLE9BQU8sT0FBTztJQUNsQixLQUFLLENBQWM7SUFDbkIsTUFBTSxDQUFVO0lBQ2hCLE9BQU8sQ0FBVTtJQUNqQixjQUFjLENBQWdCO0lBQzlCLElBQUksQ0FBTztJQUVYLGNBQWM7UUFDWixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsVUFBVSxJQUFJLEVBQUUsQ0FBQztJQUM5QyxDQUFDO0lBVUQsSUFBSSxPQUFPO1FBQ1QsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFHRCxJQUFJLE9BQU87UUFDVCxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDO0lBQ3JDLENBQUM7SUFLRCxJQUFJLEVBQUU7UUFDSixPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ25FLENBQUM7SUFLRCxJQUFJLEdBQUc7UUFDTCxPQUFPLElBQUksQ0FBQyxNQUFNO1lBQ2hCLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQztnQkFD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QUFDLENBQUMsQ0FDeEMsS0FBYSxFQUViLE9BQVksRUFDWixPQUFzRDtRQUV0RCxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUU7WUFDYixPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksR0FBRyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1NBQ2pFO1FBRUQsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsT0FBTyxFQUFFO1lBQzVDLEtBQUssRUFBRSxPQUFPLENBQUMsS0FBSyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxHQUFHLENBQUM7U0FDekQsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQztRQUNoRSxPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsSUFDekQsT0FBTyxDQUNMLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLEVBQ2xELFVBQVUsQ0FFZCxFQUFFLENBQUM7SUFDTCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDIyIHRoZSBvYWsgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4gTUlUIGxpY2Vuc2UuXG5cbmltcG9ydCB0eXBlIHtcbiAgQm9keSxcbiAgQm9keUJ5dGVzLFxuICBCb2R5Rm9ybSxcbiAgQm9keUZvcm1EYXRhLFxuICBCb2R5SnNvbixcbiAgQm9keU9wdGlvbnMsXG4gIEJvZHlSZWFkZXIsXG4gIEJvZHlTdHJlYW0sXG4gIEJvZHlUZXh0LFxufSBmcm9tIFwiLi9ib2R5LnRzXCI7XG5pbXBvcnQgeyBSZXF1ZXN0Qm9keSB9IGZyb20gXCIuL2JvZHkudHNcIjtcbmltcG9ydCB0eXBlIHsgSFRUUE1ldGhvZHMsIFNlcnZlclJlcXVlc3QgfSBmcm9tIFwiLi90eXBlcy5kLnRzXCI7XG5pbXBvcnQgeyBwcmVmZXJyZWRDaGFyc2V0cyB9IGZyb20gXCIuL25lZ290aWF0aW9uL2NoYXJzZXQudHNcIjtcbmltcG9ydCB7IHByZWZlcnJlZEVuY29kaW5ncyB9IGZyb20gXCIuL25lZ290aWF0aW9uL2VuY29kaW5nLnRzXCI7XG5pbXBvcnQgeyBwcmVmZXJyZWRMYW5ndWFnZXMgfSBmcm9tIFwiLi9uZWdvdGlhdGlvbi9sYW5ndWFnZS50c1wiO1xuaW1wb3J0IHsgcHJlZmVycmVkTWVkaWFUeXBlcyB9IGZyb20gXCIuL25lZ290aWF0aW9uL21lZGlhVHlwZS50c1wiO1xuXG4vKiogQW4gaW50ZXJmYWNlIHdoaWNoIHByb3ZpZGVzIGluZm9ybWF0aW9uIGFib3V0IHRoZSBjdXJyZW50IHJlcXVlc3QuIFRoZVxuICogaW5zdGFuY2UgcmVsYXRlZCB0byB0aGUgY3VycmVudCByZXF1ZXN0IGlzIGF2YWlsYWJsZSBvbiB0aGVcbiAqIHtAbGlua2NvZGUgQ29udGV4dH0ncyBgLnJlcXVlc3RgIHByb3BlcnR5LlxuICpcbiAqIFRoZSBpbnRlcmZhY2UgY29udGFpbnMgc2V2ZXJhbCBwcm9wZXJ0aWVzIHRvIGdldCBpbmZvcm1hdGlvbiBhYm91dCB0aGVcbiAqIHJlcXVlc3QgYXMgd2VsbCBhcyBzZXZlcmFsIG1ldGhvZHMsIHdoaWNoIGluY2x1ZGUgY29udGVudCBuZWdvdGlhdGlvbiBhbmRcbiAqIHRoZSBhYmlsaXR5IHRvIGRlY29kZSBhIHJlcXVlc3QgYm9keS5cbiAqL1xuZXhwb3J0IGNsYXNzIFJlcXVlc3Qge1xuICAjYm9keTogUmVxdWVzdEJvZHk7XG4gICNwcm94eTogYm9vbGVhbjtcbiAgI3NlY3VyZTogYm9vbGVhbjtcbiAgI3NlcnZlclJlcXVlc3Q6IFNlcnZlclJlcXVlc3Q7XG4gICN1cmw/OiBVUkw7XG5cbiAgI2dldFJlbW90ZUFkZHIoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy4jc2VydmVyUmVxdWVzdC5yZW1vdGVBZGRyID8/IFwiXCI7XG4gIH1cblxuICAvKiogSXMgYHRydWVgIGlmIHRoZSByZXF1ZXN0IG1pZ2h0IGhhdmUgYSBib2R5LCBvdGhlcndpc2UgYGZhbHNlYC5cbiAgICpcbiAgICogKipXQVJOSU5HKiogdGhpcyBpcyBhbiB1bnJlbGlhYmxlIEFQSS4gSW4gSFRUUC8yIGluIG1hbnkgc2l0dWF0aW9ucyB5b3VcbiAgICogY2Fubm90IGRldGVybWluZSBpZiBhIHJlcXVlc3QgaGFzIGEgYm9keSBvciBub3QgdW5sZXNzIHlvdSBhdHRlbXB0IHRvIHJlYWRcbiAgICogdGhlIGJvZHksIGR1ZSB0byB0aGUgc3RyZWFtaW5nIG5hdHVyZSBvZiBIVFRQLzIuIEFzIG9mIERlbm8gMS4xNi4xLCBmb3JcbiAgICogSFRUUC8xLjEsIERlbm8gYWxzbyByZWZsZWN0cyB0aGF0IGJlaGF2aW91ci4gIFRoZSBvbmx5IHJlbGlhYmxlIHdheSB0b1xuICAgKiBkZXRlcm1pbmUgaWYgYSByZXF1ZXN0IGhhcyBhIGJvZHkgb3Igbm90IGlzIHRvIGF0dGVtcHQgdG8gcmVhZCB0aGUgYm9keS5cbiAgICovXG4gIGdldCBoYXNCb2R5KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLiNib2R5LmhhcygpO1xuICB9XG5cbiAgLyoqIFRoZSBgSGVhZGVyc2Agc3VwcGxpZWQgaW4gdGhlIHJlcXVlc3QuICovXG4gIGdldCBoZWFkZXJzKCk6IEhlYWRlcnMge1xuICAgIHJldHVybiB0aGlzLiNzZXJ2ZXJSZXF1ZXN0LmhlYWRlcnM7XG4gIH1cblxuICAvKiogUmVxdWVzdCByZW1vdGUgYWRkcmVzcy4gV2hlbiB0aGUgYXBwbGljYXRpb24ncyBgLnByb3h5YCBpcyB0cnVlLCB0aGVcbiAgICogYFgtRm9yd2FyZGVkLUZvcmAgd2lsbCBiZSB1c2VkIHRvIGRldGVybWluZSB0aGUgcmVxdWVzdGluZyByZW1vdGUgYWRkcmVzcy5cbiAgICovXG4gIGdldCBpcCgpOiBzdHJpbmcge1xuICAgIHJldHVybiAodGhpcy4jcHJveHkgPyB0aGlzLmlwc1swXSA6IHRoaXMuI2dldFJlbW90ZUFkZHIoKSkgPz8gXCJcIjtcbiAgfVxuXG4gIC8qKiBXaGVuIHRoZSBhcHBsaWNhdGlvbidzIGAucHJveHlgIGlzIGB0cnVlYCwgdGhpcyB3aWxsIGJlIHNldCB0byBhbiBhcnJheSBvZlxuICAgKiBJUHMsIG9yZGVyZWQgZnJvbSB1cHN0cmVhbSB0byBkb3duc3RyZWFtLCBiYXNlZCBvbiB0aGUgdmFsdWUgb2YgdGhlIGhlYWRlclxuICAgKiBgWC1Gb3J3YXJkZWQtRm9yYC4gIFdoZW4gYGZhbHNlYCBhbiBlbXB0eSBhcnJheSBpcyByZXR1cm5lZC4gKi9cbiAgZ2V0IGlwcygpOiBzdHJpbmdbXSB7XG4gICAgcmV0dXJuIHRoaXMuI3Byb3h5XG4gICAgICA/ICh0aGlzLiNzZXJ2ZXJSZXF1ZXN0LmhlYWRlcnMuZ2V0KFwieC1mb3J3YXJkZWQtZm9yXCIpID8/XG4gICAgICAgIHRoaXMuI2dldFJlbW90ZUFkZHIoKSkuc3BsaXQoL1xccyosXFxzKi8pXG4gICAgICA6IFtdO1xuICB9XG5cbiAgLyoqIFRoZSBIVFRQIE1ldGhvZCB1c2VkIGJ5IHRoZSByZXF1ZXN0LiAqL1xuICBnZXQgbWV0aG9kKCk6IEhUVFBNZXRob2RzIHtcbiAgICByZXR1cm4gdGhpcy4jc2VydmVyUmVxdWVzdC5tZXRob2QgYXMgSFRUUE1ldGhvZHM7XG4gIH1cblxuICAvKiogU2hvcnRjdXQgdG8gYHJlcXVlc3QudXJsLnByb3RvY29sID09PSBcImh0dHBzOlwiYC4gKi9cbiAgZ2V0IHNlY3VyZSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy4jc2VjdXJlO1xuICB9XG5cbiAgLyoqIFNldCB0byB0aGUgdmFsdWUgb2YgdGhlIF9vcmlnaW5hbF8gRGVubyBzZXJ2ZXIgcmVxdWVzdC4gKi9cbiAgZ2V0IG9yaWdpbmFsUmVxdWVzdCgpOiBTZXJ2ZXJSZXF1ZXN0IHtcbiAgICByZXR1cm4gdGhpcy4jc2VydmVyUmVxdWVzdDtcbiAgfVxuXG4gIC8qKiBBIHBhcnNlZCBVUkwgZm9yIHRoZSByZXF1ZXN0IHdoaWNoIGNvbXBsaWVzIHdpdGggdGhlIGJyb3dzZXIgc3RhbmRhcmRzLlxuICAgKiBXaGVuIHRoZSBhcHBsaWNhdGlvbidzIGAucHJveHlgIGlzIGB0cnVlYCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGJhc2VkIG9mZiBvZlxuICAgKiB0aGUgYFgtRm9yd2FyZGVkLVByb3RvYCBhbmQgYFgtRm9yd2FyZGVkLUhvc3RgIGhlYWRlciB2YWx1ZXMgaWYgcHJlc2VudCBpblxuICAgKiB0aGUgcmVxdWVzdC4gKi9cbiAgZ2V0IHVybCgpOiBVUkwge1xuICAgIGlmICghdGhpcy4jdXJsKSB7XG4gICAgICBjb25zdCBzZXJ2ZXJSZXF1ZXN0ID0gdGhpcy4jc2VydmVyUmVxdWVzdDtcbiAgICAgIGlmICghdGhpcy4jcHJveHkpIHtcbiAgICAgICAgLy8gYmV0d2VlbiAxLjkuMCBhbmQgMS45LjEgdGhlIHJlcXVlc3QudXJsIG9mIHRoZSBuYXRpdmUgSFRUUCBzdGFydGVkXG4gICAgICAgIC8vIHJldHVybmluZyB0aGUgZnVsbCBVUkwsIHdoZXJlIHByZXZpb3VzbHkgaXQgb25seSByZXR1cm5lZCB0aGUgcGF0aFxuICAgICAgICAvLyBzbyB3ZSB3aWxsIHRyeSB0byB1c2UgdGhhdCBVUkwgaGVyZSwgYnV0IGRlZmF1bHQgYmFjayB0byBvbGQgbG9naWNcbiAgICAgICAgLy8gaWYgdGhlIFVSTCBpc24ndCB2YWxpZC5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBpZiAoc2VydmVyUmVxdWVzdC5yYXdVcmwpIHtcbiAgICAgICAgICAgIHRoaXMuI3VybCA9IG5ldyBVUkwoc2VydmVyUmVxdWVzdC5yYXdVcmwpO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuI3VybDtcbiAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2gge1xuICAgICAgICAgIC8vIHdlIGRvbid0IGNhcmUgYWJvdXQgZXJyb3JzIGhlcmVcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgbGV0IHByb3RvOiBzdHJpbmc7XG4gICAgICBsZXQgaG9zdDogc3RyaW5nO1xuICAgICAgaWYgKHRoaXMuI3Byb3h5KSB7XG4gICAgICAgIHByb3RvID0gc2VydmVyUmVxdWVzdFxuICAgICAgICAgIC5oZWFkZXJzLmdldChcIngtZm9yd2FyZGVkLXByb3RvXCIpPy5zcGxpdCgvXFxzKixcXHMqLywgMSlbMF0gPz9cbiAgICAgICAgICBcImh0dHBcIjtcbiAgICAgICAgaG9zdCA9IHNlcnZlclJlcXVlc3QuaGVhZGVycy5nZXQoXCJ4LWZvcndhcmRlZC1ob3N0XCIpID8/XG4gICAgICAgICAgc2VydmVyUmVxdWVzdC5oZWFkZXJzLmdldChcImhvc3RcIikgPz8gXCJcIjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHByb3RvID0gdGhpcy4jc2VjdXJlID8gXCJodHRwc1wiIDogXCJodHRwXCI7XG4gICAgICAgIGhvc3QgPSBzZXJ2ZXJSZXF1ZXN0LmhlYWRlcnMuZ2V0KFwiaG9zdFwiKSA/PyBcIlwiO1xuICAgICAgfVxuICAgICAgdHJ5IHtcbiAgICAgICAgdGhpcy4jdXJsID0gbmV3IFVSTChgJHtwcm90b306Ly8ke2hvc3R9JHtzZXJ2ZXJSZXF1ZXN0LnVybH1gKTtcbiAgICAgIH0gY2F0Y2gge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFxuICAgICAgICAgIGBUaGUgc2VydmVyIHJlcXVlc3QgVVJMIG9mIFwiJHtwcm90b306Ly8ke2hvc3R9JHtzZXJ2ZXJSZXF1ZXN0LnVybH1cIiBpcyBpbnZhbGlkLmAsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0aGlzLiN1cmw7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihcbiAgICBzZXJ2ZXJSZXF1ZXN0OiBTZXJ2ZXJSZXF1ZXN0LFxuICAgIHByb3h5ID0gZmFsc2UsXG4gICAgc2VjdXJlID0gZmFsc2UsXG4gICkge1xuICAgIHRoaXMuI3Byb3h5ID0gcHJveHk7XG4gICAgdGhpcy4jc2VjdXJlID0gc2VjdXJlO1xuICAgIHRoaXMuI3NlcnZlclJlcXVlc3QgPSBzZXJ2ZXJSZXF1ZXN0O1xuICAgIHRoaXMuI2JvZHkgPSBuZXcgUmVxdWVzdEJvZHkoXG4gICAgICBzZXJ2ZXJSZXF1ZXN0LmdldEJvZHkoKSxcbiAgICAgIHNlcnZlclJlcXVlc3QuaGVhZGVycyxcbiAgICApO1xuICB9XG5cbiAgLyoqIFJldHVybnMgYW4gYXJyYXkgb2YgbWVkaWEgdHlwZXMsIGFjY2VwdGVkIGJ5IHRoZSByZXF1ZXN0b3IsIGluIG9yZGVyIG9mXG4gICAqIHByZWZlcmVuY2UuICBJZiB0aGVyZSBhcmUgbm8gZW5jb2RpbmdzIHN1cHBsaWVkIGJ5IHRoZSByZXF1ZXN0b3IsXG4gICAqIHRoZW4gYWNjZXB0aW5nIGFueSBpcyBpbXBsaWVkIGlzIHJldHVybmVkLlxuICAgKi9cbiAgYWNjZXB0cygpOiBzdHJpbmdbXSB8IHVuZGVmaW5lZDtcbiAgLyoqIEZvciBhIGdpdmVuIHNldCBvZiBtZWRpYSB0eXBlcywgcmV0dXJuIHRoZSBiZXN0IG1hdGNoIGFjY2VwdGVkIGJ5IHRoZVxuICAgKiByZXF1ZXN0b3IuICBJZiB0aGVyZSBhcmUgbm8gZW5jb2RpbmcgdGhhdCBtYXRjaCwgdGhlbiB0aGUgbWV0aG9kIHJldHVybnNcbiAgICogYHVuZGVmaW5lZGAuXG4gICAqL1xuICBhY2NlcHRzKC4uLnR5cGVzOiBzdHJpbmdbXSk6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgYWNjZXB0cyguLi50eXBlczogc3RyaW5nW10pOiBzdHJpbmcgfCBzdHJpbmdbXSB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgYWNjZXB0VmFsdWUgPSB0aGlzLiNzZXJ2ZXJSZXF1ZXN0LmhlYWRlcnMuZ2V0KFwiQWNjZXB0XCIpO1xuICAgIGlmICghYWNjZXB0VmFsdWUpIHtcbiAgICAgIHJldHVybiB0eXBlcy5sZW5ndGggPyB0eXBlc1swXSA6IFtcIiovKlwiXTtcbiAgICB9XG4gICAgaWYgKHR5cGVzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIHByZWZlcnJlZE1lZGlhVHlwZXMoYWNjZXB0VmFsdWUsIHR5cGVzKVswXTtcbiAgICB9XG4gICAgcmV0dXJuIHByZWZlcnJlZE1lZGlhVHlwZXMoYWNjZXB0VmFsdWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBkZXByZWNhdGVkIHRoZSBoZWFkZXIgYmVoaW5kIHRoaXMgaXMgbm8gbG9uZ2VyIHVzZWQgaW4gYnJvd3NlcnNcbiAgICovXG4gIGFjY2VwdHNDaGFyc2V0cygpOiBzdHJpbmdbXSB8IHVuZGVmaW5lZDtcbiAgLyoqXG4gICAqIEBkZXByZWNhdGVkIHRoZSBoZWFkZXIgYmVoaW5kIHRoaXMgaXMgbm8gbG9uZ2VyIHVzZWQgaW4gYnJvd3NlcnNcbiAgICovXG4gIGFjY2VwdHNDaGFyc2V0cyguLi5jaGFyc2V0czogc3RyaW5nW10pOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIC8qKiBAZGVwcmVjYXRlZCB0aGUgaGVhZGVyIGJlaGluZCB0aGlzIGlzIG5vIGxvbmdlciB1c2VkIGluIGJyb3dzZXJzICovXG4gIGFjY2VwdHNDaGFyc2V0cyguLi5jaGFyc2V0czogc3RyaW5nW10pOiBzdHJpbmdbXSB8IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgYWNjZXB0Q2hhcnNldFZhbHVlID0gdGhpcy4jc2VydmVyUmVxdWVzdC5oZWFkZXJzLmdldChcbiAgICAgIFwiQWNjZXB0LUNoYXJzZXRcIixcbiAgICApO1xuICAgIGlmICghYWNjZXB0Q2hhcnNldFZhbHVlKSB7XG4gICAgICByZXR1cm4gY2hhcnNldHMubGVuZ3RoID8gY2hhcnNldHNbMF0gOiBbXCIqXCJdO1xuICAgIH1cbiAgICBpZiAoY2hhcnNldHMubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gcHJlZmVycmVkQ2hhcnNldHMoYWNjZXB0Q2hhcnNldFZhbHVlLCBjaGFyc2V0cylbMF07XG4gICAgfVxuICAgIHJldHVybiBwcmVmZXJyZWRDaGFyc2V0cyhhY2NlcHRDaGFyc2V0VmFsdWUpO1xuICB9XG5cbiAgLyoqIFJldHVybnMgYW4gYXJyYXkgb2YgZW5jb2RpbmdzLCBhY2NlcHRlZCBieSB0aGUgcmVxdWVzdG9yLCBpbiBvcmRlciBvZlxuICAgKiBwcmVmZXJlbmNlLiAgSWYgdGhlcmUgYXJlIG5vIGVuY29kaW5ncyBzdXBwbGllZCBieSB0aGUgcmVxdWVzdG9yLFxuICAgKiB0aGVuIGBbXCIqXCJdYCBpcyByZXR1cm5lZCwgbWF0Y2hpbmcgYW55LlxuICAgKi9cbiAgYWNjZXB0c0VuY29kaW5ncygpOiBzdHJpbmdbXSB8IHVuZGVmaW5lZDtcbiAgLyoqIEZvciBhIGdpdmVuIHNldCBvZiBlbmNvZGluZ3MsIHJldHVybiB0aGUgYmVzdCBtYXRjaCBhY2NlcHRlZCBieSB0aGVcbiAgICogcmVxdWVzdG9yLiAgSWYgdGhlcmUgYXJlIG5vIGVuY29kaW5ncyB0aGF0IG1hdGNoLCB0aGVuIHRoZSBtZXRob2QgcmV0dXJuc1xuICAgKiBgdW5kZWZpbmVkYC5cbiAgICpcbiAgICogKipOT1RFOioqIFlvdSBzaG91bGQgYWx3YXlzIHN1cHBseSBgaWRlbnRpdHlgIGFzIG9uZSBvZiB0aGUgZW5jb2RpbmdzXG4gICAqIHRvIGVuc3VyZSB0aGF0IHRoZXJlIGlzIGEgbWF0Y2ggd2hlbiB0aGUgYEFjY2VwdC1FbmNvZGluZ2AgaGVhZGVyIGlzIHBhcnRcbiAgICogb2YgdGhlIHJlcXVlc3QuXG4gICAqL1xuICBhY2NlcHRzRW5jb2RpbmdzKC4uLmVuY29kaW5nczogc3RyaW5nW10pOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIGFjY2VwdHNFbmNvZGluZ3MoLi4uZW5jb2RpbmdzOiBzdHJpbmdbXSk6IHN0cmluZ1tdIHwgc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBhY2NlcHRFbmNvZGluZ1ZhbHVlID0gdGhpcy4jc2VydmVyUmVxdWVzdC5oZWFkZXJzLmdldChcbiAgICAgIFwiQWNjZXB0LUVuY29kaW5nXCIsXG4gICAgKTtcbiAgICBpZiAoIWFjY2VwdEVuY29kaW5nVmFsdWUpIHtcbiAgICAgIHJldHVybiBlbmNvZGluZ3MubGVuZ3RoID8gZW5jb2RpbmdzWzBdIDogW1wiKlwiXTtcbiAgICB9XG4gICAgaWYgKGVuY29kaW5ncy5sZW5ndGgpIHtcbiAgICAgIHJldHVybiBwcmVmZXJyZWRFbmNvZGluZ3MoYWNjZXB0RW5jb2RpbmdWYWx1ZSwgZW5jb2RpbmdzKVswXTtcbiAgICB9XG4gICAgcmV0dXJuIHByZWZlcnJlZEVuY29kaW5ncyhhY2NlcHRFbmNvZGluZ1ZhbHVlKTtcbiAgfVxuXG4gIC8qKiBSZXR1cm5zIGFuIGFycmF5IG9mIGxhbmd1YWdlcywgYWNjZXB0ZWQgYnkgdGhlIHJlcXVlc3RvciwgaW4gb3JkZXIgb2ZcbiAgICogcHJlZmVyZW5jZS4gIElmIHRoZXJlIGFyZSBubyBsYW5ndWFnZXMgc3VwcGxpZWQgYnkgdGhlIHJlcXVlc3RvcixcbiAgICogYFtcIipcIl1gIGlzIHJldHVybmVkLCBpbmRpY2F0aW5nIGFueSBsYW5ndWFnZSBpcyBhY2NlcHRlZC5cbiAgICovXG4gIGFjY2VwdHNMYW5ndWFnZXMoKTogc3RyaW5nW10gfCB1bmRlZmluZWQ7XG4gIC8qKiBGb3IgYSBnaXZlbiBzZXQgb2YgbGFuZ3VhZ2VzLCByZXR1cm4gdGhlIGJlc3QgbWF0Y2ggYWNjZXB0ZWQgYnkgdGhlXG4gICAqIHJlcXVlc3Rvci4gIElmIHRoZXJlIGFyZSBubyBsYW5ndWFnZXMgdGhhdCBtYXRjaCwgdGhlbiB0aGUgbWV0aG9kIHJldHVybnNcbiAgICogYHVuZGVmaW5lZGAuICovXG4gIGFjY2VwdHNMYW5ndWFnZXMoLi4ubGFuZ3M6IHN0cmluZ1tdKTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBhY2NlcHRzTGFuZ3VhZ2VzKC4uLmxhbmdzOiBzdHJpbmdbXSk6IHN0cmluZ1tdIHwgc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBhY2NlcHRMYW5ndWFnZVZhbHVlID0gdGhpcy4jc2VydmVyUmVxdWVzdC5oZWFkZXJzLmdldChcbiAgICAgIFwiQWNjZXB0LUxhbmd1YWdlXCIsXG4gICAgKTtcbiAgICBpZiAoIWFjY2VwdExhbmd1YWdlVmFsdWUpIHtcbiAgICAgIHJldHVybiBsYW5ncy5sZW5ndGggPyBsYW5nc1swXSA6IFtcIipcIl07XG4gICAgfVxuICAgIGlmIChsYW5ncy5sZW5ndGgpIHtcbiAgICAgIHJldHVybiBwcmVmZXJyZWRMYW5ndWFnZXMoYWNjZXB0TGFuZ3VhZ2VWYWx1ZSwgbGFuZ3MpWzBdO1xuICAgIH1cbiAgICByZXR1cm4gcHJlZmVycmVkTGFuZ3VhZ2VzKGFjY2VwdExhbmd1YWdlVmFsdWUpO1xuICB9XG5cbiAgYm9keShvcHRpb25zOiBCb2R5T3B0aW9uczxcImJ5dGVzXCI+KTogQm9keUJ5dGVzO1xuICBib2R5KG9wdGlvbnM6IEJvZHlPcHRpb25zPFwiZm9ybVwiPik6IEJvZHlGb3JtO1xuICBib2R5KG9wdGlvbnM6IEJvZHlPcHRpb25zPFwiZm9ybS1kYXRhXCI+KTogQm9keUZvcm1EYXRhO1xuICBib2R5KG9wdGlvbnM6IEJvZHlPcHRpb25zPFwianNvblwiPik6IEJvZHlKc29uO1xuICBib2R5KG9wdGlvbnM6IEJvZHlPcHRpb25zPFwicmVhZGVyXCI+KTogQm9keVJlYWRlcjtcbiAgYm9keShvcHRpb25zOiBCb2R5T3B0aW9uczxcInN0cmVhbVwiPik6IEJvZHlTdHJlYW07XG4gIGJvZHkob3B0aW9uczogQm9keU9wdGlvbnM8XCJ0ZXh0XCI+KTogQm9keVRleHQ7XG4gIGJvZHkob3B0aW9ucz86IEJvZHlPcHRpb25zKTogQm9keTtcbiAgLyoqIEFjY2VzcyB0aGUgYm9keSBvZiB0aGUgcmVxdWVzdC4gVGhpcyBpcyBhIG1ldGhvZCwgYmVjYXVzZSB0aGVyZSBhcmVcbiAgICogc2V2ZXJhbCBvcHRpb25zIHdoaWNoIGNhbiBiZSBwcm92aWRlZCB3aGljaCBjYW4gaW5mbHVlbmNlIGhvdyB0aGUgYm9keSBpc1xuICAgKiBoYW5kbGVkLiAqL1xuICBib2R5KG9wdGlvbnM6IEJvZHlPcHRpb25zID0ge30pOiBCb2R5IHwgQm9keVJlYWRlciB8IEJvZHlTdHJlYW0ge1xuICAgIHJldHVybiB0aGlzLiNib2R5LmdldChvcHRpb25zKTtcbiAgfVxuXG4gIFtTeW1ib2wuZm9yKFwiRGVuby5jdXN0b21JbnNwZWN0XCIpXShpbnNwZWN0OiAodmFsdWU6IHVua25vd24pID0+IHN0cmluZykge1xuICAgIGNvbnN0IHsgaGFzQm9keSwgaGVhZGVycywgaXAsIGlwcywgbWV0aG9kLCBzZWN1cmUsIHVybCB9ID0gdGhpcztcbiAgICByZXR1cm4gYCR7dGhpcy5jb25zdHJ1Y3Rvci5uYW1lfSAke1xuICAgICAgaW5zcGVjdCh7XG4gICAgICAgIGhhc0JvZHksXG4gICAgICAgIGhlYWRlcnMsXG4gICAgICAgIGlwLFxuICAgICAgICBpcHMsXG4gICAgICAgIG1ldGhvZCxcbiAgICAgICAgc2VjdXJlLFxuICAgICAgICB1cmw6IHVybC50b1N0cmluZygpLFxuICAgICAgfSlcbiAgICB9YDtcbiAgfVxuXG4gIFtTeW1ib2wuZm9yKFwibm9kZWpzLnV0aWwuaW5zcGVjdC5jdXN0b21cIildKFxuICAgIGRlcHRoOiBudW1iZXIsXG4gICAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgICBvcHRpb25zOiBhbnksXG4gICAgaW5zcGVjdDogKHZhbHVlOiB1bmtub3duLCBvcHRpb25zPzogdW5rbm93bikgPT4gc3RyaW5nLFxuICApIHtcbiAgICBpZiAoZGVwdGggPCAwKSB7XG4gICAgICByZXR1cm4gb3B0aW9ucy5zdHlsaXplKGBbJHt0aGlzLmNvbnN0cnVjdG9yLm5hbWV9XWAsIFwic3BlY2lhbFwiKTtcbiAgICB9XG5cbiAgICBjb25zdCBuZXdPcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucywge1xuICAgICAgZGVwdGg6IG9wdGlvbnMuZGVwdGggPT09IG51bGwgPyBudWxsIDogb3B0aW9ucy5kZXB0aCAtIDEsXG4gICAgfSk7XG4gICAgY29uc3QgeyBoYXNCb2R5LCBoZWFkZXJzLCBpcCwgaXBzLCBtZXRob2QsIHNlY3VyZSwgdXJsIH0gPSB0aGlzO1xuICAgIHJldHVybiBgJHtvcHRpb25zLnN0eWxpemUodGhpcy5jb25zdHJ1Y3Rvci5uYW1lLCBcInNwZWNpYWxcIil9ICR7XG4gICAgICBpbnNwZWN0KFxuICAgICAgICB7IGhhc0JvZHksIGhlYWRlcnMsIGlwLCBpcHMsIG1ldGhvZCwgc2VjdXJlLCB1cmwgfSxcbiAgICAgICAgbmV3T3B0aW9ucyxcbiAgICAgIClcbiAgICB9YDtcbiAgfVxufVxuIl19