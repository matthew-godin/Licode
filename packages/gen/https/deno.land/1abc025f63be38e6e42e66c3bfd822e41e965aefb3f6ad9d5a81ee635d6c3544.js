import { base64 } from "../deps.ts";
const defaultNonceSize = 16;
const text_encoder = new TextEncoder();
var AuthenticationState;
(function (AuthenticationState) {
    AuthenticationState[AuthenticationState["Init"] = 0] = "Init";
    AuthenticationState[AuthenticationState["ClientChallenge"] = 1] = "ClientChallenge";
    AuthenticationState[AuthenticationState["ServerChallenge"] = 2] = "ServerChallenge";
    AuthenticationState[AuthenticationState["ClientResponse"] = 3] = "ClientResponse";
    AuthenticationState[AuthenticationState["ServerResponse"] = 4] = "ServerResponse";
    AuthenticationState[AuthenticationState["Failed"] = 5] = "Failed";
})(AuthenticationState || (AuthenticationState = {}));
export var Reason;
(function (Reason) {
    Reason["BadMessage"] = "server sent an ill-formed message";
    Reason["BadServerNonce"] = "server sent an invalid nonce";
    Reason["BadSalt"] = "server specified an invalid salt";
    Reason["BadIterationCount"] = "server specified an invalid iteration count";
    Reason["BadVerifier"] = "server sent a bad verifier";
    Reason["Rejected"] = "rejected by server";
})(Reason || (Reason = {}));
function assert(cond) {
    if (!cond) {
        throw new Error("Scram protocol assertion failed");
    }
}
function assertValidScramString(str) {
    const unsafe = /[^\x21-\x7e]/;
    if (unsafe.test(str)) {
        throw new Error("scram username/password is currently limited to safe ascii characters");
    }
}
async function computeScramSignature(message, raw_key) {
    const key = await crypto.subtle.importKey("raw", raw_key, { name: "HMAC", hash: "SHA-256" }, false, ["sign"]);
    return new Uint8Array(await crypto.subtle.sign({ name: "HMAC", hash: "SHA-256" }, key, text_encoder.encode(message)));
}
function computeScramProof(signature, key) {
    const digest = new Uint8Array(signature.length);
    for (let i = 0; i < digest.length; i++) {
        digest[i] = signature[i] ^ key[i];
    }
    return digest;
}
async function deriveKeySignatures(password, salt, iterations) {
    const pbkdf2_password = await crypto.subtle.importKey("raw", text_encoder.encode(password), "PBKDF2", false, ["deriveBits", "deriveKey"]);
    const key = await crypto.subtle.deriveKey({
        hash: "SHA-256",
        iterations,
        name: "PBKDF2",
        salt,
    }, pbkdf2_password, { name: "HMAC", hash: "SHA-256" }, false, ["sign"]);
    const client = new Uint8Array(await crypto.subtle.sign("HMAC", key, text_encoder.encode("Client Key")));
    const server = new Uint8Array(await crypto.subtle.sign("HMAC", key, text_encoder.encode("Server Key")));
    const stored = new Uint8Array(await crypto.subtle.digest("SHA-256", client));
    return { client, server, stored };
}
function escape(str) {
    return str
        .replace(/=/g, "=3D")
        .replace(/,/g, "=2C");
}
function generateRandomNonce(size) {
    return base64.encode(crypto.getRandomValues(new Uint8Array(size)));
}
function parseScramAttributes(message) {
    const attrs = {};
    for (const entry of message.split(",")) {
        const pos = entry.indexOf("=");
        if (pos < 1) {
            throw new Error(Reason.BadMessage);
        }
        const key = entry.substr(0, pos);
        const value = entry.substr(pos + 1);
        attrs[key] = value;
    }
    return attrs;
}
export class Client {
    #auth_message;
    #client_nonce;
    #key_signatures;
    #password;
    #server_nonce;
    #state;
    #username;
    constructor(username, password, nonce) {
        assertValidScramString(password);
        assertValidScramString(username);
        this.#auth_message = "";
        this.#client_nonce = nonce ?? generateRandomNonce(defaultNonceSize);
        this.#password = password;
        this.#state = AuthenticationState.Init;
        this.#username = escape(username);
    }
    composeChallenge() {
        assert(this.#state === AuthenticationState.Init);
        try {
            const header = "n,,";
            const challenge = `n=${this.#username},r=${this.#client_nonce}`;
            const message = header + challenge;
            this.#auth_message += challenge;
            this.#state = AuthenticationState.ClientChallenge;
            return message;
        }
        catch (e) {
            this.#state = AuthenticationState.Failed;
            throw e;
        }
    }
    async receiveChallenge(challenge) {
        assert(this.#state === AuthenticationState.ClientChallenge);
        try {
            const attrs = parseScramAttributes(challenge);
            const nonce = attrs.r;
            if (!attrs.r || !attrs.r.startsWith(this.#client_nonce)) {
                throw new Error(Reason.BadServerNonce);
            }
            this.#server_nonce = nonce;
            let salt;
            if (!attrs.s) {
                throw new Error(Reason.BadSalt);
            }
            try {
                salt = base64.decode(attrs.s);
            }
            catch {
                throw new Error(Reason.BadSalt);
            }
            const iterCount = parseInt(attrs.i) | 0;
            if (iterCount <= 0) {
                throw new Error(Reason.BadIterationCount);
            }
            this.#key_signatures = await deriveKeySignatures(this.#password, salt, iterCount);
            this.#auth_message += "," + challenge;
            this.#state = AuthenticationState.ServerChallenge;
        }
        catch (e) {
            this.#state = AuthenticationState.Failed;
            throw e;
        }
    }
    async composeResponse() {
        assert(this.#state === AuthenticationState.ServerChallenge);
        assert(this.#key_signatures);
        assert(this.#server_nonce);
        try {
            const responseWithoutProof = `c=biws,r=${this.#server_nonce}`;
            this.#auth_message += "," + responseWithoutProof;
            const proof = base64.encode(computeScramProof(await computeScramSignature(this.#auth_message, this.#key_signatures.stored), this.#key_signatures.client));
            const message = `${responseWithoutProof},p=${proof}`;
            this.#state = AuthenticationState.ClientResponse;
            return message;
        }
        catch (e) {
            this.#state = AuthenticationState.Failed;
            throw e;
        }
    }
    async receiveResponse(response) {
        assert(this.#state === AuthenticationState.ClientResponse);
        assert(this.#key_signatures);
        try {
            const attrs = parseScramAttributes(response);
            if (attrs.e) {
                throw new Error(attrs.e ?? Reason.Rejected);
            }
            const verifier = base64.encode(await computeScramSignature(this.#auth_message, this.#key_signatures.server));
            if (attrs.v !== verifier) {
                throw new Error(Reason.BadVerifier);
            }
            this.#state = AuthenticationState.ServerResponse;
        }
        catch (e) {
            this.#state = AuthenticationState.Failed;
            throw e;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NyYW0uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzY3JhbS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBR3BDLE1BQU0sZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO0FBQzVCLE1BQU0sWUFBWSxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7QUFFdkMsSUFBSyxtQkFPSjtBQVBELFdBQUssbUJBQW1CO0lBQ3RCLDZEQUFJLENBQUE7SUFDSixtRkFBZSxDQUFBO0lBQ2YsbUZBQWUsQ0FBQTtJQUNmLGlGQUFjLENBQUE7SUFDZCxpRkFBYyxDQUFBO0lBQ2QsaUVBQU0sQ0FBQTtBQUNSLENBQUMsRUFQSSxtQkFBbUIsS0FBbkIsbUJBQW1CLFFBT3ZCO0FBZUQsTUFBTSxDQUFOLElBQVksTUFPWDtBQVBELFdBQVksTUFBTTtJQUNoQiwwREFBZ0QsQ0FBQTtJQUNoRCx5REFBK0MsQ0FBQTtJQUMvQyxzREFBNEMsQ0FBQTtJQUM1QywyRUFBaUUsQ0FBQTtJQUNqRSxvREFBMEMsQ0FBQTtJQUMxQyx5Q0FBK0IsQ0FBQTtBQUNqQyxDQUFDLEVBUFcsTUFBTSxLQUFOLE1BQU0sUUFPakI7QUFFRCxTQUFTLE1BQU0sQ0FBQyxJQUFhO0lBQzNCLElBQUksQ0FBQyxJQUFJLEVBQUU7UUFDVCxNQUFNLElBQUksS0FBSyxDQUFDLGlDQUFpQyxDQUFDLENBQUM7S0FDcEQ7QUFDSCxDQUFDO0FBVUQsU0FBUyxzQkFBc0IsQ0FBQyxHQUFXO0lBQ3pDLE1BQU0sTUFBTSxHQUFHLGNBQWMsQ0FBQztJQUM5QixJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDcEIsTUFBTSxJQUFJLEtBQUssQ0FDYix1RUFBdUUsQ0FDeEUsQ0FBQztLQUNIO0FBQ0gsQ0FBQztBQUVELEtBQUssVUFBVSxxQkFBcUIsQ0FDbEMsT0FBZSxFQUNmLE9BQW1CO0lBRW5CLE1BQU0sR0FBRyxHQUFH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QUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2FBQ3JDO1lBRUQsSUFBSSxDQUFDLE1BQU0sR0FBRyxtQkFBbUIsQ0FBQyxjQUFjLENBQUM7U0FDbEQ7UUFBQyxPQUFPLENBQUMsRUFBRTtZQUNWLElBQUksQ0FBQyxNQUFNLEdBQUcsbUJBQW1CLENBQUMsTUFBTSxDQUFDO1lBQ3pDLE1BQU0sQ0FBQyxDQUFDO1NBQ1Q7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBiYXNlNjQgfSBmcm9tIFwiLi4vZGVwcy50c1wiO1xuXG4vKiogTnVtYmVyIG9mIHJhbmRvbSBieXRlcyB1c2VkIHRvIGdlbmVyYXRlIGEgbm9uY2UgKi9cbmNvbnN0IGRlZmF1bHROb25jZVNpemUgPSAxNjtcbmNvbnN0IHRleHRfZW5jb2RlciA9IG5ldyBUZXh0RW5jb2RlcigpO1xuXG5lbnVtIEF1dGhlbnRpY2F0aW9uU3RhdGUge1xuICBJbml0LFxuICBDbGllbnRDaGFsbGVuZ2UsXG4gIFNlcnZlckNoYWxsZW5nZSxcbiAgQ2xpZW50UmVzcG9uc2UsXG4gIFNlcnZlclJlc3BvbnNlLFxuICBGYWlsZWQsXG59XG5cbi8qKlxuICogQ29sbGVjdGlvbiBvZiBTQ1JBTSBhdXRoZW50aWNhdGlvbiBrZXlzIGRlcml2ZWQgZnJvbSBhIHBsYWludGV4dCBwYXNzd29yZFxuICogaW4gSE1BQy1kZXJpdmVkIGJpbmFyeSBmb3JtYXRcbiAqL1xuaW50ZXJmYWNlIEtleVNpZ25hdHVyZXMge1xuICBjbGllbnQ6IFVpbnQ4QXJyYXk7XG4gIHNlcnZlcjogVWludDhBcnJheTtcbiAgc3RvcmVkOiBVaW50OEFycmF5O1xufVxuXG4vKipcbiAqIFJlYXNvbiBvZiBhdXRoZW50aWNhdGlvbiBmYWlsdXJlXG4gKi9cbmV4cG9ydCBlbnVtIFJlYXNvbiB7XG4gIEJhZE1lc3NhZ2UgPSBcInNlcnZlciBzZW50IGFuIGlsbC1mb3JtZWQgbWVzc2FnZVwiLFxuICBCYWRTZXJ2ZXJOb25jZSA9IFwic2VydmVyIHNlbnQgYW4gaW52YWxpZCBub25jZVwiLFxuICBCYWRTYWx0ID0gXCJzZXJ2ZXIgc3BlY2lmaWVkIGFuIGludmFsaWQgc2FsdFwiLFxuICBCYWRJdGVyYXRpb25Db3VudCA9IFwic2VydmVyIHNwZWNpZmllZCBhbiBpbnZhbGlkIGl0ZXJhdGlvbiBjb3VudFwiLFxuICBCYWRWZXJpZmllciA9IFwic2VydmVyIHNlbnQgYSBiYWQgdmVyaWZpZXJcIixcbiAgUmVqZWN0ZWQgPSBcInJlamVjdGVkIGJ5IHNlcnZlclwiLFxufVxuXG5mdW5jdGlvbiBhc3NlcnQoY29uZDogdW5rbm93bik6IGFzc2VydHMgY29uZCB7XG4gIGlmICghY29uZCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIlNjcmFtIHByb3RvY29sIGFzc2VydGlvbiBmYWlsZWRcIik7XG4gIH1cbn1cblxuLy8gVE9ET1xuLy8gSGFuZGxlIG1hcHBpbmcgYW5kIG1heWJlIHVuaWNvZGUgbm9ybWFsaXphdGlvbi5cbi8vIEFkZCB0ZXN0cyBmb3IgaW52YWxpZCBzdHJpbmcgdmFsdWVzXG4vKipcbiAqIE5vcm1hbGl6ZXMgc3RyaW5nIHBlciBTQVNMcHJlcC5cbiAqIEBzZWUge0BsaW5rIGh0dHBzOi8vdG9vbHMuaWV0Zi5vcmcvaHRtbC9yZmMzNDU0fVxuICogQHNlZSB7QGxpbmsgaHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzQwMTN9XG4gKi9cbmZ1bmN0aW9uIGFzc2VydFZhbGlkU2NyYW1TdHJpbmcoc3RyOiBzdHJpbmcpIHtcbiAgY29uc3QgdW5zYWZlID0gL1teXFx4MjEtXFx4N2VdLztcbiAgaWYgKHVuc2FmZS50ZXN0KHN0cikpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBcInNjcmFtIHVzZXJuYW1lL3Bhc3N3b3JkIGlzIGN1cnJlbnRseSBsaW1pdGVkIHRvIHNhZmUgYXNjaWkgY2hhcmFjdGVyc1wiLFxuICAgICk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gY29tcHV0ZVNjcmFtU2lnbmF0dXJlKFxuICBtZXNzYWdlOiBzdHJpbmcsXG4gIHJhd19rZXk6IFVpbnQ4QXJyYXksXG4pOiBQcm9taXNlPFVpbnQ4QXJyYXk+IHtcbiAgY29uc3Qga2V5ID0gYXdhaXQgY3J5cHRvLnN1YnRsZS5pbXBvcnRLZXkoXG4gICAgXCJyYXdcIixcbiAgICByYXdfa2V5LFxuICAgIHsgbmFtZTogXCJITUFDXCIsIGhhc2g6IFwiU0hBLTI1NlwiIH0sXG4gICAgZmFsc2UsXG4gICAgW1wic2lnblwiXSxcbiAgKTtcblxuICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoXG4gICAgYXdhaXQgY3J5cHRvLnN1YnRsZS5zaWduKFxuICAgICAgeyBuYW1lOiBcIkhNQUNcIiwgaGFzaDogXCJTSEEtMjU2XCIgfSxcbiAgICAgIGtleSxcbiAgICAgIHRleHRfZW5jb2Rlci5lbmNvZGUobWVzc2FnZSksXG4gICAgKSxcbiAgKTtcbn1cblxuZnVuY3Rpb24gY29tcHV0ZVNjcmFtUHJvb2Yoc2lnbmF0dXJlOiBVaW50OEFycmF5LCBrZXk6IFVpbnQ4QXJyYXkpOiBVaW50OEFycmF5IHtcbiAgY29uc3QgZGlnZXN0ID0gbmV3IFVpbnQ4QXJyYXkoc2lnbmF0dXJlLmxlbmd0aCk7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgZGlnZXN0Lmxlbmd0aDsgaSsrKSB7XG4gICAgZGlnZXN0W2ldID0gc2lnbmF0dXJlW2ldIF4ga2V5W2ldO1xuICB9XG4gIHJldHVybiBkaWdlc3Q7XG59XG5cbi8qKlxuICogRGVyaXZlcyBhdXRoZW50aWNhdGlvbiBrZXkgc2lnbmF0dXJlcyBmcm9tIGEgcGxhaW50ZXh0IHBhc3N3b3JkXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGRlcml2ZUtleVNpZ25hdHVyZXMoXG4gIHBhc3N3b3JkOiBzdHJpbmcsXG4gIHNhbHQ6IFVpbnQ4QXJyYXksXG4gIGl0ZXJhdGlvbnM6IG51bWJlcixcbik6IFByb21pc2U8S2V5U2lnbmF0dXJlcz4ge1xuICBjb25zdCBwYmtkZjJfcGFzc3dvcmQgPSBhd2FpdCBjcnlwdG8uc3VidGxlLmltcG9ydEtleShcbiAgICBcInJhd1wiLFxuICAgIHRleHRfZW5jb2Rlci5lbmNvZGUocGFzc3dvcmQpLFxuICAgIFwiUEJLREYyXCIsXG4gICAgZmFsc2UsXG4gICAgW1wiZGVyaXZlQml0c1wiLCBcImRlcml2ZUtleVwiXSxcbiAgKTtcbiAgY29uc3Qga2V5ID0gYXdhaXQgY3J5cHRvLnN1YnRsZS5kZXJpdmVLZXkoXG4gICAge1xuICAgICAgaGFzaDogXCJTSEEtMjU2XCIsXG4gICAgICBpdGVyYXRpb25zLFxuICAgICAgbmFtZTogXCJQQktERjJcIixcbiAgICAgIHNhbHQsXG4gICAgfSxcbiAgICBwYmtkZjJfcGFzc3dvcmQsXG4gICAgeyBuYW1lOiBcIkhNQUNcIiwgaGFzaDogXCJTSEEtMjU2XCIgfSxcbiAgICBmYWxzZSxcbiAgICBbXCJzaWduXCJdLFxuICApO1xuXG4gIGNvbnN0IGNsaWVudCA9IG5ldyBVaW50OEFycmF5KFxuICAgIGF3YWl0IGNyeXB0by5zdWJ0bGUuc2lnbihcIkhNQUNcIiwga2V5LCB0ZXh0X2VuY29kZXIuZW5jb2RlKFwiQ2xpZW50IEtleVwiKSksXG4gICk7XG4gIGNvbnN0IHNlcnZlciA9IG5ldyBVaW50OEFycmF5KFxuICAgIGF3YWl0IGNyeXB0by5zdWJ0bGUuc2lnbihcIkhNQUNcIiwga2V5LCB0ZXh0X2VuY29kZXIuZW5jb2RlKFwiU2VydmVyIEtleVwiKSksXG4gICk7XG4gIGNvbnN0IHN0b3JlZCA9IG5ldyBVaW50OEFycmF5KGF3YWl0IGNyeXB0by5zdWJ0bGUuZGlnZXN0KFwiU0hBLTI1NlwiLCBjbGllbnQpKTtcblxuICByZXR1cm4geyBjbGllbnQsIHNlcnZlciwgc3RvcmVkIH07XG59XG5cbi8qKiBFc2NhcGVzIFwiPVwiIGFuZCBcIixcIiBpbiBhIHN0cmluZy4gKi9cbmZ1bmN0aW9uIGVzY2FwZShzdHI6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBzdHJcbiAgICAucmVwbGFjZSgvPS9nLCBcIj0zRFwiKVxuICAgIC5yZXBsYWNlKC8sL2csIFwiPTJDXCIpO1xufVxuXG5mdW5jdGlvbiBnZW5lcmF0ZVJhbmRvbU5vbmNlKHNpemU6IG51bWJlcik6IHN0cmluZyB7XG4gIHJldHVybiBiYXNlNjQuZW5jb2RlKGNyeXB0by5nZXRSYW5kb21WYWx1ZXMobmV3IFVpbnQ4QXJyYXkoc2l6ZSkpKTtcbn1cblxuZnVuY3Rpb24gcGFyc2VTY3JhbUF0dHJpYnV0ZXMobWVzc2FnZTogc3RyaW5nKTogUmVjb3JkPHN0cmluZywgc3RyaW5nPiB7XG4gIGNvbnN0IGF0dHJzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XG5cbiAgZm9yIChjb25zdCBlbnRyeSBvZiBtZXNzYWdlLnNwbGl0KFwiLFwiKSkge1xuICAgIGNvbnN0IHBvcyA9IGVudHJ5LmluZGV4T2YoXCI9XCIpO1xuICAgIGlmIChwb3MgPCAxKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoUmVhc29uLkJhZE1lc3NhZ2UpO1xuICAgIH1cblxuICAgIC8vIFRPRE9cbiAgICAvLyBSZXBsYWNlIHdpdGggU3RyaW5nLnByb3RvdHlwZS5zdWJzdHJpbmdcbiAgICBjb25zdCBrZXkgPSBlbnRyeS5zdWJzdHIoMCwgcG9zKTtcbiAgICBjb25zdCB2YWx1ZSA9IGVudHJ5LnN1YnN0cihwb3MgKyAxKTtcbiAgICBhdHRyc1trZXldID0gdmFsdWU7XG4gIH1cblxuICByZXR1cm4gYXR0cnM7XG59XG5cbi8qKlxuICogQ2xpZW50IGNvbXBvc2VzIGFuZCB2ZXJpZmllcyBTQ1JBTSBhdXRoZW50aWNhdGlvbiBtZXNzYWdlcywga2VlcGluZyB0cmFja1xuICogb2YgYXV0aGVudGljYXRpb24gI3N0YXRlIGFuZCBwYXJhbWV0ZXJzLlxuICogQHNlZSB7QGxpbmsgaHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzU4MDJ9XG4gKi9cbmV4cG9ydCBjbGFzcyBDbGllbnQge1xuICAjYXV0aF9tZXNzYWdlOiBzdHJpbmc7XG4gICNjbGllbnRfbm9uY2U6IHN0cmluZztcbiAgI2tleV9zaWduYXR1cmVzPzogS2V5U2lnbmF0dXJlcztcbiAgI3Bhc3N3b3JkOiBzdHJpbmc7XG4gICNzZXJ2ZXJfbm9uY2U/OiBzdHJpbmc7XG4gICNzdGF0ZTogQXV0aGVudGljYXRpb25TdGF0ZTtcbiAgI3VzZXJuYW1lOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IodXNlcm5hbWU6IHN0cmluZywgcGFzc3dvcmQ6IHN0cmluZywgbm9uY2U/OiBzdHJpbmcpIHtcbiAgICBhc3NlcnRWYWxpZFNjcmFtU3RyaW5nKHBhc3N3b3JkKTtcbiAgICBhc3NlcnRWYWxpZFNjcmFtU3RyaW5nKHVzZXJuYW1lKTtcblxuICAgIHRoaXMuI2F1dGhfbWVzc2FnZSA9IFwiXCI7XG4gICAgdGhpcy4jY2xpZW50X25vbmNlID0gbm9uY2UgPz8gZ2VuZXJhdGVSYW5kb21Ob25jZShkZWZhdWx0Tm9uY2VTaXplKTtcbiAgICB0aGlzLiNwYXNzd29yZCA9IHBhc3N3b3JkO1xuICAgIHRoaXMuI3N0YXRlID0gQXV0aGVudGljYXRpb25TdGF0ZS5Jbml0O1xuICAgIHRoaXMuI3VzZXJuYW1lID0gZXNjYXBlKHVzZXJuYW1lKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb21wb3NlcyBjbGllbnQtZmlyc3QtbWVzc2FnZVxuICAgKi9cbiAgY29tcG9zZUNoYWxsZW5nZSgpOiBzdHJpbmcge1xuICAgIGFzc2VydCh0aGlzLiNzdGF0ZSA9PT0gQXV0aGVudGljYXRpb25TdGF0ZS5Jbml0KTtcblxuICAgIHRyeSB7XG4gICAgICAvLyBcIm5cIiBmb3Igbm8gY2hhbm5lbCBiaW5kaW5nLCB0aGVuIGFuIGVtcHR5IGF1dGh6aWQgb3B0aW9uIGZvbGxvd3MuXG4gICAgICBjb25zdCBoZWFkZXIgPSBcIm4sLFwiO1xuXG4gICAgICBjb25zdCBjaGFsbGVuZ2UgPSBgbj0ke3RoaXMuI3VzZXJuYW1lfSxyPSR7dGhpcy4jY2xpZW50X25vbmNlfWA7XG4gICAgICBjb25zdCBtZXNzYWdlID0gaGVhZGVyICsgY2hhbGxlbmdlO1xuXG4gICAgICB0aGlzLiNhdXRoX21lc3NhZ2UgKz0gY2hhbGxlbmdlO1xuICAgICAgdGhpcy4jc3RhdGUgPSBBdXRoZW50aWNhdGlvblN0YXRlLkNsaWVudENoYWxsZW5nZTtcbiAgICAgIHJldHVybiBtZXNzYWdlO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRoaXMuI3N0YXRlID0gQXV0aGVudGljYXRpb25TdGF0ZS5GYWlsZWQ7XG4gICAgICB0aHJvdyBlO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBQcm9jZXNzZXMgc2VydmVyLWZpcnN0LW1lc3NhZ2VcbiAgICovXG4gIGFzeW5jIHJlY2VpdmVDaGFsbGVuZ2UoY2hhbGxlbmdlOiBzdHJpbmcpIHtcbiAgICBhc3NlcnQodGhpcy4jc3RhdGUgPT09IEF1dGhlbnRpY2F0aW9uU3RhdGUuQ2xpZW50Q2hhbGxlbmdlKTtcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBhdHRycyA9IHBhcnNlU2NyYW1BdHRyaWJ1dGVzKGNoYWxsZW5nZSk7XG5cbiAgICAgIGNvbnN0IG5vbmNlID0gYXR0cnMucjtcbiAgICAgIGlmICghYXR0cnMuciB8fCAhYXR0cnMuci5zdGFydHNXaXRoKHRoaXMuI2NsaWVudF9ub25jZSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFJlYXNvbi5CYWRTZXJ2ZXJOb25jZSk7XG4gICAgICB9XG4gICAgICB0aGlzLiNzZXJ2ZXJfbm9uY2UgPSBub25jZTtcblxuICAgICAgbGV0IHNhbHQ6IFVpbnQ4QXJyYXkgfCB1bmRlZmluZWQ7XG4gICAgICBpZiAoIWF0dHJzLnMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFJlYXNvbi5CYWRTYWx0KTtcbiAgICAgIH1cbiAgICAgIHRyeSB7XG4gICAgICAgIHNhbHQgPSBiYXNlNjQuZGVjb2RlKGF0dHJzLnMpO1xuICAgICAgfSBjYXRjaCB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihSZWFzb24uQmFkU2FsdCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGl0ZXJDb3VudCA9IHBhcnNlSW50KGF0dHJzLmkpIHwgMDtcbiAgICAgIGlmIChpdGVyQ291bnQgPD0gMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoUmVhc29uLkJhZEl0ZXJhdGlvbkNvdW50KTtcbiAgICAgIH1cblxuICAgICAgdGhpcy4ja2V5X3NpZ25hdHVyZXMgPSBhd2FpdCBkZXJpdmVLZXlTaWduYXR1cmVzKFxuICAgICAgICB0aGlzLiNwYXNzd29yZCxcbiAgICAgICAgc2FsdCxcbiAgICAgICAgaXRlckNvdW50LFxuICAgICAgKTtcblxuICAgICAgdGhpcy4jYXV0aF9tZXNzYWdlICs9IFwiLFwiICsgY2hhbGxlbmdlO1xuICAgICAgdGhpcy4jc3RhdGUgPSBBdXRoZW50aWNhdGlvblN0YXRlLlNlcnZlckNoYWxsZW5nZTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aGlzLiNzdGF0ZSA9IEF1dGhlbnRpY2F0aW9uU3RhdGUuRmFpbGVkO1xuICAgICAgdGhyb3cgZTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ29tcG9zZXMgY2xpZW50LWZpbmFsLW1lc3NhZ2VcbiAgICovXG4gIGFzeW5jIGNvbXBvc2VSZXNwb25zZSgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGFzc2VydCh0aGlzLiNzdGF0ZSA9PT0gQXV0aGVudGljYXRpb25TdGF0ZS5TZXJ2ZXJDaGFsbGVuZ2UpO1xuICAgIGFzc2VydCh0aGlzLiNrZXlfc2lnbmF0dXJlcyk7XG4gICAgYXNzZXJ0KHRoaXMuI3NlcnZlcl9ub25jZSk7XG5cbiAgICB0cnkge1xuICAgICAgLy8gXCJiaXdzXCIgaXMgdGhlIGJhc2UtNjQgZW5jb2RlZCBmb3JtIG9mIHRoZSBnczItaGVhZGVyIFwibiwsXCIuXG4gICAgICBjb25zdCByZXNwb25zZVdpdGhvdXRQcm9vZiA9IGBjPWJpd3Mscj0ke3RoaXMuI3NlcnZlcl9ub25jZX1gO1xuXG4gICAgICB0aGlzLiNhdXRoX21lc3NhZ2UgKz0gXCIsXCIgKyByZXNwb25zZVdpdGhvdXRQcm9vZjtcblxuICAgICAgY29uc3QgcHJvb2YgPSBiYXNlNjQuZW5jb2RlKFxuICAgICAgICBjb21wdXRlU2NyYW1Qcm9vZihcbiAgICAgICAgICBhd2FpdCBjb21wdXRlU2NyYW1TaWduYXR1cmUoXG4gICAgICAgICAgICB0aGlzLiNhdXRoX21lc3NhZ2UsXG4gICAgICAgICAgICB0aGlzLiNrZXlfc2lnbmF0dXJlcy5zdG9yZWQsXG4gICAgICAgICAgKSxcbiAgICAgICAgICB0aGlzLiNrZXlfc2lnbmF0dXJlcy5jbGllbnQsXG4gICAgICAgICksXG4gICAgICApO1xuICAgICAgY29uc3QgbWVzc2FnZSA9IGAke3Jlc3BvbnNlV2l0aG91dFByb29mfSxwPSR7cHJvb2Z9YDtcblxuICAgICAgdGhpcy4jc3RhdGUgPSBBdXRoZW50aWNhdGlvblN0YXRlLkNsaWVudFJlc3BvbnNlO1xuICAgICAgcmV0dXJuIG1lc3NhZ2U7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhpcy4jc3RhdGUgPSBBdXRoZW50aWNhdGlvblN0YXRlLkZhaWxlZDtcbiAgICAgIHRocm93IGU7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFByb2Nlc3NlcyBzZXJ2ZXItZmluYWwtbWVzc2FnZVxuICAgKi9cbiAgYXN5bmMgcmVjZWl2ZVJlc3BvbnNlKHJlc3BvbnNlOiBzdHJpbmcpIHtcbiAgICBhc3NlcnQodGhpcy4jc3RhdGUgPT09IEF1dGhlbnRpY2F0aW9uU3RhdGUuQ2xpZW50UmVzcG9uc2UpO1xuICAgIGFzc2VydCh0aGlzLiNrZXlfc2lnbmF0dXJlcyk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgYXR0cnMgPSBwYXJzZVNjcmFtQXR0cmlidXRlcyhyZXNwb25zZSk7XG5cbiAgICAgIGlmIChhdHRycy5lKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihhdHRycy5lID8/IFJlYXNvbi5SZWplY3RlZCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHZlcmlmaWVyID0gYmFzZTY0LmVuY29kZShcbiAgICAgICAgYXdhaXQgY29tcHV0ZVNjcmFtU2lnbmF0dXJlKFxuICAgICAgICAgIHRoaXMuI2F1dGhfbWVzc2FnZSxcbiAgICAgICAgICB0aGlzLiNrZXlfc2lnbmF0dXJlcy5zZXJ2ZXIsXG4gICAgICAgICksXG4gICAgICApO1xuICAgICAgaWYgKGF0dHJzLnYgIT09IHZlcmlmaWVyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihSZWFzb24uQmFkVmVyaWZpZXIpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLiNzdGF0ZSA9IEF1dGhlbnRpY2F0aW9uU3RhdGUuU2VydmVyUmVzcG9uc2U7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhpcy4jc3RhdGUgPSBBdXRoZW50aWNhdGlvblN0YXRlLkZhaWxlZDtcbiAgICAgIHRocm93IGU7XG4gICAgfVxuICB9XG59XG4iXX0=