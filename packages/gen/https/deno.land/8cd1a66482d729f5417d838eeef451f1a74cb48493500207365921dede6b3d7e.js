import { createHash, encode } from "../deps.ts";
import { xor } from "./util.ts";
function hash(algorithm, data) {
    return new Uint8Array(createHash(algorithm).update(data).digest());
}
function mysqlNativePassword(password, seed) {
    const pwd1 = hash("sha1", encode(password));
    const pwd2 = hash("sha1", pwd1);
    let seedAndPwd2 = new Uint8Array(seed.length + pwd2.length);
    seedAndPwd2.set(seed);
    seedAndPwd2.set(pwd2, seed.length);
    seedAndPwd2 = hash("sha1", seedAndPwd2);
    return xor(seedAndPwd2, pwd1);
}
function cachingSha2Password(password, seed) {
    const stage1 = hash("sha256", encode(password));
    const stage2 = hash("sha256", stage1);
    const stage3 = hash("sha256", Uint8Array.from([...stage2, ...seed]));
    return xor(stage1, stage3);
}
export default function auth(authPluginName, password, seed) {
    switch (authPluginName) {
        case "mysql_native_password":
            return mysqlNativePassword(password, seed);
        case "caching_sha2_password":
            return cachingSha2Password(password, seed);
        default:
            throw new Error("Not supported");
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImh0dHBzOi8vZGVuby5sYW5kL3gvbXlzcWxAdjIuOS4wL3NyYy9hdXRoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFzQixNQUFNLFlBQVksQ0FBQztBQUNwRSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRWhDLFNBQVMsSUFBSSxDQUFDLFNBQTZCLEVBQUUsSUFBZ0I7SUFDM0QsT0FBTyxJQUFJLFVBQVUsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7QUFDckUsQ0FBQztBQUVELFNBQVMsbUJBQW1CLENBQUMsUUFBZ0IsRUFBRSxJQUFnQjtJQUM3RCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO0lBQzVDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFFaEMsSUFBSSxXQUFXLEdBQUcsSUFBSSxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDNUQsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN0QixXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDbkMsV0FBVyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFFeEMsT0FBTyxHQUFHLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQ2hDLENBQUM7QUFFRCxTQUFTLG1CQUFtQixDQUFDLFFBQWdCLEVBQUUsSUFBZ0I7SUFDN0QsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztJQUNoRCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ3RDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3JFLE9BQU8sR0FBRyxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztBQUM3QixDQUFDO0FBRUQsTUFBTSxDQUFDLE9BQU8sVUFBVSxJQUFJLENBQzFCLGNBQXNCLEVBQ3RCLFFBQWdCLEVBQ2hCLElBQWdCO0lBRWhCLFFBQVEsY0FBYyxFQUFFO1FBQ3RCLEtBQUssdUJBQXVCO1lBQzFCLE9BQU8sbUJBQW1CLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRTdDLEtBQUssdUJBQXVCO1lBQzFCLE9BQU8sbUJBQW1CLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzdDO1lBQ0UsTUFBTSxJQUFJLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQztLQUNwQztBQUNILENBQUMifQ==