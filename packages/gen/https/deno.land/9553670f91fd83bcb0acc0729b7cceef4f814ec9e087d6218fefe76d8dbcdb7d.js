import { concat } from "../bytes/mod.ts";
const CHAR_SPACE = " ".charCodeAt(0);
const CHAR_TAB = "\t".charCodeAt(0);
const CHAR_COLON = ":".charCodeAt(0);
const WHITESPACES = [CHAR_SPACE, CHAR_TAB];
const decoder = new TextDecoder();
const invalidHeaderCharRegex = /[^\t\x20-\x7e\x80-\xff]/g;
function str(buf) {
    return !buf ? "" : decoder.decode(buf);
}
export class TextProtoReader {
    r;
    constructor(r) {
        this.r = r;
    }
    async readLine() {
        const s = await this.readLineSlice();
        return s === null ? null : str(s);
    }
    async readMIMEHeader() {
        const m = new Headers();
        let line;
        let buf = await this.r.peek(1);
        if (buf === null) {
            return null;
        }
        else if (WHITESPACES.includes(buf[0])) {
            line = (await this.readLineSlice());
        }
        buf = await this.r.peek(1);
        if (buf === null) {
            throw new Deno.errors.UnexpectedEof();
        }
        else if (WHITESPACES.includes(buf[0])) {
            throw new Deno.errors.InvalidData(`malformed MIME header initial line: ${str(line)}`);
        }
        while (true) {
            const kv = await this.readLineSlice();
            if (kv === null)
                throw new Deno.errors.UnexpectedEof();
            if (kv.byteLength === 0)
                return m;
            let i = kv.indexOf(CHAR_COLON);
            if (i < 0) {
                throw new Deno.errors.InvalidData(`malformed MIME header line: ${str(kv)}`);
            }
            const key = str(kv.subarray(0, i));
            if (key == "") {
                continue;
            }
            i++;
            while (i < kv.byteLength &&
                (WHITESPACES.includes(kv[i]))) {
                i++;
            }
            const value = str(kv.subarray(i)).replace(invalidHeaderCharRegex, encodeURI);
            try {
                m.append(key, value);
            }
            catch {
            }
        }
    }
    async readLineSlice() {
        let line = new Uint8Array(0);
        let r = null;
        do {
            r = await this.r.readLine();
            if (r !== null && this.skipSpace(r.line) !== 0) {
                line = concat(line, r.line);
            }
        } while (r !== null && r.more);
        return r === null ? null : line;
    }
    skipSpace(l) {
        let n = 0;
        for (const val of l) {
            if (!WHITESPACES.includes(val)) {
                n++;
            }
        }
        return n;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibW9kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQU9BLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUd6QyxNQUFNLFVBQVUsR0FBVyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzdDLE1BQU0sUUFBUSxHQUFXLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDNUMsTUFBTSxVQUFVLEdBQVcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUU3QyxNQUFNLFdBQVcsR0FBa0IsQ0FBQyxVQUFVLEVBQUUsUUFBUSxDQUFDLENBQUM7QUFFMUQsTUFBTSxPQUFPLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztBQUdsQyxNQUFNLHNCQUFzQixHQUFHLDBCQUEwQixDQUFDO0FBRTFELFNBQVMsR0FBRyxDQUFDLEdBQWtDO0lBQzdDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUN6QyxDQUFDO0FBRUQsTUFBTSxPQUFPLGVBQWU7SUFDTDtJQUFyQixZQUFxQixDQUFZO1FBQVosTUFBQyxHQUFELENBQUMsQ0FBVztJQUFHLENBQUM7SUFLckMsS0FBSyxDQUFDLFFBQVE7UUFDWixNQUFNLENBQUMsR0FBRyxNQUFNLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUNyQyxPQUFPLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3BDLENBQUM7SUFzQkQsS0FBSyxDQUFDLGNBQWM7UUFDbEIsTUFBTSxDQUFDLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUN4QixJQUFJLElBQTRCLENBQUM7UUFHakMsSUFBSSxHQUFH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S0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQ2xDLENBQUM7SUFFRCxTQUFTLENBQUMsQ0FBYTtRQUNyQixJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFVixLQUFLLE1BQU0sR0FBRyxJQUFJLENBQUMsRUFBRTtZQUNuQixJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDOUIsQ0FBQyxFQUFFLENBQUM7YUFDTDtTQUNGO1FBRUQsT0FBTyxDQUFDLENBQUM7SUFDWCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDIxIHRoZSBEZW5vIGF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuIE1JVCBsaWNlbnNlLlxuLy8gQmFzZWQgb24gaHR0cHM6Ly9naXRodWIuY29tL2dvbGFuZy9nby90cmVlL21hc3Rlci9zcmMvbmV0L3RleHRwcm90b1xuLy8gQ29weXJpZ2h0IDIwMDkgVGhlIEdvIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4vLyBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZVxuLy8gbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLlxuXG5pbXBvcnQgdHlwZSB7IEJ1ZlJlYWRlciwgUmVhZExpbmVSZXN1bHQgfSBmcm9tIFwiLi4vaW8vYnVmaW8udHNcIjtcbmltcG9ydCB7IGNvbmNhdCB9IGZyb20gXCIuLi9ieXRlcy9tb2QudHNcIjtcblxuLy8gQ29uc3RhbnRzIGNyZWF0ZWQgZm9yIERSWVxuY29uc3QgQ0hBUl9TUEFDRTogbnVtYmVyID0gXCIgXCIuY2hhckNvZGVBdCgwKTtcbmNvbnN0IENIQVJfVEFCOiBudW1iZXIgPSBcIlxcdFwiLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBDSEFSX0NPTE9OOiBudW1iZXIgPSBcIjpcIi5jaGFyQ29kZUF0KDApO1xuXG5jb25zdCBXSElURVNQQUNFUzogQXJyYXk8bnVtYmVyPiA9IFtDSEFSX1NQQUNFLCBDSEFSX1RBQl07XG5cbmNvbnN0IGRlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoKTtcblxuLy8gRlJPTSBodHRwczovL2dpdGh1Yi5jb20vZGVub2xhbmQvZGVuby9ibG9iL2IzNDYyOGEyNmFiMDE4N2E4MjdhYTRlYmUyNTZlMjMxNzhlMjVkMzkvY2xpL2pzL3dlYi9oZWFkZXJzLnRzI0w5XG5jb25zdCBpbnZhbGlkSGVhZGVyQ2hhclJlZ2V4ID0gL1teXFx0XFx4MjAtXFx4N2VcXHg4MC1cXHhmZl0vZztcblxuZnVuY3Rpb24gc3RyKGJ1ZjogVWludDhBcnJheSB8IG51bGwgfCB1bmRlZmluZWQpOiBzdHJpbmcge1xuICByZXR1cm4gIWJ1ZiA/IFwiXCIgOiBkZWNvZGVyLmRlY29kZShidWYpO1xufVxuXG5leHBvcnQgY2xhc3MgVGV4dFByb3RvUmVhZGVyIHtcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgcjogQnVmUmVhZGVyKSB7fVxuXG4gIC8qKiByZWFkTGluZSgpIHJlYWRzIGEgc2luZ2xlIGxpbmUgZnJvbSB0aGUgVGV4dFByb3RvUmVhZGVyLFxuICAgKiBlbGlkaW5nIHRoZSBmaW5hbCBcXG4gb3IgXFxyXFxuIGZyb20gdGhlIHJldHVybmVkIHN0cmluZy5cbiAgICovXG4gIGFzeW5jIHJlYWRMaW5lKCk6IFByb21pc2U8c3RyaW5nIHwgbnVsbD4ge1xuICAgIGNvbnN0IHMgPSBhd2FpdCB0aGlzLnJlYWRMaW5lU2xpY2UoKTtcbiAgICByZXR1cm4gcyA9PT0gbnVsbCA/IG51bGwgOiBzdHIocyk7XG4gIH1cblxuICAvKiogUmVhZE1JTUVIZWFkZXIgcmVhZHMgYSBNSU1FLXN0eWxlIGhlYWRlciBmcm9tIHIuXG4gICAqIFRoZSBoZWFkZXIgaXMgYSBzZXF1ZW5jZSBvZiBwb3NzaWJseSBjb250aW51ZWQgS2V5OiBWYWx1ZSBsaW5lc1xuICAgKiBlbmRpbmcgaW4gYSBibGFuayBsaW5lLlxuICAgKiBUaGUgcmV0dXJuZWQgbWFwIG0gbWFwcyBDYW5vbmljYWxNSU1FSGVhZGVyS2V5KGtleSkgdG8gYVxuICAgKiBzZXF1ZW5jZSBvZiB2YWx1ZXMgaW4gdGhlIHNhbWUgb3JkZXIgZW5jb3VudGVyZWQgaW4gdGhlIGlucHV0LlxuICAgKlxuICAgKiBGb3IgZXhhbXBsZSwgY29uc2lkZXIgdGhpcyBpbnB1dDpcbiAgICpcbiAgICpcdE15LUtleTogVmFsdWUgMVxuICAgKlx0TG9uZy1LZXk6IEV2ZW5cbiAgICpcdCAgICAgICBMb25nZXIgVmFsdWVcbiAgICpcdE15LUtleTogVmFsdWUgMlxuICAgKlxuICAgKiBHaXZlbiB0aGF0IGlucHV0LCBSZWFkTUlNRUhlYWRlciByZXR1cm5zIHRoZSBtYXA6XG4gICAqXG4gICAqXHRtYXBbc3RyaW5nXVtdc3RyaW5ne1xuICAgKlx0XHRcIk15LUtleVwiOiB7XCJWYWx1ZSAxXCIsIFwiVmFsdWUgMlwifSxcbiAgICpcdFx0XCJMb25nLUtleVwiOiB7XCJFdmVuIExvbmdlciBWYWx1ZVwifSxcbiAgICpcdH1cbiAgICovXG4gIGFzeW5jIHJlYWRNSU1FSGVhZGVyKCk6IFByb21pc2U8SGVhZGVycyB8IG51bGw+IHtcbiAgICBjb25zdCBtID0gbmV3IEhlYWRlcnMoKTtcbiAgICBsZXQgbGluZTogVWludDhBcnJheSB8IHVuZGVmaW5lZDtcblxuICAgIC8vIFRoZSBmaXJzdCBsaW5lIGNhbm5vdCBzdGFydCB3aXRoIGEgbGVhZGluZyBzcGFjZS5cbiAgICBsZXQgYnVmID0gYXdhaXQgdGhpcy5yLnBlZWsoMSk7XG4gICAgaWYgKGJ1ZiA9PT0gbnVsbCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfSBlbHNlIGlmIChXSElURVNQQUNFUy5pbmNsdWRlcyhidWZbMF0pKSB7XG4gICAgICBsaW5lID0gKGF3YWl0IHRoaXMucmVhZExpbmVTbGljZSgpKSBhcyBVaW50OEFycmF5O1xuICAgIH1cblxuICAgIGJ1ZiA9IGF3YWl0IHRoaXMuci5wZWVrKDEpO1xuICAgIGlmIChidWYgPT09IG51bGwpIHtcbiAgICAgIHRocm93IG5ldyBEZW5vLmVycm9ycy5VbmV4cGVjdGVkRW9mKCk7XG4gICAgfSBlbHNlIGlmIChXSElURVNQQUNFUy5pbmNsdWRlcyhidWZbMF0pKSB7XG4gICAgICB0aHJvdyBuZXcgRGVuby5lcnJvcnMuSW52YWxpZERhdGEoXG4gICAgICAgIGBtYWxmb3JtZWQgTUlNRSBoZWFkZXIgaW5pdGlhbCBsaW5lOiAke3N0cihsaW5lKX1gLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgY29uc3Qga3YgPSBhd2FpdCB0aGlzLnJlYWRMaW5lU2xpY2UoKTsgLy8gcmVhZENvbnRpbnVlZExpbmVTbGljZVxuICAgICAgaWYgKGt2ID09PSBudWxsKSB0aHJvdyBuZXcgRGVuby5lcnJvcnMuVW5leHBlY3RlZEVvZigpO1xuICAgICAgaWYgKGt2LmJ5dGVMZW5ndGggPT09IDApIHJldHVybiBtO1xuXG4gICAgICAvLyBLZXkgZW5kcyBhdCBmaXJzdCBjb2xvblxuICAgICAgbGV0IGkgPSBrdi5pbmRleE9mKENIQVJfQ09MT04pO1xuICAgICAgaWYgKGkgPCAwKSB7XG4gICAgICAgIHRocm93IG5ldyBEZW5vLmVycm9ycy5JbnZhbGlkRGF0YShcbiAgICAgICAgICBgbWFsZm9ybWVkIE1JTUUgaGVhZGVyIGxpbmU6ICR7c3RyKGt2KX1gLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvL2xldCBrZXkgPSBjYW5vbmljYWxNSU1FSGVhZGVyS2V5KGt2LnN1YmFycmF5KDAsIGVuZEtleSkpO1xuICAgICAgY29uc3Qga2V5ID0gc3RyKGt2LnN1YmFycmF5KDAsIGkpKTtcblxuICAgICAgLy8gQXMgcGVyIFJGQyA3MjMwIGZpZWxkLW5hbWUgaXMgYSB0b2tlbixcbiAgICAgIC8vIHRva2VucyBjb25zaXN0IG9mIG9uZSBvciBtb3JlIGNoYXJzLlxuICAgICAgLy8gV2UgY291bGQgdGhyb3cgYERlbm8uZXJyb3JzLkludmFsaWREYXRhYCBoZXJlLFxuICAgICAgLy8gYnV0IGJldHRlciB0byBiZSBsaWJlcmFsIGluIHdoYXQgd2VcbiAgICAgIC8vIGFjY2VwdCwgc28gaWYgd2UgZ2V0IGFuIGVtcHR5IGtleSwgc2tpcCBpdC5cbiAgICAgIGlmIChrZXkgPT0gXCJcIikge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgLy8gU2tpcCBpbml0aWFsIHNwYWNlcyBpbiB2YWx1ZS5cbiAgICAgIGkrKzsgLy8gc2tpcCBjb2xvblxuICAgICAgd2hpbGUgKFxuICAgICAgICBpIDwga3YuYnl0ZUxlbmd0aCAmJlxuICAgICAgICAoV0hJVEVTUEFDRVMuaW5jbHVkZXMoa3ZbaV0pKVxuICAgICAgKSB7XG4gICAgICAgIGkrKztcbiAgICAgIH1cbiAgICAgIGNvbnN0IHZhbHVlID0gc3RyKGt2LnN1YmFycmF5KGkpKS5yZXBsYWNlKFxuICAgICAgICBpbnZhbGlkSGVhZGVyQ2hhclJlZ2V4LFxuICAgICAgICBlbmNvZGVVUkksXG4gICAgICApO1xuXG4gICAgICAvLyBJbiBjYXNlIG9mIGludmFsaWQgaGVhZGVyIHdlIHN3YWxsb3cgdGhlIGVycm9yXG4gICAgICAvLyBleGFtcGxlOiBcIkF1ZGlvIE1vZGVcIiA9PiBpbnZhbGlkIGR1ZSB0byBzcGFjZSBpbiB0aGUga2V5XG4gICAgICB0cnkge1xuICAgICAgICBtLmFwcGVuZChrZXksIHZhbHVlKTtcbiAgICAgIH0gY2F0Y2gge1xuICAgICAgICAvLyBQYXNzXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcmVhZExpbmVTbGljZSgpOiBQcm9taXNlPFVpbnQ4QXJyYXkgfCBudWxsPiB7XG4gICAgbGV0IGxpbmUgPSBuZXcgVWludDhBcnJheSgwKTtcbiAgICBsZXQgcjogUmVhZExpbmVSZXN1bHQgfCBudWxsID0gbnVsbDtcblxuICAgIGRvIHtcbiAgICAgIHIgPSBhd2FpdCB0aGlzLnIucmVhZExpbmUoKTtcbiAgICAgIC8vIFRPRE8ocnkpOlxuICAgICAgLy8gVGhpcyBza2lwU3BhY2UoKSBpcyBkZWZpbml0ZWx5IG1pc3BsYWNlZCwgYnV0IEkgZG9uJ3Qga25vdyB3aGVyZSBpdFxuICAgICAgLy8gY29tZXMgZnJvbSBub3IgaG93IHRvIGZpeCBpdC5cblxuICAgICAgLy9UT0RPKFNtYXNoaW5nUXVhc2FyKTogS2VwdCBza2lwU3BhY2UgdG8gcHJlc2VydmUgYmVoYXZpb3IgYnV0IGl0IHNob3VsZCBiZSBsb29rZWQgaW50byB0byBjaGVjayBpZiBpdCBtYWtlcyBzZW5zZSB3aGVuIHRoaXMgaXMgdXNlZC5cblxuICAgICAgaWYgKHIgIT09IG51bGwgJiYgdGhpcy5za2lwU3BhY2Uoci5saW5lKSAhPT0gMCkge1xuICAgICAgICBsaW5lID0gY29uY2F0KGxpbmUsIHIubGluZSk7XG4gICAgICB9XG4gICAgfSB3aGlsZSAociAhPT0gbnVsbCAmJiByLm1vcmUpO1xuXG4gICAgcmV0dXJuIHIgPT09IG51bGwgPyBudWxsIDogbGluZTtcbiAgfVxuXG4gIHNraXBTcGFjZShsOiBVaW50OEFycmF5KTogbnVtYmVyIHtcbiAgICBsZXQgbiA9IDA7XG5cbiAgICBmb3IgKGNvbnN0IHZhbCBvZiBsKSB7XG4gICAgICBpZiAoIVdISVRFU1BBQ0VTLmluY2x1ZGVzKHZhbCkpIHtcbiAgICAgICAgbisrO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBuO1xuICB9XG59XG4iXX0=