import { BufReader } from "./buf_reader.ts";
import { getFilename } from "./content_disposition.ts";
import { equals, extension, writeAll } from "./deps.ts";
import { readHeaders, toParamRegExp, unquote } from "./headers.ts";
import { httpErrors } from "./httpError.ts";
import { getRandomFilename, skipLWSPChar, stripEol } from "./util.ts";
const decoder = new TextDecoder();
const encoder = new TextEncoder();
const BOUNDARY_PARAM_REGEX = toParamRegExp("boundary", "i");
const DEFAULT_BUFFER_SIZE = 1_048_576;
const DEFAULT_MAX_FILE_SIZE = 10_485_760;
const DEFAULT_MAX_SIZE = 0;
const NAME_PARAM_REGEX = toParamRegExp("name", "i");
function append(a, b) {
    const ab = new Uint8Array(a.length + b.length);
    ab.set(a, 0);
    ab.set(b, a.length);
    return ab;
}
function isEqual(a, b) {
    return equals(skipLWSPChar(a), b);
}
async function readToStartOrEnd(body, start, end) {
    let lineResult;
    while ((lineResult = await body.readLine())) {
        if (isEqual(lineResult.bytes, start)) {
            return true;
        }
        if (isEqual(lineResult.bytes, end)) {
            return false;
        }
    }
    throw new httpErrors.BadRequest("Unable to find multi-part boundary.");
}
async function* parts({ body, customContentTypes = {}, final, part, maxFileSize, maxSize, outPath, prefix, }) {
    async function getFile(contentType) {
        const ext = customContentTypes[contentType.toLowerCase()] ??
            extension(contentType);
        if (!ext) {
            throw new httpErrors.BadRequest(`The form contained content type "${contentType}" which is not supported by the server.`);
        }
        if (!outPath) {
            outPath = await Deno.makeTempDir();
        }
        const filename = `${outPath}/${await getRandomFilename(prefix, ext)}`;
        const file = await Deno.open(filename, { write: true, createNew: true });
        return [filename, file];
    }
    while (true) {
        const headers = await readHeaders(body);
        const contentType = headers["content-type"];
        const contentDisposition = headers["content-disposition"];
        if (!contentDisposition) {
            throw new httpErrors.BadRequest("Form data part missing content-disposition header");
        }
        if (!contentDisposition.match(/^form-data;/i)) {
            throw new httpErrors.BadRequest(`Unexpected content-disposition header: "${contentDisposition}"`);
        }
        const matches = NAME_PARAM_REGEX.exec(contentDisposition);
        if (!matches) {
            throw new httpErrors.BadRequest(`Unable to determine name of form body part`);
        }
        let [, name] = matches;
        name = unquote(name);
        if (contentType) {
            const originalName = getFilename(contentDisposition);
            let byteLength = 0;
            let file;
            let filename;
            let buf;
            if (maxSize) {
                buf = new Uint8Array();
            }
            else {
                const result = await getFile(contentType);
                filename = result[0];
                file = result[1];
            }
            while (true) {
                const readResult = await body.readLine(false);
                if (!readResult) {
                    throw new httpErrors.BadRequest("Unexpected EOF reached");
                }
                const { bytes } = readResult;
                const strippedBytes = stripEol(bytes);
                if (isEqual(strippedBytes, part) || isEqual(strippedBytes, final)) {
                    if (file) {
                        const bytesDiff = bytes.length - strippedBytes.length;
                        if (bytesDiff) {
                            const originalBytesSize = await file.seek(-bytesDiff, Deno.SeekMode.Current);
                            await file.truncate(originalBytesSize);
                        }
                        file.close();
                    }
                    yield [
                        name,
                        {
                            content: buf,
                            contentType,
                            name,
                            filename,
                            originalName,
                        },
                    ];
                    if (isEqual(strippedBytes, final)) {
                        return;
                    }
                    break;
                }
                byteLength += bytes.byteLength;
                if (byteLength > maxFileSize) {
                    if (file) {
                        file.close();
                    }
                    throw new httpErrors.RequestEntityTooLarge(`File size exceeds limit of ${maxFileSize} bytes.`);
                }
                if (buf) {
                    if (byteLength > maxSize) {
                        const result = await getFile(contentType);
                        filename = result[0];
                        file = result[1];
                        await writeAll(file, buf);
                        buf = undefined;
                    }
                    else {
                        buf = append(buf, bytes);
                    }
                }
                if (file) {
                    await writeAll(file, bytes);
                }
            }
        }
        else {
            const lines = [];
            while (true) {
                const readResult = await body.readLine();
                if (!readResult) {
                    throw new httpErrors.BadRequest("Unexpected EOF reached");
                }
                const { bytes } = readResult;
                if (isEqual(bytes, part) || isEqual(bytes, final)) {
                    yield [name, lines.join("\n")];
                    if (isEqual(bytes, final)) {
                        return;
                    }
                    break;
                }
                lines.push(decoder.decode(bytes));
            }
        }
    }
}
export class FormDataReader {
    #body;
    #boundaryFinal;
    #boundaryPart;
    #reading = false;
    constructor(contentType, body) {
        const matches = contentType.match(BOUNDARY_PARAM_REGEX);
        if (!matches) {
            throw new httpErrors.BadRequest(`Content type "${contentType}" does not contain a valid boundary.`);
        }
        let [, boundary] = matches;
        boundary = unquote(boundary);
        this.#boundaryPart = encoder.encode(`--${boundary}`);
        this.#boundaryFinal = encoder.encode(`--${boundary}--`);
        this.#body = body;
    }
    async read(options = {}) {
        if (this.#reading) {
            throw new Error("Body is already being read.");
        }
        this.#reading = true;
        const { outPath, maxFileSize = DEFAULT_MAX_FILE_SIZE, maxSize = DEFAULT_MAX_SIZE, bufferSize = DEFAULT_BUFFER_SIZE, customContentTypes, } = options;
        const body = new BufReader(this.#body, bufferSize);
        const result = { fields: {} };
        if (!(await readToStartOrEnd(body, this.#boundaryPart, this.#boundaryFinal))) {
            return result;
        }
        try {
            for await (const part of parts({
                body,
                customContentTypes,
                part: this.#boundaryPart,
                final: this.#boundaryFinal,
                maxFileSize,
                maxSize,
                outPath,
            })) {
                const [key, value] = part;
                if (typeof value === "string") {
                    result.fields[key] = value;
                }
                else {
                    if (!result.files) {
                        result.files = [];
                    }
                    result.files.push(value);
                }
            }
        }
        catch (err) {
            if (err instanceof Deno.errors.PermissionDenied) {
                console.error(err.stack ? err.stack : `${err.name}: ${err.message}`);
            }
            else {
                throw err;
            }
        }
        return result;
    }
    async *stream(options = {}) {
        if (this.#reading) {
            throw new Error("Body is already being read.");
        }
        this.#reading = true;
        const { outPath, customContentTypes, maxFileSize = DEFAULT_MAX_FILE_SIZE, maxSize = DEFAULT_MAX_SIZE, bufferSize = 32000, } = options;
        const body = new BufReader(this.#body, bufferSize);
        if (!(await readToStartOrEnd(body, this.#boundaryPart, this.#boundaryFinal))) {
            return;
        }
        try {
            for await (const part of parts({
                body,
                customContentTypes,
                part: this.#boundaryPart,
                final: this.#boundaryFinal,
                maxFileSize,
                maxSize,
                outPath,
            })) {
                yield part;
            }
        }
        catch (err) {
            if (err instanceof Deno.errors.PermissionDenied) {
                console.error(err.stack ? err.stack : `${err.name}: ${err.message}`);
            }
            else {
                throw err;
            }
        }
    }
    [Symbol.for("Deno.customInspect")](inspect) {
        return `${this.constructor.name} ${inspect({})}`;
    }
    [Symbol.for("nodejs.util.inspect.custom")](depth, options, inspect) {
        if (depth < 0) {
            return options.stylize(`[${this.constructor.name}]`, "special");
        }
        const newOptions = Object.assign({}, options, {
            depth: options.depth === null ? null : options.depth - 1,
        });
        return `${options.stylize(this.constructor.name, "special")} ${inspect({}, newOptions)}`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXVsdGlwYXJ0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibXVsdGlwYXJ0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxTQUFTLEVBQWtCLE1BQU0saUJBQWlCLENBQUM7QUFDNUQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN4RCxPQUFPLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxPQUFPLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDbkUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRXRFLE1BQU0sT0FBTyxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7QUFDbEMsTUFBTSxPQUFPLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztBQUVsQyxNQUFNLG9CQUFvQixHQUFHLGFBQWEsQ0FBQyxVQUFVLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDNUQsTUFBTSxtQkFBbUIsR0FBRyxTQUFTLENBQUM7QUFDdEMsTUFBTSxxQkFBcUIsR0FBRyxVQUFVLENBQUM7QUFDekMsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLENBQUM7QUFDM0IsTUFBTSxnQkFBZ0IsR0FBRyxhQUFhLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBNkhwRCxTQUFTLE1BQU0sQ0FBQyxDQUFhLEVBQUUsQ0FBYTtJQUMxQyxNQUFNLEVBQUUsR0FBRyxJQUFJLFVBQVUsQ0FBQyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUMvQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNiLEVBQUUsQ0FBQyxHQUFH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Q0FBQyxDQUFDLENBQ3hDLEtBQWEsRUFFYixPQUFZLEVBQ1osT0FBc0Q7UUFFdEQsSUFBSSxLQUFLLEdBQUcsQ0FBQyxFQUFFO1lBQ2IsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEdBQUcsRUFBRSxTQUFTLENBQUMsQ0FBQztTQUNqRTtRQUVELE1BQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLE9BQU8sRUFBRTtZQUM1QyxLQUFLLEVBQUUsT0FBTyxDQUFDLEtBQUssS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssR0FBRyxDQUFDO1NBQ3pELENBQUMsQ0FBQztRQUNILE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxJQUN6RCxPQUFPLENBQUMsRUFBRSxFQUFFLFVBQVUsQ0FDeEIsRUFBRSxDQUFDO0lBQ0wsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTgtMjAyMiB0aGUgb2FrIGF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuIE1JVCBsaWNlbnNlLlxuXG5pbXBvcnQgeyBCdWZSZWFkZXIsIFJlYWRMaW5lUmVzdWx0IH0gZnJvbSBcIi4vYnVmX3JlYWRlci50c1wiO1xuaW1wb3J0IHsgZ2V0RmlsZW5hbWUgfSBmcm9tIFwiLi9jb250ZW50X2Rpc3Bvc2l0aW9uLnRzXCI7XG5pbXBvcnQgeyBlcXVhbHMsIGV4dGVuc2lvbiwgd3JpdGVBbGwgfSBmcm9tIFwiLi9kZXBzLnRzXCI7XG5pbXBvcnQgeyByZWFkSGVhZGVycywgdG9QYXJhbVJlZ0V4cCwgdW5xdW90ZSB9IGZyb20gXCIuL2hlYWRlcnMudHNcIjtcbmltcG9ydCB7IGh0dHBFcnJvcnMgfSBmcm9tIFwiLi9odHRwRXJyb3IudHNcIjtcbmltcG9ydCB7IGdldFJhbmRvbUZpbGVuYW1lLCBza2lwTFdTUENoYXIsIHN0cmlwRW9sIH0gZnJvbSBcIi4vdXRpbC50c1wiO1xuXG5jb25zdCBkZWNvZGVyID0gbmV3IFRleHREZWNvZGVyKCk7XG5jb25zdCBlbmNvZGVyID0gbmV3IFRleHRFbmNvZGVyKCk7XG5cbmNvbnN0IEJPVU5EQVJZX1BBUkFNX1JFR0VYID0gdG9QYXJhbVJlZ0V4cChcImJvdW5kYXJ5XCIsIFwiaVwiKTtcbmNvbnN0IERFRkFVTFRfQlVGRkVSX1NJWkUgPSAxXzA0OF81NzY7IC8vIDFtYlxuY29uc3QgREVGQVVMVF9NQVhfRklMRV9TSVpFID0gMTBfNDg1Xzc2MDsgLy8gMTBtYlxuY29uc3QgREVGQVVMVF9NQVhfU0laRSA9IDA7IC8vIGFsbCBmaWxlcyB3cml0dGVuIHRvIGRpc2NcbmNvbnN0IE5BTUVfUEFSQU1fUkVHRVggPSB0b1BhcmFtUmVnRXhwKFwibmFtZVwiLCBcImlcIik7XG5cbi8qKiBXaGVuIHJlYWRpbmcgYSBib2R5IGluIGZ1bGwgdmlhIGAucmVhZCgpYCBmcm9tIGEge0BsaW5rY29kZSBGb3JtRGF0YVJlYWRlcn1cbiAqIHRoaXMgaXMgd2hhdCBpcyB3aGF0IHRoZSB2YWx1ZSBpcyByZXNvbHZlZCwgcHJvdmlkaW5nIGEgc3BsaXQgYmV0d2VlbiBhbnlcbiAqIGZpZWxkcywgYW5kIG11bHRpLXBhcnQgZmlsZXMgdGhhdCB3ZXJlIHByb3ZpZGVkLiAqL1xuZXhwb3J0IGludGVyZmFjZSBGb3JtRGF0YUJvZHkge1xuICAvKiogQSByZWNvcmQgb2YgZm9ybSBwYXJ0cyB3aGVyZSB0aGUga2V5IHdhcyB0aGUgYG5hbWVgIG9mIHRoZSBwYXJ0IGFuZCB0aGVcbiAgICogdmFsdWUgd2FzIHRoZSB2YWx1ZSBvZiB0aGUgcGFydC4gVGhpcyByZWNvcmQgZG9lcyBub3QgaW5jbHVkZSBhbnkgZmlsZXNcbiAgICogdGhhdCB3ZXJlIHBhcnQgb2YgdGhlIGZvcm0gZGF0YS5cbiAgICpcbiAgICogKk5vdGUqOiBEdXBsaWNhdGUgbmFtZXMgYXJlIG5vdCBpbmNsdWRlZCBpbiB0aGlzIHJlY29yZCwgaWYgdGhlcmUgYXJlXG4gICAqIGR1cGxpY2F0ZXMsIHRoZSBsYXN0IHZhbHVlIHdpbGwgYmUgdGhlIHZhbHVlIHRoYXQgaXMgc2V0IGhlcmUuICBJZiB0aGVyZVxuICAgKiBpcyBhIHBvc3NpYmlsaXR5IG9mIGR1cGxpY2F0ZSB2YWx1ZXMsIHVzZSB0aGUgYC5zdHJlYW0oKWAgbWV0aG9kIG9uXG4gICAqIHtAbGlua2NvZGUgRm9ybURhdGFSZWFkZXJ9IHRvIGl0ZXJhdGUgb3ZlciB0aGUgdmFsdWVzLiAqL1xuICBmaWVsZHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG5cbiAgLyoqIEFuIGFycmF5IG9mIGFueSBmaWxlcyB0aGF0IHdlcmUgcGFydCBvZiB0aGUgZm9ybSBkYXRhLiAqL1xuICBmaWxlcz86IEZvcm1EYXRhRmlsZVtdO1xufVxuXG4vKiogQSByZXByZXNlbnRhdGlvbiBvZiBhIGZpbGUgdGhhdCBoYXMgYmVlbiByZWFkIGZyb20gYSBmb3JtIGRhdGEgYm9keS4gQmFzZWRcbiAqIG9uIHRoZSB7QGxpbmtjb2RlIEZvcm1EYXRhUmVhZE9wdGlvbnN9IHRoYXQgd2VyZSBwYXNzZWQgd2hlbiByZWFkaW5nIHdpbGxcbiAqIGRldGVybWluZSBpZiBmaWxlcyBhcmUgd3JpdHRlbiB0byBkaXNrIG9yIG5vdCBhbmQgaG93IHRoZXkgYXJlIHdyaXR0ZW4gdG9cbiAqIGRpc2suICBXaGVuIHdyaXR0ZW4gdG8gZGlzaywgdGhlIGV4dGVuc2lvbiBvZiB0aGUgZmlsZSB3aWxsIGJlIGRldGVybWluZWQgYnlcbiAqIHRoZSBjb250ZW50IHR5cGUsIHdpdGggdGhlIGAuZmlsZW5hbWVgIHByb3BlcnR5IGNvbnRhaW5pbmcgdGhlIGZ1bGwgcGF0aCB0b1xuICogdGhlIGZpbGUuXG4gKlxuICogVGhlIG9yaWdpbmFsIGZpbGVuYW1lIGFzIHBhcnQgb2YgdGhlIGZvcm0gZGF0YSBpcyBhdmFpbGFibGUgaW5cbiAqIGBvcmlnaW5hbE5hbWVgLCBidXQgZm9yIHNlY3VyaXR5IGFuZCBzdGFiaWxpdHkgcmVhc29ucywgaXQgaXMgbm90IHVzZWQgdG9cbiAqIGRldGVybWluZSB0aGUgbmFtZSBvZiB0aGUgZmlsZSBvbiBkaXNrLiBJZiBmdXJ0aGVyIHByb2Nlc3Npbmcgb3IgcmVuYW1pbmdcbiAqIGlzIHJlcXVpcmVkLCB0aGUgaW1wbGVtZW50b3Igc2hvdWxkIGRvIHRoYXQgcHJvY2Vzc2luZy4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRm9ybURhdGFGaWxlIHtcbiAgLyoqIFdoZW4gdGhlIGZpbGUgaGFzIG5vdCBiZWVuIHdyaXR0ZW4gb3V0IHRvIGRpc2MsIHRoZSBjb250ZW50cyBvZiB0aGUgZmlsZVxuICAgKiBhcyBhIHtAbGlua2NvZGUgVWludDhBcnJheX0uICovXG4gIGNvbnRlbnQ/OiBVaW50OEFycmF5O1xuXG4gIC8qKiBUaGUgY29udGVudCB0eXBlIG9nIHRoZSBmb3JtIGRhdGEgZmlsZS4gKi9cbiAgY29udGVudFR5cGU6IHN0cmluZztcblxuICAvKiogV2hlbiB0aGUgZmlsZSBoYXMgYmVlbiB3cml0dGVuIG91dCB0byBkaXNjLCB0aGUgZnVsbCBwYXRoIHRvIHRoZSBmaWxlLiAqL1xuICBmaWxlbmFtZT86IHN0cmluZztcblxuICAvKiogVGhlIGBuYW1lYCB0aGF0IHdhcyBhc3NpZ25lZCB0byB0aGUgZm9ybSBkYXRhIGZpbGUuICovXG4gIG5hbWU6IHN0cmluZztcblxuICAvKiogVGhlIGBmaWxlbmFtZWAgdGhhdCB3YXMgcHJvdmlkZWQgaW4gdGhlIGZvcm0gZGF0YSBmaWxlLiAqL1xuICBvcmlnaW5hbE5hbWU6IHN0cmluZztcbn1cblxuLyoqIE9wdGlvbnMgd2hpY2ggaW1wYWN0IGhvdyB0aGUgZm9ybSBkYXRhIGlzIGRlY29kZWQgZm9yIGFcbiAqIHtAbGlua2NvZGUgRm9ybURhdGFSZWFkZXJ9LiBBbGwgdGhlc2Ugb3B0aW9ucyBoYXZlIHNlbnNpYmxlIGRlZmF1bHRzIGZvclxuICogbW9zdCBhcHBsaWNhdGlvbnMsIGJ1dCBjYW4gYmUgbW9kaWZpZWQgZm9yIGRpZmZlcmVudCB1c2UgY2FzZXMuIE1hbnkgb2YgdGhlc2VcbiAqIG9wdGlvbnMgY2FuIGhhdmUgYW4gaW1wYWN0IG9uIHRoZSBzdGFiaWxpdHkgb2YgYSBzZXJ2ZXIsIGVzcGVjaWFsbHkgaWYgdGhlcmVcbiAqIGlzIHNvbWVvbmUgYXR0ZW1wdGluZyBhIGRlbmlhbCBvZiBzZXJ2aWNlIGF0dGFjayBvbiB5b3VyIHNlcnZlciwgc28gYmVcbiAqIGNhcmVmdWwgd2hlbiBjaGFuZ2luZyB0aGUgZGVmYXVsdHMuICovXG5leHBvcnQgaW50ZXJmYWNlIEZvcm1EYXRhUmVhZE9wdGlvbnMge1xuICAvKiogVGhlIHNpemUgb2YgdGhlIGJ1ZmZlciB0byByZWFkIGZyb20gdGhlIHJlcXVlc3QgYm9keSBhdCBhIHNpbmdsZSB0aW1lLlxuICAgKiBUaGlzIGRlZmF1bHRzIHRvIDFtYi4gKi9cbiAgYnVmZmVyU2l6ZT86IG51bWJlcjtcblxuICAvKiogQSBtYXBwaW5nIG9mIGN1c3RvbSBtZWRpYSB0eXBlcyB0aGF0IGFyZSBzdXBwb3J0ZWQsIG1hcHBlZCB0byB0aGVpclxuICAgKiBleHRlbnNpb24gd2hlbiBkZXRlcm1pbmluZyB0aGUgZXh0ZW5zaW9uIGZvciBhIGZpbGUuIFRoZSBrZXkgc2hvdWxkIGJlIGFuXG4gICAqIGFsbCBsb3dlcmNhc2UgbWVkaWEgdHlwZSB3aXRoIHRoZSB2YWx1ZSBiZWluZyB0aGUgZXh0ZW5zaW9uICh3aXRob3V0IGFuXG4gICAqIGluaXRpYWwgcGVyaW9kKSwgdG8gYmUgdXNlZCB3aGVuIGRlY29kaW5nIHRoZSBmaWxlLlxuICAgKlxuICAgKiAjIyMgRXhhbXBsZVxuICAgKlxuICAgKiBGb3JtIGRhdGEgdGhhdCBpcyBzZW50IHdpdGggY29udGVudCBoYXZpbmcgYSB0eXBlIG9mIGB0ZXh0L3Zkbi5jdXN0b21gIHdpbGxcbiAgICogYmUgZGVjb2RlZCBhbmQgYXNzaWduZWQgYSBmaWxlbmFtZSBlbmRpbmcgd2l0aCBgLnR4dGA6XG4gICAqXG4gICAqIGBgYHRzXG4gICAqIGltcG9ydCB7IEFwcGxpY2F0aW9uIH0gZnJvbSBcImh0dHBzOi8vZGVuby5sYW5kL3gvb2FrL21vZC50c1wiO1xuICAgKlxuICAgKiBjb25zdCBhcHAgPSBuZXcgQXBwbGljYXRpb24oKTtcbiAgICogYXBwLnVzZShhc3luYyAoY3R4KSA9PiB7XG4gICAqICAgY29uc3QgYm9keSA9IGN0eC5yZXF1ZXN0LmJvZHkoKTtcbiAgICogICBpZiAoYm9keS50eXBlID09PSBcImZvcm0tZGF0YVwiKSB7XG4gICAqICAgICBjb25zdCBmb3JtYXREYXRhID0gYXdhaXQgYm9keS52YWx1ZS5yZWFkKHtcbiAgICogICAgICAgY3VzdG9tQ29udGVudFR5cGVzOiB7XG4gICAqICAgICAgICAgXCJ0ZXh0L3ZuZC5jdXN0b21cIjogXCJ0eHRcIlxuICAgKiAgICAgICB9XG4gICAqICAgICB9KTtcbiAgICogICAgIGNvbnNvbGUubG9nKGZvcm1EYXRhKTtcbiAgICogICB9XG4gICAqIH0pO1xuICAgKiBgYGBcbiAgICovXG4gIGN1c3RvbUNvbnRlbnRUeXBlcz86IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG5cbiAgLyoqIFRoZSBtYXhpbXVtIGZpbGUgc2l6ZSB0aGF0IGNhbiBiZSBoYW5kbGVkLiAgVGhpcyBkZWZhdWx0cyB0byAxME1CIHdoZW5cbiAgICogbm90IHNwZWNpZmllZC4gIFRoaXMgaXMgdG8gdHJ5IHRvIGF2b2lkIERPUyBhdHRhY2tzIHdoZXJlIHNvbWVvbmUgd291bGRcbiAgICogY29udGludWUgdG8gdHJ5IHRvIHNlbmQgYSBcImZpbGVcIiBjb250aW51b3VzbHkgdW50aWwgYSBob3N0IGxpbWl0IHdhc1xuICAgKiByZWFjaGVkIGNyYXNoaW5nIHRoZSBzZXJ2ZXIgb3IgdGhlIGhvc3QuICovXG4gIG1heEZpbGVTaXplPzogbnVtYmVyO1xuXG4gIC8qKiBUaGUgbWF4aW11bSBzaXplIG9mIGEgZmlsZSB0byBob2xkIGluIG1lbW9yeSwgYW5kIG5vdCB3cml0ZSB0byBkaXNrLiBUaGlzXG4gICAqIGRlZmF1bHRzIHRvIGAwYCwgc28gdGhhdCBhbGwgbXVsdGlwYXJ0IGZvcm0gZmlsZXMgYXJlIHdyaXR0ZW4gdG8gZGlzay5cbiAgICogV2hlbiBzZXQgdG8gYSBwb3NpdGl2ZSBpbnRlZ2VyLCBpZiB0aGUgZm9ybSBkYXRhIGZpbGUgaXMgc21hbGxlciwgaXQgd2lsbFxuICAgKiBiZSByZXRhaW5lZCBpbiBtZW1vcnkgYW5kIGF2YWlsYWJsZSBpbiB0aGUgYC5jb250ZW50YCBwcm9wZXJ0eSBvZiB0aGVcbiAgICogYEZvcm1EYXRhRmlsZWAgb2JqZWN0LiAgSWYgdGhlIGZpbGUgZXhjZWVkcyB0aGUgYG1heFNpemVgIGl0IHdpbGwgYmVcbiAgICogd3JpdHRlbiB0byBkaXNrIGFuZCB0aGUgYGZpbGVuYW1lYCBmaWxlIHdpbGwgY29udGFpbiB0aGUgZnVsbCBwYXRoIHRvIHRoZVxuICAgKiBvdXRwdXQgZmlsZS4gKi9cbiAgbWF4U2l6ZT86IG51bWJlcjtcblxuICAvKiogV2hlbiB3cml0aW5nIGZvcm0gZGF0YSBmaWxlcyB0byBkaXNrLCB0aGUgb3V0cHV0IHBhdGguICBUaGlzIHdpbGwgZGVmYXVsdFxuICAgKiB0byBhIHRlbXBvcmFyeSBwYXRoIGdlbmVyYXRlZCBieSBgRGVuby5tYWtlVGVtcERpcigpYC4gKi9cbiAgb3V0UGF0aD86IHN0cmluZztcblxuICAvKiogV2hlbiBhIGZvcm0gZGF0YSBmaWxlIGlzIHdyaXR0ZW4gdG8gZGlzaywgaXQgd2lsbCBiZSBnZW5lcmF0ZWQgd2l0aCBhXG4gICAqIHJhbmRvbSBmaWxlbmFtZSBhbmQgaGF2ZSBhbiBleHRlbnNpb24gYmFzZWQgb2ZmIHRoZSBjb250ZW50IHR5cGUgZm9yIHRoZVxuICAgKiBmaWxlLiAgYHByZWZpeGAgY2FuIGJlIHNwZWNpZmllZCB0aG91Z2ggdG8gcHJlcGVuZCB0byB0aGUgZmlsZSBuYW1lLiAqL1xuICBwcmVmaXg/OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBQYXJ0c09wdGlvbnMge1xuICBib2R5OiBCdWZSZWFkZXI7XG4gIGN1c3RvbUNvbnRlbnRUeXBlcz86IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG4gIGZpbmFsOiBVaW50OEFycmF5O1xuICBtYXhGaWxlU2l6ZTogbnVtYmVyO1xuICBtYXhTaXplOiBudW1iZXI7XG4gIG91dFBhdGg/OiBzdHJpbmc7XG4gIHBhcnQ6IFVpbnQ4QXJyYXk7XG4gIHByZWZpeD86IHN0cmluZztcbn1cblxuZnVuY3Rpb24gYXBwZW5kKGE6IFVpbnQ4QXJyYXksIGI6IFVpbnQ4QXJyYXkpOiBVaW50OEFycmF5IHtcbiAgY29uc3QgYWIgPSBuZXcgVWludDhBcnJheShhLmxlbmd0aCArIGIubGVuZ3RoKTtcbiAgYWIuc2V0KGEsIDApO1xuICBhYi5zZXQoYiwgYS5sZW5ndGgpO1xuICByZXR1cm4gYWI7XG59XG5cbmZ1bmN0aW9uIGlzRXF1YWwoYTogVWludDhBcnJheSwgYjogVWludDhBcnJheSk6IGJvb2xlYW4ge1xuICByZXR1cm4gZXF1YWxzKHNraXBMV1NQQ2hhcihhKSwgYik7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJlYWRUb1N0YXJ0T3JFbmQoXG4gIGJvZHk6IEJ1ZlJlYWRlcixcbiAgc3RhcnQ6IFVpbnQ4QXJyYXksXG4gIGVuZDogVWludDhBcnJheSxcbik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICBsZXQgbGluZVJlc3VsdDogUmVhZExpbmVSZXN1bHQgfCBudWxsO1xuICB3aGlsZSAoKGxpbmVSZXN1bHQgPSBhd2FpdCBib2R5LnJlYWRMaW5lKCkpKSB7XG4gICAgaWYgKGlzRXF1YWwobGluZVJlc3VsdC5ieXRlcywgc3RhcnQpKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKGlzRXF1YWwobGluZVJlc3VsdC5ieXRlcywgZW5kKSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuICB0aHJvdyBuZXcgaHR0cEVycm9ycy5CYWRSZXF1ZXN0KFxuICAgIFwiVW5hYmxlIHRvIGZpbmQgbXVsdGktcGFydCBib3VuZGFyeS5cIixcbiAgKTtcbn1cblxuLyoqIFlpZWxkIHVwIGluZGl2aWR1YWwgcGFydHMgYnkgcmVhZGluZyB0aGUgYm9keSBhbmQgcGFyc2luZyBvdXQgdGhlIGZvcmRcbiAqIGRhdGEgdmFsdWVzLiAqL1xuYXN5bmMgZnVuY3Rpb24qIHBhcnRzKFxuICB7XG4gICAgYm9keSxcbiAgICBjdXN0b21Db250ZW50VHlwZXMgPSB7fSxcbiAgICBmaW5hbCxcbiAgICBwYXJ0LFxuICAgIG1heEZpbGVTaXplLFxuICAgIG1heFNpemUsXG4gICAgb3V0UGF0aCxcbiAgICBwcmVmaXgsXG4gIH06IFBhcnRzT3B0aW9ucyxcbik6IEFzeW5jSXRlcmFibGVJdGVyYXRvcjxbc3RyaW5nLCBzdHJpbmcgfCBGb3JtRGF0YUZpbGVdPiB7XG4gIGFzeW5jIGZ1bmN0aW9uIGdldEZpbGUoY29udGVudFR5cGU6IHN0cmluZyk6IFByb21pc2U8W3N0cmluZywgRGVuby5Gc0ZpbGVdPiB7XG4gICAgY29uc3QgZXh0ID0gY3VzdG9tQ29udGVudFR5cGVzW2NvbnRlbnRUeXBlLnRvTG93ZXJDYXNlKCldID8/XG4gICAgICBleHRlbnNpb24oY29udGVudFR5cGUpO1xuICAgIGlmICghZXh0KSB7XG4gICAgICB0aHJvdyBuZXcgaHR0cEVycm9ycy5CYWRSZXF1ZXN0KFxuICAgICAgICBgVGhlIGZvcm0gY29udGFpbmVkIGNvbnRlbnQgdHlwZSBcIiR7Y29udGVudFR5cGV9XCIgd2hpY2ggaXMgbm90IHN1cHBvcnRlZCBieSB0aGUgc2VydmVyLmAsXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAoIW91dFBhdGgpIHtcbiAgICAgIG91dFBhdGggPSBhd2FpdCBEZW5vLm1ha2VUZW1wRGlyKCk7XG4gICAgfVxuICAgIGNvbnN0IGZpbGVuYW1lID0gYCR7b3V0UGF0aH0vJHthd2FpdCBnZXRSYW5kb21GaWxlbmFtZShwcmVmaXgsIGV4dCl9YDtcbiAgICBjb25zdCBmaWxlID0gYXdhaXQgRGVuby5vcGVuKGZpbGVuYW1lLCB7IHdyaXRlOiB0cnVlLCBjcmVhdGVOZXc6IHRydWUgfSk7XG4gICAgcmV0dXJuIFtmaWxlbmFtZSwgZmlsZV07XG4gIH1cblxuICB3aGlsZSAodHJ1ZSkge1xuICAgIGNvbnN0IGhlYWRlcnMgPSBhd2FpdCByZWFkSGVhZGVycyhib2R5KTtcbiAgICBjb25zdCBjb250ZW50VHlwZSA9IGhlYWRlcnNbXCJjb250ZW50LXR5cGVcIl07XG4gICAgY29uc3QgY29udGVudERpc3Bvc2l0aW9uID0gaGVhZGVyc1tcImNvbnRlbnQtZGlzcG9zaXRpb25cIl07XG4gICAgaWYgKCFjb250ZW50RGlzcG9zaXRpb24pIHtcbiAgICAgIHRocm93IG5ldyBodHRwRXJyb3JzLkJhZFJlcXVlc3QoXG4gICAgICAgIFwiRm9ybSBkYXRhIHBhcnQgbWlzc2luZyBjb250ZW50LWRpc3Bvc2l0aW9uIGhlYWRlclwiLFxuICAgICAgKTtcbiAgICB9XG4gICAgaWYgKCFjb250ZW50RGlzcG9zaXRpb24ubWF0Y2goL15mb3JtLWRhdGE7L2kpKSB7XG4gICAgICB0aHJvdyBuZXcgaHR0cEVycm9ycy5CYWRSZXF1ZXN0KFxuICAgICAgICBgVW5leHBlY3RlZCBjb250ZW50LWRpc3Bvc2l0aW9uIGhlYWRlcjogXCIke2NvbnRlbnREaXNwb3NpdGlvbn1cImAsXG4gICAgICApO1xuICAgIH1cbiAgICBjb25zdCBtYXRjaGVzID0gTkFNRV9QQVJBTV9SRUdFWC5leGVjKGNvbnRlbnREaXNwb3NpdGlvbik7XG4gICAgaWYgKCFtYXRjaGVzKSB7XG4gICAgICB0aHJvdyBuZXcgaHR0cEVycm9ycy5CYWRSZXF1ZXN0KFxuICAgICAgICBgVW5hYmxlIHRvIGRldGVybWluZSBuYW1lIG9mIGZvcm0gYm9keSBwYXJ0YCxcbiAgICAgICk7XG4gICAgfVxuICAgIGxldCBbLCBuYW1lXSA9IG1hdGNoZXM7XG4gICAgbmFtZSA9IHVucXVvdGUobmFtZSk7XG4gICAgaWYgKGNvbnRlbnRUeXBlKSB7XG4gICAgICBjb25zdCBvcmlnaW5hbE5hbWUgPSBnZXRGaWxlbmFtZShjb250ZW50RGlzcG9zaXRpb24pO1xuICAgICAgbGV0IGJ5dGVMZW5ndGggPSAwO1xuICAgICAgbGV0IGZpbGU6IERlbm8uRnNGaWxlIHwgdW5kZWZpbmVkO1xuICAgICAgbGV0IGZpbGVuYW1lOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgICBsZXQgYnVmOiBVaW50OEFycmF5IHwgdW5kZWZpbmVkO1xuICAgICAgaWYgKG1heFNpemUpIHtcbiAgICAgICAgYnVmID0gbmV3IFVpbnQ4QXJyYXkoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdldEZpbGUoY29udGVudFR5cGUpO1xuICAgICAgICBmaWxlbmFtZSA9IHJlc3VsdFswXTtcbiAgICAgICAgZmlsZSA9IHJlc3VsdFsxXTtcbiAgICAgIH1cbiAgICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICAgIGNvbnN0IHJlYWRSZXN1bHQgPSBhd2FpdCBib2R5LnJlYWRMaW5lKGZhbHNlKTtcbiAgICAgICAgaWYgKCFyZWFkUmVzdWx0KSB7XG4gICAgICAgICAgdGhyb3cgbmV3IGh0dHBFcnJvcnMuQmFkUmVxdWVzdChcIlVuZXhwZWN0ZWQgRU9GIHJlYWNoZWRcIik7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgeyBieXRlcyB9ID0gcmVhZFJlc3VsdDtcbiAgICAgICAgY29uc3Qgc3RyaXBwZWRCeXRlcyA9IHN0cmlwRW9sKGJ5dGVzKTtcbiAgICAgICAgaWYgKGlzRXF1YWwoc3RyaXBwZWRCeXRlcywgcGFydCkgfHwgaXNFcXVhbChzdHJpcHBlZEJ5dGVzLCBmaW5hbCkpIHtcbiAgICAgICAgICBpZiAoZmlsZSkge1xuICAgICAgICAgICAgLy8gcmVtb3ZlIGV4dHJhIDIgYnl0ZXMgKFtDUiwgTEZdKSBmcm9tIHJlc3VsdCBmaWxlXG4gICAgICAgICAgICBjb25zdCBieXRlc0RpZmYgPSBieXRlcy5sZW5ndGggLSBzdHJpcHBlZEJ5dGVzLmxlbmd0aDtcbiAgICAgICAgICAgIGlmIChieXRlc0RpZmYpIHtcbiAgICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWxCeXRlc1NpemUgPSBhd2FpdCBmaWxlLnNlZWsoXG4gICAgICAgICAgICAgICAgLWJ5dGVzRGlmZixcbiAgICAgICAgICAgICAgICBEZW5vLlNlZWtNb2RlLkN1cnJlbnQsXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIGF3YWl0IGZpbGUudHJ1bmNhdGUob3JpZ2luYWxCeXRlc1NpemUpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmaWxlLmNsb3NlKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHlpZWxkIFtcbiAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIGNvbnRlbnQ6IGJ1ZixcbiAgICAgICAgICAgICAgY29udGVudFR5cGUsXG4gICAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICAgIGZpbGVuYW1lLFxuICAgICAgICAgICAgICBvcmlnaW5hbE5hbWUsXG4gICAgICAgICAgICB9IGFzIEZvcm1EYXRhRmlsZSxcbiAgICAgICAgICBdO1xuICAgICAgICAgIGlmIChpc0VxdWFsKHN0cmlwcGVkQnl0ZXMsIGZpbmFsKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBieXRlTGVuZ3RoICs9IGJ5dGVzLmJ5dGVMZW5ndGg7XG4gICAgICAgIGlmIChieXRlTGVuZ3RoID4gbWF4RmlsZVNpemUpIHtcbiAgICAgICAgICBpZiAoZmlsZSkge1xuICAgICAgICAgICAgZmlsZS5jbG9zZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aHJvdyBuZXcgaHR0cEVycm9ycy5SZXF1ZXN0RW50aXR5VG9vTGFyZ2UoXG4gICAgICAgICAgICBgRmlsZSBzaXplIGV4Y2VlZHMgbGltaXQgb2YgJHttYXhGaWxlU2l6ZX0gYnl0ZXMuYCxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGlmIChidWYpIHtcbiAgICAgICAgICBpZiAoYnl0ZUxlbmd0aCA+IG1heFNpemUpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdldEZpbGUoY29udGVudFR5cGUpO1xuICAgICAgICAgICAgZmlsZW5hbWUgPSByZXN1bHRbMF07XG4gICAgICAgICAgICBmaWxlID0gcmVzdWx0WzFdO1xuICAgICAgICAgICAgYXdhaXQgd3JpdGVBbGwoZmlsZSwgYnVmKTtcbiAgICAgICAgICAgIGJ1ZiA9IHVuZGVmaW5lZDtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYnVmID0gYXBwZW5kKGJ1ZiwgYnl0ZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoZmlsZSkge1xuICAgICAgICAgIGF3YWl0IHdyaXRlQWxsKGZpbGUsIGJ5dGVzKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBsaW5lczogc3RyaW5nW10gPSBbXTtcbiAgICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICAgIGNvbnN0IHJlYWRSZXN1bHQgPSBhd2FpdCBib2R5LnJlYWRMaW5lKCk7XG4gICAgICAgIGlmICghcmVhZFJlc3VsdCkge1xuICAgICAgICAgIHRocm93IG5ldyBodHRwRXJyb3JzLkJhZFJlcXVlc3QoXCJVbmV4cGVjdGVkIEVPRiByZWFjaGVkXCIpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHsgYnl0ZXMgfSA9IHJlYWRSZXN1bHQ7XG4gICAgICAgIGlmIChpc0VxdWFsKGJ5dGVzLCBwYXJ0KSB8fCBpc0VxdWFsKGJ5dGVzLCBmaW5hbCkpIHtcbiAgICAgICAgICB5aWVsZCBbbmFtZSwgbGluZXMuam9pbihcIlxcblwiKV07XG4gICAgICAgICAgaWYgKGlzRXF1YWwoYnl0ZXMsIGZpbmFsKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBsaW5lcy5wdXNoKGRlY29kZXIuZGVjb2RlKGJ5dGVzKSk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbi8qKiBBbiBpbnRlcmZhY2Ugd2hpY2ggcHJvdmlkZXMgYW4gaW50ZXJmYWNlIHRvIGFjY2VzcyB0aGUgZmllbGRzIG9mIGFcbiAqIGBtdWx0aXBhcnQvZm9ybS1kYXRhYCBib2R5LlxuICpcbiAqIE5vcm1hbGx5IGFuIGluc3RhbmNlIG9mIHRoaXMgaXMgYWNjZXNzZWQgd2hlbiBoYW5kbGluZyBhIHJlcXVlc3QgYm9keSwgYW5kXG4gKiBkZWFsaW5nIHdpdGggZGVjb2RpbmcgaXQuICBUaGVyZSBhcmUgb3B0aW9ucyB0aGF0IGNhbiBiZSBzZXQgd2hlbiBhdHRlbXB0aW5nXG4gKiB0byByZWFkIGEgbXVsdGktcGFydCBib2R5IChzZWU6IHtAbGlua2NvZGUgRm9ybURhdGFSZWFkT3B0aW9uc30pLlxuICpcbiAqIElmIHlvdSBgLnJlYWQoKWAgdGhlIHZhbHVlLCB0aGVuIGEgcHJvbWlzZSBpcyBwcm92aWRlZCBvZiB0eXBlXG4gKiB7QGxpbmtjb2RlIEZvcm1EYXRhQm9keX0uIElmIHlvdSB1c2UgdGhlIGAuc3RyZWFtKClgIHByb3BlcnR5LCBpdCBpcyBhbiBhc3luY1xuICogaXRlcmF0b3Igd2hpY2ggeWllbGRzIHVwIGEgdHVwbGUgb2Ygd2l0aCB0aGUgZmlyc3QgZWxlbWVudCBiZWluZyBhXG4gKlxuICogIyMjIEV4YW1wbGVzXG4gKlxuICogVXNpbmcgYC5yZWFkKClgOlxuICpcbiAqIGBgYHRzXG4gKiBpbXBvcnQgeyBBcHBsaWNhdGlvbiB9IGZyb20gXCJodHRwczovL2Rlbm8ubGFuZC94L29hay9tb2QudHNcIjtcbiAqXG4gKiBjb25zdCBhcHAgPSBuZXcgQXBwbGljYXRpb24oKTtcbiAqXG4gKiBhcHAudXNlKGFzeW5jIChjdHgpID0+IHtcbiAqICAgY29uc3QgYm9keSA9IGN0eC5yZXF1ZXN0LmJvZHkoKTtcbiAqICAgaWYgKGJvZHkudHlwZSA9PT0gXCJmb3JtLWRhdGFcIikge1xuICogICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgYm9keS52YWx1ZTtcbiAqICAgICBjb25zdCBmb3JtRGF0YSA9IGF3YWl0IHZhbHVlLnJlYWQoKTtcbiAqICAgICAvLyB0aGUgZm9ybSBkYXRhIGlzIGZ1bGx5IGF2YWlsYWJsZVxuICogICB9XG4gKiB9KTtcbiAqIGBgYFxuICpcbiAqICBVc2luZyBgLnN0cmVhbSgpYDpcbiAqXG4gKiBgYGB0c1xuICogaW1wb3J0IHsgQXBwbGljYXRpb24gfSBmcm9tIFwiaHR0cHM6Ly9kZW5vLmxhbmQveC9vYWsvbW9kLnRzXCI7XG4gKlxuICogY29uc3QgYXBwID0gbmV3IEFwcGxpY2F0aW9uKCk7XG4gKlxuICogYXBwLnVzZShhc3luYyAoY3R4KSA9PiB7XG4gKiAgIGNvbnN0IGJvZHkgPSBjdHgucmVxdWVzdC5ib2R5KCk7XG4gKiAgIGlmIChib2R5LnR5cGUgPT09IFwiZm9ybS1kYXRhXCIpIHtcbiAqICAgICBjb25zdCB2YWx1ZSA9IGF3YWl0IGJvZHkudmFsdWU7XG4gKiAgICAgZm9yIGF3YWl0IChjb25zdCBbbmFtZSwgdmFsdWVdIG9mIHZhbHVlLnN0cmVhbSgpKSB7XG4gKiAgICAgICAvLyBhc3luY2hyb25vdXNseSBpdGVyYXRlIGVhY2ggcGFydCBvZiB0aGUgYm9keVxuICogICAgIH1cbiAqICAgfVxuICogfSk7XG4gKiBgYGBcbiAqL1xuZXhwb3J0IGNsYXNzIEZvcm1EYXRhUmVhZGVyIHtcbiAgI2JvZHk6IERlbm8uUmVhZGVyO1xuICAjYm91bmRhcnlGaW5hbDogVWludDhBcnJheTtcbiAgI2JvdW5kYXJ5UGFydDogVWludDhBcnJheTtcbiAgI3JlYWRpbmcgPSBmYWxzZTtcblxuICBjb25zdHJ1Y3Rvcihjb250ZW50VHlwZTogc3RyaW5nLCBib2R5OiBEZW5vLlJlYWRlcikge1xuICAgIGNvbnN0IG1hdGNoZXMgPSBjb250ZW50VHlwZS5tYXRjaChCT1VOREFSWV9QQVJBTV9SRUdFWCk7XG4gICAgaWYgKCFtYXRjaGVzKSB7XG4gICAgICB0aHJvdyBuZXcgaHR0cEVycm9ycy5CYWRSZXF1ZXN0KFxuICAgICAgICBgQ29udGVudCB0eXBlIFwiJHtjb250ZW50VHlwZX1cIiBkb2VzIG5vdCBjb250YWluIGEgdmFsaWQgYm91bmRhcnkuYCxcbiAgICAgICk7XG4gICAgfVxuICAgIGxldCBbLCBib3VuZGFyeV0gPSBtYXRjaGVzO1xuICAgIGJvdW5kYXJ5ID0gdW5xdW90ZShib3VuZGFyeSk7XG4gICAgdGhpcy4jYm91bmRhcnlQYXJ0ID0gZW5jb2Rlci5lbmNvZGUoYC0tJHtib3VuZGFyeX1gKTtcbiAgICB0aGlzLiNib3VuZGFyeUZpbmFsID0gZW5jb2Rlci5lbmNvZGUoYC0tJHtib3VuZGFyeX0tLWApO1xuICAgIHRoaXMuI2JvZHkgPSBib2R5O1xuICB9XG5cbiAgLyoqIFJlYWRzIHRoZSBtdWx0aXBhcnQgYm9keSBvZiB0aGUgcmVzcG9uc2UgYW5kIHJlc29sdmVzIHdpdGggYW4gb2JqZWN0IHdoaWNoXG4gICAqIGNvbnRhaW5zIGZpZWxkcyBhbmQgZmlsZXMgdGhhdCB3ZXJlIHBhcnQgb2YgdGhlIHJlc3BvbnNlLlxuICAgKlxuICAgKiAqTm90ZSo6IHRoaXMgbWV0aG9kIGhhbmRsZXMgbXVsdGlwbGUgZmlsZXMgd2l0aCB0aGUgc2FtZSBgbmFtZWAgYXR0cmlidXRlXG4gICAqIGluIHRoZSByZXF1ZXN0LCBidXQgYnkgZGVzaWduIGl0IGRvZXMgbm90IGhhbmRsZSBtdWx0aXBsZSBmaWVsZHMgdGhhdCBzaGFyZVxuICAgKiB0aGUgc2FtZSBgbmFtZWAuICBJZiB5b3UgZXhwZWN0IHRoZSByZXF1ZXN0IGJvZHkgdG8gY29udGFpbiBtdWx0aXBsZSBmb3JtXG4gICAqIGRhdGEgZmllbGRzIHdpdGggdGhlIHNhbWUgbmFtZSwgaXQgaXMgYmV0dGVyIHRvIHVzZSB0aGUgYC5zdHJlYW0oKWAgbWV0aG9kXG4gICAqIHdoaWNoIHdpbGwgaXRlcmF0ZSBvdmVyIGVhY2ggZm9ybSBkYXRhIGZpZWxkIGluZGl2aWR1YWxseS4gKi9cbiAgYXN5bmMgcmVhZChvcHRpb25zOiBGb3JtRGF0YVJlYWRPcHRpb25zID0ge30pOiBQcm9taXNlPEZvcm1EYXRhQm9keT4ge1xuICAgIGlmICh0aGlzLiNyZWFkaW5nKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJCb2R5IGlzIGFscmVhZHkgYmVpbmcgcmVhZC5cIik7XG4gICAgfVxuICAgIHRoaXMuI3JlYWRpbmcgPSB0cnVlO1xuICAgIGNvbnN0IHtcbiAgICAgIG91dFBhdGgsXG4gICAgICBtYXhGaWxlU2l6ZSA9IERFRkFVTFRfTUFYX0ZJTEVfU0laRSxcbiAgICAgIG1heFNpemUgPSBERUZBVUxUX01BWF9TSVpFLFxuICAgICAgYnVmZmVyU2l6ZSA9IERFRkFVTFRfQlVGRkVSX1NJWkUsXG4gICAgICBjdXN0b21Db250ZW50VHlwZXMsXG4gICAgfSA9IG9wdGlvbnM7XG4gICAgY29uc3QgYm9keSA9IG5ldyBCdWZSZWFkZXIodGhpcy4jYm9keSwgYnVmZmVyU2l6ZSk7XG4gICAgY29uc3QgcmVzdWx0OiBGb3JtRGF0YUJvZHkgPSB7IGZpZWxkczoge30gfTtcbiAgICBpZiAoXG4gICAgICAhKGF3YWl0IHJlYWRUb1N0YXJ0T3JFbmQoYm9keSwgdGhpcy4jYm91bmRhcnlQYXJ0LCB0aGlzLiNib3VuZGFyeUZpbmFsKSlcbiAgICApIHtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBmb3IgYXdhaXQgKFxuICAgICAgICBjb25zdCBwYXJ0IG9mIHBhcnRzKHtcbiAgICAgICAgICBib2R5LFxuICAgICAgICAgIGN1c3RvbUNvbnRlbnRUeXBlcyxcbiAgICAgICAgICBwYXJ0OiB0aGlzLiNib3VuZGFyeVBhcnQsXG4gICAgICAgICAgZmluYWw6IHRoaXMuI2JvdW5kYXJ5RmluYWwsXG4gICAgICAgICAgbWF4RmlsZVNpemUsXG4gICAgICAgICAgbWF4U2l6ZSxcbiAgICAgICAgICBvdXRQYXRoLFxuICAgICAgICB9KVxuICAgICAgKSB7XG4gICAgICAgIGNvbnN0IFtrZXksIHZhbHVlXSA9IHBhcnQ7XG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICByZXN1bHQuZmllbGRzW2tleV0gPSB2YWx1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAoIXJlc3VsdC5maWxlcykge1xuICAgICAgICAgICAgcmVzdWx0LmZpbGVzID0gW107XG4gICAgICAgICAgfVxuICAgICAgICAgIHJlc3VsdC5maWxlcy5wdXNoKHZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIERlbm8uZXJyb3JzLlBlcm1pc3Npb25EZW5pZWQpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnIuc3RhY2sgPyBlcnIuc3RhY2sgOiBgJHtlcnIubmFtZX06ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICAvKiogUmV0dXJucyBhbiBpdGVyYXRvciB3aGljaCB3aWxsIGFzeW5jaHJvbm91c2x5IHlpZWxkIGVhY2ggcGFydCBvZiB0aGUgZm9ybVxuICAgKiBkYXRhLiAgVGhlIHlpZWxkZWQgdmFsdWUgaXMgYSB0dXBsZSwgd2hlcmUgdGhlIGZpcnN0IGVsZW1lbnQgaXMgdGhlIG5hbWVcbiAgICogb2YgdGhlIHBhcnQgYW5kIHRoZSBzZWNvbmQgZWxlbWVudCBpcyBhIGBzdHJpbmdgIG9yIGEgYEZvcm1EYXRhRmlsZWBcbiAgICogb2JqZWN0LiAqL1xuICBhc3luYyAqc3RyZWFtKFxuICAgIG9wdGlvbnM6IEZvcm1EYXRhUmVhZE9wdGlvbnMgPSB7fSxcbiAgKTogQXN5bmNJdGVyYWJsZUl0ZXJhdG9yPFtuYW1lOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcgfCBGb3JtRGF0YUZpbGVdPiB7XG4gICAgaWYgKHRoaXMuI3JlYWRpbmcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkJvZHkgaXMgYWxyZWFkeSBiZWluZyByZWFkLlwiKTtcbiAgICB9XG4gICAgdGhpcy4jcmVhZGluZyA9IHRydWU7XG4gICAgY29uc3Qge1xuICAgICAgb3V0UGF0aCxcbiAgICAgIGN1c3RvbUNvbnRlbnRUeXBlcyxcbiAgICAgIG1heEZpbGVTaXplID0gREVGQVVMVF9NQVhfRklMRV9TSVpFLFxuICAgICAgbWF4U2l6ZSA9IERFRkFVTFRfTUFYX1NJWkUsXG4gICAgICBidWZmZXJTaXplID0gMzIwMDAsXG4gICAgfSA9IG9wdGlvbnM7XG4gICAgY29uc3QgYm9keSA9IG5ldyBCdWZSZWFkZXIodGhpcy4jYm9keSwgYnVmZmVyU2l6ZSk7XG4gICAgaWYgKFxuICAgICAgIShhd2FpdCByZWFkVG9TdGFydE9yRW5kKGJvZHksIHRoaXMuI2JvdW5kYXJ5UGFydCwgdGhpcy4jYm91bmRhcnlGaW5hbCkpXG4gICAgKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBmb3IgYXdhaXQgKFxuICAgICAgICBjb25zdCBwYXJ0IG9mIHBhcnRzKHtcbiAgICAgICAgICBib2R5LFxuICAgICAgICAgIGN1c3RvbUNvbnRlbnRUeXBlcyxcbiAgICAgICAgICBwYXJ0OiB0aGlzLiNib3VuZGFyeVBhcnQsXG4gICAgICAgICAgZmluYWw6IHRoaXMuI2JvdW5kYXJ5RmluYWwsXG4gICAgICAgICAgbWF4RmlsZVNpemUsXG4gICAgICAgICAgbWF4U2l6ZSxcbiAgICAgICAgICBvdXRQYXRoLFxuICAgICAgICB9KVxuICAgICAgKSB7XG4gICAgICAgIHlpZWxkIHBhcnQ7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoZXJyIGluc3RhbmNlb2YgRGVuby5lcnJvcnMuUGVybWlzc2lvbkRlbmllZCkge1xuICAgICAgICBjb25zb2xlLmVycm9yKGVyci5zdGFjayA/IGVyci5zdGFjayA6IGAke2Vyci5uYW1lfTogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGVycjtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBbU3ltYm9sLmZvcihcIkRlbm8uY3VzdG9tSW5zcGVjdFwiKV0oaW5zcGVjdDogKHZhbHVlOiB1bmtub3duKSA9PiBzdHJpbmcpIHtcbiAgICByZXR1cm4gYCR7dGhpcy5jb25zdHJ1Y3Rvci5uYW1lfSAke2luc3BlY3Qoe30pfWA7XG4gIH1cblxuICBbU3ltYm9sLmZvcihcIm5vZGVqcy51dGlsLmluc3BlY3QuY3VzdG9tXCIpXShcbiAgICBkZXB0aDogbnVtYmVyLFxuICAgIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gICAgb3B0aW9uczogYW55LFxuICAgIGluc3BlY3Q6ICh2YWx1ZTogdW5rbm93biwgb3B0aW9ucz86IHVua25vd24pID0+IHN0cmluZyxcbiAgKSB7XG4gICAgaWYgKGRlcHRoIDwgMCkge1xuICAgICAgcmV0dXJuIG9wdGlvbnMuc3R5bGl6ZShgWyR7dGhpcy5jb25zdHJ1Y3Rvci5uYW1lfV1gLCBcInNwZWNpYWxcIik7XG4gICAgfVxuXG4gICAgY29uc3QgbmV3T3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMsIHtcbiAgICAgIGRlcHRoOiBvcHRpb25zLmRlcHRoID09PSBudWxsID8gbnVsbCA6IG9wdGlvbnMuZGVwdGggLSAxLFxuICAgIH0pO1xuICAgIHJldHVybiBgJHtvcHRpb25zLnN0eWxpemUodGhpcy5jb25zdHJ1Y3Rvci5uYW1lLCBcInNwZWNpYWxcIil9ICR7XG4gICAgICBpbnNwZWN0KHt9LCBuZXdPcHRpb25zKVxuICAgIH1gO1xuICB9XG59XG4iXX0=