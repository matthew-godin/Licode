import { RequestBody } from "./body.ts";
import { NativeRequest } from "./http_server_native.ts";
import { preferredCharsets } from "./negotiation/charset.ts";
import { preferredEncodings } from "./negotiation/encoding.ts";
import { preferredLanguages } from "./negotiation/language.ts";
import { preferredMediaTypes } from "./negotiation/mediaType.ts";
export class Request {
    #body;
    #proxy;
    #secure;
    #serverRequest;
    #url;
    #getRemoteAddr() {
        return this.#serverRequest instanceof NativeRequest
            ? this.#serverRequest.remoteAddr ?? ""
            : this.#serverRequest?.conn?.remoteAddr?.hostname ?? "";
    }
    get hasBody() {
        return this.#body.has();
    }
    get headers() {
        return this.#serverRequest.headers;
    }
    get ip() {
        return (this.#proxy ? this.ips[0] : this.#getRemoteAddr()) ?? "";
    }
    get ips() {
        return this.#proxy
            ? (this.#serverRequest.headers.get("x-forwarded-for") ??
                this.#getRemoteAddr()).split(/\s*,\s*/)
            : [];
    }
    get method() {
        return this.#serverRequest.method;
    }
    get secure() {
        return this.#secure;
    }
    get originalRequest() {
        return this.#serverRequest;
    }
    get url() {
        if (!this.#url) {
            const serverRequest = this.#serverRequest;
            if (serverRequest instanceof NativeRequest && !this.#proxy) {
                try {
                    this.#url = new URL(serverRequest.rawUrl);
                    return this.#url;
                }
                catch {
                }
            }
            let proto;
            let host;
            if (this.#proxy) {
                proto = serverRequest
                    .headers.get("x-forwarded-proto")?.split(/\s*,\s*/, 1)[0] ??
                    "http";
                host = serverRequest.headers.get("x-forwarded-host") ??
                    serverRequest.headers.get("host") ?? "";
            }
            else {
                proto = this.#secure ? "https" : "http";
                host = serverRequest.headers.get("host") ?? "";
            }
            try {
                this.#url = new URL(`${proto}://${host}${serverRequest.url}`);
            }
            catch {
                throw new TypeError(`The server request URL of "${proto}://${host}${serverRequest.url}" is invalid.`);
            }
        }
        return this.#url;
    }
    constructor(serverRequest, proxy = false, secure = false) {
        this.#proxy = proxy;
        this.#secure = secure;
        this.#serverRequest = serverRequest;
        this.#body = new RequestBody(serverRequest instanceof NativeRequest
            ? serverRequest.request
            : serverRequest);
    }
    accepts(...types) {
        const acceptValue = this.#serverRequest.headers.get("Accept");
        if (!acceptValue) {
            return;
        }
        if (types.length) {
            return preferredMediaTypes(acceptValue, types)[0];
        }
        return preferredMediaTypes(acceptValue);
    }
    acceptsCharsets(...charsets) {
        const acceptCharsetValue = this.#serverRequest.headers.get("Accept-Charset");
        if (!acceptCharsetValue) {
            return;
        }
        if (charsets.length) {
            return preferredCharsets(acceptCharsetValue, charsets)[0];
        }
        return preferredCharsets(acceptCharsetValue);
    }
    acceptsEncodings(...encodings) {
        const acceptEncodingValue = this.#serverRequest.headers.get("Accept-Encoding");
        if (!acceptEncodingValue) {
            return;
        }
        if (encodings.length) {
            return preferredEncodings(acceptEncodingValue, encodings)[0];
        }
        return preferredEncodings(acceptEncodingValue);
    }
    acceptsLanguages(...langs) {
        const acceptLanguageValue = this.#serverRequest.headers.get("Accept-Language");
        if (!acceptLanguageValue) {
            return;
        }
        if (langs.length) {
            return preferredLanguages(acceptLanguageValue, langs)[0];
        }
        return preferredLanguages(acceptLanguageValue);
    }
    body(options = {}) {
        return this.#body.get(options);
    }
    [Symbol.for("Deno.customInspect")](inspect) {
        const { hasBody, headers, ip, ips, method, secure, url } = this;
        return `${this.constructor.name} ${inspect({
            hasBody,
            headers,
            ip,
            ips,
            method,
            secure,
            url: url.toString(),
        })}`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVxdWVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInJlcXVlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBYUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN4QyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFHeEQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDN0QsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDL0QsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDL0QsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFHakUsTUFBTSxPQUFPLE9BQU87SUFDbEIsS0FBSyxDQUFjO0lBQ25CLE1BQU0sQ0FBVTtJQUNoQixPQUFPLENBQVU7SUFDakIsY0FBYyxDQUFnQztJQUM5QyxJQUFJLENBQU87SUFFWCxjQUFjO1FBQ1osT0FBTyxJQUFJLENBQUMsY0FBYyxZQUFZLGFBQWE7WUFDakQsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsVUFBVSxJQUFJLEVBQUU7WUFDdEMsQ0FBQyxDQUFFLElBQUksQ0FBQyxjQUFjLEVBQUUsSUFBSSxFQUFFLFVBQTJCLEVBQUUsUUFBUSxJQUFJLEVBQUUsQ0FBQztJQUM5RSxDQUFDO0lBR0QsSUFBSSxPQUFPO1FBQ1QsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFHRCxJQUFJLE9BQU87UUFDVCxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDO0lBQ3JDLENBQUM7SUFLRCxJQUFJLEVBQUU7UUFDSixPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGNB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QUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUN6RCxpQkFBaUIsQ0FDbEIsQ0FBQztRQUNGLElBQUksQ0FBQyxtQkFBbUIsRUFBRTtZQUN4QixPQUFPO1NBQ1I7UUFDRCxJQUFJLEtBQUssQ0FBQyxNQUFNLEVBQUU7WUFDaEIsT0FBTyxrQkFBa0IsQ0FBQyxtQkFBbUIsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUMxRDtRQUNELE9BQU8sa0JBQWtCLENBQUMsbUJBQW1CLENBQUMsQ0FBQztJQUNqRCxDQUFDO0lBVUQsSUFBSSxDQUFDLFVBQXVCLEVBQUU7UUFDNUIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBRUQsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLG9CQUFvQixDQUFDLENBQUMsQ0FBQyxPQUFtQztRQUNwRSxNQUFNLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBQ2hFLE9BQU8sR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksSUFDN0IsT0FBTyxDQUFDO1lBQ04sT0FBTztZQUNQLE9BQU87WUFDUCxFQUFFO1lBQ0YsR0FBRztZQUNILE1BQU07WUFDTixNQUFNO1lBQ04sR0FBRyxFQUFFLEdBQUcsQ0FBQyxRQUFRLEVBQUU7U0FDcEIsQ0FDSCxFQUFFLENBQUM7SUFDTCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDIxIHRoZSBvYWsgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4gTUlUIGxpY2Vuc2UuXG5cbmltcG9ydCB0eXBlIHtcbiAgQm9keSxcbiAgQm9keUJ5dGVzLFxuICBCb2R5Rm9ybSxcbiAgQm9keUZvcm1EYXRhLFxuICBCb2R5SnNvbixcbiAgQm9keU9wdGlvbnMsXG4gIEJvZHlSZWFkZXIsXG4gIEJvZHlTdHJlYW0sXG4gIEJvZHlUZXh0LFxufSBmcm9tIFwiLi9ib2R5LnRzXCI7XG5pbXBvcnQgeyBSZXF1ZXN0Qm9keSB9IGZyb20gXCIuL2JvZHkudHNcIjtcbmltcG9ydCB7IE5hdGl2ZVJlcXVlc3QgfSBmcm9tIFwiLi9odHRwX3NlcnZlcl9uYXRpdmUudHNcIjtcbmltcG9ydCB0eXBlIHsgU2VydmVyUmVxdWVzdCB9IGZyb20gXCIuL2h0dHBfc2VydmVyX3N0ZC50c1wiO1xuaW1wb3J0IHR5cGUgeyBIVFRQTWV0aG9kcyB9IGZyb20gXCIuL3R5cGVzLmQudHNcIjtcbmltcG9ydCB7IHByZWZlcnJlZENoYXJzZXRzIH0gZnJvbSBcIi4vbmVnb3RpYXRpb24vY2hhcnNldC50c1wiO1xuaW1wb3J0IHsgcHJlZmVycmVkRW5jb2RpbmdzIH0gZnJvbSBcIi4vbmVnb3RpYXRpb24vZW5jb2RpbmcudHNcIjtcbmltcG9ydCB7IHByZWZlcnJlZExhbmd1YWdlcyB9IGZyb20gXCIuL25lZ290aWF0aW9uL2xhbmd1YWdlLnRzXCI7XG5pbXBvcnQgeyBwcmVmZXJyZWRNZWRpYVR5cGVzIH0gZnJvbSBcIi4vbmVnb3RpYXRpb24vbWVkaWFUeXBlLnRzXCI7XG5cbi8qKiBBbiBpbnRlcmZhY2Ugd2hpY2ggcHJvdmlkZXMgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGN1cnJlbnQgcmVxdWVzdC4gKi9cbmV4cG9ydCBjbGFzcyBSZXF1ZXN0IHtcbiAgI2JvZHk6IFJlcXVlc3RCb2R5O1xuICAjcHJveHk6IGJvb2xlYW47XG4gICNzZWN1cmU6IGJvb2xlYW47XG4gICNzZXJ2ZXJSZXF1ZXN0OiBTZXJ2ZXJSZXF1ZXN0IHwgTmF0aXZlUmVxdWVzdDtcbiAgI3VybD86IFVSTDtcblxuICAjZ2V0UmVtb3RlQWRkcigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLiNzZXJ2ZXJSZXF1ZXN0IGluc3RhbmNlb2YgTmF0aXZlUmVxdWVzdFxuICAgICAgPyB0aGlzLiNzZXJ2ZXJSZXF1ZXN0LnJlbW90ZUFkZHIgPz8gXCJcIlxuICAgICAgOiAodGhpcy4jc2VydmVyUmVxdWVzdD8uY29ubj8ucmVtb3RlQWRkciBhcyBEZW5vLk5ldEFkZHIpPy5ob3N0bmFtZSA/PyBcIlwiO1xuICB9XG5cbiAgLyoqIElzIGB0cnVlYCBpZiB0aGUgcmVxdWVzdCBoYXMgYSBib2R5LCBvdGhlcndpc2UgYGZhbHNlYC4gKi9cbiAgZ2V0IGhhc0JvZHkoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuI2JvZHkuaGFzKCk7XG4gIH1cblxuICAvKiogVGhlIGBIZWFkZXJzYCBzdXBwbGllZCBpbiB0aGUgcmVxdWVzdC4gKi9cbiAgZ2V0IGhlYWRlcnMoKTogSGVhZGVycyB7XG4gICAgcmV0dXJuIHRoaXMuI3NlcnZlclJlcXVlc3QuaGVhZGVycztcbiAgfVxuXG4gIC8qKiBSZXF1ZXN0IHJlbW90ZSBhZGRyZXNzLiBXaGVuIHRoZSBhcHBsaWNhdGlvbidzIGAucHJveHlgIGlzIHRydWUsIHRoZVxuICAgKiBgWC1Gb3J3YXJkZWQtRm9yYCB3aWxsIGJlIHVzZWQgdG8gZGV0ZXJtaW5lIHRoZSByZXF1ZXN0aW5nIHJlbW90ZSBhZGRyZXNzLlxuICAgKi9cbiAgZ2V0IGlwKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuICh0aGlzLiNwcm94eSA/IHRoaXMuaXBzWzBdIDogdGhpcy4jZ2V0UmVtb3RlQWRkcigpKSA/PyBcIlwiO1xuICB9XG5cbiAgLyoqIFdoZW4gdGhlIGFwcGxpY2F0aW9uJ3MgYC5wcm94eWAgaXMgYHRydWVgLCB0aGlzIHdpbGwgYmUgc2V0IHRvIGFuIGFycmF5IG9mXG4gICAqIElQcywgb3JkZXJlZCBmcm9tIHVwc3RyZWFtIHRvIGRvd25zdHJlYW0sIGJhc2VkIG9uIHRoZSB2YWx1ZSBvZiB0aGUgaGVhZGVyXG4gICAqIGBYLUZvcndhcmRlZC1Gb3JgLiAgV2hlbiBgZmFsc2VgIGFuIGVtcHR5IGFycmF5IGlzIHJldHVybmVkLiAqL1xuICBnZXQgaXBzKCk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gdGhpcy4jcHJveHlcbiAgICAgID8gKHRoaXMuI3NlcnZlclJlcXVlc3QuaGVhZGVycy5nZXQoXCJ4LWZvcndhcmRlZC1mb3JcIikgPz9cbiAgICAgICAgdGhpcy4jZ2V0UmVtb3RlQWRkcigpKS5zcGxpdCgvXFxzKixcXHMqLylcbiAgICAgIDogW107XG4gIH1cblxuICAvKiogVGhlIEhUVFAgTWV0aG9kIHVzZWQgYnkgdGhlIHJlcXVlc3QuICovXG4gIGdldCBtZXRob2QoKTogSFRUUE1ldGhvZHMge1xuICAgIHJldHVybiB0aGlzLiNzZXJ2ZXJSZXF1ZXN0Lm1ldGhvZCBhcyBIVFRQTWV0aG9kcztcbiAgfVxuXG4gIC8qKiBTaG9ydGN1dCB0byBgcmVxdWVzdC51cmwucHJvdG9jb2wgPT09IFwiaHR0cHM6XCJgLiAqL1xuICBnZXQgc2VjdXJlKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLiNzZWN1cmU7XG4gIH1cblxuICAvKiogU2V0IHRvIHRoZSB2YWx1ZSBvZiB0aGUgX29yaWdpbmFsXyBEZW5vIHNlcnZlciByZXF1ZXN0LiAqL1xuICBnZXQgb3JpZ2luYWxSZXF1ZXN0KCk6IFNlcnZlclJlcXVlc3QgfCBOYXRpdmVSZXF1ZXN0IHtcbiAgICByZXR1cm4gdGhpcy4jc2VydmVyUmVxdWVzdDtcbiAgfVxuXG4gIC8qKiBBIHBhcnNlZCBVUkwgZm9yIHRoZSByZXF1ZXN0IHdoaWNoIGNvbXBsaWVzIHdpdGggdGhlIGJyb3dzZXIgc3RhbmRhcmRzLlxuICAgKiBXaGVuIHRoZSBhcHBsaWNhdGlvbidzIGAucHJveHlgIGlzIGB0cnVlYCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGJhc2VkIG9mZiBvZlxuICAgKiB0aGUgYFgtRm9yd2FyZGVkLVByb3RvYCBhbmQgYFgtRm9yd2FyZGVkLUhvc3RgIGhlYWRlciB2YWx1ZXMgaWYgcHJlc2VudCBpblxuICAgKiB0aGUgcmVxdWVzdC4gKi9cbiAgZ2V0IHVybCgpOiBVUkwge1xuICAgIGlmICghdGhpcy4jdXJsKSB7XG4gICAgICBjb25zdCBzZXJ2ZXJSZXF1ZXN0ID0gdGhpcy4jc2VydmVyUmVxdWVzdDtcbiAgICAgIGlmIChzZXJ2ZXJSZXF1ZXN0IGluc3RhbmNlb2YgTmF0aXZlUmVxdWVzdCAmJiAhdGhpcy4jcHJveHkpIHtcbiAgICAgICAgLy8gYmV0d2VlbiAxLjkuMCBhbmQgMS45LjEgdGhlIHJlcXVlc3QudXJsIG9mIHRoZSBuYXRpdmUgSFRUUCBzdGFydGVkXG4gICAgICAgIC8vIHJldHVybmluZyB0aGUgZnVsbCBVUkwsIHdoZXJlIHByZXZpb3VzbHkgaXQgb25seSByZXR1cm5lZCB0aGUgcGF0aFxuICAgICAgICAvLyBzbyB3ZSB3aWxsIHRyeSB0byB1c2UgdGhhdCBVUkwgaGVyZSwgYnV0IGRlZmF1bHQgYmFjayB0byBvbGQgbG9naWNcbiAgICAgICAgLy8gaWYgdGhlIFVSTCBpc24ndCB2YWxpZC5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICB0aGlzLiN1cmwgPSBuZXcgVVJMKHNlcnZlclJlcXVlc3QucmF3VXJsKTtcbiAgICAgICAgICByZXR1cm4gdGhpcy4jdXJsO1xuICAgICAgICB9IGNhdGNoIHtcbiAgICAgICAgICAvLyB3ZSBkb24ndCBjYXJlIGFib3V0IGVycm9ycyBoZXJlXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGxldCBwcm90bzogc3RyaW5nO1xuICAgICAgbGV0IGhvc3Q6IHN0cmluZztcbiAgICAgIGlmICh0aGlzLiNwcm94eSkge1xuICAgICAgICBwcm90byA9IHNlcnZlclJlcXVlc3RcbiAgICAgICAgICAuaGVhZGVycy5nZXQoXCJ4LWZvcndhcmRlZC1wcm90b1wiKT8uc3BsaXQoL1xccyosXFxzKi8sIDEpWzBdID8/XG4gICAgICAgICAgXCJodHRwXCI7XG4gICAgICAgIGhvc3QgPSBzZXJ2ZXJSZXF1ZXN0LmhlYWRlcnMuZ2V0KFwieC1mb3J3YXJkZWQtaG9zdFwiKSA/P1xuICAgICAgICAgIHNlcnZlclJlcXVlc3QuaGVhZGVycy5nZXQoXCJob3N0XCIpID8/IFwiXCI7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwcm90byA9IHRoaXMuI3NlY3VyZSA/IFwiaHR0cHNcIiA6IFwiaHR0cFwiO1xuICAgICAgICBob3N0ID0gc2VydmVyUmVxdWVzdC5oZWFkZXJzLmdldChcImhvc3RcIikgPz8gXCJcIjtcbiAgICAgIH1cbiAgICAgIHRyeSB7XG4gICAgICAgIHRoaXMuI3VybCA9IG5ldyBVUkwoYCR7cHJvdG99Oi8vJHtob3N0fSR7c2VydmVyUmVxdWVzdC51cmx9YCk7XG4gICAgICB9IGNhdGNoIHtcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcbiAgICAgICAgICBgVGhlIHNlcnZlciByZXF1ZXN0IFVSTCBvZiBcIiR7cHJvdG99Oi8vJHtob3N0fSR7c2VydmVyUmVxdWVzdC51cmx9XCIgaXMgaW52YWxpZC5gLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGhpcy4jdXJsO1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgc2VydmVyUmVxdWVzdDogU2VydmVyUmVxdWVzdCB8IE5hdGl2ZVJlcXVlc3QsXG4gICAgcHJveHkgPSBmYWxzZSxcbiAgICBzZWN1cmUgPSBmYWxzZSxcbiAgKSB7XG4gICAgdGhpcy4jcHJveHkgPSBwcm94eTtcbiAgICB0aGlzLiNzZWN1cmUgPSBzZWN1cmU7XG4gICAgdGhpcy4jc2VydmVyUmVxdWVzdCA9IHNlcnZlclJlcXVlc3Q7XG4gICAgdGhpcy4jYm9keSA9IG5ldyBSZXF1ZXN0Qm9keShcbiAgICAgIHNlcnZlclJlcXVlc3QgaW5zdGFuY2VvZiBOYXRpdmVSZXF1ZXN0XG4gICAgICAgID8gc2VydmVyUmVxdWVzdC5yZXF1ZXN0XG4gICAgICAgIDogc2VydmVyUmVxdWVzdCxcbiAgICApO1xuICB9XG5cbiAgLyoqIFJldHVybnMgYW4gYXJyYXkgb2YgbWVkaWEgdHlwZXMsIGFjY2VwdGVkIGJ5IHRoZSByZXF1ZXN0b3IsIGluIG9yZGVyIG9mXG4gICAqIHByZWZlcmVuY2UuICBJZiB0aGVyZSBhcmUgbm8gZW5jb2RpbmdzIHN1cHBsaWVkIGJ5IHRoZSByZXF1ZXN0b3IsXG4gICAqIGB1bmRlZmluZWRgIGlzIHJldHVybmVkLlxuICAgKi9cbiAgYWNjZXB0cygpOiBzdHJpbmdbXSB8IHVuZGVmaW5lZDtcbiAgLyoqIEZvciBhIGdpdmVuIHNldCBvZiBtZWRpYSB0eXBlcywgcmV0dXJuIHRoZSBiZXN0IG1hdGNoIGFjY2VwdGVkIGJ5IHRoZVxuICAgKiByZXF1ZXN0b3IuICBJZiB0aGVyZSBhcmUgbm8gZW5jb2RpbmcgdGhhdCBtYXRjaCwgdGhlbiB0aGUgbWV0aG9kIHJldHVybnNcbiAgICogYHVuZGVmaW5lZGAuXG4gICAqL1xuICBhY2NlcHRzKC4uLnR5cGVzOiBzdHJpbmdbXSk6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgYWNjZXB0cyguLi50eXBlczogc3RyaW5nW10pOiBzdHJpbmcgfCBzdHJpbmdbXSB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgYWNjZXB0VmFsdWUgPSB0aGlzLiNzZXJ2ZXJSZXF1ZXN0LmhlYWRlcnMuZ2V0KFwiQWNjZXB0XCIpO1xuICAgIGlmICghYWNjZXB0VmFsdWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHR5cGVzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIHByZWZlcnJlZE1lZGlhVHlwZXMoYWNjZXB0VmFsdWUsIHR5cGVzKVswXTtcbiAgICB9XG4gICAgcmV0dXJuIHByZWZlcnJlZE1lZGlhVHlwZXMoYWNjZXB0VmFsdWUpO1xuICB9XG5cbiAgLyoqIFJldHVybnMgYW4gYXJyYXkgb2YgY2hhcnNldHMsIGFjY2VwdGVkIGJ5IHRoZSByZXF1ZXN0b3IsIGluIG9yZGVyIG9mXG4gICAqIHByZWZlcmVuY2UuICBJZiB0aGVyZSBhcmUgbm8gY2hhcnNldHMgc3VwcGxpZWQgYnkgdGhlIHJlcXVlc3RvcixcbiAgICogYHVuZGVmaW5lZGAgaXMgcmV0dXJuZWQuXG4gICAqL1xuICBhY2NlcHRzQ2hhcnNldHMoKTogc3RyaW5nW10gfCB1bmRlZmluZWQ7XG4gIC8qKiBGb3IgYSBnaXZlbiBzZXQgb2YgY2hhcnNldHMsIHJldHVybiB0aGUgYmVzdCBtYXRjaCBhY2NlcHRlZCBieSB0aGVcbiAgICogcmVxdWVzdG9yLiAgSWYgdGhlcmUgYXJlIG5vIGNoYXJzZXRzIHRoYXQgbWF0Y2gsIHRoZW4gdGhlIG1ldGhvZCByZXR1cm5zXG4gICAqIGB1bmRlZmluZWRgLiAqL1xuICBhY2NlcHRzQ2hhcnNldHMoLi4uY2hhcnNldHM6IHN0cmluZ1tdKTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBhY2NlcHRzQ2hhcnNldHMoLi4uY2hhcnNldHM6IHN0cmluZ1tdKTogc3RyaW5nW10gfCBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGFjY2VwdENoYXJzZXRWYWx1ZSA9IHRoaXMuI3NlcnZlclJlcXVlc3QuaGVhZGVycy5nZXQoXG4gICAgICBcIkFjY2VwdC1DaGFyc2V0XCIsXG4gICAgKTtcbiAgICBpZiAoIWFjY2VwdENoYXJzZXRWYWx1ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoY2hhcnNldHMubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gcHJlZmVycmVkQ2hhcnNldHMoYWNjZXB0Q2hhcnNldFZhbHVlLCBjaGFyc2V0cylbMF07XG4gICAgfVxuICAgIHJldHVybiBwcmVmZXJyZWRDaGFyc2V0cyhhY2NlcHRDaGFyc2V0VmFsdWUpO1xuICB9XG5cbiAgLyoqIFJldHVybnMgYW4gYXJyYXkgb2YgZW5jb2RpbmdzLCBhY2NlcHRlZCBieSB0aGUgcmVxdWVzdG9yLCBpbiBvcmRlciBvZlxuICAgKiBwcmVmZXJlbmNlLiAgSWYgdGhlcmUgYXJlIG5vIGVuY29kaW5ncyBzdXBwbGllZCBieSB0aGUgcmVxdWVzdG9yLFxuICAgKiBgdW5kZWZpbmVkYCBpcyByZXR1cm5lZC5cbiAgICovXG4gIGFjY2VwdHNFbmNvZGluZ3MoKTogc3RyaW5nW10gfCB1bmRlZmluZWQ7XG4gIC8qKiBGb3IgYSBnaXZlbiBzZXQgb2YgZW5jb2RpbmdzLCByZXR1cm4gdGhlIGJlc3QgbWF0Y2ggYWNjZXB0ZWQgYnkgdGhlXG4gICAqIHJlcXVlc3Rvci4gIElmIHRoZXJlIGFyZSBubyBlbmNvZGluZ3MgdGhhdCBtYXRjaCwgdGhlbiB0aGUgbWV0aG9kIHJldHVybnNcbiAgICogYHVuZGVmaW5lZGAuXG4gICAqXG4gICAqICoqTk9URToqKiBZb3Ugc2hvdWxkIGFsd2F5cyBzdXBwbHkgYGlkZW50aXR5YCBhcyBvbmUgb2YgdGhlIGVuY29kaW5nc1xuICAgKiB0byBlbnN1cmUgdGhhdCB0aGVyZSBpcyBhIG1hdGNoIHdoZW4gdGhlIGBBY2NlcHQtRW5jb2RpbmdgIGhlYWRlciBpcyBwYXJ0XG4gICAqIG9mIHRoZSByZXF1ZXN0LlxuICAgKi9cbiAgYWNjZXB0c0VuY29kaW5ncyguLi5lbmNvZGluZ3M6IHN0cmluZ1tdKTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBhY2NlcHRzRW5jb2RpbmdzKC4uLmVuY29kaW5nczogc3RyaW5nW10pOiBzdHJpbmdbXSB8IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgYWNjZXB0RW5jb2RpbmdWYWx1ZSA9IHRoaXMuI3NlcnZlclJlcXVlc3QuaGVhZGVycy5nZXQoXG4gICAgICBcIkFjY2VwdC1FbmNvZGluZ1wiLFxuICAgICk7XG4gICAgaWYgKCFhY2NlcHRFbmNvZGluZ1ZhbHVlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChlbmNvZGluZ3MubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gcHJlZmVycmVkRW5jb2RpbmdzKGFjY2VwdEVuY29kaW5nVmFsdWUsIGVuY29kaW5ncylbMF07XG4gICAgfVxuICAgIHJldHVybiBwcmVmZXJyZWRFbmNvZGluZ3MoYWNjZXB0RW5jb2RpbmdWYWx1ZSk7XG4gIH1cblxuICAvKiogUmV0dXJucyBhbiBhcnJheSBvZiBsYW5ndWFnZXMsIGFjY2VwdGVkIGJ5IHRoZSByZXF1ZXN0b3IsIGluIG9yZGVyIG9mXG4gICAqIHByZWZlcmVuY2UuICBJZiB0aGVyZSBhcmUgbm8gbGFuZ3VhZ2VzIHN1cHBsaWVkIGJ5IHRoZSByZXF1ZXN0b3IsXG4gICAqIGB1bmRlZmluZWRgIGlzIHJldHVybmVkLlxuICAgKi9cbiAgYWNjZXB0c0xhbmd1YWdlcygpOiBzdHJpbmdbXSB8IHVuZGVmaW5lZDtcbiAgLyoqIEZvciBhIGdpdmVuIHNldCBvZiBsYW5ndWFnZXMsIHJldHVybiB0aGUgYmVzdCBtYXRjaCBhY2NlcHRlZCBieSB0aGVcbiAgICogcmVxdWVzdG9yLiAgSWYgdGhlcmUgYXJlIG5vIGxhbmd1YWdlcyB0aGF0IG1hdGNoLCB0aGVuIHRoZSBtZXRob2QgcmV0dXJuc1xuICAgKiBgdW5kZWZpbmVkYC4gKi9cbiAgYWNjZXB0c0xhbmd1YWdlcyguLi5sYW5nczogc3RyaW5nW10pOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIGFjY2VwdHNMYW5ndWFnZXMoLi4ubGFuZ3M6IHN0cmluZ1tdKTogc3RyaW5nW10gfCBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGFjY2VwdExhbmd1YWdlVmFsdWUgPSB0aGlzLiNzZXJ2ZXJSZXF1ZXN0LmhlYWRlcnMuZ2V0KFxuICAgICAgXCJBY2NlcHQtTGFuZ3VhZ2VcIixcbiAgICApO1xuICAgIGlmICghYWNjZXB0TGFuZ3VhZ2VWYWx1ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAobGFuZ3MubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gcHJlZmVycmVkTGFuZ3VhZ2VzKGFjY2VwdExhbmd1YWdlVmFsdWUsIGxhbmdzKVswXTtcbiAgICB9XG4gICAgcmV0dXJuIHByZWZlcnJlZExhbmd1YWdlcyhhY2NlcHRMYW5ndWFnZVZhbHVlKTtcbiAgfVxuXG4gIGJvZHkob3B0aW9uczogQm9keU9wdGlvbnM8XCJieXRlc1wiPik6IEJvZHlCeXRlcztcbiAgYm9keShvcHRpb25zOiBCb2R5T3B0aW9uczxcImZvcm1cIj4pOiBCb2R5Rm9ybTtcbiAgYm9keShvcHRpb25zOiBCb2R5T3B0aW9uczxcImZvcm0tZGF0YVwiPik6IEJvZHlGb3JtRGF0YTtcbiAgYm9keShvcHRpb25zOiBCb2R5T3B0aW9uczxcImpzb25cIj4pOiBCb2R5SnNvbjtcbiAgYm9keShvcHRpb25zOiBCb2R5T3B0aW9uczxcInJlYWRlclwiPik6IEJvZHlSZWFkZXI7XG4gIGJvZHkob3B0aW9uczogQm9keU9wdGlvbnM8XCJzdHJlYW1cIj4pOiBCb2R5U3RyZWFtO1xuICBib2R5KG9wdGlvbnM6IEJvZHlPcHRpb25zPFwidGV4dFwiPik6IEJvZHlUZXh0O1xuICBib2R5KG9wdGlvbnM/OiBCb2R5T3B0aW9ucyk6IEJvZHk7XG4gIGJvZHkob3B0aW9uczogQm9keU9wdGlvbnMgPSB7fSk6IEJvZHkgfCBCb2R5UmVhZGVyIHwgQm9keVN0cmVhbSB7XG4gICAgcmV0dXJuIHRoaXMuI2JvZHkuZ2V0KG9wdGlvbnMpO1xuICB9XG5cbiAgW1N5bWJvbC5mb3IoXCJEZW5vLmN1c3RvbUluc3BlY3RcIildKGluc3BlY3Q6ICh2YWx1ZTogdW5rbm93bikgPT4gc3RyaW5nKSB7XG4gICAgY29uc3QgeyBoYXNCb2R5LCBoZWFkZXJzLCBpcCwgaXBzLCBtZXRob2QsIHNlY3VyZSwgdXJsIH0gPSB0aGlzO1xuICAgIHJldHVybiBgJHt0aGlzLmNvbnN0cnVjdG9yLm5hbWV9ICR7XG4gICAgICBpbnNwZWN0KHtcbiAgICAgICAgaGFzQm9keSxcbiAgICAgICAgaGVhZGVycyxcbiAgICAgICAgaXAsXG4gICAgICAgIGlwcyxcbiAgICAgICAgbWV0aG9kLFxuICAgICAgICBzZWN1cmUsXG4gICAgICAgIHVybDogdXJsLnRvU3RyaW5nKCksXG4gICAgICB9KVxuICAgIH1gO1xuICB9XG59XG4iXX0=