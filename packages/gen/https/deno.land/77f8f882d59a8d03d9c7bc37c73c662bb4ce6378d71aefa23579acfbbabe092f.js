import { isRouterContext } from "../util.ts";
const FORWARDED_RE = /^(,[ \\t]*)*([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?(;([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?)*([ \\t]*,([ \\t]*([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?(;([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?)*)?)*$/g;
function createMatcher({ match }) {
    return function matches(ctx) {
        if (!match) {
            return true;
        }
        if (typeof match === "string") {
            return ctx.request.url.pathname.startsWith(match);
        }
        if (match instanceof RegExp) {
            return match.test(ctx.request.url.pathname);
        }
        return match(ctx);
    };
}
async function createRequest(target, ctx, { headers: optHeaders, map, proxyHeaders = true, request: reqFn }) {
    let path = ctx.request.url.pathname;
    let params;
    if (isRouterContext(ctx)) {
        params = ctx.params;
    }
    if (map && typeof map === "function") {
        path = map(path, params);
    }
    else if (map) {
        path = map[path] ?? path;
    }
    const url = new URL(String(target));
    if (url.pathname.endsWith("/") && path.startsWith("/")) {
        url.pathname = `${url.pathname}${path.slice(1)}`;
    }
    else if (!url.pathname.endsWith("/") && !path.startsWith("/")) {
        url.pathname = `${url.pathname}/${path}`;
    }
    else {
        url.pathname = `${url.pathname}${path}`;
    }
    url.search = ctx.request.url.search;
    const body = getBodyInit(ctx);
    const headers = new Headers(ctx.request.headers);
    if (optHeaders) {
        if (typeof optHeaders === "function") {
            optHeaders = await optHeaders(ctx);
        }
        for (const [key, value] of iterableHeaders(optHeaders)) {
            headers.set(key, value);
        }
    }
    if (proxyHeaders) {
        const maybeForwarded = headers.get("forwarded");
        const ip = ctx.request.ip.startsWith("[")
            ? `"${ctx.request.ip}"`
            : ctx.request.ip;
        const host = headers.get("host");
        if (maybeForwarded && FORWARDED_RE.test(maybeForwarded)) {
            let value = `for=${ip}`;
            if (host) {
                value += `;host=${host}`;
            }
            headers.append("forwarded", value);
        }
        else {
            headers.append("x-forwarded-for", ip);
            if (host) {
                headers.append("x-forwarded-host", host);
            }
        }
    }
    const init = {
        body,
        headers,
        method: ctx.request.method,
        redirect: "follow",
    };
    let request = new Request(url.toString(), init);
    if (reqFn) {
        request = await reqFn(request);
    }
    return request;
}
function getBodyInit(ctx) {
    if (!ctx.request.hasBody) {
        return null;
    }
    return ctx.request.body({ type: "stream" }).value;
}
function iterableHeaders(headers) {
    if (headers instanceof Headers) {
        return headers.entries();
    }
    else if (Array.isArray(headers)) {
        return headers.values();
    }
    else {
        return Object.entries(headers).values();
    }
}
async function processResponse(response, ctx, { contentType: contentTypeFn, response: resFn }) {
    if (resFn) {
        response = await resFn(response);
    }
    if (response.body) {
        ctx.response.body = response.body;
    }
    else {
        ctx.response.body = null;
    }
    ctx.response.status = response.status;
    for (const [key, value] of response.headers) {
        ctx.response.headers.append(key, value);
    }
    if (contentTypeFn) {
        const value = await contentTypeFn(response.url, ctx.response.headers.get("content-type") ?? undefined);
        if (value != null) {
            ctx.response.headers.set("content-type", value);
        }
    }
}
export function proxy(target, options = {}) {
    const matches = createMatcher(options);
    return async function proxy(ctx, next) {
        if (!matches(ctx)) {
            return next();
        }
        const request = await createRequest(target, ctx, options);
        const { fetch = globalThis.fetch } = options;
        const response = await fetch(request);
        await processResponse(response, ctx, options);
        return next();
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJveHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJwcm94eS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFVQSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBd0U3QyxNQUFNLFlBQVksR0FDaEIsaW5CQUFpbkIsQ0FBQztBQUVwbkIsU0FBUyxhQUFhLENBQ3BCLEVBQUUsS0FBSyxFQUFzQjtJQUU3QixPQUFPLFNBQVMsT0FBTyxDQUFDLEdBQXdCO1FBQzlDLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDVixPQUFPLElBQUksQ0FBQztTQUNiO1FBQ0QsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUU7WUFDN0IsT0FBTyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ25EO1FBQ0QsSUFBSSxLQUFLLFlBQVksTUFBTSxFQUFFO1lBQzNCLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUM3QztRQUNELE9BQU8sS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3BCLENBQUMsQ0FBQztBQUNKLENBQUM7QUFFRCxLQUFLLFVBQVUsYUFBYSxDQUMxQixNQUFvQixFQUNwQixHQUFxQyxFQUNyQyxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLFlBQVksR0FBRyxJQUFJLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFDM0M7SUFFcEIsSUFBSSxJQUFJLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDO0lBQ3BDLElBQUksTUFBcUIsQ0FBQztJQUMxQixJQUFJLGVBQWUsQ0FBTyxHQUFHLENBQUMsRUFBRTtRQUM5QixNQUFNLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQztLQUNyQjtJQUNELElBQUksR0FBRyxJQUFJLE9BQU8sR0FBRyxL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QUUsR0FBRyxPQUFPLENBQUM7UUFDN0MsTUFBTSxRQUFRLEdBQUcsTUFBTSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDdEMsTUFBTSxlQUFlLENBQUMsUUFBUSxFQUFFLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUM5QyxPQUFPLElBQUksRUFBRSxDQUFDO0lBQ2hCLENBQUMsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDIxIHRoZSBvYWsgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4gTUlUIGxpY2Vuc2UuXG5cbmltcG9ydCB0eXBlIHsgU3RhdGUgfSBmcm9tIFwiLi4vYXBwbGljYXRpb24udHNcIjtcbmltcG9ydCB0eXBlIHsgQ29udGV4dCB9IGZyb20gXCIuLi9jb250ZXh0LnRzXCI7XG5pbXBvcnQgdHlwZSB7IE1pZGRsZXdhcmUgfSBmcm9tIFwiLi4vbWlkZGxld2FyZS50c1wiO1xuaW1wb3J0IHR5cGUge1xuICBSb3V0ZVBhcmFtcyxcbiAgUm91dGVyQ29udGV4dCxcbiAgUm91dGVyTWlkZGxld2FyZSxcbn0gZnJvbSBcIi4uL3JvdXRlci50c1wiO1xuaW1wb3J0IHsgaXNSb3V0ZXJDb250ZXh0IH0gZnJvbSBcIi4uL3V0aWwudHNcIjtcblxuZXhwb3J0IHR5cGUgRmV0Y2ggPSAoaW5wdXQ6IFJlcXVlc3QpID0+IFByb21pc2U8UmVzcG9uc2U+O1xuXG5leHBvcnQgdHlwZSBQcm94eU1hdGNoRnVuY3Rpb248XG4gIFAgZXh0ZW5kcyBSb3V0ZVBhcmFtcyA9IFJvdXRlUGFyYW1zLFxuICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICBTIGV4dGVuZHMgU3RhdGUgPSBSZWNvcmQ8c3RyaW5nLCBhbnk+LFxuPiA9IChjdHg6IENvbnRleHQ8Uz4gfCBSb3V0ZXJDb250ZXh0PFAsIFM+KSA9PiBib29sZWFuO1xuXG5leHBvcnQgdHlwZSBQcm94eU1hcEZ1bmN0aW9uPFAgZXh0ZW5kcyBSb3V0ZVBhcmFtcz4gPSAoXG4gIHBhdGg6IHN0cmluZyxcbiAgcGFyYW1zPzogUCxcbikgPT4gc3RyaW5nO1xuXG5leHBvcnQgdHlwZSBQcm94eUhlYWRlcnNGdW5jdGlvbjxTIGV4dGVuZHMgU3RhdGU+ID0gKFxuICBjdHg6IENvbnRleHQ8Uz4sXG4pID0+IEhlYWRlcnNJbml0IHwgUHJvbWlzZTxIZWFkZXJzSW5pdD47XG5cbmV4cG9ydCB0eXBlIFByb3h5Um91dGVySGVhZGVyc0Z1bmN0aW9uPFAgZXh0ZW5kcyBSb3V0ZVBhcmFtcywgUyBleHRlbmRzIFN0YXRlPiA9XG4gIChjdHg6IFJvdXRlckNvbnRleHQ8UCwgUz4pID0+IEhlYWRlcnNJbml0IHwgUHJvbWlzZTxIZWFkZXJzSW5pdD47XG5cbmV4cG9ydCBpbnRlcmZhY2UgUHJveHlPcHRpb25zPFxuICBQIGV4dGVuZHMgUm91dGVQYXJhbXMgPSBSb3V0ZVBhcmFtcyxcbiAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgUyBleHRlbmRzIFN0YXRlID0gUmVjb3JkPHN0cmluZywgYW55Pixcbj4ge1xuICAvKiogQSBjYWxsYmFjayBob29rIHRoYXQgaXMgY2FsbGVkIGFmdGVyIHRoZSByZXNwb25zZSBpcyByZWNlaXZlZCB3aGljaCBhbGxvd3NcbiAgICogdGhlIHJlc3BvbnNlIGNvbnRlbnQgdHlwZSB0byBiZSBhZGp1c3RlZC4gVGhpcyBpcyBmb3Igc2l0dWF0aW9ucyB3aGVyZSB0aGVcbiAgICogY29udGVudCB0eXBlIHByb3ZpZGVkIGJ5IHRoZSBwcm94eSBzZXJ2ZXIgbWlnaHQgbm90IGJlIHN1aXRhYmxlIGZvclxuICAgKiByZXNwb25kaW5nIHdpdGguICovXG4gIGNvbnRlbnRUeXBlPyhcbiAgICB1cmw6IHN0cmluZyxcbiAgICBjb250ZW50VHlwZT86IHN0cmluZyxcbiAgKTogUHJvbWlzZTxzdHJpbmcgfCB1bmRlZmluZWQ+IHwgc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAvKiogVGhlIGZldGNoIGZ1bmN0aW9uIHRvIHVzZSB0byBwcm94eSB0aGUgcmVxdWVzdC4gVGhpcyBkZWZhdWx0cyB0byB0aGVcbiAgICogZ2xvYmFsIGBmZXRjaGAgZnVuY3Rpb24uIFRoaXMgaXMgZGVzaWduZWQgZm9yIHRlc3QgbW9ja2luZyBwdXJwb3Nlcy4gKi9cbiAgZmV0Y2g/OiBGZXRjaDtcbiAgLyoqIEFkZGl0aW9uYWwgaGVhZGVycyB0aGF0IHNob3VsZCBiZSBzZXQgaW4gdGhlIHJlc3BvbnNlLiBUaGUgdmFsdWUgY2FuXG4gICAqIGJlIGEgaGVhZGVycyBpbml0IHZhbHVlIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIG9yIHJlc29sdmVzIHdpdGggYVxuICAgKiBoZWFkZXJzIGluaXQgdmFsdWUuICovXG4gIGhlYWRlcnM/OlxuICAgIHwgSGVhZGVyc0luaXRcbiAgICB8IFByb3h5SGVhZGVyc0Z1bmN0aW9uPFM+XG4gICAgfCBQcm94eVJvdXRlckhlYWRlcnNGdW5jdGlvbjxQLCBTPjtcbiAgLyoqIEVpdGhlciBhIHJlY29yZCBvciBhIHByb3h5IG1hcCBmdW5jdGlvbiB0aGF0IHdpbGwgYWxsb3cgcHJveGllZCByZXF1ZXN0c1xuICAgKiBiZWluZyBoYW5kbGVkIGJ5IHRoZSBtaWRkbGV3YXJlIHRvIGJlIHJlbWFwcGVkIHRvIGEgZGlmZmVyZW50IHJlbW90ZVxuICAgKiBwYXRoLiAqL1xuICBtYXA/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+IHwgUHJveHlNYXBGdW5jdGlvbjxQPjtcbiAgLyoqIEEgc3RyaW5nLCByZWd1bGFyIGV4cHJlc3Npb24gb3IgcHJveHkgbWF0Y2ggZnVuY3Rpb24gd2hhdCBkZXRlcm1pbmVzIGlmXG4gICAqIHRoZSBwcm94eSBtaWRkbGV3YXJlIHNob3VsZCBwcm94eSB0aGUgcmVxdWVzdC5cbiAgICpcbiAgICogSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHRoZSBtYXRjaCB3aWxsIGJlIHRydWUgaWYgdGhlIHJlcXVlc3RzIHBhdGhuYW1lXG4gICAqIHN0YXJ0cyB3aXRoIHRoZSBzdHJpbmcuIEluIHRoZSBjYXNlIG9mIGEgcmVndWxhciBleHByZXNzaW9uLCBpZiB0aGVcbiAgICogcGF0aG5hbWVcbiAgICogKi9cbiAgbWF0Y2g/OlxuICAgIHwgc3RyaW5nXG4gICAgfCBSZWdFeHBcbiAgICB8IFByb3h5TWF0Y2hGdW5jdGlvbjxQLCBTPjtcbiAgLyoqIEEgZmxhZyB0aGF0IGluZGljYXRlcyBpZiB0cmFkaXRpb25hbCBwcm94eSBoZWFkZXJzIHNob3VsZCBiZSBzZXQgaW4gdGhlXG4gICAqIHJlc3BvbnNlLiBUaGlzIGRlZmF1bHRzIHRvIGB0cnVlYC5cbiAgICovXG4gIHByb3h5SGVhZGVycz86IGJvb2xlYW47XG4gIC8qKiBBIGNhbGxiYWNrIGhvb2sgd2hpY2ggd2lsbCBiZSBjYWxsZWQgYmVmb3JlIGVhY2ggcHJveGllZCBmZXRjaCByZXF1ZXN0XG4gICAqIHRvIGFsbG93IHRoZSBuYXRpdmUgYFJlcXVlc3RgIHRvIGJlIG1vZGlmaWVkIG9yIHJlcGxhY2VkLiAqL1xuICByZXF1ZXN0PyhyZXE6IFJlcXVlc3QpOiBSZXF1ZXN0IHwgUHJvbWlzZTxSZXF1ZXN0PjtcbiAgLyoqIEEgY2FsbGJhY2sgaG9vayB3aGljaCB3aWxsIGJlIGNhbGxlZCBhZnRlciBlYWNoIHByb3hpZWQgZmV0Y2ggcmVzcG9uc2VcbiAgICogaXMgcmVjZWl2ZWQgdG8gYWxsb3cgdGhlIG5hdGl2ZSBgUmVzcG9uc2VgIHRvIGJlIG1vZGlmaWVkIG9yIHJlcGxhY2VkLiAqL1xuICByZXNwb25zZT8ocmVzOiBSZXNwb25zZSk6IFJlc3BvbnNlIHwgUHJvbWlzZTxSZXNwb25zZT47XG59XG5cbmNvbnN0IEZPUldBUkRFRF9SRSA9XG4gIC9eKCxbIFxcXFx0XSopKihbISMkJSYnKisuXl9gfH4wLTlBLVphLXotXSs9KFshIyQlJicqKy5eX2B8fjAtOUEtWmEtei1dK3xcXFwiKFtcXFxcdCBcXFxceDIxXFxcXHgyMy1cXFxceDVCXFxcXHg1RC1cXFxceDdFXFxcXHg4MC1cXFxceEZGXXxcXFxcXFxcXFtcXFxcdCBcXFxceDIxLVxcXFx4N0VcXFxceDgwLVxcXFx4RkZdKSpcXFwiKSk/KDsoWyEjJCUmJyorLl5fYHx+MC05QS1aYS16LV0rPShbISMkJSYnKisuXl9gfH4wLTlBLVphLXotXSt8XFxcIihbXFxcXHQgXFxcXHgyMVxcXFx4MjMtXFxcXHg1QlxcXFx4NUQtXFxcXHg3RVxcXFx4ODAtXFxcXHhGRl18XFxcXFxcXFxbXFxcXHQgXFxcXHgyMS1cXFxceDdFXFxcXHg4MC1cXFxceEZGXSkqXFxcIikpPykqKFsgXFxcXHRdKiwoWyBcXFxcdF0qKFshIyQlJicqKy5eX2B8fjAtOUEtWmEtei1dKz0oWyEjJCUmJyorLl5fYHx+MC05QS1aYS16LV0rfFxcXCIoW1xcXFx0IFxcXFx4MjFcXFxceDIzLVxcXFx4NUJcXFxceDVELVxcXFx4N0VcXFxceDgwLVxcXFx4RkZdfFxcXFxcXFxcW1xcXFx0IFxcXFx4MjEtXFxcXHg3RVxcXFx4ODAtXFxcXHhGRl0pKlxcXCIpKT8oOyhbISMkJSYnKisuXl9gfH4wLTlBLVphLXotXSs9KFshIyQlJicqKy5eX2B8fjAtOUEtWmEtei1dK3xcXFwiKFtcXFxcdCBcXFxceDIxXFxcXHgyMy1cXFxceDVCXFxcXHg1RC1cXFxceDdFXFxcXHg4MC1cXFxceEZGXXxcXFxcXFxcXFtcXFxcdCBcXFxceDIxLVxcXFx4N0VcXFxceDgwLVxcXFx4RkZdKSpcXFwiKSk/KSopPykqJC9nO1xuXG5mdW5jdGlvbiBjcmVhdGVNYXRjaGVyPFAgZXh0ZW5kcyBSb3V0ZVBhcmFtcywgUyBleHRlbmRzIFN0YXRlPihcbiAgeyBtYXRjaCB9OiBQcm94eU9wdGlvbnM8UCwgUz4sXG4pIHtcbiAgcmV0dXJuIGZ1bmN0aW9uIG1hdGNoZXMoY3R4OiBSb3V0ZXJDb250ZXh0PFAsIFM+KTogYm9vbGVhbiB7XG4gICAgaWYgKCFtYXRjaCkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgbWF0Y2ggPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHJldHVybiBjdHgucmVxdWVzdC51cmwucGF0aG5hbWUuc3RhcnRzV2l0aChtYXRjaCk7XG4gICAgfVxuICAgIGlmIChtYXRjaCBpbnN0YW5jZW9mIFJlZ0V4cCkge1xuICAgICAgcmV0dXJuIG1hdGNoLnRlc3QoY3R4LnJlcXVlc3QudXJsLnBhdGhuYW1lKTtcbiAgICB9XG4gICAgcmV0dXJuIG1hdGNoKGN0eCk7XG4gIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVJlcXVlc3Q8UCBleHRlbmRzIFJvdXRlUGFyYW1zLCBTIGV4dGVuZHMgU3RhdGU+KFxuICB0YXJnZXQ6IHN0cmluZyB8IFVSTCxcbiAgY3R4OiBDb250ZXh0PFM+IHwgUm91dGVyQ29udGV4dDxQLCBTPixcbiAgeyBoZWFkZXJzOiBvcHRIZWFkZXJzLCBtYXAsIHByb3h5SGVhZGVycyA9IHRydWUsIHJlcXVlc3Q6IHJlcUZuIH06XG4gICAgUHJveHlPcHRpb25zPFAsIFM+LFxuKTogUHJvbWlzZTxSZXF1ZXN0PiB7XG4gIGxldCBwYXRoID0gY3R4LnJlcXVlc3QudXJsLnBhdGhuYW1lO1xuICBsZXQgcGFyYW1zOiBQIHwgdW5kZWZpbmVkO1xuICBpZiAoaXNSb3V0ZXJDb250ZXh0PFAsIFM+KGN0eCkpIHtcbiAgICBwYXJhbXMgPSBjdHgucGFyYW1zO1xuICB9XG4gIGlmIChtYXAgJiYgdHlwZW9mIG1hcCA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgcGF0aCA9IG1hcChwYXRoLCBwYXJhbXMpO1xuICB9IGVsc2UgaWYgKG1hcCkge1xuICAgIHBhdGggPSBtYXBbcGF0aF0gPz8gcGF0aDtcbiAgfVxuICBjb25zdCB1cmwgPSBuZXcgVVJMKFN0cmluZyh0YXJnZXQpKTtcbiAgaWYgKHVybC5wYXRobmFtZS5lbmRzV2l0aChcIi9cIikgJiYgcGF0aC5zdGFydHNXaXRoKFwiL1wiKSkge1xuICAgIHVybC5wYXRobmFtZSA9IGAke3VybC5wYXRobmFtZX0ke3BhdGguc2xpY2UoMSl9YDtcbiAgfSBlbHNlIGlmICghdXJsLnBhdGhuYW1lLmVuZHNXaXRoKFwiL1wiKSAmJiAhcGF0aC5zdGFydHNXaXRoKFwiL1wiKSkge1xuICAgIHVybC5wYXRobmFtZSA9IGAke3VybC5wYXRobmFtZX0vJHtwYXRofWA7XG4gIH0gZWxzZSB7XG4gICAgdXJsLnBhdGhuYW1lID0gYCR7dXJsLnBhdGhuYW1lfSR7cGF0aH1gO1xuICB9XG4gIHVybC5zZWFyY2ggPSBjdHgucmVxdWVzdC51cmwuc2VhcmNoO1xuXG4gIGNvbnN0IGJvZHkgPSBnZXRCb2R5SW5pdChjdHgpO1xuICBjb25zdCBoZWFkZXJzID0gbmV3IEhlYWRlcnMoY3R4LnJlcXVlc3QuaGVhZGVycyk7XG4gIGlmIChvcHRIZWFkZXJzKSB7XG4gICAgaWYgKHR5cGVvZiBvcHRIZWFkZXJzID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIG9wdEhlYWRlcnMgPSBhd2FpdCBvcHRIZWFkZXJzKGN0eCBhcyBSb3V0ZXJDb250ZXh0PFAsIFM+KTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgaXRlcmFibGVIZWFkZXJzKG9wdEhlYWRlcnMpKSB7XG4gICAgICBoZWFkZXJzLnNldChrZXksIHZhbHVlKTtcbiAgICB9XG4gIH1cbiAgaWYgKHByb3h5SGVhZGVycykge1xuICAgIGNvbnN0IG1heWJlRm9yd2FyZGVkID0gaGVhZGVycy5nZXQoXCJmb3J3YXJkZWRcIik7XG4gICAgY29uc3QgaXAgPSBjdHgucmVxdWVzdC5pcC5zdGFydHNXaXRoKFwiW1wiKVxuICAgICAgPyBgXCIke2N0eC5yZXF1ZXN0LmlwfVwiYFxuICAgICAgOiBjdHgucmVxdWVzdC5pcDtcbiAgICBjb25zdCBob3N0ID0gaGVhZGVycy5nZXQoXCJob3N0XCIpO1xuICAgIGlmIChtYXliZUZvcndhcmRlZCAmJiBGT1JXQVJERURfUkUudGVzdChtYXliZUZvcndhcmRlZCkpIHtcbiAgICAgIGxldCB2YWx1ZSA9IGBmb3I9JHtpcH1gO1xuICAgICAgaWYgKGhvc3QpIHtcbiAgICAgICAgdmFsdWUgKz0gYDtob3N0PSR7aG9zdH1gO1xuICAgICAgfVxuICAgICAgaGVhZGVycy5hcHBlbmQoXCJmb3J3YXJkZWRcIiwgdmFsdWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBoZWFkZXJzLmFwcGVuZChcIngtZm9yd2FyZGVkLWZvclwiLCBpcCk7XG4gICAgICBpZiAoaG9zdCkge1xuICAgICAgICBoZWFkZXJzLmFwcGVuZChcIngtZm9yd2FyZGVkLWhvc3RcIiwgaG9zdCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgY29uc3QgaW5pdDogUmVxdWVzdEluaXQgPSB7XG4gICAgYm9keSxcbiAgICBoZWFkZXJzLFxuICAgIG1ldGhvZDogY3R4LnJlcXVlc3QubWV0aG9kLFxuICAgIHJlZGlyZWN0OiBcImZvbGxvd1wiLFxuICB9O1xuICBsZXQgcmVxdWVzdCA9IG5ldyBSZXF1ZXN0KHVybC50b1N0cmluZygpLCBpbml0KTtcbiAgaWYgKHJlcUZuKSB7XG4gICAgcmVxdWVzdCA9IGF3YWl0IHJlcUZuKHJlcXVlc3QpO1xuICB9XG4gIHJldHVybiByZXF1ZXN0O1xufVxuXG5mdW5jdGlvbiBnZXRCb2R5SW5pdDxQIGV4dGVuZHMgUm91dGVQYXJhbXMsIFMgZXh0ZW5kcyBTdGF0ZT4oXG4gIGN0eDogQ29udGV4dDxTPiB8IFJvdXRlckNvbnRleHQ8UCwgUz4sXG4pOiBCb2R5SW5pdCB8IG51bGwge1xuICBpZiAoIWN0eC5yZXF1ZXN0Lmhhc0JvZHkpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICByZXR1cm4gY3R4LnJlcXVlc3QuYm9keSh7IHR5cGU6IFwic3RyZWFtXCIgfSkudmFsdWU7XG59XG5cbmZ1bmN0aW9uIGl0ZXJhYmxlSGVhZGVycyhcbiAgaGVhZGVyczogSGVhZGVyc0luaXQsXG4pOiBJdGVyYWJsZUl0ZXJhdG9yPFtzdHJpbmcsIHN0cmluZ10+IHtcbiAgaWYgKGhlYWRlcnMgaW5zdGFuY2VvZiBIZWFkZXJzKSB7XG4gICAgcmV0dXJuIGhlYWRlcnMuZW50cmllcygpO1xuICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoaGVhZGVycykpIHtcbiAgICByZXR1cm4gaGVhZGVycy52YWx1ZXMoKSBhcyBJdGVyYWJsZUl0ZXJhdG9yPFtzdHJpbmcsIHN0cmluZ10+O1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBPYmplY3QuZW50cmllcyhoZWFkZXJzKS52YWx1ZXMoKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBwcm9jZXNzUmVzcG9uc2U8UCBleHRlbmRzIFJvdXRlUGFyYW1zLCBTIGV4dGVuZHMgU3RhdGU+KFxuICByZXNwb25zZTogUmVzcG9uc2UsXG4gIGN0eDogQ29udGV4dDxTPiB8IFJvdXRlckNvbnRleHQ8UCwgUz4sXG4gIHsgY29udGVudFR5cGU6IGNvbnRlbnRUeXBlRm4sIHJlc3BvbnNlOiByZXNGbiB9OiBQcm94eU9wdGlvbnM8UCwgUz4sXG4pIHtcbiAgaWYgKHJlc0ZuKSB7XG4gICAgcmVzcG9uc2UgPSBhd2FpdCByZXNGbihyZXNwb25zZSk7XG4gIH1cbiAgaWYgKHJlc3BvbnNlLmJvZHkpIHtcbiAgICBjdHgucmVzcG9uc2UuYm9keSA9IHJlc3BvbnNlLmJvZHk7XG4gIH0gZWxzZSB7XG4gICAgY3R4LnJlc3BvbnNlLmJvZHkgPSBudWxsO1xuICB9XG4gIGN0eC5yZXNwb25zZS5zdGF0dXMgPSByZXNwb25zZS5zdGF0dXM7XG4gIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIHJlc3BvbnNlLmhlYWRlcnMpIHtcbiAgICBjdHgucmVzcG9uc2UuaGVhZGVycy5hcHBlbmQoa2V5LCB2YWx1ZSk7XG4gIH1cbiAgaWYgKGNvbnRlbnRUeXBlRm4pIHtcbiAgICBjb25zdCB2YWx1ZSA9IGF3YWl0IGNvbnRlbnRUeXBlRm4oXG4gICAgICByZXNwb25zZS51cmwsXG4gICAgICBjdHgucmVzcG9uc2UuaGVhZGVycy5nZXQoXCJjb250ZW50LXR5cGVcIikgPz8gdW5kZWZpbmVkLFxuICAgICk7XG4gICAgaWYgKHZhbHVlICE9IG51bGwpIHtcbiAgICAgIGN0eC5yZXNwb25zZS5oZWFkZXJzLnNldChcImNvbnRlbnQtdHlwZVwiLCB2YWx1ZSk7XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogTWlkZGxld2FyZSB0aGF0IHByb3ZpZGVzIGEgYmFjay10by1iYWNrIHByb3h5IGZvciByZXF1ZXN0cy5cbiAqXG4gKiBAcGFyYW0gdGFyZ2V0XG4gKiBAcGFyYW0gb3B0aW9uc1xuICovXG5leHBvcnQgZnVuY3Rpb24gcHJveHk8UyBleHRlbmRzIFN0YXRlPihcbiAgdGFyZ2V0OiBzdHJpbmcgfCBVUkwsXG4gIG9wdGlvbnM/OiBQcm94eU9wdGlvbnM8Um91dGVQYXJhbXMsIFM+LFxuKTogTWlkZGxld2FyZTxTPjtcbmV4cG9ydCBmdW5jdGlvbiBwcm94eTxQIGV4dGVuZHMgUm91dGVQYXJhbXMsIFMgZXh0ZW5kcyBTdGF0ZT4oXG4gIHRhcmdldDogc3RyaW5nIHwgVVJMLFxuICBvcHRpb25zOiBQcm94eU9wdGlvbnM8UCwgUz4gPSB7fSxcbik6IFJvdXRlck1pZGRsZXdhcmU8UCwgUz4ge1xuICBjb25zdCBtYXRjaGVzID0gY3JlYXRlTWF0Y2hlcihvcHRpb25zKTtcbiAgcmV0dXJuIGFzeW5jIGZ1bmN0aW9uIHByb3h5KGN0eCwgbmV4dCkge1xuICAgIGlmICghbWF0Y2hlcyhjdHgpKSB7XG4gICAgICByZXR1cm4gbmV4dCgpO1xuICAgIH1cbiAgICBjb25zdCByZXF1ZXN0ID0gYXdhaXQgY3JlYXRlUmVxdWVzdCh0YXJnZXQsIGN0eCwgb3B0aW9ucyk7XG4gICAgY29uc3QgeyBmZXRjaCA9IGdsb2JhbFRoaXMuZmV0Y2ggfSA9IG9wdGlvbnM7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChyZXF1ZXN0KTtcbiAgICBhd2FpdCBwcm9jZXNzUmVzcG9uc2UocmVzcG9uc2UsIGN0eCwgb3B0aW9ucyk7XG4gICAgcmV0dXJuIG5leHQoKTtcbiAgfTtcbn1cbiJdfQ==