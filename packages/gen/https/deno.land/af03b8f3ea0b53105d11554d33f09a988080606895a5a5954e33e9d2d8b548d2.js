import { buildFlags, } from "./scripts.ts";
import { merge } from "./merge.ts";
const reDenoAction = new RegExp(/^(deno +\w+) *(.*)$/);
const reCompact = new RegExp(/^'(?:\\'|.)*?\.(ts|js)'|^"(?:\\"|.)*?\.(ts|js)"|^(?:\\ |\S)+\.(ts|js)$/);
const reCliCompact = new RegExp(/^(run|test|fmt|lint) *(.*)$/);
export class Runner {
    #config;
    #args;
    constructor(config, args = []) {
        this.#config = config;
        this.#args = args;
    }
    cmd(cmd, options) {
        const command = {
            cmd,
            options,
            exe: () => {
                return this.execute(command);
            },
        };
        return command;
    }
    buildCliCommand(args, global) {
        const cmd = args.join(" ");
        let out;
        if (reCompact.test(cmd)) {
            out = ["deno", "run"];
            out = out.concat(stdCmd(cmd));
        }
        else if (reCliCompact.test(cmd)) {
            out = ["deno"];
            out = out.concat(stdCmd(cmd));
        }
        else {
            out = stdCmd(cmd);
        }
        return this.cmd(out, global);
    }
    buildCommands(script, global, args) {
        if (typeof script === "object") {
            const options = Object.assign({}, merge(global, script));
            return this.buildStringCommands(script.cmd, options, args);
        }
        return this.buildStringCommands(script, global, args);
    }
    buildStringCommands(script, global, args) {
        if (script.includes("&&")) {
            const commands = [];
            script.split("&&").map((s) => {
                commands.push(this.buildCommand(s, global, args));
            });
            return commands;
        }
        return [this.buildCommand(script, global, args)];
    }
    buildCommand(cmd, options, cli) {
        let out = [];
        cmd = stdCmd(cmd).join(" ");
        const denoAction = reDenoAction.exec(cmd);
        if (denoAction && denoAction.length === 3) {
            const action = denoAction[1];
            const args = denoAction[2];
            out = out.concat(stdCmd(action));
            out = out.concat(buildFlags(options));
            if (args)
                out = out.concat(stdCmd(args));
        }
        else if (reCompact.test(cmd)) {
            out = ["deno", "run"];
            out = out.concat(buildFlags(options));
            out = out.concat(stdCmd(cmd));
        }
        else {
            out = stdCmd(cmd);
        }
        if (cli)
            out = out.concat(cli);
        return this.cmd(out, options);
    }
    build(script) {
        const g = Object.assign({
            watch: true,
        }, this.#config);
        g.scripts = {};
        const s = this.#config.scripts[script];
        if (!s) {
            if (this.#args.length > 0) {
                return [this.buildCliCommand(this.#args, g)];
            }
            else {
                throw new Error("Script does not exist and CLI args are not provided.");
            }
        }
        const args = this.#args.slice(1);
        let commands = [];
        if (Array.isArray(s)) {
            s.forEach((ss) => {
                commands = commands.concat(this.buildCommands(ss, g, args));
            });
        }
        else {
            commands = commands.concat(this.buildCommands(s, g, args));
        }
        return commands;
    }
    execute(command) {
        const options = {
            cmd: command.cmd,
            env: command.options.env ?? {},
            stdin: command.options.stdin ?? "inherit",
            stdout: command.options.stdout ?? "inherit",
            stderr: command.options.stderr ?? "inherit",
        };
        return Deno.run(options);
    }
}
function stdCmd(cmd) {
    return cmd.trim().replace(/\s\s+/g, " ").split(" ");
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnVubmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaHR0cHM6Ly9kZW5vLmxhbmQveC9kZW5vbkAyLjUuMC9zcmMvcnVubmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFDTCxVQUFVLEdBS1gsTUFBTSxjQUFjLENBQUM7QUFFdEIsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFlBQVksQ0FBQztBQVVuQyxNQUFNLFlBQVksR0FBRyxJQUFJLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0FBQ3ZELE1BQU0sU0FBUyxHQUFHLElBQUksTUFBTSxDQUMxQix3RUFBd0UsQ0FDekUsQ0FBQztBQUNGLE1BQU0sWUFBWSxHQUFHLElBQUksTUFBTSxDQUFDLDZCQUE2QixDQUFDLENBQUM7QUFNL0QsTUFBTSxPQUFPLE1BQU07SUFDakIsT0FBTyxDQUFlO0lBQ3RCLEtBQUssQ0FBVztJQUVoQixZQUFZLE1BQW9CLEVBQUUsT0FBaUIsRUFBRTtRQUNuRCxJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztRQUN0QixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztJQUNwQixDQUFDO0lBRU8sR0FBRyxDQUFDLEdBQWEsRUFBRSxPQUFzQjtRQUMvQyxNQUFNLE9BQU8sR0FBRztZQUNkLEdBQUc7WUFDSCxPQUFPO1lBQ1AsR0FBRyxFQUFFLEdBQWlCLEVBQUU7Z0JBQ3RCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUMvQixDQUFDO1NBQ0YsQ0FBQztRQUNGLE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7SUFFTyxlQUFlLENBQUMsSUFBYyxFQUFFLE1BQXFCO1FBQzNELE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDM0IsSUFBSSxHQUFhLENBQUM7UUFDbEIsSUFBSSxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3ZCLEdB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QUMsRUFBRSxFQUFFLEVBQUU7Z0JBQ2YsUUFBUSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDOUQsQ0FBQyxDQUFDLENBQUM7U0FDSjthQUFNO1lBQ0wsUUFBUSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7U0FDNUQ7UUFFRCxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0lBSUQsT0FBTyxDQUFDLE9BQWdCO1FBQ3RCLE1BQU0sT0FBTyxHQUFHO1lBQ2QsR0FBRyxFQUFFLE9BQU8sQ0FBQyxHQUFHO1lBQ2hCLEdBQUcsRUFBRSxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsSUFBSSxFQUFFO1lBQzlCLEtBQUssRUFBRSxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssSUFBSSxTQUFTO1lBQ3pDLE1BQU0sRUFBRSxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sSUFBSSxTQUFTO1lBQzNDLE1BQU0sRUFBRSxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sSUFBSSxTQUFTO1NBQzVDLENBQUM7UUFDRixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDM0IsQ0FBQztDQUNGO0FBRUQsU0FBUyxNQUFNLENBQUMsR0FBVztJQUN6QixPQUFPLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUN0RCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjAtMjAyMSB0aGUgZGVub3NhdXJzIHRlYW0uIEFsbCByaWdodHMgcmVzZXJ2ZWQuIE1JVCBsaWNlbnNlLlxuXG5pbXBvcnQge1xuICBidWlsZEZsYWdzLFxuICBTY3JpcHQsXG4gIFNjcmlwdE9iamVjdCxcbiAgU2NyaXB0T3B0aW9ucyxcbiAgU2NyaXB0cyxcbn0gZnJvbSBcIi4vc2NyaXB0cy50c1wiO1xuXG5pbXBvcnQgeyBtZXJnZSB9IGZyb20gXCIuL21lcmdlLnRzXCI7XG5cbi8qKiBgUnVubmVyYCBjb25maWd1cmF0aW9uLlxuICogVGhpcyBjb25maWd1cmF0aW9uIGlzLCBpbiBjb250cmFzdCB0byBvdGhlciwgZXh0ZW5kZWRcbiAqIGJ5IGBEZW5vbmAgY29uZmlnIGFzIHNjcmlwdHMgaGFzIHRvIGJlIGEgdG9wIGxldmVsXG4gKiBwYXJhbWV0ZXIuICovXG5leHBvcnQgaW50ZXJmYWNlIFJ1bm5lckNvbmZpZyBleHRlbmRzIFNjcmlwdE9wdGlvbnMge1xuICBzY3JpcHRzOiBTY3JpcHRzO1xufVxuXG5jb25zdCByZURlbm9BY3Rpb24gPSBuZXcgUmVnRXhwKC9eKGRlbm8gK1xcdyspICooLiopJC8pO1xuY29uc3QgcmVDb21wYWN0ID0gbmV3IFJlZ0V4cChcbiAgL14nKD86XFxcXCd8LikqP1xcLih0c3xqcyknfF5cIig/OlxcXFxcInwuKSo/XFwuKHRzfGpzKVwifF4oPzpcXFxcIHxcXFMpK1xcLih0c3xqcykkLyxcbik7XG5jb25zdCByZUNsaUNvbXBhY3QgPSBuZXcgUmVnRXhwKC9eKHJ1bnx0ZXN0fGZtdHxsaW50KSAqKC4qKSQvKTtcblxuLyoqIEhhbmRsZSBhbGwgdGhlIHRoaW5ncyByZWxhdGVkIHRvIHByb2Nlc3MgbWFuYWdlbWVudC5cbiAqIFNjcmlwdHMgYXJlIGJ1aWx0IGludG8gZXhlY3V0YWJsZSBjb21tYW5kcyB0aGF0IGFyZVxuICogZXhlY3V0ZWQgYnkgYERlbm8ucnVuKClgIGFuZCBtYW5hZ2VkIGluIGFuIGBFeGVjdXRhYmxlYFxuICogb2JqZWN0IHRvIG1ha2UgYXZhaWxhYmxlIHByb2Nlc3MgZXZlbnRzLiAqL1xuZXhwb3J0IGNsYXNzIFJ1bm5lciB7XG4gICNjb25maWc6IFJ1bm5lckNvbmZpZztcbiAgI2FyZ3M6IHN0cmluZ1tdO1xuXG4gIGNvbnN0cnVjdG9yKGNvbmZpZzogUnVubmVyQ29uZmlnLCBhcmdzOiBzdHJpbmdbXSA9IFtdKSB7XG4gICAgdGhpcy4jY29uZmlnID0gY29uZmlnO1xuICAgIHRoaXMuI2FyZ3MgPSBhcmdzO1xuICB9XG5cbiAgcHJpdmF0ZSBjbWQoY21kOiBzdHJpbmdbXSwgb3B0aW9uczogU2NyaXB0T3B0aW9ucyk6IENvbW1hbmQge1xuICAgIGNvbnN0IGNvbW1hbmQgPSB7XG4gICAgICBjbWQsXG4gICAgICBvcHRpb25zLFxuICAgICAgZXhlOiAoKTogRGVuby5Qcm9jZXNzID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZXhlY3V0ZShjb21tYW5kKTtcbiAgICAgIH0sXG4gICAgfTtcbiAgICByZXR1cm4gY29tbWFuZDtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRDbGlDb21tYW5kKGFyZ3M6IHN0cmluZ1tdLCBnbG9iYWw6IFNjcmlwdE9wdGlvbnMpOiBDb21tYW5kIHtcbiAgICBjb25zdCBjbWQgPSBhcmdzLmpvaW4oXCIgXCIpO1xuICAgIGxldCBvdXQ6IHN0cmluZ1tdO1xuICAgIGlmIChyZUNvbXBhY3QudGVzdChjbWQpKSB7XG4gICAgICBvdXQgPSBbXCJkZW5vXCIsIFwicnVuXCJdO1xuICAgICAgb3V0ID0gb3V0LmNvbmNhdChzdGRDbWQoY21kKSk7XG4gICAgfSBlbHNlIGlmIChyZUNsaUNvbXBhY3QudGVzdChjbWQpKSB7XG4gICAgICBvdXQgPSBbXCJkZW5vXCJdO1xuICAgICAgb3V0ID0gb3V0LmNvbmNhdChzdGRDbWQoY21kKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIG91dCA9IHN0ZENtZChjbWQpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5jbWQob3V0LCBnbG9iYWwpOyAvLyBzaW5nbGUgY29tbWFuZFxuICB9XG5cbiAgcHJpdmF0ZSBidWlsZENvbW1hbmRzKFxuICAgIHNjcmlwdDogc3RyaW5nIHwgU2NyaXB0T2JqZWN0LFxuICAgIGdsb2JhbDogU2NyaXB0T3B0aW9ucyxcbiAgICBhcmdzOiBzdHJpbmdbXSxcbiAgKTogQ29tbWFuZFtdIHtcbiAgICBpZiAodHlwZW9mIHNjcmlwdCA9PT0gXCJvYmplY3RcIikge1xuICAgICAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIG1lcmdlKGdsb2JhbCwgc2NyaXB0KSk7XG4gICAgICByZXR1cm4gdGhpcy5idWlsZFN0cmluZ0NvbW1hbmRzKHNjcmlwdC5jbWQsIG9wdGlvbnMsIGFyZ3MpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmJ1aWxkU3RyaW5nQ29tbWFuZHMoc2NyaXB0LCBnbG9iYWwsIGFyZ3MpO1xuICB9XG5cbiAgcHVibGljIGJ1aWxkU3RyaW5nQ29tbWFuZHMoXG4gICAgc2NyaXB0OiBzdHJpbmcsXG4gICAgZ2xvYmFsOiBTY3JpcHRPcHRpb25zLFxuICAgIGFyZ3M6IHN0cmluZ1tdLFxuICApOiBDb21tYW5kW10ge1xuICAgIGlmIChzY3JpcHQuaW5jbHVkZXMoXCImJlwiKSkge1xuICAgICAgY29uc3QgY29tbWFuZHM6IENvbW1hbmRbXSA9IFtdO1xuICAgICAgc2NyaXB0LnNwbGl0KFwiJiZcIikubWFwKChzKSA9PiB7XG4gICAgICAgIGNvbW1hbmRzLnB1c2godGhpcy5idWlsZENvbW1hbmQocywgZ2xvYmFsLCBhcmdzKSk7XG4gICAgICB9KTtcbiAgICAgIHJldHVybiBjb21tYW5kcztcbiAgICB9XG5cbiAgICByZXR1cm4gW3RoaXMuYnVpbGRDb21tYW5kKHNjcmlwdCwgZ2xvYmFsLCBhcmdzKV07XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkQ29tbWFuZChcbiAgICBjbWQ6IHN0cmluZyxcbiAgICBvcHRpb25zOiBTY3JpcHRPcHRpb25zLFxuICAgIGNsaTogc3RyaW5nW10sXG4gICk6IENvbW1hbmQge1xuICAgIGxldCBvdXQ6IHN0cmluZ1tdID0gW107XG4gICAgY21kID0gc3RkQ21kKGNtZCkuam9pbihcIiBcIik7XG4gICAgY29uc3QgZGVub0FjdGlvbiA9IHJlRGVub0FjdGlvbi5leGVjKGNtZCk7XG4gICAgaWYgKGRlbm9BY3Rpb24gJiYgZGVub0FjdGlvbi5sZW5ndGggPT09IDMpIHtcbiAgICAgIGNvbnN0IGFjdGlvbiA9IGRlbm9BY3Rpb25bMV07XG4gICAgICBjb25zdCBhcmdzID0gZGVub0FjdGlvblsyXTtcbiAgICAgIG91dCA9IG91dC5jb25jYXQoc3RkQ21kKGFjdGlvbikpO1xuICAgICAgb3V0ID0gb3V0LmNvbmNhdChidWlsZEZsYWdzKG9wdGlvbnMpKTtcbiAgICAgIGlmIChhcmdzKSBvdXQgPSBvdXQuY29uY2F0KHN0ZENtZChhcmdzKSk7XG4gICAgfSBlbHNlIGlmIChyZUNvbXBhY3QudGVzdChjbWQpKSB7XG4gICAgICBvdXQgPSBbXCJkZW5vXCIsIFwicnVuXCJdO1xuICAgICAgb3V0ID0gb3V0LmNvbmNhdChidWlsZEZsYWdzKG9wdGlvbnMpKTtcbiAgICAgIG91dCA9IG91dC5jb25jYXQoc3RkQ21kKGNtZCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBvdXQgPSBzdGRDbWQoY21kKTtcbiAgICB9XG5cbiAgICBpZiAoY2xpKSBvdXQgPSBvdXQuY29uY2F0KGNsaSk7XG4gICAgcmV0dXJuIHRoaXMuY21kKG91dCwgb3B0aW9ucyk7IC8vIHNpbmdsZSBjb21tYW5kXG4gIH1cblxuICAvKiogQnVpbGQgdGhlIHNjcmlwdCwgaW4gd2hhdGV2ZXIgZm9ybSBpdCBpcyBkZWNsYXJlZCBpbixcbiAgICogdG8gYmUgY29tcGF0aWJsZSB3aXRoIGBEZW5vLnJ1bigpYC5cbiAgICogVGhpcyBmdW5jdGlvbiBhZGQgZmxhZ3MsIGFyZ3VtZW50cyBhbmQgYWN0aW9ucy4gKi9cbiAgYnVpbGQoc2NyaXB0OiBzdHJpbmcpOiBDb21tYW5kW10ge1xuICAgIC8vIGdsb2JhbCBvcHRpb25zXG4gICAgY29uc3QgZyA9IE9iamVjdC5hc3NpZ24oXG4gICAgICB7XG4gICAgICAgIHdhdGNoOiB0cnVlLCAvLyB0aGlzIGlzIGEgZmlsZSB3YXRjaGVyIGFmdGVyIGFsbCA6KVxuICAgICAgfSxcbiAgICAgIHRoaXMuI2NvbmZpZyxcbiAgICApO1xuICAgIGcuc2NyaXB0cyA9IHt9O1xuXG4gICAgY29uc3QgczogU2NyaXB0ID0gdGhpcy4jY29uZmlnLnNjcmlwdHNbc2NyaXB0XTtcblxuICAgIGlmICghcykge1xuICAgICAgaWYgKHRoaXMuI2FyZ3MubGVuZ3RoID4gMCkge1xuICAgICAgICByZXR1cm4gW3RoaXMuYnVpbGRDbGlDb21tYW5kKHRoaXMuI2FyZ3MsIGcpXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIlNjcmlwdCBkb2VzIG5vdCBleGlzdCBhbmQgQ0xJIGFyZ3MgYXJlIG5vdCBwcm92aWRlZC5cIik7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgYXJncyA9IHRoaXMuI2FyZ3Muc2xpY2UoMSk7XG5cbiAgICBsZXQgY29tbWFuZHM6IENvbW1hbmRbXSA9IFtdO1xuXG4gICAgaWYgKEFycmF5LmlzQXJyYXkocykpIHtcbiAgICAgIHMuZm9yRWFjaCgoc3MpID0+IHtcbiAgICAgICAgY29tbWFuZHMgPSBjb21tYW5kcy5jb25jYXQodGhpcy5idWlsZENvbW1hbmRzKHNzLCBnLCBhcmdzKSk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29tbWFuZHMgPSBjb21tYW5kcy5jb25jYXQodGhpcy5idWlsZENvbW1hbmRzKHMsIGcsIGFyZ3MpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY29tbWFuZHM7XG4gIH1cblxuICAvKiogQ3JlYXRlIGFuIGBFeGVjdXRpb25gIG9iamVjdCB0byBoYW5kbGUgdGhlIGxpZmV0aW1lXG4gICAqIG9mIHRoZSBwcm9jZXNzIHRoYXQgaXMgZXhlY3V0ZWQuICovXG4gIGV4ZWN1dGUoY29tbWFuZDogQ29tbWFuZCk6IERlbm8uUHJvY2VzcyB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIGNtZDogY29tbWFuZC5jbWQsXG4gICAgICBlbnY6IGNvbW1hbmQub3B0aW9ucy5lbnYgPz8ge30sXG4gICAgICBzdGRpbjogY29tbWFuZC5vcHRpb25zLnN0ZGluID8/IFwiaW5oZXJpdFwiLFxuICAgICAgc3Rkb3V0OiBjb21tYW5kLm9wdGlvbnMuc3Rkb3V0ID8/IFwiaW5oZXJpdFwiLFxuICAgICAgc3RkZXJyOiBjb21tYW5kLm9wdGlvbnMuc3RkZXJyID8/IFwiaW5oZXJpdFwiLFxuICAgIH07XG4gICAgcmV0dXJuIERlbm8ucnVuKG9wdGlvbnMpO1xuICB9XG59XG5cbmZ1bmN0aW9uIHN0ZENtZChjbWQ6IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgcmV0dXJuIGNtZC50cmltKCkucmVwbGFjZSgvXFxzXFxzKy9nLCBcIiBcIikuc3BsaXQoXCIgXCIpO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENvbW1hbmQge1xuICBjbWQ6IHN0cmluZ1tdO1xuICBvcHRpb25zOiBTY3JpcHRPcHRpb25zO1xuICBleGU6ICgpID0+IERlbm8uUHJvY2Vzcztcbn1cbiJdfQ==