import { AsyncIterableReader } from "./async_iterable_reader.ts";
import { contentType, readerFromStreamReader, Status, STATUS_TEXT, } from "./deps.ts";
import { DomResponse } from "./http_server_native.ts";
import { BODY_TYPES, encodeUrl, isAsyncIterable, isHtml, isReader, isRedirectStatus, readableStreamFromReader, Uint8ArrayTransformStream, } from "./util.ts";
export const REDIRECT_BACK = Symbol("redirect backwards");
const encoder = new TextEncoder();
function toUint8Array(body) {
    let bodyText;
    if (BODY_TYPES.includes(typeof body)) {
        bodyText = String(body);
    }
    else {
        bodyText = JSON.stringify(body);
    }
    return encoder.encode(bodyText);
}
async function convertBodyToBodyInit(body, type) {
    let result;
    if (BODY_TYPES.includes(typeof body)) {
        result = String(body);
        type = type ?? (isHtml(result) ? "html" : "text/plain");
    }
    else if (isReader(body)) {
        result = readableStreamFromReader(body);
    }
    else if (ArrayBuffer.isView(body) || body instanceof ArrayBuffer ||
        body instanceof Blob || body instanceof URLSearchParams) {
        result = body;
    }
    else if (body instanceof ReadableStream) {
        result = body.pipeThrough(new Uint8ArrayTransformStream());
    }
    else if (body instanceof FormData) {
        result = body;
        type = "multipart/form-data";
    }
    else if (body && typeof body === "object") {
        result = JSON.stringify(body);
        type = type ?? "json";
    }
    else if (typeof body === "function") {
        const result = body.call(null);
        return convertBodyToBodyInit(await result, type);
    }
    else if (body) {
        throw new TypeError("Response body was set but could not be converted.");
    }
    return [result, type];
}
async function convertBodyToStdBody(body, type) {
    let result;
    if (BODY_TYPES.includes(typeof body)) {
        const bodyText = String(body);
        result = encoder.encode(bodyText);
        type = type ?? (isHtml(bodyText) ? "html" : "text/plain");
    }
    else if (body instanceof Uint8Array || isReader(body)) {
        result = body;
    }
    else if (body instanceof ReadableStream) {
        result = readerFromStreamReader(body.pipeThrough(new Uint8ArrayTransformStream()).getReader());
    }
    else if (isAsyncIterable(body)) {
        result = new AsyncIterableReader(body, toUint8Array);
    }
    else if (body && typeof body === "object") {
        result = encoder.encode(JSON.stringify(body));
        type = type ?? "json";
    }
    else if (typeof body === "function") {
        const result = body.call(null);
        return convertBodyToStdBody(await result, type);
    }
    else if (body) {
        throw new TypeError("Response body was set but could not be converted.");
    }
    return [result, type];
}
export class Response {
    #body;
    #bodySet = false;
    #domResponse;
    #headers = new Headers();
    #request;
    #resources = [];
    #serverResponse;
    #status;
    #type;
    #writable = true;
    async #getBodyInit() {
        const [body, type] = await convertBodyToBodyInit(this.body, this.type);
        this.type = type;
        return body;
    }
    async #getStdBody() {
        const [body, type] = await convertBodyToStdBody(this.body, this.type);
        this.type = type;
        return body;
    }
    #setContentType() {
        if (this.type) {
            const contentTypeString = contentType(this.type);
            if (contentTypeString && !this.headers.has("Content-Type")) {
                this.headers.append("Content-Type", contentTypeString);
            }
        }
    }
    get body() {
        return this.#body;
    }
    set body(value) {
        if (!this.#writable) {
            throw new Error("The response is not writable.");
        }
        this.#bodySet = true;
        this.#body = value;
    }
    get headers() {
        return this.#headers;
    }
    set headers(value) {
        if (!this.#writable) {
            throw new Error("The response is not writable.");
        }
        this.#headers = value;
    }
    get status() {
        if (this.#status) {
            return this.#status;
        }
        return this.body != null
            ? Status.OK
            : this.#bodySet
                ? Status.NoContent
                : Status.NotFound;
    }
    set status(value) {
        if (!this.#writable) {
            throw new Error("The response is not writable.");
        }
        this.#status = value;
    }
    get type() {
        return this.#type;
    }
    set type(value) {
        if (!this.#writable) {
            throw new Error("The response is not writable.");
        }
        this.#type = value;
    }
    get writable() {
        return this.#writable;
    }
    constructor(request) {
        this.#request = request;
    }
    addResource(rid) {
        this.#resources.push(rid);
    }
    destroy(closeResources = true) {
        this.#writable = false;
        this.#body = undefined;
        this.#serverResponse = undefined;
        this.#domResponse = undefined;
        if (closeResources) {
            for (const rid of this.#resources) {
                Deno.close(rid);
            }
        }
    }
    redirect(url, alt = "/") {
        if (url === REDIRECT_BACK) {
            url = this.#request.headers.get("Referer") ?? String(alt);
        }
        else if (typeof url === "object") {
            url = String(url);
        }
        this.headers.set("Location", encodeUrl(url));
        if (!this.status || !isRedirectStatus(this.status)) {
            this.status = Status.Found;
        }
        if (this.#request.accepts("html")) {
            url = encodeURI(url);
            this.type = "text/html; charset=utf-8";
            this.body = `Redirecting to <a href="${url}">${url}</a>.`;
            return;
        }
        this.type = "text/plain; charset=utf-8";
        this.body = `Redirecting to ${url}.`;
    }
    async toDomResponse() {
        if (this.#domResponse) {
            return this.#domResponse;
        }
        const bodyInit = await this.#getBodyInit();
        this.#setContentType();
        const { headers } = this;
        if (!(bodyInit ||
            headers.has("Content-Type") ||
            headers.has("Content-Length"))) {
            headers.append("Content-Length", "0");
        }
        this.#writable = false;
        const status = this.status;
        const responseInit = {
            headers,
            status,
            statusText: STATUS_TEXT.get(status),
        };
        return this.#domResponse = new DomResponse(bodyInit, responseInit);
    }
    async toServerResponse() {
        if (this.#serverResponse) {
            return this.#serverResponse;
        }
        const body = await this.#getStdBody();
        this.#setContentType();
        const { headers } = this;
        if (!(body ||
            headers.has("Content-Type") ||
            headers.has("Content-Length"))) {
            headers.append("Content-Length", "0");
        }
        this.#writable = false;
        return this.#serverResponse = {
            body,
            headers,
            status: this.status,
        };
    }
    [Symbol.for("Deno.customInspect")](inspect) {
        const { body, headers, status, type, writable } = this;
        return `${this.constructor.name} ${inspect({ body, headers, status, type, writable })}`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzcG9uc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZXNwb25zZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNqRSxPQUFPLEVBQ0wsV0FBVyxFQUNYLHNCQUFzQixFQUN0QixNQUFNLEVBQ04sV0FBVyxHQUNaLE1BQU0sV0FBVyxDQUFDO0FBQ25CLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUd0RCxPQUFPLEVBQ0wsVUFBVSxFQUNWLFNBQVMsRUFDVCxlQUFlLEVBQ2YsTUFBTSxFQUNOLFFBQVEsRUFDUixnQkFBZ0IsRUFDaEIsd0JBQXdCLEVBQ3hCLHlCQUF5QixHQUMxQixNQUFNLFdBQVcsQ0FBQztBQStCbkIsTUFBTSxDQUFDLE1BQU0sYUFBYSxHQUFHLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0FBRTFELE1BQU0sT0FBTyxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7QUFFbEMsU0FBUyxZQUFZLENBQUMsSUFBVTtJQUM5QixJQUFJLFFBQWdCLENBQUM7SUFDckIsSUFBSSxVQUFVLENBQUMsUUFBUSxDQUFDLE9BQU8sSUFBSSxDQUFDLEVBQUU7UUFDcEMsUUFBUSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUN6QjtTQUFNO1FBQ0wsUUFBUSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDakM7SUFDRCxPQUFPLE9BQU8sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDbEMsQ0FBQztBQUVELEtBQUssVUFBVSxxQkFBcUIsQ0FDbEMsSUFBeUIsRUFDekIsSUFBYTtJQUViLElBQUksTUFBdUMsQ0FBQztJQUM1QyxJQUFJLFVBQVUsQ0FBQyxRQUFRLENBQUMsT0FBTyxJQUFJLENBQUMsRUFBRTtRQUNwQyxNQUFNLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3RCLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUM7S0FDekQ7U0FBTSxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUN6QixNQUFNLEdBQUcsd0JBQXdCLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDekM7U0FBTSxJQUNMLFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxZQUFZLFdBQVc7UUFDdkQsSUFBSSxZQUFZLElBQUksSUFBSSxJQUFJLFlBQVksZUFBZSxFQUN2RDtRQUNBLE1BQU0sR0FBRyxJQUFJLENBQUM7S0FDZjtTQUFNLElBQUksSUFBSSxZQUFZLGNBQWMsRUFBRTtRQUN6QyxNQUFNLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLHlCQUF5QixFQUFFLENBQUMsQ0FBQztLQUM1RDtTQUFNLElBQUksSUFBSSxZQUFZLFFBQVEsRUFBRTtRQUNuQyxNQUFNLEdBQUcsSUFBSSxDQUFDO1FBQ2QsSUFBSSxHQUFHLHFCQUFxQixDQUFDO0tBQzlCO1NBQU0sSUFBSSxJQUFJLElBQUksT0FBTyxJQUFJLEtBQUssUUFBUSxFQUFFO1FBQzNDLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzlCLElBQUksR0FBRyxJQUFJLElBQUksTUFBTSxDQUFDO0tBQ3ZCO1NBQU0sSUFBSSxPQUFPLElBQUksS0FBSyxVQUFVLEVBQUU7UUFDckMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMvQixPQUFPLHFCQUFxQixDQUFDLE1BQU0sTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQ2xEO1NBQU0sSUFBSSxJQUFJLEVBQUU7UUFDZixNQUFNLElBQUksU0FBUyxDQUFDLG1EQUFtRCxDQUFDLENBQUM7S0FDMUU7SUFDRCxPQUFPLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQ3hCLENBQUM7QUFFRCxLQUFLLFVBQVUsb0JBQW9CLENBQ2pDLElBQXlCLEVBQ3pCLElBQWE7SUFFYixJQUFJLE1BQTRDLENBQUM7SUFDakQsSUFBSSxVQUFVLENBQUMsUUFBUSxDQUFDLE9BQU8sSUFBSSxDQUFDLEVBQUU7UUFDcEMsTUFBTSxRQUFRLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzlCLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ2xDLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUM7S0FDM0Q7U0FBTSxJQUFJLElBQUksWUFBWSxVQUFVLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ3ZELE1BQU0sR0FBRyxJQUFJLENBQUM7S0FDZjtTQUFNLElBQUksSUFBSSxZQUFZLGNBQWMsRUFBRTtRQUN6QyxNQUFNLEdBQUcsc0JBQXNCLENBQzdCLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSx5QkFBeUIsRUFBRSxDQUFDLENBQUMsU0FBUyxFQUFFLENBQzlELENBQUM7S0FDSDtTQUFNLElBQUksZUFBZSxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ2hDLE1BQU0sR0FBRyxJQUFJLG1CQUFtQixDQUFDLElBQUksRUFBRSxZQUFZLENBQUMsQ0FBQztLQUN0RDtTQUFNLElBQUksSUFBSSxJQUFJLE9BQU8sSUFBSSxLQUFLLFFBQVEsRUFBRTtRQUMzQyxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDOUMsSUFBSSxHQUFHLElBQUksSUFBSSxNQUFNLENBQUM7S0FDdkI7U0FBTSxJQUFJLE9BQU8sSUFBSSxLQUFLLFVBQVUsRUFBRTtRQUNyQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQy9CLE9BQU8sb0JBQW9CLENBQUMsTUFBTSxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7S0FDakQ7U0FBTSxJQUFJLElBQUksRUFBRTtRQUNmLE1BQU0sSUFBSSxTQUFTLENBQUMsbURBQW1ELENBQUMsQ0FBQztLQUMxRTtJQUNELE9BQU8sQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDeEIsQ0FBQztBQUlELE1BQU0sT0FBTyxRQUFRO0lBQ25CLEtBQUssQ0FBdUI7SUFDNUIsUUFBUSxHQUFHLEtBQUssQ0FBQztJQUNqQixZQUFZLENBQXVCO0lBQ25DLFFBQVEsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO0lBQ3pCLFFBQVEsQ0FBVTtJQUNsQixVQUFVLEdBQWEsRUFBRSxDQUFDO0lBQzFCLGVBQWUsQ0FBa0I7SUFDakMsT0FBTyxDQUFVO0lBQ2pCLEtBQUssQ0FBVTtJQUNmLFNBQVMsR0FBRyxJQUFJLENBQUM7SUFFakIsS0FBSyxDQUFDLFlBQVk7UUFDaEIsTUFBTSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxNQUFNLHFCQUFxQixDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3ZFLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELEtBQUssQ0FBQyxXQUFXO1FBQ2YsTUFBTSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxNQUFNLG9CQUFvQixDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3RFLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELGVBQWU7UUFDYixJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDYixNQUFNLGlCQUFpQixHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDakQsSUFBSSxpQkFBaUIsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxFQUFFO2dCQUMxRCxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxjQUFjLEVBQUUsaUJBQWlCLENBQUMsQ0FBQzthQUN4RDtTQUNGO0lBQ0gsQ0FBQztJQU9ELElBQUksSUFBSTtRQUNOLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUNwQixDQUFDO0lBT0QsSUFBSSxJQUFJLENBQUMsS0FBMEI7UUFDakMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDbkIsTUFBTSxJQUFJLEtBQUssQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO1NBQ2xEO1FBQ0QsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFDckIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7SUFDckIsQ0FBQztJQUdELElBQUksT0FBTztRQUNULE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN2QixDQUFDO0lBR0QsSUFBSSxPQUFPLENBQUMsS0FBYztRQUN4QixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLCtCQUErQixDQUFDLENBQUM7U0FDbEQ7UUFDRCxJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztJQUN4QixDQUFDO0lBT0QsSUFBSSxNQUFNO1FBQ1IsSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ2hCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztTQUNyQjtRQUNELE9BQU8sSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJO1lBQ3RCLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUNYLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUTtnQkFDZixDQUFDLENBQUMsTUFBTSxDQUFDLFNBQVM7Z0JBQ2xCLENBQUMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDO0lBQ3RCLENBQUM7SUFPRCxJQUFJLE1BQU0sQ0FBQyxLQUFhO1FBQ3RCLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ25CLE1BQU0sSUFBSSxLQUFLLENBQUMsK0JBQStCLENBQUMsQ0FBQztTQUNsRDtRQUNELElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO0lBQ3ZCLENBQUM7SUFJRCxJQUFJLElBQUk7UUFDTixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDcEIsQ0FBQztJQUdELElBQUksSUFBSSxDQUFDLEtBQXlCO1FBQ2hDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ25CLE1BQU0sSUFBSSxLQUFLLENBQUMsK0JBQStCLENBQUMsQ0FBQztTQUNsRDtRQUNELElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO0lBQ3JCLENBQUM7SUFJRCxJQUFJLFFBQVE7UUFDVixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUM7SUFDeEIsQ0FBQztJQUVELFlBQVksT0FBZ0I7UUFDMUIsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUM7SUFDMUIsQ0FBQztJQUlELFdBQVcsQ0FBQyxHQUFXO1FBQ3JCLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzVCLENBQUM7SUFNRCxPQUFPLENBQUMsY0FBYyxHQUFHLElBQUk7UUFDM0IsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7UUFDdkIsSUFBSSxDQUFDLEtBQUssR0FBRyxTQUFTLENBQUM7UUFDdkIsSUFBSSxDQUFDLGVBQWUsR0FBRyxTQUFTLENBQUM7UUFDakMsSUFBSSxDQUFDLFlBQVksR0FBRyxTQUFTLENBQUM7UUFDOUIsSUFBSSxjQUFjLEVBQUU7WUFDbEIsS0FBSyxNQUFNLEdBQUcsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFO2dCQUNqQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQ2pCO1NBQ0Y7SUFDSCxDQUFDO0lBb0JELFFBQVEsQ0FDTixHQUF3QyxFQUN4QyxNQUFvQixHQUFHO1FBRXZCLElBQUksR0FBRyxLQUFLLGFBQWEsRUFBRTtZQUN6QixHQUFHLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUMzRDthQUFNLElBQUksT0FBTyxHQUFHLEtBQUssUUFBUSxFQUFFO1lBQ2xDLEdBQUcsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDbkI7UUFDRCxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDN0MsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDbEQsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDO1NBQzVCO1FBRUQsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUNqQyxHQUFHLEdBQUcsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3JCLElBQUksQ0FBQyxJQUFJLEdBQUcsMEJBQTBCLENBQUM7WUFDdkMsSUFBSSxDQUFDLElBQUksR0FBRywyQkFBMkIsR0FBRyxLQUFLLEdBQUcsT0FBTyxDQUFDO1lBQzFELE9BQU87U0FDUjtRQUNELElBQUksQ0FBQyxJQUFJLEdBQUcsMkJBQTJCLENBQUM7UUFDeEMsSUFBSSxDQUFDLElBQUksR0FBRyxrQkFBa0IsR0FBRyxHQUFHLENBQUM7SUFDdkMsQ0FBQztJQUVELEtBQUssQ0FBQyxhQUFhO1FBQ2pCLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNyQixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUM7U0FDMUI7UUFFRCxNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUUzQyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7UUFFdkIsTUFBTSxFQUFFLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQztRQUl6QixJQUNFLENBQUMsQ0FDQyxRQUFRO1lBQ1IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUM7WUFDM0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUM5QixFQUNEO1lBQ0EsT0FBTyxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLENBQUMsQ0FBQztTQUN2QztRQUVELElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO1FBRXZCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDM0IsTUFBTSxZQUFZLEdBQWlCO1lBQ2pDLE9BQU87WUFDUCxNQUFNO1lBQ04sVUFBVSxFQUFFLFdBQVcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDO1NBQ3BDLENBQUM7UUFFRixPQUFPLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxXQUFXLENBQUMsUUFBUSxFQUFFLFlBQVksQ0FBQyxDQUFDO0lBQ3JFLENBQUM7SUFNRCxLQUFLLENBQUMsZ0JBQWdCO1FBQ3BCLElBQUksSUFBSSxDQUFDLGVBQWUsRUFBRTtZQUN4QixPQUFPLElBQUksQ0FBQyxlQUFlLENBQUM7U0FDN0I7UUFFRCxNQUFNLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUd0QyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7UUFFdkIsTUFBTSxFQUFFLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQztRQUl6QixJQUNFLENBQUMsQ0FDQyxJQUFJO1lBQ0osT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUM7WUFDM0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUM5QixFQUNEO1lBQ0EsT0FBTyxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLENBQUMsQ0FBQztTQUN2QztRQUVELElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO1FBQ3ZCLE9BQU8sSUFBSSxDQUFDLGVBQWUsR0FBRztZQUM1QixJQUFJO1lBQ0osT0FBTztZQUNQLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTTtTQUNwQixDQUFDO0lBQ0osQ0FBQztJQUVELENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsT0FBbUM7UUFDcEUsTUFBTSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFDdkQsT0FBTyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxJQUM3QixPQUFPLENBQUMsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLENBQ25ELEVBQUUsQ0FBQztJQUNMLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE4LTIwMjEgdGhlIG9hayBhdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLiBNSVQgbGljZW5zZS5cblxuaW1wb3J0IHsgQXN5bmNJdGVyYWJsZVJlYWRlciB9IGZyb20gXCIuL2FzeW5jX2l0ZXJhYmxlX3JlYWRlci50c1wiO1xuaW1wb3J0IHtcbiAgY29udGVudFR5cGUsXG4gIHJlYWRlckZyb21TdHJlYW1SZWFkZXIsXG4gIFN0YXR1cyxcbiAgU1RBVFVTX1RFWFQsXG59IGZyb20gXCIuL2RlcHMudHNcIjtcbmltcG9ydCB7IERvbVJlc3BvbnNlIH0gZnJvbSBcIi4vaHR0cF9zZXJ2ZXJfbmF0aXZlLnRzXCI7XG5pbXBvcnQgdHlwZSB7IFNlcnZlclJlc3BvbnNlIH0gZnJvbSBcIi4vaHR0cF9zZXJ2ZXJfc3RkLnRzXCI7XG5pbXBvcnQgdHlwZSB7IFJlcXVlc3QgfSBmcm9tIFwiLi9yZXF1ZXN0LnRzXCI7XG5pbXBvcnQge1xuICBCT0RZX1RZUEVTLFxuICBlbmNvZGVVcmwsXG4gIGlzQXN5bmNJdGVyYWJsZSxcbiAgaXNIdG1sLFxuICBpc1JlYWRlcixcbiAgaXNSZWRpcmVjdFN0YXR1cyxcbiAgcmVhZGFibGVTdHJlYW1Gcm9tUmVhZGVyLFxuICBVaW50OEFycmF5VHJhbnNmb3JtU3RyZWFtLFxufSBmcm9tIFwiLi91dGlsLnRzXCI7XG5cbnR5cGUgQm9keSA9XG4gIHwgc3RyaW5nXG4gIHwgbnVtYmVyXG4gIHwgYmlnaW50XG4gIHwgYm9vbGVhblxuICB8IHN5bWJvbFxuICAvLyBkZW5vLWxpbnQtaWdub3JlIGJhbi10eXBlc1xuICB8IG9iamVjdFxuICB8IHVuZGVmaW5lZFxuICB8IG51bGw7XG50eXBlIEJvZHlGdW5jdGlvbiA9ICgpID0+IEJvZHkgfCBQcm9taXNlPEJvZHk+O1xuXG4vKiogQSBzeW1ib2wgdGhhdCBpbmRpY2F0ZXMgdG8gYHJlc3BvbnNlLnJlZGlyZWN0KClgIHRvIGF0dGVtcHQgdG8gcmVkaXJlY3RcbiAqIGJhY2sgdG8gdGhlIHJlcXVlc3QgcmVmZXJyZXIuICBGb3IgZXhhbXBsZTpcbiAqXG4gKiBgYGB0c1xuICogaW1wb3J0IHsgQXBwbGljYXRpb24sIFJFRElSRUNUX0JBQ0sgfSBmcm9tIFwiaHR0cHM6Ly9kZW5vLmxhbmQveC9vYWsvbW9kLnRzXCI7XG4gKlxuICogY29uc3QgYXBwID0gbmV3IEFwcGxpY2F0aW9uKCk7XG4gKlxuICogYXBwLnVzZSgoY3R4KSA9PiB7XG4gKiAgIGlmIChjdHgucmVxdWVzdC51cmwucGF0aE5hbWUgPT09IFwiL2JhY2tcIikge1xuICogICAgIGN0eC5yZXNwb25zZS5yZWRpcmVjdChSRURJUkVDVF9CQUNLLCBcIi9cIik7XG4gKiAgIH1cbiAqIH0pO1xuICpcbiAqIGF3YWl0IGFwcC5saXN0ZW4oeyBwb3J0OiA4MCB9KTtcbiAqIGBgYFxuICovXG5leHBvcnQgY29uc3QgUkVESVJFQ1RfQkFDSyA9IFN5bWJvbChcInJlZGlyZWN0IGJhY2t3YXJkc1wiKTtcblxuY29uc3QgZW5jb2RlciA9IG5ldyBUZXh0RW5jb2RlcigpO1xuXG5mdW5jdGlvbiB0b1VpbnQ4QXJyYXkoYm9keTogQm9keSk6IFVpbnQ4QXJyYXkge1xuICBsZXQgYm9keVRleHQ6IHN0cmluZztcbiAgaWYgKEJPRFlfVFlQRVMuaW5jbHVkZXModHlwZW9mIGJvZHkpKSB7XG4gICAgYm9keVRleHQgPSBTdHJpbmcoYm9keSk7XG4gIH0gZWxzZSB7XG4gICAgYm9keVRleHQgPSBKU09OLnN0cmluZ2lmeShib2R5KTtcbiAgfVxuICByZXR1cm4gZW5jb2Rlci5lbmNvZGUoYm9keVRleHQpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjb252ZXJ0Qm9keVRvQm9keUluaXQoXG4gIGJvZHk6IEJvZHkgfCBCb2R5RnVuY3Rpb24sXG4gIHR5cGU/OiBzdHJpbmcsXG4pOiBQcm9taXNlPFtnbG9iYWxUaGlzLkJvZHlJbml0IHwgdW5kZWZpbmVkLCBzdHJpbmcgfCB1bmRlZmluZWRdPiB7XG4gIGxldCByZXN1bHQ6IGdsb2JhbFRoaXMuQm9keUluaXQgfCB1bmRlZmluZWQ7XG4gIGlmIChCT0RZX1RZUEVTLmluY2x1ZGVzKHR5cGVvZiBib2R5KSkge1xuICAgIHJlc3VsdCA9IFN0cmluZyhib2R5KTtcbiAgICB0eXBlID0gdHlwZSA/PyAoaXNIdG1sKHJlc3VsdCkgPyBcImh0bWxcIiA6IFwidGV4dC9wbGFpblwiKTtcbiAgfSBlbHNlIGlmIChpc1JlYWRlcihib2R5KSkge1xuICAgIHJlc3VsdCA9IHJlYWRhYmxlU3RyZWFtRnJvbVJlYWRlcihib2R5KTtcbiAgfSBlbHNlIGlmIChcbiAgICBBcnJheUJ1ZmZlci5pc1ZpZXcoYm9keSkgfHwgYm9keSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyIHx8XG4gICAgYm9keSBpbnN0YW5jZW9mIEJsb2IgfHwgYm9keSBpbnN0YW5jZW9mIFVSTFNlYXJjaFBhcmFtc1xuICApIHtcbiAgICByZXN1bHQgPSBib2R5O1xuICB9IGVsc2UgaWYgKGJvZHkgaW5zdGFuY2VvZiBSZWFkYWJsZVN0cmVhbSkge1xuICAgIHJlc3VsdCA9IGJvZHkucGlwZVRocm91Z2gobmV3IFVpbnQ4QXJyYXlUcmFuc2Zvcm1TdHJlYW0oKSk7XG4gIH0gZWxzZSBpZiAoYm9keSBpbnN0YW5jZW9mIEZvcm1EYXRhKSB7XG4gICAgcmVzdWx0ID0gYm9keTtcbiAgICB0eXBlID0gXCJtdWx0aXBhcnQvZm9ybS1kYXRhXCI7XG4gIH0gZWxzZSBpZiAoYm9keSAmJiB0eXBlb2YgYm9keSA9PT0gXCJvYmplY3RcIikge1xuICAgIHJlc3VsdCA9IEpTT04uc3RyaW5naWZ5KGJvZHkpO1xuICAgIHR5cGUgPSB0eXBlID8/IFwianNvblwiO1xuICB9IGVsc2UgaWYgKHR5cGVvZiBib2R5ID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICBjb25zdCByZXN1bHQgPSBib2R5LmNhbGwobnVsbCk7XG4gICAgcmV0dXJuIGNvbnZlcnRCb2R5VG9Cb2R5SW5pdChhd2FpdCByZXN1bHQsIHR5cGUpO1xuICB9IGVsc2UgaWYgKGJvZHkpIHtcbiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiUmVzcG9uc2UgYm9keSB3YXMgc2V0IGJ1dCBjb3VsZCBub3QgYmUgY29udmVydGVkLlwiKTtcbiAgfVxuICByZXR1cm4gW3Jlc3VsdCwgdHlwZV07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNvbnZlcnRCb2R5VG9TdGRCb2R5KFxuICBib2R5OiBCb2R5IHwgQm9keUZ1bmN0aW9uLFxuICB0eXBlPzogc3RyaW5nLFxuKTogUHJvbWlzZTxbVWludDhBcnJheSB8IERlbm8uUmVhZGVyIHwgdW5kZWZpbmVkLCBzdHJpbmcgfCB1bmRlZmluZWRdPiB7XG4gIGxldCByZXN1bHQ6IFVpbnQ4QXJyYXkgfCBEZW5vLlJlYWRlciB8IHVuZGVmaW5lZDtcbiAgaWYgKEJPRFlfVFlQRVMuaW5jbHVkZXModHlwZW9mIGJvZHkpKSB7XG4gICAgY29uc3QgYm9keVRleHQgPSBTdHJpbmcoYm9keSk7XG4gICAgcmVzdWx0ID0gZW5jb2Rlci5lbmNvZGUoYm9keVRleHQpO1xuICAgIHR5cGUgPSB0eXBlID8/IChpc0h0bWwoYm9keVRleHQpID8gXCJodG1sXCIgOiBcInRleHQvcGxhaW5cIik7XG4gIH0gZWxzZSBpZiAoYm9keSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkgfHwgaXNSZWFkZXIoYm9keSkpIHtcbiAgICByZXN1bHQgPSBib2R5O1xuICB9IGVsc2UgaWYgKGJvZHkgaW5zdGFuY2VvZiBSZWFkYWJsZVN0cmVhbSkge1xuICAgIHJlc3VsdCA9IHJlYWRlckZyb21TdHJlYW1SZWFkZXIoXG4gICAgICBib2R5LnBpcGVUaHJvdWdoKG5ldyBVaW50OEFycmF5VHJhbnNmb3JtU3RyZWFtKCkpLmdldFJlYWRlcigpLFxuICAgICk7XG4gIH0gZWxzZSBpZiAoaXNBc3luY0l0ZXJhYmxlKGJvZHkpKSB7XG4gICAgcmVzdWx0ID0gbmV3IEFzeW5jSXRlcmFibGVSZWFkZXIoYm9keSwgdG9VaW50OEFycmF5KTtcbiAgfSBlbHNlIGlmIChib2R5ICYmIHR5cGVvZiBib2R5ID09PSBcIm9iamVjdFwiKSB7XG4gICAgcmVzdWx0ID0gZW5jb2Rlci5lbmNvZGUoSlNPTi5zdHJpbmdpZnkoYm9keSkpO1xuICAgIHR5cGUgPSB0eXBlID8/IFwianNvblwiO1xuICB9IGVsc2UgaWYgKHR5cGVvZiBib2R5ID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICBjb25zdCByZXN1bHQgPSBib2R5LmNhbGwobnVsbCk7XG4gICAgcmV0dXJuIGNvbnZlcnRCb2R5VG9TdGRCb2R5KGF3YWl0IHJlc3VsdCwgdHlwZSk7XG4gIH0gZWxzZSBpZiAoYm9keSkge1xuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJSZXNwb25zZSBib2R5IHdhcyBzZXQgYnV0IGNvdWxkIG5vdCBiZSBjb252ZXJ0ZWQuXCIpO1xuICB9XG4gIHJldHVybiBbcmVzdWx0LCB0eXBlXTtcbn1cblxuLyoqIEFuIGludGVyZmFjZSB0byBjb250cm9sIHdoYXQgcmVzcG9uc2Ugd2lsbCBiZSBzZW50IHdoZW4gdGhlIG1pZGRsZXdhcmVcbiAqIGZpbmlzaGVzIHByb2Nlc3NpbmcgdGhlIHJlcXVlc3QuICovXG5leHBvcnQgY2xhc3MgUmVzcG9uc2Uge1xuICAjYm9keT86IEJvZHkgfCBCb2R5RnVuY3Rpb247XG4gICNib2R5U2V0ID0gZmFsc2U7XG4gICNkb21SZXNwb25zZT86IGdsb2JhbFRoaXMuUmVzcG9uc2U7XG4gICNoZWFkZXJzID0gbmV3IEhlYWRlcnMoKTtcbiAgI3JlcXVlc3Q6IFJlcXVlc3Q7XG4gICNyZXNvdXJjZXM6IG51bWJlcltdID0gW107XG4gICNzZXJ2ZXJSZXNwb25zZT86IFNlcnZlclJlc3BvbnNlO1xuICAjc3RhdHVzPzogU3RhdHVzO1xuICAjdHlwZT86IHN0cmluZztcbiAgI3dyaXRhYmxlID0gdHJ1ZTtcblxuICBhc3luYyAjZ2V0Qm9keUluaXQoKTogUHJvbWlzZTxnbG9iYWxUaGlzLkJvZHlJbml0IHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3QgW2JvZHksIHR5cGVdID0gYXdhaXQgY29udmVydEJvZHlUb0JvZHlJbml0KHRoaXMuYm9keSwgdGhpcy50eXBlKTtcbiAgICB0aGlzLnR5cGUgPSB0eXBlO1xuICAgIHJldHVybiBib2R5O1xuICB9XG5cbiAgYXN5bmMgI2dldFN0ZEJvZHkoKTogUHJvbWlzZTxVaW50OEFycmF5IHwgRGVuby5SZWFkZXIgfCB1bmRlZmluZWQ+IHtcbiAgICBjb25zdCBbYm9keSwgdHlwZV0gPSBhd2FpdCBjb252ZXJ0Qm9keVRvU3RkQm9keSh0aGlzLmJvZHksIHRoaXMudHlwZSk7XG4gICAgdGhpcy50eXBlID0gdHlwZTtcbiAgICByZXR1cm4gYm9keTtcbiAgfVxuXG4gICNzZXRDb250ZW50VHlwZSgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy50eXBlKSB7XG4gICAgICBjb25zdCBjb250ZW50VHlwZVN0cmluZyA9IGNvbnRlbnRUeXBlKHRoaXMudHlwZSk7XG4gICAgICBpZiAoY29udGVudFR5cGVTdHJpbmcgJiYgIXRoaXMuaGVhZGVycy5oYXMoXCJDb250ZW50LVR5cGVcIikpIHtcbiAgICAgICAgdGhpcy5oZWFkZXJzLmFwcGVuZChcIkNvbnRlbnQtVHlwZVwiLCBjb250ZW50VHlwZVN0cmluZyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqIFRoZSBib2R5IG9mIHRoZSByZXNwb25zZS4gIFRoZSBib2R5IHdpbGwgYmUgYXV0b21hdGljYWxseSBwcm9jZXNzZWQgd2hlblxuICAgKiB0aGUgcmVzcG9uc2UgaXMgYmVpbmcgc2VudCBhbmQgY29udmVydGVkIHRvIGEgYFVpbnQ4QXJyYXlgIG9yIGFcbiAgICogYERlbm8uUmVhZGVyYC5cbiAgICpcbiAgICogQXV0b21hdGljIGNvbnZlcnNpb24gdG8gYSBgRGVuby5SZWFkZXJgIG9jY3VycyBmb3IgYXN5bmMgaXRlcmFibGVzLiAqL1xuICBnZXQgYm9keSgpOiBCb2R5IHwgQm9keUZ1bmN0aW9uIHtcbiAgICByZXR1cm4gdGhpcy4jYm9keTtcbiAgfVxuXG4gIC8qKiBUaGUgYm9keSBvZiB0aGUgcmVzcG9uc2UuICBUaGUgYm9keSB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgcHJvY2Vzc2VkIHdoZW5cbiAgICogdGhlIHJlc3BvbnNlIGlzIGJlaW5nIHNlbnQgYW5kIGNvbnZlcnRlZCB0byBhIGBVaW50OEFycmF5YCBvciBhXG4gICAqIGBEZW5vLlJlYWRlcmAuXG4gICAqXG4gICAqIEF1dG9tYXRpYyBjb252ZXJzaW9uIHRvIGEgYERlbm8uUmVhZGVyYCBvY2N1cnMgZm9yIGFzeW5jIGl0ZXJhYmxlcy4gKi9cbiAgc2V0IGJvZHkodmFsdWU6IEJvZHkgfCBCb2R5RnVuY3Rpb24pIHtcbiAgICBpZiAoIXRoaXMuI3dyaXRhYmxlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJUaGUgcmVzcG9uc2UgaXMgbm90IHdyaXRhYmxlLlwiKTtcbiAgICB9XG4gICAgdGhpcy4jYm9keVNldCA9IHRydWU7XG4gICAgdGhpcy4jYm9keSA9IHZhbHVlO1xuICB9XG5cbiAgLyoqIEhlYWRlcnMgdGhhdCB3aWxsIGJlIHJldHVybmVkIGluIHRoZSByZXNwb25zZS4gKi9cbiAgZ2V0IGhlYWRlcnMoKTogSGVhZGVycyB7XG4gICAgcmV0dXJuIHRoaXMuI2hlYWRlcnM7XG4gIH1cblxuICAvKiogSGVhZGVycyB0aGF0IHdpbGwgYmUgcmV0dXJuZWQgaW4gdGhlIHJlc3BvbnNlLiAqL1xuICBzZXQgaGVhZGVycyh2YWx1ZTogSGVhZGVycykge1xuICAgIGlmICghdGhpcy4jd3JpdGFibGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlRoZSByZXNwb25zZSBpcyBub3Qgd3JpdGFibGUuXCIpO1xuICAgIH1cbiAgICB0aGlzLiNoZWFkZXJzID0gdmFsdWU7XG4gIH1cblxuICAvKiogVGhlIEhUVFAgc3RhdHVzIG9mIHRoZSByZXNwb25zZS4gIElmIHRoaXMgaGFzIG5vdCBiZWVuIGV4cGxpY2l0bHkgc2V0LFxuICAgKiByZWFkaW5nIHRoZSB2YWx1ZSB3aWxsIHJldHVybiB3aGF0IHdvdWxkIGJlIHRoZSB2YWx1ZSBvZiBzdGF0dXMgaWYgdGhlXG4gICAqIHJlc3BvbnNlIHdlcmUgc2VudCBhdCB0aGlzIHBvaW50IGluIHByb2Nlc3NpbmcgdGhlIG1pZGRsZXdhcmUuICBJZiB0aGUgYm9keVxuICAgKiBoYXMgYmVlbiBzZXQsIHRoZSBzdGF0dXMgd2lsbCBiZSBgMjAwIE9LYC4gIElmIGEgdmFsdWUgZm9yIHRoZSBib2R5IGhhc1xuICAgKiBub3QgYmVlbiBzZXQgeWV0LCB0aGUgc3RhdHVzIHdpbGwgYmUgYDQwNCBOb3QgRm91bmRgLiAqL1xuICBnZXQgc3RhdHVzKCk6IFN0YXR1cyB7XG4gICAgaWYgKHRoaXMuI3N0YXR1cykge1xuICAgICAgcmV0dXJuIHRoaXMuI3N0YXR1cztcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuYm9keSAhPSBudWxsXG4gICAgICA/IFN0YXR1cy5PS1xuICAgICAgOiB0aGlzLiNib2R5U2V0XG4gICAgICA/IFN0YXR1cy5Ob0NvbnRlbnRcbiAgICAgIDogU3RhdHVzLk5vdEZvdW5kO1xuICB9XG5cbiAgLyoqIFRoZSBIVFRQIHN0YXR1cyBvZiB0aGUgcmVzcG9uc2UuICBJZiB0aGlzIGhhcyBub3QgYmVlbiBleHBsaWNpdGx5IHNldCxcbiAgICogcmVhZGluZyB0aGUgdmFsdWUgd2lsbCByZXR1cm4gd2hhdCB3b3VsZCBiZSB0aGUgdmFsdWUgb2Ygc3RhdHVzIGlmIHRoZVxuICAgKiByZXNwb25zZSB3ZXJlIHNlbnQgYXQgdGhpcyBwb2ludCBpbiBwcm9jZXNzaW5nIHRoZSBtaWRkbGV3YXJlLiAgSWYgdGhlIGJvZHlcbiAgICogaGFzIGJlZW4gc2V0LCB0aGUgc3RhdHVzIHdpbGwgYmUgYDIwMCBPS2AuICBJZiBhIHZhbHVlIGZvciB0aGUgYm9keSBoYXNcbiAgICogbm90IGJlZW4gc2V0IHlldCwgdGhlIHN0YXR1cyB3aWxsIGJlIGA0MDQgTm90IEZvdW5kYC4gKi9cbiAgc2V0IHN0YXR1cyh2YWx1ZTogU3RhdHVzKSB7XG4gICAgaWYgKCF0aGlzLiN3cml0YWJsZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVGhlIHJlc3BvbnNlIGlzIG5vdCB3cml0YWJsZS5cIik7XG4gICAgfVxuICAgIHRoaXMuI3N0YXR1cyA9IHZhbHVlO1xuICB9XG5cbiAgLyoqIFRoZSBtZWRpYSB0eXBlLCBvciBleHRlbnNpb24gb2YgdGhlIHJlc3BvbnNlLiAgU2V0dGluZyB0aGlzIHZhbHVlIHdpbGxcbiAgICogZW5zdXJlIGFuIGFwcHJvcHJpYXRlIGBDb250ZW50LVR5cGVgIGhlYWRlciBpcyBhZGRlZCB0byB0aGUgcmVzcG9uc2UuICovXG4gIGdldCB0eXBlKCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuI3R5cGU7XG4gIH1cbiAgLyoqIFRoZSBtZWRpYSB0eXBlLCBvciBleHRlbnNpb24gb2YgdGhlIHJlc3BvbnNlLiAgU2V0dGluZyB0aGlzIHZhbHVlIHdpbGxcbiAgICogZW5zdXJlIGFuIGFwcHJvcHJpYXRlIGBDb250ZW50LVR5cGVgIGhlYWRlciBpcyBhZGRlZCB0byB0aGUgcmVzcG9uc2UuICovXG4gIHNldCB0eXBlKHZhbHVlOiBzdHJpbmcgfCB1bmRlZmluZWQpIHtcbiAgICBpZiAoIXRoaXMuI3dyaXRhYmxlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJUaGUgcmVzcG9uc2UgaXMgbm90IHdyaXRhYmxlLlwiKTtcbiAgICB9XG4gICAgdGhpcy4jdHlwZSA9IHZhbHVlO1xuICB9XG5cbiAgLyoqIEEgcmVhZC1vbmx5IHByb3BlcnR5IHdoaWNoIGRldGVybWluZXMgaWYgdGhlIHJlc3BvbnNlIGlzIHdyaXRhYmxlIG9yIG5vdC5cbiAgICogT25jZSB0aGUgcmVzcG9uc2UgaGFzIGJlZW4gcHJvY2Vzc2VkLCB0aGlzIHZhbHVlIGlzIHNldCB0byBgZmFsc2VgLiAqL1xuICBnZXQgd3JpdGFibGUoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuI3dyaXRhYmxlO1xuICB9XG5cbiAgY29uc3RydWN0b3IocmVxdWVzdDogUmVxdWVzdCkge1xuICAgIHRoaXMuI3JlcXVlc3QgPSByZXF1ZXN0O1xuICB9XG5cbiAgLyoqIEFkZCBhIHJlc291cmNlIHRvIHRoZSBsaXN0IG9mIHJlc291cmNlcyB0aGF0IHdpbGwgYmUgY2xvc2VkIHdoZW4gdGhlXG4gICAqIHJlcXVlc3QgaXMgZGVzdHJveWVkLiAqL1xuICBhZGRSZXNvdXJjZShyaWQ6IG51bWJlcik6IHZvaWQge1xuICAgIHRoaXMuI3Jlc291cmNlcy5wdXNoKHJpZCk7XG4gIH1cblxuICAvKiogUmVsZWFzZSBhbnkgcmVzb3VyY2VzIHRoYXQgYXJlIGJlaW5nIHRyYWNrZWQgYnkgdGhlIHJlc3BvbnNlLlxuICAgKlxuICAgKiBAcGFyYW0gY2xvc2VSZXNvdXJjZXMgY2xvc2UgYW55IHJlc291cmNlIElEcyByZWdpc3RlcmVkIHdpdGggdGhlIHJlc3BvbnNlXG4gICAqL1xuICBkZXN0cm95KGNsb3NlUmVzb3VyY2VzID0gdHJ1ZSk6IHZvaWQge1xuICAgIHRoaXMuI3dyaXRhYmxlID0gZmFsc2U7XG4gICAgdGhpcy4jYm9keSA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLiNzZXJ2ZXJSZXNwb25zZSA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLiNkb21SZXNwb25zZSA9IHVuZGVmaW5lZDtcbiAgICBpZiAoY2xvc2VSZXNvdXJjZXMpIHtcbiAgICAgIGZvciAoY29uc3QgcmlkIG9mIHRoaXMuI3Jlc291cmNlcykge1xuICAgICAgICBEZW5vLmNsb3NlKHJpZCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqIFNldHMgdGhlIHJlc3BvbnNlIHRvIHJlZGlyZWN0IHRvIHRoZSBzdXBwbGllZCBgdXJsYC5cbiAgICpcbiAgICogSWYgdGhlIGAuc3RhdHVzYCBpcyBub3QgY3VycmVudGx5IGEgcmVkaXJlY3Qgc3RhdHVzLCB0aGUgc3RhdHVzIHdpbGwgYmUgc2V0XG4gICAqIHRvIGAzMDIgRm91bmRgLlxuICAgKlxuICAgKiBUaGUgYm9keSB3aWxsIGJlIHNldCB0byBhIG1lc3NhZ2UgaW5kaWNhdGluZyB0aGUgcmVkaXJlY3Rpb24gaXMgb2NjdXJyaW5nLlxuICAgKi9cbiAgcmVkaXJlY3QodXJsOiBzdHJpbmcgfCBVUkwpOiB2b2lkO1xuICAvKiogU2V0cyB0aGUgcmVzcG9uc2UgdG8gcmVkaXJlY3QgYmFjayB0byB0aGUgcmVmZXJyZXIgaWYgYXZhaWxhYmxlLCB3aXRoIGFuXG4gICAqIG9wdGlvbmFsIGBhbHRgIFVSTCBpZiB0aGVyZSBpcyBubyByZWZlcnJlciBoZWFkZXIgb24gdGhlIHJlcXVlc3QuICBJZiB0aGVyZVxuICAgKiBpcyBubyByZWZlcnJlciBoZWFkZXIsIG5vciBhbiBgYWx0YCBwYXJhbWV0ZXIsIHRoZSByZWRpcmVjdCBpcyBzZXQgdG8gYC9gLlxuICAgKlxuICAgKiBJZiB0aGUgYC5zdGF0dXNgIGlzIG5vdCBjdXJyZW50bHkgYSByZWRpcmVjdCBzdGF0dXMsIHRoZSBzdGF0dXMgd2lsbCBiZSBzZXRcbiAgICogdG8gYDMwMiBGb3VuZGAuXG4gICAqXG4gICAqIFRoZSBib2R5IHdpbGwgYmUgc2V0IHRvIGEgbWVzc2FnZSBpbmRpY2F0aW5nIHRoZSByZWRpcmVjdGlvbiBpcyBvY2N1cnJpbmcuXG4gICAqL1xuICByZWRpcmVjdCh1cmw6IHR5cGVvZiBSRURJUkVDVF9CQUNLLCBhbHQ/OiBzdHJpbmcgfCBVUkwpOiB2b2lkO1xuICByZWRpcmVjdChcbiAgICB1cmw6IHN0cmluZyB8IFVSTCB8IHR5cGVvZiBSRURJUkVDVF9CQUNLLFxuICAgIGFsdDogc3RyaW5nIHwgVVJMID0gXCIvXCIsXG4gICk6IHZvaWQge1xuICAgIGlmICh1cmwgPT09IFJFRElSRUNUX0JBQ0spIHtcbiAgICAgIHVybCA9IHRoaXMuI3JlcXVlc3QuaGVhZGVycy5nZXQoXCJSZWZlcmVyXCIpID8/IFN0cmluZyhhbHQpO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIHVybCA9PT0gXCJvYmplY3RcIikge1xuICAgICAgdXJsID0gU3RyaW5nKHVybCk7XG4gICAgfVxuICAgIHRoaXMuaGVhZGVycy5zZXQoXCJMb2NhdGlvblwiLCBlbmNvZGVVcmwodXJsKSk7XG4gICAgaWYgKCF0aGlzLnN0YXR1cyB8fCAhaXNSZWRpcmVjdFN0YXR1cyh0aGlzLnN0YXR1cykpIHtcbiAgICAgIHRoaXMuc3RhdHVzID0gU3RhdHVzLkZvdW5kO1xuICAgIH1cblxuICAgIGlmICh0aGlzLiNyZXF1ZXN0LmFjY2VwdHMoXCJodG1sXCIpKSB7XG4gICAgICB1cmwgPSBlbmNvZGVVUkkodXJsKTtcbiAgICAgIHRoaXMudHlwZSA9IFwidGV4dC9odG1sOyBjaGFyc2V0PXV0Zi04XCI7XG4gICAgICB0aGlzLmJvZHkgPSBgUmVkaXJlY3RpbmcgdG8gPGEgaHJlZj1cIiR7dXJsfVwiPiR7dXJsfTwvYT4uYDtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy50eXBlID0gXCJ0ZXh0L3BsYWluOyBjaGFyc2V0PXV0Zi04XCI7XG4gICAgdGhpcy5ib2R5ID0gYFJlZGlyZWN0aW5nIHRvICR7dXJsfS5gO1xuICB9XG5cbiAgYXN5bmMgdG9Eb21SZXNwb25zZSgpOiBQcm9taXNlPGdsb2JhbFRoaXMuUmVzcG9uc2U+IHtcbiAgICBpZiAodGhpcy4jZG9tUmVzcG9uc2UpIHtcbiAgICAgIHJldHVybiB0aGlzLiNkb21SZXNwb25zZTtcbiAgICB9XG5cbiAgICBjb25zdCBib2R5SW5pdCA9IGF3YWl0IHRoaXMuI2dldEJvZHlJbml0KCk7XG5cbiAgICB0aGlzLiNzZXRDb250ZW50VHlwZSgpO1xuXG4gICAgY29uc3QgeyBoZWFkZXJzIH0gPSB0aGlzO1xuXG4gICAgLy8gSWYgdGhlcmUgaXMgbm8gYm9keSBhbmQgbm8gY29udGVudCB0eXBlIGFuZCBubyBzZXQgbGVuZ3RoLCB0aGVuIHNldCB0aGVcbiAgICAvLyBjb250ZW50IGxlbmd0aCB0byAwXG4gICAgaWYgKFxuICAgICAgIShcbiAgICAgICAgYm9keUluaXQgfHxcbiAgICAgICAgaGVhZGVycy5oYXMoXCJDb250ZW50LVR5cGVcIikgfHxcbiAgICAgICAgaGVhZGVycy5oYXMoXCJDb250ZW50LUxlbmd0aFwiKVxuICAgICAgKVxuICAgICkge1xuICAgICAgaGVhZGVycy5hcHBlbmQoXCJDb250ZW50LUxlbmd0aFwiLCBcIjBcIik7XG4gICAgfVxuXG4gICAgdGhpcy4jd3JpdGFibGUgPSBmYWxzZTtcblxuICAgIGNvbnN0IHN0YXR1cyA9IHRoaXMuc3RhdHVzO1xuICAgIGNvbnN0IHJlc3BvbnNlSW5pdDogUmVzcG9uc2VJbml0ID0ge1xuICAgICAgaGVhZGVycyxcbiAgICAgIHN0YXR1cyxcbiAgICAgIHN0YXR1c1RleHQ6IFNUQVRVU19URVhULmdldChzdGF0dXMpLFxuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy4jZG9tUmVzcG9uc2UgPSBuZXcgRG9tUmVzcG9uc2UoYm9keUluaXQsIHJlc3BvbnNlSW5pdCk7XG4gIH1cblxuICAvKiogVGFrZSB0aGlzIHJlc3BvbnNlIGFuZCBjb252ZXJ0IGl0IHRvIHRoZSByZXNwb25zZSB1c2VkIGJ5IHRoZSBEZW5vIG5ldFxuICAgKiBzZXJ2ZXIuICBDYWxsaW5nIHRoaXMgd2lsbCBzZXQgdGhlIHJlc3BvbnNlIHRvIG5vdCBiZSB3cml0YWJsZS5cbiAgICpcbiAgICogTW9zdCB1c2VycyB3aWxsIGhhdmUgbm8gbmVlZCB0byBjYWxsIHRoaXMgbWV0aG9kLiAqL1xuICBhc3luYyB0b1NlcnZlclJlc3BvbnNlKCk6IFByb21pc2U8U2VydmVyUmVzcG9uc2U+IHtcbiAgICBpZiAodGhpcy4jc2VydmVyUmVzcG9uc2UpIHtcbiAgICAgIHJldHVybiB0aGlzLiNzZXJ2ZXJSZXNwb25zZTtcbiAgICB9XG4gICAgLy8gUHJvY2VzcyB0aGUgYm9keVxuICAgIGNvbnN0IGJvZHkgPSBhd2FpdCB0aGlzLiNnZXRTdGRCb2R5KCk7XG5cbiAgICAvLyBJZiB0aGVyZSBpcyBhIHJlc3BvbnNlIHR5cGUsIHNldCB0aGUgY29udGVudCB0eXBlIGhlYWRlclxuICAgIHRoaXMuI3NldENvbnRlbnRUeXBlKCk7XG5cbiAgICBjb25zdCB7IGhlYWRlcnMgfSA9IHRoaXM7XG5cbiAgICAvLyBJZiB0aGVyZSBpcyBubyBib2R5IGFuZCBubyBjb250ZW50IHR5cGUgYW5kIG5vIHNldCBsZW5ndGgsIHRoZW4gc2V0IHRoZVxuICAgIC8vIGNvbnRlbnQgbGVuZ3RoIHRvIDBcbiAgICBpZiAoXG4gICAgICAhKFxuICAgICAgICBib2R5IHx8XG4gICAgICAgIGhlYWRlcnMuaGFzKFwiQ29udGVudC1UeXBlXCIpIHx8XG4gICAgICAgIGhlYWRlcnMuaGFzKFwiQ29udGVudC1MZW5ndGhcIilcbiAgICAgIClcbiAgICApIHtcbiAgICAgIGhlYWRlcnMuYXBwZW5kKFwiQ29udGVudC1MZW5ndGhcIiwgXCIwXCIpO1xuICAgIH1cblxuICAgIHRoaXMuI3dyaXRhYmxlID0gZmFsc2U7XG4gICAgcmV0dXJuIHRoaXMuI3NlcnZlclJlc3BvbnNlID0ge1xuICAgICAgYm9keSxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBzdGF0dXM6IHRoaXMuc3RhdHVzLFxuICAgIH07XG4gIH1cblxuICBbU3ltYm9sLmZvcihcIkRlbm8uY3VzdG9tSW5zcGVjdFwiKV0oaW5zcGVjdDogKHZhbHVlOiB1bmtub3duKSA9PiBzdHJpbmcpIHtcbiAgICBjb25zdCB7IGJvZHksIGhlYWRlcnMsIHN0YXR1cywgdHlwZSwgd3JpdGFibGUgfSA9IHRoaXM7XG4gICAgcmV0dXJuIGAke3RoaXMuY29uc3RydWN0b3IubmFtZX0gJHtcbiAgICAgIGluc3BlY3QoeyBib2R5LCBoZWFkZXJzLCBzdGF0dXMsIHR5cGUsIHdyaXRhYmxlIH0pXG4gICAgfWA7XG4gIH1cbn1cbiJdfQ==