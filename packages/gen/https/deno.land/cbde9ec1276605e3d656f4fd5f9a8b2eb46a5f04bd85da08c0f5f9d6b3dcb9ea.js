import { isWebSocketCloseEvent, isWebSocketPingEvent, isWebSocketPongEvent, } from "./deps.ts";
export class WebSocketShim extends EventTarget {
    #binaryType = "blob";
    #protocol = "";
    #readyState = WebSocket.CONNECTING;
    #socket;
    #url;
    #wasClean = false;
    #getBinaryData(data) {
        if (this.#binaryType === "arraybuffer") {
            return data.buffer;
        }
        return new Blob([data]);
    }
    #listen() {
        queueMicrotask(async () => {
            for await (const event of this.#socket) {
                if (this.#readyState === WebSocket.CONNECTING) {
                    this.#readyState = WebSocket.OPEN;
                    this.dispatchEvent(new Event("open", { cancelable: false }));
                }
                if (this.#readyState === WebSocket.CLOSING &&
                    !isWebSocketCloseEvent(event)) {
                    const error = new Error("Received an event while closing.");
                    this.dispatchEvent(new ErrorEvent("error", { error, cancelable: false }));
                }
                if (isWebSocketCloseEvent(event)) {
                    this.#readyState = WebSocket.CLOSED;
                    const { code, reason } = event;
                    const wasClean = this.#wasClean;
                    this.dispatchEvent(new CloseEvent("close", {
                        code,
                        reason,
                        wasClean,
                        cancelable: false,
                    }));
                    return;
                }
                else if (isWebSocketPingEvent(event) || isWebSocketPongEvent(event)) {
                    const [type, data] = event;
                    this.dispatchEvent(new MessageEvent("message", { data: type, cancelable: false }));
                    this.dispatchEvent(new MessageEvent("message", { data, cancelable: false }));
                }
                else {
                    const data = typeof event === "string"
                        ? event
                        : this.#getBinaryData(event);
                    this.dispatchEvent(new MessageEvent("message", { data, cancelable: false }));
                }
                if (this.#readyState === WebSocket.CLOSED) {
                    return;
                }
            }
        });
    }
    get binaryType() {
        return this.#binaryType;
    }
    set binaryType(value) {
        this.#binaryType = value;
    }
    get bufferedAmount() {
        return 0;
    }
    get extensions() {
        return "";
    }
    onclose = null;
    onerror = null;
    onmessage = null;
    onopen = null;
    get protocol() {
        return this.#protocol;
    }
    get readyState() {
        return this.#readyState;
    }
    get url() {
        return this.#url;
    }
    constructor(socket, url, protocol = "") {
        super();
        this.#protocol = protocol;
        this.#socket = socket;
        this.#url = url;
        this.#listen();
    }
    close(code, reason) {
        queueMicrotask(async () => {
            try {
                this.#readyState = WebSocket.CLOSING;
                await this.#socket.close(code, reason);
                this.#wasClean = true;
            }
            catch (error) {
                this.dispatchEvent(new ErrorEvent("error", { error }));
            }
        });
    }
    send(data) {
        queueMicrotask(async () => {
            try {
                let d;
                if (typeof data === "string") {
                    d = data;
                }
                else if (data instanceof Blob) {
                    d = new Uint8Array(await data.arrayBuffer());
                }
                else if (ArrayBuffer.isView(data)) {
                    d = new Uint8Array(data.buffer);
                }
                else {
                    d = new Uint8Array(data);
                }
                await this.#socket.send(d);
            }
            catch (error) {
                this.dispatchEvent(new ErrorEvent("error", { error, cancelable: false }));
            }
        });
    }
    dispatchEvent(event) {
        if (event.type === "error" && this.onerror) {
            this.onerror.call(this, event);
        }
        else if (event.type === "close" && event instanceof CloseEvent && this.onclose) {
            this.onclose.call(this, event);
        }
        else if (event.type === "message" && event instanceof MessageEvent &&
            this.onmessage) {
            this.onmessage.call(this, event);
        }
        else if (event.type === "open" && this.onopen) {
            this.onopen.call(this, event);
        }
        if (!event.defaultPrevented) {
            return super.dispatchEvent(event);
        }
        else {
            return false;
        }
    }
    get CLOSED() {
        return WebSocket.CLOSED;
    }
    get CLOSING() {
        return WebSocket.CLOSING;
    }
    get CONNECTING() {
        return WebSocket.CONNECTING;
    }
    get OPEN() {
        return WebSocket.OPEN;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2Vic29ja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsid2Vic29ja2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFDTCxxQkFBcUIsRUFDckIsb0JBQW9CLEVBQ3BCLG9CQUFvQixHQUVyQixNQUFNLFdBQVcsQ0FBQztBQVFuQixNQUFNLE9BQU8sYUFBYyxTQUFRLFdBQVc7SUFDNUMsV0FBVyxHQUFlLE1BQU0sQ0FBQztJQUNqQyxTQUFTLEdBQUcsRUFBRSxDQUFDO0lBQ2YsV0FBVyxHQUFHLFNBQVMsQ0FBQyxVQUFVLENBQUM7SUFDbkMsT0FBTyxDQUFlO0lBQ3RCLElBQUksQ0FBUztJQUNiLFNBQVMsR0FBRyxLQUFLLENBQUM7SUFFbEIsY0FBYyxDQUFDLElBQWdCO1FBQzdCLElBQUksSUFBSSxDQUFDLFdBQVcsS0FBSyxhQUFhLEVBQUU7WUFDdEMsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDO1NBQ3BCO1FBQ0QsT0FBTyxJQUFJLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDMUIsQ0FBQztJQUVELE9BQU87UUFDTCxjQUFjLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFDeEIsSUFBSSxLQUFLLEVBQUUsTUFBTSxLQUFLLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtnQkFDdEMsSUFBSSxJQUFJLENBQUMsV0FBVyxLQUFLLFNBQVMsQ0FBQyxVQUFVLEVBQUU7b0JBQzdDLElBQUksQ0FBQyxXQUFXLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQztvQkFDbEMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLEtBQUssQ0FBQyxNQUFNLEVBQUUsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO2lCQUM5RDtnQkFDRCxJQUNFLElBQUksQ0FBQyxXQUFXLEtBQUssU0FBUyxDQUFDLE9BQU87b0JBQ3RDLENBQUMscUJBQXFCLENBQUMsS0FBSyxDQUFDLEVBQzdCO29CQUNBLE1BQU0sS0FB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LENBQUMsTUFBTSxDQUFDO0lBQzFCLENBQUM7SUFFRCxJQUFJLE9BQU87UUFDVCxPQUFPLFNBQVMsQ0FBQyxPQUFPLENBQUM7SUFDM0IsQ0FBQztJQUVELElBQUksVUFBVTtRQUNaLE9BQU8sU0FBUyxDQUFDLFVBQVUsQ0FBQztJQUM5QixDQUFDO0lBRUQsSUFBSSxJQUFJO1FBQ04sT0FBTyxTQUFTLENBQUMsSUFBSSxDQUFDO0lBQ3hCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE4LTIwMjEgdGhlIG9hayBhdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLiBNSVQgbGljZW5zZS5cblxuaW1wb3J0IHtcbiAgaXNXZWJTb2NrZXRDbG9zZUV2ZW50LFxuICBpc1dlYlNvY2tldFBpbmdFdmVudCxcbiAgaXNXZWJTb2NrZXRQb25nRXZlbnQsXG4gIFdlYlNvY2tldFN0ZCxcbn0gZnJvbSBcIi4vZGVwcy50c1wiO1xuXG5leHBvcnQgaW50ZXJmYWNlIFVwZ3JhZGVXZWJTb2NrZXRPcHRpb25zIHtcbiAgcHJvdG9jb2w/OiBzdHJpbmc7XG59XG5cbi8qKiBBIHNoaW0gd2hpY2ggdGFrZXMgYSBgc3RkYCBsaWJyYXJ5IFdlYlNvY2tldCBhbmQgY29udmVydHMgaXQgaW50byBhIHdlYlxuICogc3RhbmRhcmQgYFdlYlNvY2tldGAgd2hpY2ggaXMgbmF0aXZlbHkgc3VwcG9ydGVkIGJ5IERlbm8uICovXG5leHBvcnQgY2xhc3MgV2ViU29ja2V0U2hpbSBleHRlbmRzIEV2ZW50VGFyZ2V0IGltcGxlbWVudHMgV2ViU29ja2V0IHtcbiAgI2JpbmFyeVR5cGU6IEJpbmFyeVR5cGUgPSBcImJsb2JcIjtcbiAgI3Byb3RvY29sID0gXCJcIjtcbiAgI3JlYWR5U3RhdGUgPSBXZWJTb2NrZXQuQ09OTkVDVElORztcbiAgI3NvY2tldDogV2ViU29ja2V0U3RkO1xuICAjdXJsOiBzdHJpbmc7XG4gICN3YXNDbGVhbiA9IGZhbHNlO1xuXG4gICNnZXRCaW5hcnlEYXRhKGRhdGE6IFVpbnQ4QXJyYXkpOiBBcnJheUJ1ZmZlciB8IEJsb2Ige1xuICAgIGlmICh0aGlzLiNiaW5hcnlUeXBlID09PSBcImFycmF5YnVmZmVyXCIpIHtcbiAgICAgIHJldHVybiBkYXRhLmJ1ZmZlcjtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBCbG9iKFtkYXRhXSk7XG4gIH1cblxuICAjbGlzdGVuKCkge1xuICAgIHF1ZXVlTWljcm90YXNrKGFzeW5jICgpID0+IHtcbiAgICAgIGZvciBhd2FpdCAoY29uc3QgZXZlbnQgb2YgdGhpcy4jc29ja2V0KSB7XG4gICAgICAgIGlmICh0aGlzLiNyZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuQ09OTkVDVElORykge1xuICAgICAgICAgIHRoaXMuI3JlYWR5U3RhdGUgPSBXZWJTb2NrZXQuT1BFTjtcbiAgICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQobmV3IEV2ZW50KFwib3BlblwiLCB7IGNhbmNlbGFibGU6IGZhbHNlIH0pKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoXG4gICAgICAgICAgdGhpcy4jcmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0LkNMT1NJTkcgJiZcbiAgICAgICAgICAhaXNXZWJTb2NrZXRDbG9zZUV2ZW50KGV2ZW50KVxuICAgICAgICApIHtcbiAgICAgICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcihcIlJlY2VpdmVkIGFuIGV2ZW50IHdoaWxlIGNsb3NpbmcuXCIpO1xuICAgICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChcbiAgICAgICAgICAgIG5ldyBFcnJvckV2ZW50KFwiZXJyb3JcIiwgeyBlcnJvciwgY2FuY2VsYWJsZTogZmFsc2UgfSksXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoaXNXZWJTb2NrZXRDbG9zZUV2ZW50KGV2ZW50KSkge1xuICAgICAgICAgIHRoaXMuI3JlYWR5U3RhdGUgPSBXZWJTb2NrZXQuQ0xPU0VEO1xuICAgICAgICAgIGNvbnN0IHsgY29kZSwgcmVhc29uIH0gPSBldmVudDtcbiAgICAgICAgICBjb25zdCB3YXNDbGVhbiA9IHRoaXMuI3dhc0NsZWFuO1xuICAgICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChcbiAgICAgICAgICAgIG5ldyBDbG9zZUV2ZW50KFwiY2xvc2VcIiwge1xuICAgICAgICAgICAgICBjb2RlLFxuICAgICAgICAgICAgICByZWFzb24sXG4gICAgICAgICAgICAgIHdhc0NsZWFuLFxuICAgICAgICAgICAgICBjYW5jZWxhYmxlOiBmYWxzZSxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9IGVsc2UgaWYgKGlzV2ViU29ja2V0UGluZ0V2ZW50KGV2ZW50KSB8fCBpc1dlYlNvY2tldFBvbmdFdmVudChldmVudCkpIHtcbiAgICAgICAgICBjb25zdCBbdHlwZSwgZGF0YV0gPSBldmVudDtcbiAgICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoXG4gICAgICAgICAgICBuZXcgTWVzc2FnZUV2ZW50KFwibWVzc2FnZVwiLCB7IGRhdGE6IHR5cGUsIGNhbmNlbGFibGU6IGZhbHNlIH0pLFxuICAgICAgICAgICk7XG4gICAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KFxuICAgICAgICAgICAgbmV3IE1lc3NhZ2VFdmVudChcIm1lc3NhZ2VcIiwgeyBkYXRhLCBjYW5jZWxhYmxlOiBmYWxzZSB9KSxcbiAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IGRhdGEgPSB0eXBlb2YgZXZlbnQgPT09IFwic3RyaW5nXCJcbiAgICAgICAgICAgID8gZXZlbnRcbiAgICAgICAgICAgIDogdGhpcy4jZ2V0QmluYXJ5RGF0YShldmVudCk7XG4gICAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KFxuICAgICAgICAgICAgbmV3IE1lc3NhZ2VFdmVudChcIm1lc3NhZ2VcIiwgeyBkYXRhLCBjYW5jZWxhYmxlOiBmYWxzZSB9KSxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLiNyZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuQ0xPU0VEKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBnZXQgYmluYXJ5VHlwZSgpOiBCaW5hcnlUeXBlIHtcbiAgICByZXR1cm4gdGhpcy4jYmluYXJ5VHlwZTtcbiAgfVxuXG4gIHNldCBiaW5hcnlUeXBlKHZhbHVlOiBCaW5hcnlUeXBlKSB7XG4gICAgdGhpcy4jYmluYXJ5VHlwZSA9IHZhbHVlO1xuICB9XG5cbiAgZ2V0IGJ1ZmZlcmVkQW1vdW50KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIDA7XG4gIH1cblxuICBnZXQgZXh0ZW5zaW9ucygpOiBzdHJpbmcge1xuICAgIHJldHVybiBcIlwiO1xuICB9XG5cbiAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgb25jbG9zZTogKCh0aGlzOiBXZWJTb2NrZXQsIGV2OiBDbG9zZUV2ZW50KSA9PiBhbnkpIHwgbnVsbCA9IG51bGw7XG4gIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gIG9uZXJyb3I6ICgodGhpczogV2ViU29ja2V0LCBldjogRXZlbnQgfCBFcnJvckV2ZW50KSA9PiBhbnkpIHwgbnVsbCA9IG51bGw7XG4gIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gIG9ubWVzc2FnZTogKCh0aGlzOiBXZWJTb2NrZXQsIGV2OiBNZXNzYWdlRXZlbnQpID0+IGFueSkgfCBudWxsID0gbnVsbDtcbiAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgb25vcGVuOiAoKHRoaXM6IFdlYlNvY2tldCwgZXY6IEV2ZW50KSA9PiBhbnkpIHwgbnVsbCA9IG51bGw7XG5cbiAgZ2V0IHByb3RvY29sKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuI3Byb3RvY29sO1xuICB9XG5cbiAgZ2V0IHJlYWR5U3RhdGUoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy4jcmVhZHlTdGF0ZTtcbiAgfVxuXG4gIGdldCB1cmwoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy4jdXJsO1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgc29ja2V0OiBXZWJTb2NrZXRTdGQsXG4gICAgdXJsOiBzdHJpbmcsXG4gICAgcHJvdG9jb2w6IHN0cmluZyA9IFwiXCIsXG4gICkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy4jcHJvdG9jb2wgPSBwcm90b2NvbDtcbiAgICB0aGlzLiNzb2NrZXQgPSBzb2NrZXQ7XG4gICAgdGhpcy4jdXJsID0gdXJsO1xuICAgIHRoaXMuI2xpc3RlbigpO1xuICB9XG5cbiAgY2xvc2UoY29kZT86IG51bWJlciwgcmVhc29uPzogc3RyaW5nKTogdm9pZCB7XG4gICAgcXVldWVNaWNyb3Rhc2soYXN5bmMgKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgdGhpcy4jcmVhZHlTdGF0ZSA9IFdlYlNvY2tldC5DTE9TSU5HO1xuICAgICAgICAvLyBzdGQgaGFzIGJhZCB0eXBpbmdzIGhlcmUg7aC97bitXG4gICAgICAgIGF3YWl0IHRoaXMuI3NvY2tldC5jbG9zZShjb2RlIGFzIG51bWJlciwgcmVhc29uIGFzIHN0cmluZyk7XG4gICAgICAgIHRoaXMuI3dhc0NsZWFuID0gdHJ1ZTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChuZXcgRXJyb3JFdmVudChcImVycm9yXCIsIHsgZXJyb3IgfSkpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgc2VuZChkYXRhOiBzdHJpbmcgfCBBcnJheUJ1ZmZlckxpa2UgfCBCbG9iIHwgQXJyYXlCdWZmZXJWaWV3KTogdm9pZCB7XG4gICAgcXVldWVNaWNyb3Rhc2soYXN5bmMgKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgbGV0IGQ6IHN0cmluZyB8IFVpbnQ4QXJyYXk7XG4gICAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgIGQgPSBkYXRhO1xuICAgICAgICB9IGVsc2UgaWYgKGRhdGEgaW5zdGFuY2VvZiBCbG9iKSB7XG4gICAgICAgICAgZCA9IG5ldyBVaW50OEFycmF5KGF3YWl0IGRhdGEuYXJyYXlCdWZmZXIoKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KGRhdGEpKSB7XG4gICAgICAgICAgZCA9IG5ldyBVaW50OEFycmF5KGRhdGEuYnVmZmVyKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBkID0gbmV3IFVpbnQ4QXJyYXkoZGF0YSk7XG4gICAgICAgIH1cbiAgICAgICAgYXdhaXQgdGhpcy4jc29ja2V0LnNlbmQoZCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoXG4gICAgICAgICAgbmV3IEVycm9yRXZlbnQoXCJlcnJvclwiLCB7IGVycm9yLCBjYW5jZWxhYmxlOiBmYWxzZSB9KSxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGRpc3BhdGNoRXZlbnQoZXZlbnQ6IEV2ZW50KSB7XG4gICAgaWYgKGV2ZW50LnR5cGUgPT09IFwiZXJyb3JcIiAmJiB0aGlzLm9uZXJyb3IpIHtcbiAgICAgIHRoaXMub25lcnJvci5jYWxsKHRoaXMsIGV2ZW50KTtcbiAgICB9IGVsc2UgaWYgKFxuICAgICAgZXZlbnQudHlwZSA9PT0gXCJjbG9zZVwiICYmIGV2ZW50IGluc3RhbmNlb2YgQ2xvc2VFdmVudCAmJiB0aGlzLm9uY2xvc2VcbiAgICApIHtcbiAgICAgIHRoaXMub25jbG9zZS5jYWxsKHRoaXMsIGV2ZW50KTtcbiAgICB9IGVsc2UgaWYgKFxuICAgICAgZXZlbnQudHlwZSA9PT0gXCJtZXNzYWdlXCIgJiYgZXZlbnQgaW5zdGFuY2VvZiBNZXNzYWdlRXZlbnQgJiZcbiAgICAgIHRoaXMub25tZXNzYWdlXG4gICAgKSB7XG4gICAgICB0aGlzLm9ubWVzc2FnZS5jYWxsKHRoaXMsIGV2ZW50KTtcbiAgICB9IGVsc2UgaWYgKGV2ZW50LnR5cGUgPT09IFwib3BlblwiICYmIHRoaXMub25vcGVuKSB7XG4gICAgICB0aGlzLm9ub3Blbi5jYWxsKHRoaXMsIGV2ZW50KTtcbiAgICB9XG4gICAgaWYgKCFldmVudC5kZWZhdWx0UHJldmVudGVkKSB7XG4gICAgICByZXR1cm4gc3VwZXIuZGlzcGF0Y2hFdmVudChldmVudCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBnZXQgQ0xPU0VEKCkge1xuICAgIHJldHVybiBXZWJTb2NrZXQuQ0xPU0VEO1xuICB9XG5cbiAgZ2V0IENMT1NJTkcoKSB7XG4gICAgcmV0dXJuIFdlYlNvY2tldC5DTE9TSU5HO1xuICB9XG5cbiAgZ2V0IENPTk5FQ1RJTkcoKSB7XG4gICAgcmV0dXJuIFdlYlNvY2tldC5DT05ORUNUSU5HO1xuICB9XG5cbiAgZ2V0IE9QRU4oKSB7XG4gICAgcmV0dXJuIFdlYlNvY2tldC5PUEVOO1xuICB9XG59XG4iXX0=